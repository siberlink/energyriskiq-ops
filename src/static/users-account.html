<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZDXY4E2P1N"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-ZDXY4E2P1N');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account - EnergyRiskIQ</title>
    <link rel="canonical" href="https://energyriskiq.com/users/account">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
        }

        .header {
            background: #1e293b;
            border-bottom: 1px solid #334155;
            padding: 0 24px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-logo {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-badge {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }

        .user-email {
            font-size: 14px;
            font-weight: 500;
        }

        .logout-btn {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #f87171;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        .sidebar {
            position: fixed;
            top: 64px;
            left: 0;
            bottom: 0;
            width: 260px;
            background: #1e293b;
            border-right: 1px solid #334155;
            padding: 24px 16px;
            overflow-y: auto;
        }

        .sidebar-section {
            margin-bottom: 32px;
        }

        .sidebar-title {
            font-size: 11px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0 12px;
            margin-bottom: 12px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            color: #94a3b8;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 4px;
            text-decoration: none;
        }

        .nav-item:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #e2e8f0;
        }

        .nav-item.active {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
        }

        .pro-badge-nav {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            font-size: 9px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: auto;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .pro-badge-nav.pro-badge-locked {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            font-size: 8px;
        }

        .nav-item-disabled {
            opacity: 0.6;
            cursor: not-allowed !important;
            pointer-events: none;
        }

        .nav-item-disabled:hover {
            background: transparent !important;
            color: rgba(255, 255, 255, 0.6) !important;
        }

        .geri-upgrade-hint {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            padding: 4px 12px 8px 44px;
            margin-top: -4px;
            font-style: italic;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .main {
            margin-left: 260px;
            margin-top: 64px;
            padding: 32px;
            min-height: calc(100vh - 64px);
        }

        .page-header {
            margin-bottom: 32px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: #f1f5f9;
            margin-bottom: 8px;
        }

        .page-subtitle {
            color: #94a3b8;
            font-size: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 24px;
        }

        .stat-label {
            font-size: 13px;
            color: #94a3b8;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #f1f5f9;
        }

        .stat-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
        }

        .stat-badge.free {
            background: rgba(100, 116, 139, 0.2);
            color: #94a3b8;
        }

        .stat-badge.personal {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        .stat-badge.trader {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        .stat-badge.pro {
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
        }

        .stat-badge.enterprise {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }

        .content-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 24px;
        }

        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid #334155;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #f1f5f9;
        }

        .card-body {
            padding: 24px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid #334155;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-size: 14px;
            color: #94a3b8;
        }

        .info-value {
            font-size: 14px;
            color: #f1f5f9;
            font-weight: 500;
        }

        .alerts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .sample-card {
            background: #1e293b;
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid #334155;
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .sample-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 8px 10px -6px rgba(0, 0, 0, 0.2);
            border-color: rgba(59, 130, 246, 0.4);
        }

        .card-timestamp {
            background: linear-gradient(135deg, #334155, #475569);
            color: #e2e8f0;
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-timestamp svg {
            width: 14px;
            height: 14px;
            opacity: 0.7;
        }

        .card-timestamp .latest-badge {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 10px;
            text-transform: uppercase;
            margin-left: auto;
        }

        .sample-card .card-header {
            padding: 1.25rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            border-bottom: 1px solid #334155;
            background: transparent;
        }

        .alert-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .alert-icon svg {
            width: 24px;
            height: 24px;
        }

        .alert-icon.regional {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1));
            color: #fbbf24;
        }

        .alert-icon.asset {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.1));
            color: #60a5fa;
        }

        .alert-icon.high-impact {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));
            color: #f87171;
        }

        .alert-icon.digest {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(139, 92, 246, 0.1));
            color: #a78bfa;
        }

        .card-header-text h3 {
            font-size: 1rem;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 0.25rem;
        }

        .card-header-text .type-badge {
            display: inline-block;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            background: rgba(100, 116, 139, 0.3);
            color: #94a3b8;
        }

        .sample-card .card-body {
            padding: 1.25rem 1.5rem;
            flex: 1;
        }

        .alert-content {
            background: #0f172a;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Mono', monospace;
            font-size: 0.8rem;
            line-height: 1.6;
            color: #94a3b8;
            white-space: pre-wrap;
            overflow-x: auto;
            max-height: 280px;
            overflow-y: auto;
        }

        .sample-card .card-footer {
            padding: 1rem 1.5rem;
            background: rgba(15, 23, 42, 0.5);
            border-top: 1px solid #334155;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .channel-badge {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .channel-badge.email {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        .channel-badge.telegram {
            background: rgba(0, 136, 204, 0.2);
            color: #38bdf8;
        }

        .channel-badge.sms {
            background: rgba(16, 185, 129, 0.2);
            color: #4ade80;
        }

        .sample-card .card-footer span {
            font-size: 0.8rem;
            color: #64748b;
        }

        .sample-card.locked {
            opacity: 0.6;
            filter: grayscale(30%);
        }

        .sample-card.locked .alert-content {
            filter: blur(3px);
        }

        .card-lock-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px 20px;
            background: linear-gradient(180deg, transparent 0%, rgba(139, 92, 246, 0.15) 100%);
            border-top: 1px solid rgba(139, 92, 246, 0.2);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #a78bfa;
        }

        .lock-icon {
            font-size: 14px;
        }

        .alert-filters {
            display: flex;
            gap: 16px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-label {
            font-size: 13px;
            color: #94a3b8;
            font-weight: 500;
        }

        .filter-input {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 13px;
            color: #e2e8f0;
            font-family: inherit;
        }

        .filter-input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .filter-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .filter-btn.secondary {
            background: rgba(100, 116, 139, 0.2);
            color: #94a3b8;
        }

        .filter-btn.secondary:hover {
            background: rgba(100, 116, 139, 0.3);
            box-shadow: none;
            transform: none;
        }

        .filter-toggle {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid #334155;
            background: #1e293b;
            color: #94a3b8;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-toggle:hover {
            border-color: #3b82f6;
            color: #e2e8f0;
        }

        .filter-toggle.active {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .filter-toggle-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-divider {
            width: 1px;
            height: 24px;
            background: #334155;
            margin: 0 8px;
        }

        @media (max-width: 768px) {
            .alert-filters {
                flex-direction: column;
                align-items: flex-start;
            }
            .filter-divider {
                display: none;
            }
            .filter-toggle-group {
                width: 100%;
            }
        }

        .upgrade-sidebar-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(59, 130, 246, 0.15) 100%);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }

        .upgrade-sidebar-title {
            font-size: 14px;
            font-weight: 600;
            color: #a78bfa;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .upgrade-sidebar-text {
            font-size: 12px;
            color: #94a3b8;
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .upgrade-sidebar-btn {
            width: 100%;
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            border: none;
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upgrade-sidebar-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        /* GERI Display Styles */
        .geri-display-card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid #334155;
            border-radius: 16px;
            padding: 32px;
            text-align: center;
            max-width: 500px;
            margin: 0 auto 24px;
        }

        .geri-loading {
            padding: 40px;
            text-align: center;
        }

        .geri-loading p {
            color: #9ca3af;
            margin-top: 16px;
        }

        .geri-value-display {
            font-size: 80px;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 8px;
        }

        .geri-band-display {
            font-size: 24px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 8px;
        }

        .geri-trend-display {
            font-size: 16px;
            margin-bottom: 16px;
        }

        .geri-date-display {
            color: #9ca3af;
            font-size: 14px;
        }

        .geri-realtime-badge {
            display: inline-block;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            font-size: 12px;
            font-weight: 600;
            padding: 4px 12px;
            border-radius: 20px;
            margin-bottom: 24px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .geri-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-top: 24px;
        }

        .geri-detail-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 20px;
        }

        .geri-detail-title {
            color: #9ca3af;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .geri-detail-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .geri-detail-list li {
            color: #e2e8f0;
            font-size: 14px;
            padding: 6px 0;
            border-bottom: 1px solid #334155;
        }

        .geri-detail-list li:last-child {
            border-bottom: none;
        }

        .geri-methodology-link {
            text-align: center;
            margin-top: 24px;
        }

        .geri-methodology-link a {
            color: #60a5fa;
            text-decoration: none;
            font-size: 14px;
        }

        .geri-methodology-link a:hover {
            text-decoration: underline;
        }

        .geri-methodology-header-link {
            display: inline-block;
            color: #60a5fa;
            text-decoration: none;
            font-size: 14px;
            margin-top: 8px;
        }

        .geri-methodology-header-link:hover {
            text-decoration: underline;
        }

        /* Interpretation Preview Section */
        .geri-interpretation-preview {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 20px;
            margin-top: 24px;
        }

        .geri-interpretation-title {
            font-size: 16px;
            font-weight: 600;
            color: #60a5fa;
            margin-bottom: 12px;
        }

        .geri-interpretation-text {
            color: #9ca3af;
            font-style: italic;
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .geri-see-more-link {
            color: #3b82f6;
            text-decoration: none;
            font-size: 14px;
            cursor: pointer;
        }

        .geri-see-more-link:hover {
            text-decoration: underline;
        }

        /* Interpretation Modal */
        .interpretation-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .interpretation-modal-overlay.active {
            display: flex;
        }

        .interpretation-modal-content {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 16px;
            max-width: 700px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 32px;
            position: relative;
        }

        .interpretation-modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: transparent;
            border: none;
            color: #94a3b8;
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
            line-height: 1;
        }

        .interpretation-modal-close:hover {
            color: #e2e8f0;
        }

        .interpretation-modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 20px;
            padding-right: 30px;
        }

        .interpretation-modal-body {
            color: #cbd5e1;
            font-style: italic;
            line-height: 1.8;
            font-size: 15px;
            border-left: 4px solid #60a5fa;
            padding-left: 20px;
        }

        /* GERI Charts Section */
        .geri-charts-section {
            margin-top: 32px;
        }

        .geri-charts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .geri-charts-title {
            font-size: 18px;
            font-weight: 600;
            color: #f1f5f9;
        }

        .geri-charts-title span {
            font-size: 13px;
            color: #64748b;
            font-weight: 400;
        }

        .geri-chart-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .chart-range-btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid #334155;
            background: #1e293b;
            color: #94a3b8;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chart-range-btn:hover:not(:disabled) {
            border-color: #3b82f6;
            color: #e2e8f0;
        }

        .chart-range-btn.active {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .chart-range-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .chart-range-btn .tooltip-hint {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            border: 1px solid #334155;
            color: #94a3b8;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 10;
            margin-bottom: 6px;
        }

        .chart-range-btn:disabled:hover .tooltip-hint {
            display: block;
        }

        .chart-range-btn {
            position: relative;
        }

        .geri-chart-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .geri-chart-container {
            position: relative;
            height: 320px;
            width: 100%;
        }

        .geri-trend-indicators {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .trend-indicator-card {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 16px;
            text-align: center;
        }

        .trend-indicator-label {
            font-size: 12px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .trend-indicator-value {
            font-size: 24px;
            font-weight: 700;
            color: #f1f5f9;
        }

        .trend-indicator-value.positive {
            color: #f87171;
        }

        .trend-indicator-value.negative {
            color: #4ade80;
        }

        .trend-indicator-value.neutral {
            color: #94a3b8;
        }

        .trend-indicator-subtext {
            font-size: 11px;
            color: #64748b;
            margin-top: 4px;
        }

        .market-overlay-toggles {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .overlay-toggle {
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid #334155;
            background: transparent;
            color: #64748b;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .overlay-toggle:hover {
            border-color: #475569;
            color: #94a3b8;
        }

        .overlay-toggle.active {
            border-color: var(--overlay-color, #3b82f6);
            background: rgba(59, 130, 246, 0.1);
            color: var(--overlay-color, #3b82f6);
        }

        .overlay-toggle .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--overlay-color, #64748b);
        }

        .chart-zoom-hint {
            font-size: 11px;
            color: #64748b;
            text-align: right;
            margin-top: 8px;
        }

        @media (max-width: 768px) {
            .geri-charts-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .geri-chart-container {
                height: 280px;
            }

            .geri-chart-card {
                padding: 16px;
            }

            .geri-trend-indicators {
                grid-template-columns: repeat(2, 1fr);
            }

            .trend-indicator-value {
                font-size: 20px;
            }

            .market-overlay-toggles {
                justify-content: flex-start;
            }
        }

        @media (max-width: 576px) {
            .geri-chart-container {
                height: 240px;
            }

            .geri-trend-indicators {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }

            .trend-indicator-card {
                padding: 12px;
            }

            .trend-indicator-label {
                font-size: 10px;
            }

            .trend-indicator-value {
                font-size: 18px;
            }

            .chart-range-btn {
                padding: 6px 12px;
                font-size: 12px;
            }

            .overlay-toggle {
                padding: 5px 10px;
                font-size: 11px;
            }
        }

        @media (max-width: 400px) {
            .geri-chart-container {
                height: 200px;
            }

            .geri-trend-indicators {
                grid-template-columns: 1fr 1fr;
            }

            .trend-indicator-value {
                font-size: 16px;
            }
        }

        .geri-upgrade-required {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid #334155;
            border-radius: 16px;
            padding: 48px 32px;
            text-align: center;
            max-width: 500px;
            margin: 0 auto;
        }

        .geri-upgrade-required h3 {
            color: #e2e8f0;
            font-size: 20px;
            margin-bottom: 12px;
        }

        .geri-upgrade-required p {
            color: #9ca3af;
            margin-bottom: 24px;
        }

        .geri-upgrade-btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            border: none;
            padding: 12px 32px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .geri-upgrade-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        @media (max-width: 768px) {
            .geri-details-grid {
                grid-template-columns: 1fr;
            }
            .geri-value-display {
                font-size: 60px;
            }
            .geri-display-card {
                padding: 24px 16px;
            }
        }

        .upgrade-banner-small {
            margin-top: 12px;
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 10px;
            font-size: 13px;
            color: #a78bfa;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .alert-types-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 16px;
        }

        .alert-type-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            border-radius: 8px;
            background: #1e293b;
            border: 1px solid #334155;
        }

        .alert-type-item.allowed {
            border-color: rgba(34, 197, 94, 0.3);
            background: rgba(34, 197, 94, 0.05);
        }

        .alert-type-item.locked {
            border-color: #334155;
            opacity: 0.6;
        }

        .alert-type-icon {
            font-size: 16px;
        }

        .alert-type-item.allowed .alert-type-icon {
            color: #4ade80;
        }

        .alert-type-item.locked .alert-type-icon {
            color: #64748b;
        }

        .alert-type-name {
            font-size: 13px;
            font-weight: 500;
            flex: 1;
        }

        .upgrade-hint {
            font-size: 11px;
            color: #a78bfa;
            background: rgba(139, 92, 246, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
        }

        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .upgrade-banner {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .upgrade-content h3 {
            font-size: 18px;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 8px;
        }

        .upgrade-content p {
            color: #94a3b8;
            font-size: 14px;
        }

        .upgrade-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }

        .upgrade-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .section-content {
            display: none;
        }

        .section-content.active {
            display: block;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 60px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #334155;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .plans-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .plan-card {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 24px;
            position: relative;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .plan-card.current {
            border-color: #3b82f6;
        }

        .plan-card.current::before {
            content: 'Current Plan';
            position: absolute;
            top: -10px;
            left: 20px;
            background: #3b82f6;
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 4px 12px;
            border-radius: 4px;
        }

        .plan-name {
            font-size: 20px;
            font-weight: 700;
            color: #f1f5f9;
            margin-bottom: 8px;
        }

        .plan-price {
            font-size: 32px;
            font-weight: 700;
            color: #22c55e;
            margin-bottom: 16px;
        }

        .plan-price span {
            font-size: 14px;
            color: #64748b;
            font-weight: 400;
        }

        .plan-features {
            list-style: none;
            margin-bottom: 24px;
        }

        .plan-features li {
            padding: 8px 0;
            font-size: 13px;
            color: #94a3b8;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .plan-features li::before {
            content: '✓';
            color: #22c55e;
            font-weight: bold;
        }

        .plan-btn {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: auto;
        }

        .plan-btn.current {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #60a5fa;
        }

        .plan-btn.upgrade {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border: none;
            color: white;
        }

        /* Mobile Menu Toggle Button */
        .mobile-menu-btn {
            display: none;
            background: transparent;
            border: none;
            color: #e2e8f0;
            cursor: pointer;
            padding: 8px;
            margin-right: 8px;
        }

        .mobile-menu-btn svg {
            width: 24px;
            height: 24px;
        }

        /* Mobile Overlay */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 64px;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 89;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* Tablet Responsive (768px) */
        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }

            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 90;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main {
                margin-left: 0;
                padding: 24px 16px;
            }

            .header {
                padding: 0 16px;
            }

            .user-email {
                display: none;
            }

            .page-title {
                font-size: 24px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .stat-card {
                padding: 16px;
            }

            .stat-value {
                font-size: 24px;
            }

            .alerts-grid {
                grid-template-columns: 1fr;
            }

            .plans-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }

            .upgrade-banner {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }

            .card-header {
                padding: 16px;
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .card-body {
                padding: 16px;
            }

            .info-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
        }

        /* Mobile Responsive (576px) */
        @media (max-width: 576px) {
            .header-badge {
                display: none;
            }

            .header-logo {
                font-size: 18px;
            }

            .logout-btn {
                padding: 6px 12px;
                font-size: 12px;
            }

            .user-avatar {
                width: 32px;
                height: 32px;
                font-size: 12px;
            }

            .main {
                padding: 16px 12px;
            }

            .page-header {
                margin-bottom: 20px;
            }

            .page-title {
                font-size: 20px;
            }

            .page-subtitle {
                font-size: 13px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .stat-card {
                padding: 16px;
            }

            .stat-label {
                font-size: 12px;
            }

            .stat-value {
                font-size: 28px;
            }

            .content-card {
                border-radius: 8px;
            }

            .card-title {
                font-size: 16px;
            }

            .plans-grid {
                grid-template-columns: 1fr;
            }

            .plan-card {
                padding: 20px;
            }

            .plan-name {
                font-size: 18px;
            }

            .plan-price {
                font-size: 28px;
            }

            .sample-card .card-header {
                padding: 1rem;
            }

            .alert-icon {
                width: 40px;
                height: 40px;
            }

            .alert-icon svg {
                width: 20px;
                height: 20px;
            }

            .card-header-text h3 {
                font-size: 14px;
            }

            .card-header-text p {
                font-size: 11px;
            }

            .sample-card .card-body {
                padding: 1rem;
            }

            .card-actions {
                flex-direction: column;
            }

            .card-actions .btn {
                width: 100%;
                justify-content: center;
            }

            .upgrade-banner {
                padding: 16px;
            }

            .upgrade-content h3 {
                font-size: 16px;
            }

            .upgrade-content p {
                font-size: 13px;
            }

            .upgrade-btn {
                width: 100%;
                padding: 12px 20px;
            }

            .nav-item {
                padding: 14px 12px;
                font-size: 15px;
            }

            .sidebar {
                width: 280px;
                padding: 20px 12px;
            }
        }

        /* Small Mobile (400px) */
        @media (max-width: 400px) {
            .header {
                padding: 0 12px;
            }

            .header-logo {
                font-size: 16px;
            }

            .main {
                padding: 12px 10px;
            }

            .stat-value {
                font-size: 24px;
            }

            .plan-price {
                font-size: 24px;
            }
        }

        /* ============================================
           EERI Pro Dashboard Styles
           Encapsulated module - do not affect other sections
           ============================================ */
        
        .eeri-header-links {
            display: flex;
            gap: 24px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .eeri-methodology-header-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: #60a5fa;
            text-decoration: none;
            font-size: 14px;
            padding: 6px 12px;
            border: 1px solid #334155;
            border-radius: 6px;
            background: rgba(59, 130, 246, 0.1);
            transition: all 0.2s;
        }

        .eeri-methodology-header-link:hover {
            text-decoration: none;
            background: rgba(59, 130, 246, 0.2);
            border-color: #60a5fa;
        }

        .eeri-pro-loading {
            text-align: center;
            padding: 60px 20px;
        }

        .eeri-pro-loading p {
            color: #9ca3af;
            margin-top: 16px;
        }

        /* EERI Locked State */
        .eeri-pro-locked {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px 20px;
        }

        .eeri-locked-card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid #334155;
            border-radius: 20px;
            padding: 48px 40px;
            text-align: center;
            max-width: 520px;
        }

        .eeri-locked-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .eeri-locked-card h2 {
            color: #f1f5f9;
            font-size: 24px;
            margin-bottom: 12px;
        }

        .eeri-locked-card p {
            color: #9ca3af;
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .eeri-locked-features {
            list-style: none;
            padding: 0;
            margin: 0 0 24px 0;
            text-align: left;
        }

        .eeri-locked-features li {
            color: #e2e8f0;
            font-size: 14px;
            padding: 8px 0;
            padding-left: 28px;
            position: relative;
        }

        .eeri-locked-features li::before {
            content: "✓";
            position: absolute;
            left: 0;
            color: #8b5cf6;
            font-weight: 700;
        }

        .eeri-upgrade-btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            border: none;
            padding: 14px 36px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .eeri-upgrade-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
        }

        .eeri-upgrade-hint {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            padding: 4px 12px 8px 44px;
            margin-top: -4px;
            font-style: italic;
        }

        /* EERI Pro Dashboard */
        .eeri-pro-dashboard {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* Daily Summary Card */
        .eeri-summary-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 16px;
            padding: 24px;
        }

        .eeri-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .eeri-summary-label {
            color: #a78bfa;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .eeri-summary-date {
            color: #64748b;
            font-size: 13px;
        }

        .eeri-summary-text {
            color: #e2e8f0;
            font-size: 15px;
            line-height: 1.7;
            font-style: italic;
        }

        .eeri-summary-text p {
            margin: 0 0 12px 0;
        }

        .eeri-summary-text p:last-child {
            margin-bottom: 0;
        }

        .eeri-summary-meta {
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid rgba(139, 92, 246, 0.2);
        }

        .eeri-summary-drivers {
            color: #94a3b8;
            font-size: 12px;
        }

        /* Main Row */
        .eeri-main-row {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 24px;
        }

        @media (max-width: 900px) {
            .eeri-main-row {
                grid-template-columns: 1fr;
            }
        }

        /* EERI Value Card */
        .eeri-value-card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid #334155;
            border-radius: 16px;
            padding: 28px;
            text-align: center;
        }

        .eeri-value-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .eeri-value-label {
            color: #64748b;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .eeri-realtime-badge {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .eeri-value-display {
            margin-bottom: 12px;
        }

        .eeri-value-number {
            font-size: 72px;
            font-weight: 700;
            line-height: 1;
            background: linear-gradient(135deg, #f1f5f9 0%, #94a3b8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .eeri-value-band {
            display: block;
            font-size: 18px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 8px;
        }

        .eeri-value-trend {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .eeri-trend-icon {
            font-size: 20px;
        }

        .eeri-trend-text {
            color: #94a3b8;
            font-size: 14px;
        }

        .eeri-computed-at {
            color: #64748b;
            font-size: 12px;
        }

        /* Component Breakdown Card */
        .eeri-components-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 16px;
            padding: 24px;
        }

        .eeri-components-header {
            margin-bottom: 20px;
        }

        .eeri-components-title {
            color: #f1f5f9;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .eeri-components-hint {
            color: #64748b;
            font-size: 12px;
        }

        .eeri-components-chart {
            display: flex;
            height: 24px;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .eeri-component-bar {
            height: 100%;
            transition: all 0.3s ease;
            position: relative;
        }

        .eeri-component-bar:hover {
            filter: brightness(1.2);
        }

        .eeri-components-legend {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        @media (max-width: 600px) {
            .eeri-components-legend {
                grid-template-columns: 1fr;
            }
        }

        .eeri-legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .eeri-legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
            flex-shrink: 0;
        }

        .eeri-legend-label {
            color: #94a3b8;
            font-size: 13px;
            flex: 1;
        }

        .eeri-legend-value {
            color: #e2e8f0;
            font-size: 13px;
            font-weight: 600;
        }

        /* Asset Stress Card */
        .eeri-asset-stress-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 16px;
            padding: 24px;
        }

        .eeri-asset-stress-header {
            margin-bottom: 20px;
        }

        .eeri-section-title {
            color: #f1f5f9;
            font-size: 16px;
            font-weight: 600;
            margin: 0 0 4px 0;
        }

        .eeri-section-subtitle {
            color: #64748b;
            font-size: 12px;
        }

        .eeri-asset-stress-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .eeri-asset-item {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            transition: all 0.2s;
        }

        .eeri-asset-item:hover {
            border-color: #475569;
        }

        .eeri-asset-name {
            color: #94a3b8;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .eeri-asset-score {
            font-size: 28px;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 6px;
        }

        .eeri-asset-status {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .eeri-asset-trend {
            font-size: 14px;
        }

        /* Drivers Card */
        .eeri-drivers-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 16px;
            padding: 24px;
        }

        .eeri-drivers-header {
            margin-bottom: 20px;
        }

        .eeri-drivers-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .eeri-driver-item {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: flex-start;
            gap: 16px;
        }

        .eeri-driver-rank {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
        }

        .eeri-driver-content {
            flex: 1;
        }

        .eeri-driver-headline {
            color: #e2e8f0;
            font-size: 14px;
            font-weight: 500;
            line-height: 1.4;
            margin-bottom: 8px;
        }

        .eeri-driver-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .eeri-driver-tag {
            font-size: 10px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .eeri-driver-tag.theme {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        .eeri-driver-tag.severity {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .eeri-driver-tag.confidence {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        .eeri-driver-tag.assets {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }

        /* History Card */
        .eeri-history-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 16px;
            padding: 24px;
        }

        .eeri-history-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 20px;
        }

        .eeri-time-controls {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .eeri-time-range-group,
        .eeri-smoothing-group {
            display: flex;
            gap: 4px;
        }

        .eeri-time-btn,
        .eeri-smooth-btn {
            background: transparent;
            border: 1px solid #334155;
            color: #64748b;
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .eeri-time-btn:hover,
        .eeri-smooth-btn:hover {
            border-color: #475569;
            color: #94a3b8;
        }

        .eeri-time-btn.active,
        .eeri-smooth-btn.active {
            background: rgba(59, 130, 246, 0.15);
            border-color: #3b82f6;
            color: #60a5fa;
        }

        .eeri-chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 16px;
        }

        .eeri-stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            padding-top: 16px;
            border-top: 1px solid #334155;
        }

        @media (max-width: 600px) {
            .eeri-stats-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .eeri-stat {
            text-align: center;
        }

        .eeri-stat-label {
            color: #64748b;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
            display: block;
        }

        .eeri-stat-value {
            color: #e2e8f0;
            font-size: 20px;
            font-weight: 700;
        }

        /* Regime Card */
        .eeri-regime-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 16px;
            padding: 24px;
        }

        .eeri-regime-header {
            margin-bottom: 20px;
        }

        .eeri-regime-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        @media (max-width: 768px) {
            .eeri-regime-content {
                grid-template-columns: 1fr;
            }
        }

        .eeri-band-distribution {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .eeri-band-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .eeri-band-label {
            width: 80px;
            color: #94a3b8;
            font-size: 12px;
            font-weight: 500;
        }

        .eeri-band-bar-container {
            flex: 1;
            height: 20px;
            background: #0f172a;
            border-radius: 10px;
            overflow: hidden;
        }

        .eeri-band-bar {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .eeri-band-percent {
            width: 50px;
            color: #e2e8f0;
            font-size: 13px;
            font-weight: 600;
            text-align: right;
        }

        .eeri-transitions-title {
            color: #94a3b8;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .eeri-transitions-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .eeri-transition-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .eeri-transition-date {
            color: #64748b;
            width: 80px;
        }

        .eeri-transition-arrow {
            color: #64748b;
        }

        /* EERI Tooltip Icon */
        .eeri-tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            font-size: 14px;
            color: #64748b;
            cursor: pointer;
            transition: color 0.2s ease;
            margin-left: 6px;
            vertical-align: middle;
        }

        .eeri-tooltip-icon:hover {
            color: #3b82f6;
        }

        /* EERI Modal */
        .eeri-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .eeri-modal-overlay.active {
            display: flex;
        }

        .eeri-modal {
            background: #1e293b;
            border-radius: 16px;
            max-width: 560px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid #334155;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .eeri-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid #334155;
        }

        .eeri-modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #f8fafc;
            margin: 0;
        }

        .eeri-modal-close {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            transition: color 0.2s ease;
        }

        .eeri-modal-close:hover {
            color: #f8fafc;
        }

        .eeri-modal-body {
            padding: 24px;
            color: #cbd5e1;
            line-height: 1.7;
        }

        .eeri-modal-body h4 {
            color: #f8fafc;
            margin: 0 0 12px 0;
            font-size: 15px;
        }

        .eeri-modal-body p {
            margin: 0 0 16px 0;
            font-size: 14px;
        }

        .eeri-modal-body p:last-child {
            margin-bottom: 0;
        }

        .eeri-modal-body ul {
            margin: 0 0 16px 0;
            padding-left: 20px;
        }

        .eeri-modal-body li {
            margin-bottom: 8px;
            font-size: 14px;
        }

        .eeri-modal-body .eeri-modal-highlight {
            background: #0f172a;
            border-radius: 8px;
            padding: 12px 16px;
            margin: 16px 0;
            border-left: 3px solid #3b82f6;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Toggle menu">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="3" y1="6" x2="21" y2="6"/>
                    <line x1="3" y1="12" x2="21" y2="12"/>
                    <line x1="3" y1="18" x2="21" y2="18"/>
                </svg>
            </button>
            <a href="/" style="text-decoration: none;">
                <span class="header-logo">EnergyRiskIQ</span>
            </a>
            <span class="header-badge" id="planBadge">Free</span>
        </div>
        <div class="header-right">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">U</div>
                <span class="user-email" id="userEmail">Loading...</span>
            </div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </header>

    <div class="sidebar-overlay" onclick="closeMobileMenu()"></div>
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-section">
            <div class="sidebar-title">Account</div>
            <a class="nav-item active" onclick="showSection('dashboard'); closeMobileMenu();">
                <span class="nav-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="9" rx="1"/>
                        <rect x="14" y="3" width="7" height="5" rx="1"/>
                        <rect x="14" y="12" width="7" height="9" rx="1"/>
                        <rect x="3" y="16" width="7" height="5" rx="1"/>
                    </svg>
                </span>
                Dashboard
            </a>
            <a class="nav-item" onclick="showSection('alerts'); closeMobileMenu();">
                <span class="nav-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                    </svg>
                </span>
                My Alerts
            </a>
            <a class="nav-item" id="geriNavItem" onclick="showSection('geri'); closeMobileMenu();">
                <span class="nav-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2v20"/>
                        <path d="M2 12h20"/>
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6l4 6-4 6-4-6 4-6z"/>
                    </svg>
                </span>
                Real-Time GERI
                <span class="pro-badge-nav" id="geriBadge">PRO</span>
            </a>
            <div class="geri-upgrade-hint" id="geriUpgradeHint" style="display: none;">
                (Upgrade your plan to Pro to access GERI)
            </div>
            <a class="nav-item" id="eeriNavItem" onclick="showSection('eeri-pro'); closeMobileMenu();">
                <span class="nav-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                    </svg>
                </span>
                EERI Pro Dashboard
                <span class="pro-badge-nav" id="eeriBadge">PRO</span>
            </a>
            <div class="eeri-upgrade-hint" id="eeriUpgradeHint" style="display: none;">
                (Upgrade to Pro for full EERI access)
            </div>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-title">Subscription</div>
            <a class="nav-item" onclick="showSection('plans'); closeMobileMenu();">
                <span class="nav-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                </span>
                Upgrade Plan
            </a>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-title">Settings</div>
            <a class="nav-item" onclick="showSection('settings'); closeMobileMenu();">
                <span class="nav-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                </span>
                Settings
            </a>
        </div>

        <div id="upgradeSidebarCard" class="upgrade-sidebar-card" style="display: none;">
            <div class="upgrade-sidebar-title">
                <span>&#9889;</span> Unlock More Alerts
            </div>
            <p class="upgrade-sidebar-text">
                Get real-time alerts, asset risk tracking, and priority notifications with an upgraded plan.
            </p>
            <button class="upgrade-sidebar-btn" onclick="showSection('plans'); closeMobileMenu();">
                View Upgrade Options
            </button>
        </div>
    </nav>

    <main class="main">
        <!-- Dashboard Section -->
        <div class="section-content active" id="section-dashboard">
            <div class="page-header">
                <h1 class="page-title">Welcome back!</h1>
                <p class="page-subtitle">Your energy risk intelligence dashboard</p>
            </div>

            <div id="upgradeBanner" class="upgrade-banner" style="display: none;">
                <div class="upgrade-content">
                    <h3>Upgrade to unlock more features</h3>
                    <p>Get real-time alerts, asset risk tracking, and more with a paid plan.</p>
                </div>
                <button class="upgrade-btn" onclick="showSection('plans')">View Plans</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Current Plan</div>
                    <div class="stat-value" id="currentPlan">Free</div>
                    <span class="stat-badge free" id="planBadgeCard">Free Tier</span>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Alerts Received</div>
                    <div class="stat-value" id="alertsCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Member Since</div>
                    <div class="stat-value" id="memberSince">--</div>
                </div>
            </div>

            <div class="content-card">
                <div class="card-header">
                    <h2 class="card-title">Recent Alerts</h2>
                </div>
                <div class="card-body" id="recentAlerts">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alerts Section -->
        <div class="section-content" id="section-alerts">
            <div class="page-header">
                <h1 class="page-title">My Alerts</h1>
                <p class="page-subtitle">View your alert history and available alert types</p>
            </div>

            <div class="content-card">
                <div class="card-header">
                    <h2 class="card-title">Your Alert Types</h2>
                </div>
                <div class="card-body">
                    <p style="color: #94a3b8; font-size: 14px; margin-bottom: 12px;">
                        Based on your current plan, you have access to the following alert types:
                    </p>
                    <div class="alert-types-grid" id="alertTypesInfo">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>
            </div>

            <div class="content-card" style="margin-top: 24px;">
                <div class="card-header">
                    <h2 class="card-title">Alert History (Last 24 Hours)</h2>
                </div>
                <div class="card-body">
                    <div class="alert-filters">
                        <div class="filter-group">
                            <span class="filter-label">From:</span>
                            <input type="date" id="filterFromDate" class="filter-input">
                            <input type="time" id="filterFromTime" class="filter-input" style="width: 100px;">
                        </div>
                        <div class="filter-group">
                            <span class="filter-label">To:</span>
                            <input type="date" id="filterToDate" class="filter-input">
                            <input type="time" id="filterToTime" class="filter-input" style="width: 100px;">
                        </div>
                        <div class="filter-divider"></div>
                        <div class="filter-group">
                            <span class="filter-label">Region:</span>
                            <select id="filterRegion" class="filter-input" style="min-width: 120px;">
                                <option value="">All Regions</option>
                                <option value="europe">Europe</option>
                                <option value="north_america">North America</option>
                                <option value="asia">Asia</option>
                                <option value="middle_east">Middle East</option>
                                <option value="global">Global</option>
                            </select>
                        </div>
                        <div class="filter-divider"></div>
                        <div class="filter-toggle-group">
                            <button type="button" class="filter-toggle active" id="filterOil" onclick="toggleFilter('Oil')">Oil</button>
                            <button type="button" class="filter-toggle active" id="filterGas" onclick="toggleFilter('Gas')">Gas</button>
                            <button type="button" class="filter-toggle active" id="filterFX" onclick="toggleFilter('FX')">FX</button>
                        </div>
                        <div class="filter-divider"></div>
                        <button class="filter-btn" onclick="applyFilters()">Apply</button>
                        <button class="filter-btn secondary" onclick="resetFilters()">Reset</button>
                    </div>
                    <div id="allAlerts">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="content-card" style="margin-top: 24px; display: none;" id="lockedSamplesSection">
            </div>
        </div>

        <!-- Plans Section -->
        <div class="section-content" id="section-plans">
            <div class="page-header">
                <h1 class="page-title">Upgrade Your Plan</h1>
                <p class="page-subtitle">Choose the plan that fits your needs</p>
            </div>

            <div class="plans-grid" id="plansGrid">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- GERI Section (Pro Only) -->
        <div class="section-content" id="section-geri">
            <div class="page-header">
                <h1 class="page-title">Real-Time GERI</h1>
                <p class="page-subtitle">Global Energy Risk Index - Real-time data for Pro subscribers</p>
                <a href="/geri/methodology" target="_blank" class="geri-methodology-header-link">📖 View GERI Methodology & Construction</a>
            </div>

            <div id="geriContent">
                <div class="geri-display-card">
                    <div class="geri-loading">
                        <div class="spinner"></div>
                        <p>Loading GERI data...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- EERI Pro Section -->
        <div class="section-content" id="section-eeri-pro">
            <div class="page-header">
                <h1 class="page-title">EERI Pro Dashboard</h1>
                <p class="page-subtitle">European Energy Risk Index - Real-time intelligence for Pro subscribers</p>
                <div class="eeri-header-links">
                    <a href="/eeri/methodology" target="_blank" class="eeri-methodology-header-link">📖 View EERI Methodology</a>
                    <a href="javascript:void(0)" onclick="openEeriModal('behavioral')" class="eeri-methodology-header-link">🧠 Conceptual, Behavioral Interpretation</a>
                </div>
            </div>

            <div id="eeriProContent">
                <!-- Loading State -->
                <div class="eeri-pro-loading" id="eeriProLoading">
                    <div class="spinner"></div>
                    <p>Loading EERI Pro data...</p>
                </div>

                <!-- Locked State for non-Pro users -->
                <div class="eeri-pro-locked" id="eeriProLocked" style="display: none;">
                    <div class="eeri-locked-card">
                        <div class="eeri-locked-icon">⚡</div>
                        <h2>EERI Pro Dashboard</h2>
                        <p>Unlock real-time European energy risk intelligence with component transparency, asset stress analysis, and historical intelligence.</p>
                        <ul class="eeri-locked-features">
                            <li>Real-time EERI with component breakdown</li>
                            <li>Asset Stress Panel across all energy classes</li>
                            <li>Full Top Drivers with severity & confidence</li>
                            <li>Historical charts with advanced time controls</li>
                            <li>Daily AI-generated intelligence summary</li>
                        </ul>
                        <button class="eeri-upgrade-btn" onclick="showSection('plans')">Upgrade to Pro</button>
                    </div>
                </div>

                <!-- Pro Dashboard Content -->
                <div class="eeri-pro-dashboard" id="eeriProDashboard" style="display: none;">

                    <!-- Main Index Display Row -->
                    <div class="eeri-main-row">
                        <!-- EERI Value Card -->
                        <div class="eeri-value-card">
                            <div class="eeri-value-header">
                                <span class="eeri-value-label">EERI</span>
                                <span class="eeri-realtime-badge">REAL-TIME</span>
                            </div>
                            <div class="eeri-value-display">
                                <span class="eeri-value-number" id="eeriValue">--</span>
                                <span class="eeri-value-band" id="eeriBandLabel">--</span>
                            </div>
                            <div class="eeri-value-trend">
                                <span class="eeri-trend-icon" id="eeriTrendIcon">→</span>
                                <span class="eeri-trend-text" id="eeriTrendText">Stable</span>
                            </div>
                            <div class="eeri-computed-at" id="eeriComputedAt">--</div>
                        </div>

                        <!-- Component Breakdown Card -->
                        <div class="eeri-components-card">
                            <div class="eeri-components-header">
                                <span class="eeri-components-title">Component Breakdown <span class="eeri-tooltip-icon" onclick="openEeriModal('components')">ⓘ</span></span>
                                <span class="eeri-components-hint">Contribution to today's EERI</span>
                            </div>
                            <div class="eeri-components-chart" id="eeriComponentsChart">
                                <!-- Component bars rendered by JS -->
                            </div>
                            <div class="eeri-components-legend" id="eeriComponentsLegend">
                                <!-- Legend items rendered by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Asset Stress Panel -->
                    <div class="eeri-asset-stress-card">
                        <div class="eeri-asset-stress-header">
                            <h3 class="eeri-section-title">Asset Stress Panel <span class="eeri-tooltip-icon" onclick="openEeriModal('assetStress')">ⓘ</span></h3>
                            <span class="eeri-section-subtitle">Current stress levels across energy asset classes</span>
                        </div>
                        <div class="eeri-asset-stress-grid" id="eeriAssetStressGrid">
                            <!-- Asset stress items rendered by JS -->
                        </div>
                    </div>

                    <!-- Top Drivers Section -->
                    <div class="eeri-drivers-card">
                        <div class="eeri-drivers-header">
                            <h3 class="eeri-section-title">Top Risk Drivers</h3>
                            <span class="eeri-section-subtitle">Key factors driving today's EERI level</span>
                        </div>
                        <div class="eeri-drivers-list" id="eeriDriversList">
                            <!-- Driver items rendered by JS -->
                        </div>
                    </div>

                    <!-- Historical Intelligence Section -->
                    <div class="eeri-history-card">
                        <div class="eeri-history-header">
                            <h3 class="eeri-section-title">Historical Intelligence <span class="eeri-tooltip-icon" onclick="openEeriModal('history')">ⓘ</span></h3>
                            <div class="eeri-time-controls">
                                <div class="eeri-time-range-group">
                                    <button class="eeri-time-btn active" data-days="7">7D</button>
                                    <button class="eeri-time-btn" data-days="30">30D</button>
                                    <button class="eeri-time-btn" data-days="90">90D</button>
                                    <button class="eeri-time-btn" data-days="365">All</button>
                                </div>
                                <div class="eeri-smoothing-group">
                                    <button class="eeri-smooth-btn active" data-smooth="raw">Raw</button>
                                    <button class="eeri-smooth-btn" data-smooth="ma3">3D MA</button>
                                    <button class="eeri-smooth-btn" data-smooth="ma7">7D MA</button>
                                </div>
                            </div>
                        </div>
                        <div class="eeri-chart-container">
                            <canvas id="eeriHistoryChart" height="300"></canvas>
                        </div>
                        <div class="eeri-stats-row" id="eeriStatsRow">
                            <div class="eeri-stat">
                                <span class="eeri-stat-label">Period Avg</span>
                                <span class="eeri-stat-value" id="eeriStatAvg">--</span>
                            </div>
                            <div class="eeri-stat">
                                <span class="eeri-stat-label">Max</span>
                                <span class="eeri-stat-value" id="eeriStatMax">--</span>
                            </div>
                            <div class="eeri-stat">
                                <span class="eeri-stat-label">Min</span>
                                <span class="eeri-stat-value" id="eeriStatMin">--</span>
                            </div>
                            <div class="eeri-stat">
                                <span class="eeri-stat-label">Volatility</span>
                                <span class="eeri-stat-value" id="eeriStatVol">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- Regime Statistics -->
                    <div class="eeri-regime-card">
                        <div class="eeri-regime-header">
                            <h3 class="eeri-section-title">Regime Statistics <span class="eeri-tooltip-icon" onclick="openEeriModal('regime')">ⓘ</span></h3>
                            <span class="eeri-section-subtitle">Risk band distribution (last 90 days)</span>
                        </div>
                        <div class="eeri-regime-content">
                            <div class="eeri-band-distribution" id="eeriBandDistribution">
                                <!-- Band distribution bars rendered by JS -->
                            </div>
                            <div class="eeri-transitions" id="eeriTransitions">
                                <h4 class="eeri-transitions-title">Recent Regime Transitions</h4>
                                <div class="eeri-transitions-list" id="eeriTransitionsList">
                                    <!-- Transitions rendered by JS -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Daily Intelligence Summary Card (moved to bottom) -->
                    <div class="eeri-summary-card" id="eeriDailySummary">
                        <div class="eeri-summary-header">
                            <div class="eeri-summary-label">Daily Intelligence Summary</div>
                            <div class="eeri-summary-date" id="eeriSummaryDate">--</div>
                        </div>
                        <div class="eeri-summary-text" id="eeriSummaryText">
                            Loading intelligence summary...
                        </div>
                        <div class="eeri-summary-meta">
                            <span class="eeri-summary-drivers" id="eeriSummaryDrivers"></span>
                        </div>
                    </div>

                </div>

                <!-- EERI Tooltip Modal -->
                <div class="eeri-modal-overlay" id="eeriModalOverlay" onclick="closeEeriModal()">
                    <div class="eeri-modal" onclick="event.stopPropagation()">
                        <div class="eeri-modal-header">
                            <h3 class="eeri-modal-title" id="eeriModalTitle">Information</h3>
                            <button class="eeri-modal-close" onclick="closeEeriModal()">&times;</button>
                        </div>
                        <div class="eeri-modal-body" id="eeriModalBody">
                            <!-- Modal content rendered by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div class="section-content" id="section-settings">
            <div class="page-header">
                <h1 class="page-title">Settings</h1>
                <p class="page-subtitle">Manage your account settings</p>
            </div>

            <div class="content-card">
                <div class="card-header">
                    <h2 class="card-title">Account Information</h2>
                </div>
                <div class="card-body" id="accountInfo">
                    <div class="info-row">
                        <span class="info-label">Email</span>
                        <span class="info-value" id="settingsEmail">--</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Plan</span>
                        <span class="info-value" id="settingsPlan">--</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Account Created</span>
                        <span class="info-value" id="settingsCreated">--</span>
                    </div>
                </div>
            </div>

            <div class="content-card" style="margin-top: 24px;">
                <div class="card-header">
                    <h2 class="card-title">Telegram Notifications</h2>
                </div>
                <div class="card-body">
                    <div id="telegramNotAvailable" style="display: none;">
                        <p style="color: #94a3b8; font-size: 14px; margin-bottom: 16px;">
                            Telegram notifications are available on Trader, Pro, and Enterprise plans.
                        </p>
                        <a href="#" onclick="showSection('plans')" class="filter-btn" style="text-decoration: none; display: inline-block;">
                            Upgrade to Enable
                        </a>
                    </div>
                    
                    <div id="telegramLinked" style="display: none;">
                        <div class="info-row">
                            <span class="info-label">Status</span>
                            <span class="info-value" style="color: #4ade80;">
                                <span style="display: inline-block; width: 8px; height: 8px; background: #4ade80; border-radius: 50%; margin-right: 8px;"></span>
                                Connected
                            </span>
                        </div>
                        <div style="margin-top: 16px;">
                            <button class="filter-btn secondary" onclick="unlinkTelegram()">
                                Unlink Telegram
                            </button>
                        </div>
                    </div>
                    
                    <div id="telegramNotLinked" style="display: none;">
                        <p style="color: #94a3b8; font-size: 14px; margin-bottom: 16px;">
                            Link your Telegram account to receive instant alerts on your phone.
                        </p>
                        
                        <div id="telegramLinkStep1">
                            <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px;">
                                <button class="filter-btn" onclick="generateTelegramCode()">
                                    Connect via Telegram
                                </button>
                                <button class="filter-btn secondary" onclick="showManualChatIdEntry()">
                                    Enter Chat ID Manually
                                </button>
                            </div>
                        </div>
                        
                        <div id="telegramLinkStep2" style="display: none;">
                            <div style="background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                                <p style="color: #94a3b8; font-size: 13px; margin-bottom: 12px;">Click the button below to open Telegram and connect:</p>
                                
                                <a id="telegramDeepLink" href="#" target="_blank" style="display: inline-block; background: #0088cc; color: white; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600; margin-bottom: 16px;">
                                    Open @energyriskiq_bot in Telegram
                                </a>
                                
                                <p style="color: #64748b; font-size: 12px; margin-top: 8px;">
                                    Or search for <span style="color: #60a5fa; font-weight: 600;">@<span id="telegramBotUsername">energyriskiq_bot</span></span> and send this code:
                                </p>
                                <div style="background: #0f172a; border: 2px dashed #3b82f6; border-radius: 8px; padding: 16px; text-align: center; margin-top: 12px;">
                                    <span id="telegramLinkCode" style="font-size: 28px; font-weight: 700; letter-spacing: 4px; color: #f1f5f9;">--------</span>
                                </div>
                                <p style="color: #64748b; font-size: 12px; margin-top: 12px; text-align: center;">
                                    Code expires in <span id="telegramCodeExpiry">15</span> minutes
                                </p>
                            </div>
                            
                            <button class="filter-btn secondary" onclick="cancelTelegramLink()">
                                Cancel
                            </button>
                        </div>
                        
                        <div id="telegramManualEntry" style="display: none;">
                            <div style="background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                                <p style="color: #94a3b8; font-size: 13px; margin-bottom: 12px;">Enter your Telegram Chat ID:</p>
                                <p style="color: #64748b; font-size: 12px; margin-bottom: 16px;">
                                    To find your Chat ID, message <span style="color: #60a5fa;">@energyriskiq_bot</span> with <span style="color: #f1f5f9; font-family: monospace;">/start</span> - it will show your Chat ID.
                                </p>
                                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                    <input type="text" id="manualChatIdInput" placeholder="e.g., 123456789" style="flex: 1; min-width: 150px; padding: 12px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: #f1f5f9; font-size: 16px;">
                                    <button class="filter-btn" onclick="linkManualChatId()">Link</button>
                                </div>
                            </div>
                            <button class="filter-btn secondary" onclick="cancelManualEntry()">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alert Settings Section -->
            <div class="content-card" style="margin-top: 24px;">
                <div class="card-header">
                    <h2 class="card-title">Alert Preferences</h2>
                </div>
                <div class="card-body">
                    <p style="color: #94a3b8; font-size: 14px; margin-bottom: 16px;">
                        Configure which alerts you want to receive based on your plan.
                    </p>
                    
                    <div id="alertSettingsInfo" style="margin-bottom: 20px;">
                        <div style="display: flex; gap: 24px; flex-wrap: wrap; margin-bottom: 16px;">
                            <div>
                                <span style="color: #64748b; font-size: 13px;">Plan:</span>
                                <span id="settingsPlanBadge" class="stat-badge" style="margin-left: 8px;">--</span>
                            </div>
                            <div>
                                <span style="color: #64748b; font-size: 13px;">Regions Used:</span>
                                <span id="settingsRegionCount" style="color: #f1f5f9; font-weight: 600; margin-left: 8px;">0 / 1</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Add New Setting Form -->
                    <div style="background: #0f172a; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                        <h3 style="font-size: 15px; font-weight: 600; color: #f1f5f9; margin-bottom: 16px;">Add Alert Setting</h3>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end;">
                            <div style="flex: 1; min-width: 180px;">
                                <label style="display: block; font-size: 13px; color: #94a3b8; margin-bottom: 6px;">Alert Type</label>
                                <select id="newAlertType" class="filter-input" style="width: 100%;">
                                    <option value="">Select alert type...</option>
                                </select>
                            </div>
                            <div style="flex: 1; min-width: 180px;">
                                <label style="display: block; font-size: 13px; color: #94a3b8; margin-bottom: 6px;">Region</label>
                                <select id="newAlertRegion" class="filter-input" style="width: 100%;">
                                    <option value="">Select region...</option>
                                </select>
                            </div>
                            <button class="filter-btn" onclick="addAlertSetting()" style="height: 38px;">
                                Add Setting
                            </button>
                        </div>
                        <p id="addSettingError" style="color: #f87171; font-size: 13px; margin-top: 12px; display: none;"></p>
                    </div>
                    
                    <!-- Current Settings List -->
                    <div>
                        <h3 style="font-size: 15px; font-weight: 600; color: #f1f5f9; margin-bottom: 16px;">Your Active Settings</h3>
                        <div id="currentSettingsList">
                            <div class="loading"><div class="spinner"></div></div>
                        </div>
                        <div id="noSettingsMessage" style="display: none; text-align: center; padding: 32px; color: #64748b;">
                            <p style="font-size: 14px;">No alert settings configured yet.</p>
                            <p style="font-size: 13px; margin-top: 8px;">Add a setting above to start receiving alerts.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let sessionToken = null;
        let currentUser = null;
        let allAlerts = [];
        let userSettings = null;

        // Mobile Menu Functions
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        }

        function closeMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
        }

        function checkSession() {
            try {
                const session = localStorage.getItem('userSession');
                if (!session) {
                    window.location.href = '/users';
                    return false;
                }

                const data = JSON.parse(session);
                if (!data || !data.token || !data.expires) {
                    localStorage.removeItem('userSession');
                    window.location.href = '/users';
                    return false;
                }
                
                if (data.expires < Date.now()) {
                    localStorage.removeItem('userSession');
                    window.location.href = '/users';
                    return false;
                }

                sessionToken = data.token;
                return true;
            } catch (error) {
                console.error('Session check error:', error);
                localStorage.removeItem('userSession');
                window.location.href = '/users';
                return false;
            }
        }

        async function loadDashboard() {
            console.log('loadDashboard started, sessionToken:', sessionToken ? 'present' : 'missing');
            const controller = new AbortController();
            const timeout = setTimeout(() => {
                console.log('Dashboard request timed out after 15s');
                controller.abort();
            }, 15000);
            
            try {
                const startTime = performance.now();
                console.log('Making API calls...');
                
                const [dashboardResponse, plansResponse] = await Promise.all([
                    fetch('/users/dashboard?alerts_limit=100', {
                        headers: { 'X-User-Token': sessionToken },
                        signal: controller.signal
                    }),
                    fetch('/billing/plans', { signal: controller.signal })
                ]);
                
                clearTimeout(timeout);
                console.log('API responses received:', dashboardResponse.status, plansResponse.status);

                if (!dashboardResponse.ok) {
                    if (dashboardResponse.status === 401) {
                        localStorage.removeItem('userSession');
                        window.location.href = '/users';
                        return;
                    }
                    throw new Error('Failed to load dashboard');
                }

                const dashboard = await dashboardResponse.json();
                
                currentUser = dashboard.user;
                allAlerts = dashboard.alerts.items || [];
                userSettings = dashboard.settings;
                allowedAlertTypes = dashboard.alerts.allowed_types || [];
                
                updateUI();
                initializeFilters();
                renderAlerts(allAlerts, allowedAlertTypes);
                renderAllowedAlertTypes(allowedAlertTypes, dashboard.alerts.locked_types || []);
                renderLockedSamples(dashboard.alerts.locked_samples || []);
                renderSettingsFromDashboard(dashboard.settings);
                
                if (plansResponse.ok) {
                    const plansData = await plansResponse.json();
                    renderPlans(plansData.plans || []);
                }
                
                console.log(`Dashboard loaded in ${(performance.now() - startTime).toFixed(0)}ms`);
            } catch (error) {
                clearTimeout(timeout);
                console.error('Error loading dashboard:', error);
                
                const errorMessage = error.name === 'AbortError' 
                    ? 'Request timed out. Please check your connection and refresh the page.'
                    : 'Failed to load alerts. Please refresh the page or try again later.';
                
                document.getElementById('recentAlerts').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">&#9888;</div>
                        <p>${errorMessage}</p>
                    </div>
                `;
                document.getElementById('allAlerts').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">&#9888;</div>
                        <p>${errorMessage}</p>
                    </div>
                `;
            }
        }

        async function loadUserData() {
            try {
                const response = await fetch('/users/me', {
                    headers: { 'X-User-Token': sessionToken }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('userSession');
                        window.location.href = '/users';
                        return;
                    }
                    throw new Error('Failed to load user');
                }

                currentUser = await response.json();
                updateUI();
                loadAlerts();
            } catch (error) {
                console.error('Error loading user:', error);
            }
        }

        function updateUI() {
            if (!currentUser) return;

            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('userAvatar').textContent = currentUser.email.charAt(0).toUpperCase();

            const plan = currentUser.plan || 'free';
            const planDisplay = plan.charAt(0).toUpperCase() + plan.slice(1);

            document.getElementById('planBadge').textContent = planDisplay;
            document.getElementById('planBadge').className = 'header-badge';

            document.getElementById('currentPlan').textContent = planDisplay;
            document.getElementById('planBadgeCard').textContent = planDisplay + ' Tier';
            document.getElementById('planBadgeCard').className = 'stat-badge ' + plan;

            if (currentUser.created_at) {
                const date = new Date(currentUser.created_at);
                document.getElementById('memberSince').textContent = date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    year: 'numeric' 
                });
                document.getElementById('settingsCreated').textContent = date.toLocaleDateString();
            }

            document.getElementById('settingsEmail').textContent = currentUser.email;
            document.getElementById('settingsPlan').textContent = planDisplay;

            if (plan === 'free') {
                document.getElementById('upgradeBanner').style.display = 'flex';
            }
            
            if (plan !== 'enterprise') {
                document.getElementById('upgradeSidebarCard').style.display = 'block';
            }
            
            updateTelegramUI();
        }

        function updateTelegramUI() {
            if (!currentUser) return;
            
            const plan = currentUser.plan || 'free';
            const telegramEnabled = ['trader', 'pro', 'enterprise'].includes(plan);
            const isLinked = !!currentUser.telegram_chat_id;
            
            document.getElementById('telegramNotAvailable').style.display = telegramEnabled ? 'none' : 'block';
            document.getElementById('telegramLinked').style.display = (telegramEnabled && isLinked) ? 'block' : 'none';
            document.getElementById('telegramNotLinked').style.display = (telegramEnabled && !isLinked) ? 'block' : 'none';
            
            // Show GERI nav item for all users, but disable for non-Pro/Enterprise
            const geriEnabled = ['pro', 'enterprise'].includes(plan);
            const geriNavItem = document.getElementById('geriNavItem');
            const geriBadge = document.getElementById('geriBadge');
            const geriUpgradeHint = document.getElementById('geriUpgradeHint');
            
            if (geriNavItem) {
                if (geriEnabled) {
                    geriNavItem.classList.remove('nav-item-disabled');
                    geriNavItem.onclick = function() { showSection('geri'); closeMobileMenu(); };
                    if (geriBadge) {
                        geriBadge.textContent = 'PRO';
                        geriBadge.classList.remove('pro-badge-locked');
                    }
                    if (geriUpgradeHint) geriUpgradeHint.style.display = 'none';
                } else {
                    geriNavItem.classList.add('nav-item-disabled');
                    geriNavItem.onclick = function(e) { e.preventDefault(); };
                    if (geriBadge) {
                        geriBadge.textContent = 'Pro+ Users';
                        geriBadge.classList.add('pro-badge-locked');
                    }
                    if (geriUpgradeHint) geriUpgradeHint.style.display = 'block';
                }
            }
            
            // Show EERI Pro nav item for all users, but handle based on plan
            const eeriNavItem = document.getElementById('eeriNavItem');
            const eeriBadge = document.getElementById('eeriBadge');
            const eeriUpgradeHint = document.getElementById('eeriUpgradeHint');
            
            if (eeriNavItem) {
                if (geriEnabled) {
                    eeriNavItem.classList.remove('nav-item-disabled');
                    eeriNavItem.onclick = function() { showSection('eeri-pro'); closeMobileMenu(); };
                    if (eeriBadge) {
                        eeriBadge.textContent = 'PRO';
                        eeriBadge.classList.remove('pro-badge-locked');
                    }
                    if (eeriUpgradeHint) eeriUpgradeHint.style.display = 'none';
                } else {
                    eeriNavItem.classList.add('nav-item-disabled');
                    eeriNavItem.onclick = function(e) { e.preventDefault(); };
                    if (eeriBadge) {
                        eeriBadge.textContent = 'Pro+ Users';
                        eeriBadge.classList.add('pro-badge-locked');
                    }
                    if (eeriUpgradeHint) eeriUpgradeHint.style.display = 'block';
                }
            }
        }

        async function loadGeriData() {
            const plan = currentUser?.plan || 'free';
            const geriEnabled = ['pro', 'enterprise'].includes(plan);
            
            const contentDiv = document.getElementById('geriContent');
            if (!contentDiv) return;
            
            if (!geriEnabled) {
                contentDiv.innerHTML = `
                    <div class="geri-upgrade-required">
                        <h3>🔒 Pro Feature</h3>
                        <p>Real-time GERI access is available exclusively for Pro and Enterprise subscribers.</p>
                        <button class="geri-upgrade-btn" onclick="showSection('plans')">Upgrade to Pro</button>
                    </div>
                `;
                return;
            }
            
            try {
                const response = await fetch('/api/v1/indices/geri/latest', {
                    headers: { 'X-User-Token': sessionToken }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch GERI data');
                }
                
                const result = await response.json();
                
                if (!result.success || !result.data) {
                    contentDiv.innerHTML = `
                        <div class="geri-display-card">
                            <p style="color: #9ca3af;">No GERI data available yet.</p>
                        </div>
                    `;
                    return;
                }
                
                const geri = result.data;
                const bandColors = {
                    'LOW': '#22c55e',
                    'MODERATE': '#eab308',
                    'ELEVATED': '#f97316',
                    'CRITICAL': '#ef4444'
                };
                const bandColor = bandColors[geri.band] || '#6b7280';
                
                // Expressive trend labels matching homepage
                let trendLabel = 'Stable';
                const trendVal = geri.trend_7d || 0;
                if (trendVal >= 10) trendLabel = 'Rising Sharply';
                else if (trendVal >= 3) trendLabel = 'Rising';
                else if (trendVal > 0) trendLabel = 'Slightly Rising';
                else if (trendVal <= -10) trendLabel = 'Falling Sharply';
                else if (trendVal <= -3) trendLabel = 'Falling';
                else if (trendVal < 0) trendLabel = 'Slightly Falling';
                
                const trendSign = trendVal > 0 ? '+' : '';
                const trendDisplay = `<div class="geri-trend-display" style="color: #4ade80;">7-Day Trend: ${trendLabel} (${trendSign}${trendVal.toFixed(0)})</div>`;
                
                const components = geri.components || {};
                const topDrivers = components.top_drivers || [];
                const topRegions = components.top_regions || [];
                const interpretation = components.interpretation || '';
                
                // Drivers with region · category tags
                const driversHtml = topDrivers.slice(0, 5).map(d => {
                    const tagParts = [];
                    if (d.region) tagParts.push(d.region);
                    if (d.category) tagParts.push(d.category);
                    const tagText = tagParts.length > 0 ? ` <span style="color: #9ca3af; font-size: 0.85rem;">(${tagParts.join(' · ')})</span>` : '';
                    return `<li>${d.headline || d.type || 'Unknown'}${tagText}</li>`;
                }).join('') || '<li>No data</li>';
                
                // Regions with Primary/Secondary/Tertiary labels
                const regionLabels = ['Primary', 'Secondary', 'Tertiary', 'Quaternary', 'Quinary'];
                const regionsHtml = topRegions.slice(0, 5).map((r, i) => {
                    const label = regionLabels[i] || '';
                    return `<li>${r.region || 'Unknown'} <span style="color: #9ca3af; font-size: 0.85rem;">(${label})</span></li>`;
                }).join('') || '<li>No data</li>';
                
                // Interpretation section - 15 word preview + "See more..." link
                const interpretationWords = interpretation ? interpretation.split(/\s+/) : [];
                const interpretationPreview = interpretationWords.slice(0, 15).join(' ');
                const hasMoreInterpretation = interpretationWords.length > 15;
                const interpretationHtml = interpretation ? 
                    '<div class="geri-interpretation-preview">' +
                        '<div class="geri-interpretation-title">GERI Interpretation</div>' +
                        '<p class="geri-interpretation-text">"' + interpretationPreview + (hasMoreInterpretation ? '..."' : '"') + '</p>' +
                        (hasMoreInterpretation ? '<a class="geri-see-more-link" onclick="openInterpretationModal()">See more...</a>' : '') +
                    '</div>' : '';
                
                // Store full interpretation for modal
                window.fullGeriInterpretation = interpretation || '';
                
                // Format computed_at date as YYYY-MM-DD
                const computedAt = geri.computed_at ? geri.computed_at.substring(0, 10) : geri.date || 'N/A';
                
                contentDiv.innerHTML = 
                    // 1) GERI Card
                    '<div class="geri-display-card">' +
                        '<div class="geri-realtime-badge">⚡ Real-Time</div>' +
                        '<div class="geri-header-row" style="display: flex; align-items: center; gap: 12px; justify-content: center; margin-bottom: 8px;">' +
                            '<span style="font-size: 2rem;">🔥</span>' +
                            '<span style="font-size: 1.25rem; font-weight: 600; color: #e2e8f0;">Global Energy Risk Index:</span>' +
                        '</div>' +
                        '<div class="geri-value-line" style="font-size: 1.5rem; font-weight: bold; color: ' + bandColor + '; margin-bottom: 8px;">' + (geri.value || '--') + ' / 100 (' + (geri.band || 'N/A') + ')</div>' +
                        '<div class="geri-scale-ref" style="font-size: 0.75rem; color: #9ca3af; margin-bottom: 12px;">0 = minimal risk · 100 = extreme systemic stress</div>' +
                        trendDisplay +
                        '<div class="geri-date-display" style="margin-top: 8px;">Date Computed: ' + computedAt + '</div>' +
                    '</div>' +
                    
                    // 2) GERI Charts Section
                    '<div class="geri-charts-section">' +
                        '<div class="geri-charts-header">' +
                            '<h3 class="geri-charts-title">GERI History <span>(since Jan 2026)</span></h3>' +
                            '<div class="geri-chart-controls">' +
                                '<button class="chart-range-btn active" data-range="all">Since Launch</button>' +
                                '<button class="chart-range-btn" data-range="90" disabled>' +
                                    '90 Days' +
                                    '<span class="tooltip-hint">Available as history grows</span>' +
                                '</button>' +
                                '<button class="chart-range-btn" data-range="365" disabled>' +
                                    '1 Year' +
                                    '<span class="tooltip-hint">Available as history grows</span>' +
                                '</button>' +
                            '</div>' +
                        '</div>' +
                        '<div class="geri-trend-indicators">' +
                            '<div class="trend-indicator-card">' +
                                '<div class="trend-indicator-label">1-Day Change</div>' +
                                '<div class="trend-indicator-value" id="trend1d">--</div>' +
                                '<div class="trend-indicator-subtext">vs yesterday</div>' +
                            '</div>' +
                            '<div class="trend-indicator-card">' +
                                '<div class="trend-indicator-label">7-Day Change</div>' +
                                '<div class="trend-indicator-value" id="trend7d">--</div>' +
                                '<div class="trend-indicator-subtext">vs 7-day avg</div>' +
                            '</div>' +
                            '<div class="trend-indicator-card">' +
                                '<div class="trend-indicator-label">Momentum</div>' +
                                '<div class="trend-indicator-value" id="trendMomentum">--</div>' +
                                '<div class="trend-indicator-subtext">slope direction</div>' +
                            '</div>' +
                            '<div class="trend-indicator-card">' +
                                '<div class="trend-indicator-label">Current Band</div>' +
                                '<div class="trend-indicator-value" id="currentBand">--</div>' +
                                '<div class="trend-indicator-subtext" id="currentBandValue">--/100</div>' +
                            '</div>' +
                        '</div>' +
                        '<div class="market-overlay-toggles">' +
                            '<button class="overlay-toggle" data-overlay="brent" style="--overlay-color: #f59e0b;">' +
                                '<span class="dot"></span> Brent Oil (USD/barrel)' +
                            '</button>' +
                            '<button class="overlay-toggle" data-overlay="gas_storage" style="--overlay-color: #10b981;">' +
                                '<span class="dot"></span> EU Gas Storage (%)' +
                            '</button>' +
                        '</div>' +
                        '<div class="geri-chart-card">' +
                            '<div class="geri-chart-container">' +
                                '<canvas id="geriHistoryChart"></canvas>' +
                            '</div>' +
                            '<p class="chart-zoom-hint">💡 Pinch/scroll to zoom • Double-click to reset</p>' +
                        '</div>' +
                    '</div>' +
                    
                    // 3) Primary Risk Drivers
                    '<div class="geri-detail-card" style="margin-top: 24px;">' +
                        '<div class="geri-detail-title" style="color: #60a5fa;">Primary Risk Drivers:</div>' +
                        '<ul class="geri-detail-list">' + driversHtml + '</ul>' +
                    '</div>' +
                    
                    // 4) Top Regions Under Pressure
                    '<div class="geri-detail-card" style="margin-top: 16px;">' +
                        '<div class="geri-detail-title" style="color: #60a5fa;">Top Regions Under Pressure:</div>' +
                        '<ul class="geri-detail-list">' + regionsHtml + '</ul>' +
                    '</div>' +
                    
                    // 5) Interpretation (last)
                    interpretationHtml;
                
                // Load chart data
                loadGeriChartData(geri);
                
            } catch (error) {
                console.error('Error loading GERI:', error);
                contentDiv.innerHTML = '<div class="geri-display-card"><p style="color: #ef4444;">Error loading GERI data. Please try again later.</p></div>';
            }
        }
        
        // Chart instance reference
        let geriChart = null;
        let geriHistoryData = [];
        let currentRangeFilter = 'all'; // Track current range
        let marketOverlays = {
            brent: { active: false, data: [], rawData: [], unit: 'USD/barrel' },
            gas_storage: { active: false, data: [], rawData: [], unit: '%' }
        };
        let overlayDataLoaded = false;
        
        // Fetch real market data from API
        async function loadMarketOverlayData() {
            if (overlayDataLoaded) return;
            
            try {
                const response = await fetch('/api/v1/indices/geri/market-overlays?from=2026-01-01', {
                    headers: { 'X-User-Token': sessionToken }
                });
                
                if (!response.ok) {
                    console.warn('Failed to fetch market overlay data');
                    return;
                }
                
                const result = await response.json();
                
                if (result.overlays?.brent?.data) {
                    marketOverlays.brent.rawData = result.overlays.brent.data;
                    marketOverlays.brent.unit = result.overlays.brent.unit;
                    alignOverlayWithGeri('brent');
                }
                
                if (result.overlays?.gas_storage?.data) {
                    marketOverlays.gas_storage.rawData = result.overlays.gas_storage.data;
                    marketOverlays.gas_storage.unit = result.overlays.gas_storage.unit;
                    alignOverlayWithGeri('gas_storage');
                }
                
                overlayDataLoaded = true;
                console.log('Market overlay data loaded:', {
                    brent: marketOverlays.brent.data.length,
                    gas_storage: marketOverlays.gas_storage.data.length
                });
            } catch (error) {
                console.error('Error loading market overlay data:', error);
            }
        }
        
        // Align overlay data with GERI dates (for chart synchronization)
        function alignOverlayWithGeri(key) {
            const overlay = marketOverlays[key];
            const rawData = overlay.rawData;
            
            // Create a map of date -> value for quick lookup
            const dateMap = {};
            rawData.forEach(d => {
                dateMap[d.date] = d.value;
            });
            
            // Map to GERI dates
            overlay.data = geriHistoryData.map(geriPoint => {
                const val = dateMap[geriPoint.date];
                return val !== undefined ? val : null;
            });
        }
        
        // Get overlay data sliced to current range
        function getSlicedOverlayData(key) {
            const fullData = marketOverlays[key].data;
            if (currentRangeFilter === 'all' || !fullData.length) {
                return fullData;
            }
            const rangeNum = parseInt(currentRangeFilter);
            return fullData.slice(-rangeNum);
        }
        
        async function loadGeriChartData(currentGeri) {
            try {
                // Fetch all GERI history from launch (Jan 2026)
                const response = await fetch('/api/v1/indices/geri?from=2026-01-01', {
                    headers: { 'X-User-Token': sessionToken }
                });
                
                if (!response.ok) throw new Error('Failed to fetch GERI history');
                
                const result = await response.json();
                geriHistoryData = result.data || [];
                
                // Fetch real market overlay data from API
                await loadMarketOverlayData();
                
                // Update trend indicators
                updateTrendIndicators(currentGeri, geriHistoryData);
                
                // Initialize chart
                initializeGeriChart();
                
                // Setup range buttons (enable when we have enough data)
                setupRangeButtons();
                
                // Setup overlay toggles
                setupOverlayToggles();
                
            } catch (error) {
                console.error('Error loading GERI chart data:', error);
            }
        }
        
        function updateTrendIndicators(currentGeri, historyData) {
            const trend1dEl = document.getElementById('trend1d');
            const trend7dEl = document.getElementById('trend7d');
            const momentumEl = document.getElementById('trendMomentum');
            const currentBandEl = document.getElementById('currentBand');
            const currentBandValueEl = document.getElementById('currentBandValue');
            
            // Current band
            if (currentBandEl && currentGeri) {
                const bandColor = currentGeri.band === 'CRITICAL' ? '#ef4444' :
                                  currentGeri.band === 'ELEVATED' ? '#f97316' :
                                  currentGeri.band === 'MODERATE' ? '#eab308' : '#22c55e';
                currentBandEl.textContent = currentGeri.band || '--';
                currentBandEl.style.color = bandColor;
            }
            if (currentBandValueEl && currentGeri) {
                currentBandValueEl.textContent = (currentGeri.value || '--') + '/100';
            }
            
            // 1-day change
            const trend1d = currentGeri.trend_1d || 0;
            if (trend1dEl) {
                const sign = trend1d > 0 ? '+' : '';
                trend1dEl.textContent = sign + trend1d.toFixed(0);
                trend1dEl.className = 'trend-indicator-value ' + 
                    (trend1d > 0 ? 'positive' : trend1d < 0 ? 'negative' : 'neutral');
            }
            
            // 7-day change
            const trend7d = currentGeri.trend_7d || 0;
            if (trend7dEl) {
                const sign = trend7d > 0 ? '+' : '';
                trend7dEl.textContent = sign + trend7d.toFixed(0);
                trend7dEl.className = 'trend-indicator-value ' + 
                    (trend7d > 0 ? 'positive' : trend7d < 0 ? 'negative' : 'neutral');
            }
            
            // Momentum (based on recent slope)
            if (momentumEl && historyData.length >= 3) {
                const recent = historyData.slice(-5);
                const firstVal = recent[0]?.value || 0;
                const lastVal = recent[recent.length - 1]?.value || 0;
                const diff = lastVal - firstVal;
                
                let momentum = 'Stable';
                if (diff > 5) momentum = 'Accelerating ↗';
                else if (diff > 0) momentum = 'Rising ↑';
                else if (diff < -5) momentum = 'Decelerating ↘';
                else if (diff < 0) momentum = 'Falling ↓';
                
                momentumEl.textContent = momentum;
                momentumEl.className = 'trend-indicator-value ' + 
                    (diff > 0 ? 'positive' : diff < 0 ? 'negative' : 'neutral');
            }
        }
        
        function initializeGeriChart() {
            const ctx = document.getElementById('geriHistoryChart');
            if (!ctx) return;
            
            // Destroy existing chart
            if (geriChart) {
                geriChart.destroy();
            }
            
            const labels = geriHistoryData.map(d => d.date);
            const values = geriHistoryData.map(d => d.value);
            
            // Band colors for background shading
            const bandPlugin = {
                id: 'bandShading',
                beforeDraw: (chart) => {
                    const ctx = chart.ctx;
                    const chartArea = chart.chartArea;
                    const yScale = chart.scales.y;
                    
                    const bands = [
                        { min: 0, max: 25, color: 'rgba(34, 197, 94, 0.1)' },    // LOW - green
                        { min: 25, max: 50, color: 'rgba(234, 179, 8, 0.1)' },   // MODERATE - yellow
                        { min: 50, max: 75, color: 'rgba(249, 115, 22, 0.1)' },  // ELEVATED - orange
                        { min: 75, max: 100, color: 'rgba(239, 68, 68, 0.1)' }   // CRITICAL - red
                    ];
                    
                    bands.forEach(band => {
                        const top = yScale.getPixelForValue(band.max);
                        const bottom = yScale.getPixelForValue(band.min);
                        
                        ctx.save();
                        ctx.fillStyle = band.color;
                        ctx.fillRect(chartArea.left, top, chartArea.right - chartArea.left, bottom - top);
                        ctx.restore();
                    });
                }
            };
            
            geriChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'GERI',
                        data: values,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointRadius: 3,
                        pointHoverRadius: 6,
                        pointBackgroundColor: '#3b82f6',
                        pointBorderColor: '#1e293b',
                        pointBorderWidth: 2,
                        yAxisID: 'y'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#94a3b8',
                                usePointStyle: true,
                                padding: 20,
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            backgroundColor: '#1e293b',
                            titleColor: '#f1f5f9',
                            bodyColor: '#94a3b8',
                            borderColor: '#334155',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                title: (items) => 'Date: ' + items[0].label,
                                label: (context) => {
                                    const val = context.parsed.y;
                                    let band = 'LOW';
                                    if (val >= 76) band = 'CRITICAL';
                                    else if (val >= 51) band = 'ELEVATED';
                                    else if (val >= 26) band = 'MODERATE';
                                    return context.dataset.label + ': ' + val.toFixed(0) + ' (' + band + ')';
                                }
                            }
                        },
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'x'
                            },
                            zoom: {
                                wheel: { enabled: true },
                                pinch: { enabled: true },
                                mode: 'x',
                                onZoomComplete: ({ chart }) => {
                                    chart.update('none');
                                }
                            }
                        },
                        decimation: {
                            enabled: false
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(51, 65, 85, 0.5)' },
                            ticks: { 
                                color: '#64748b',
                                maxRotation: 45,
                                autoSkip: true,
                                maxTicksLimit: 10
                            }
                        },
                        y: {
                            min: 0,
                            max: 100,
                            grid: { color: 'rgba(51, 65, 85, 0.5)' },
                            ticks: { 
                                color: '#64748b',
                                stepSize: 25,
                                callback: (val) => val
                            },
                            title: {
                                display: true,
                                text: 'GERI Value',
                                color: '#64748b'
                            }
                        },
                        y1: {
                            position: 'right',
                            display: false,
                            min: 0,
                            max: 100,
                            grid: { drawOnChartArea: false },
                            ticks: { 
                                color: '#64748b',
                                stepSize: 25
                            }
                        }
                    }
                },
                plugins: [bandPlugin]
            });
        }
        
        function setupRangeButtons() {
            const buttons = document.querySelectorAll('.chart-range-btn');
            const dataLength = geriHistoryData.length;
            
            buttons.forEach(btn => {
                const range = btn.dataset.range;
                
                // Enable buttons based on available data
                if (range === '90' && dataLength >= 90) {
                    btn.disabled = false;
                } else if (range === '365' && dataLength >= 365) {
                    btn.disabled = false;
                }
                
                btn.addEventListener('click', () => {
                    if (btn.disabled) return;
                    
                    // Update active state
                    buttons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // Track current range for overlay slicing
                    currentRangeFilter = range;
                    
                    // Filter data based on range
                    let filteredData = geriHistoryData;
                    if (range !== 'all') {
                        filteredData = geriHistoryData.slice(-parseInt(range));
                    }
                    
                    // Update chart with GERI data
                    if (geriChart) {
                        geriChart.data.labels = filteredData.map(d => d.date);
                        geriChart.data.datasets[0].data = filteredData.map(d => d.value);
                        
                        // Also update overlay data to match new range
                        updateMarketOverlays();
                    }
                });
            });
        }
        
        function setupOverlayToggles() {
            const toggles = document.querySelectorAll('.overlay-toggle');
            
            toggles.forEach(toggle => {
                toggle.addEventListener('click', () => {
                    const overlay = toggle.dataset.overlay;
                    toggle.classList.toggle('active');
                    marketOverlays[overlay].active = toggle.classList.contains('active');
                    
                    // Update chart with market overlay
                    updateMarketOverlays();
                });
            });
        }
        
        async function updateMarketOverlays() {
            if (!geriChart) return;
            
            // Remove existing overlay datasets (keep only GERI)
            geriChart.data.datasets = geriChart.data.datasets.filter(ds => ds.label === 'GERI');
            
            // Display configuration for each overlay
            const overlayConfigs = {
                brent: { label: 'Brent Oil (USD/barrel)', color: '#f59e0b' },
                gas_storage: { label: 'EU Gas Storage (%)', color: '#10b981' }
            };
            
            // Get current labels from chart (matches current range)
            const currentLabels = geriChart.data.labels;
            
            Object.entries(marketOverlays).forEach(([key, overlay]) => {
                if (overlay.active && overlay.data.length > 0) {
                    const config = overlayConfigs[key];
                    
                    // Use pre-generated stable data, sliced to match current range
                    const slicedData = getSlicedOverlayData(key);
                    
                    // Create explicit x,y point objects to prevent Chart.js reprocessing
                    const pointData = slicedData.map((y, i) => ({
                        x: currentLabels[i],
                        y: y
                    }));
                    
                    geriChart.data.datasets.push({
                        label: config.label,
                        data: pointData,
                        borderColor: config.color,
                        backgroundColor: 'transparent',
                        borderWidth: 1.5,
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0.3,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        yAxisID: 'y1',
                        normalized: true,
                        parsing: false
                    });
                }
            });
            
            // Show/hide secondary y-axis
            const hasOverlays = Object.values(marketOverlays).some(o => o.active);
            geriChart.options.scales.y1.display = hasOverlays;
            
            geriChart.update();
        }

        async function generateTelegramCode() {
            try {
                const response = await fetch('/users/telegram/generate-code', {
                    method: 'POST',
                    headers: { 'X-User-Token': sessionToken }
                });
                
                if (!response.ok) {
                    const err = await response.json().catch(() => ({}));
                    throw new Error(err.detail || 'Failed to generate code');
                }
                
                const data = await response.json();
                
                document.getElementById('telegramLinkCode').textContent = data.code;
                document.getElementById('telegramBotUsername').textContent = data.bot_username;
                document.getElementById('telegramCodeExpiry').textContent = data.expires_in_minutes;
                
                if (data.deep_link) {
                    document.getElementById('telegramDeepLink').href = data.deep_link;
                }
                
                document.getElementById('telegramLinkStep1').style.display = 'none';
                document.getElementById('telegramLinkStep2').style.display = 'block';
                document.getElementById('telegramManualEntry').style.display = 'none';
                
                telegramPollCount = 0;
                setTimeout(() => {
                    checkTelegramLinked();
                }, 5000);
            } catch (error) {
                console.error('Error generating Telegram code:', error);
                alert(error.message || 'Failed to generate linking code. Please try again.');
            }
        }

        function showManualChatIdEntry() {
            document.getElementById('telegramLinkStep1').style.display = 'none';
            document.getElementById('telegramLinkStep2').style.display = 'none';
            document.getElementById('telegramManualEntry').style.display = 'block';
        }

        function cancelManualEntry() {
            document.getElementById('telegramLinkStep1').style.display = 'block';
            document.getElementById('telegramManualEntry').style.display = 'none';
            document.getElementById('manualChatIdInput').value = '';
        }

        async function linkManualChatId() {
            const chatId = document.getElementById('manualChatIdInput').value.trim();
            if (!chatId) {
                alert('Please enter your Chat ID');
                return;
            }
            
            try {
                const response = await fetch(`/users/telegram/link-manual?chat_id=${encodeURIComponent(chatId)}`, {
                    method: 'POST',
                    headers: { 'X-User-Token': sessionToken }
                });
                
                if (!response.ok) {
                    const err = await response.json().catch(() => ({}));
                    throw new Error(err.detail || 'Failed to link Telegram');
                }
                
                const data = await response.json();
                currentUser.telegram_chat_id = data.chat_id;
                updateTelegramUI();
                cancelManualEntry();
                alert('Telegram linked successfully!');
            } catch (error) {
                console.error('Error linking Telegram:', error);
                alert(error.message || 'Failed to link Telegram. Please check your Chat ID and try again.');
            }
        }

        function cancelTelegramLink() {
            document.getElementById('telegramLinkStep1').style.display = 'block';
            document.getElementById('telegramManualEntry').style.display = 'none';
            document.getElementById('telegramLinkStep2').style.display = 'none';
        }

        let telegramPollCount = 0;
        const MAX_TELEGRAM_POLLS = 180;
        
        async function checkTelegramLinked() {
            telegramPollCount++;
            
            if (telegramPollCount > MAX_TELEGRAM_POLLS) {
                cancelTelegramLink();
                alert('Linking code expired. Please generate a new code.');
                return;
            }
            
            try {
                const response = await fetch('/users/me', {
                    headers: { 'X-User-Token': sessionToken }
                });
                
                if (response.ok) {
                    const user = await response.json();
                    if (user.telegram_chat_id) {
                        currentUser = user;
                        updateTelegramUI();
                        cancelTelegramLink();
                        telegramPollCount = 0;
                    } else if (document.getElementById('telegramLinkStep2').style.display === 'block') {
                        setTimeout(checkTelegramLinked, 5000);
                    }
                }
            } catch (error) {
                console.error('Error checking Telegram status:', error);
            }
        }

        async function unlinkTelegram() {
            if (!confirm('Are you sure you want to unlink your Telegram account?')) return;
            
            try {
                const response = await fetch('/users/telegram/unlink', {
                    method: 'POST',
                    headers: { 'X-User-Token': sessionToken }
                });
                
                if (!response.ok) throw new Error('Failed to unlink');
                
                currentUser.telegram_chat_id = null;
                updateTelegramUI();
            } catch (error) {
                console.error('Error unlinking Telegram:', error);
                alert('Failed to unlink Telegram. Please try again.');
            }
        }

        let allowedAlertTypes = [];

        async function loadAlerts() {
            try {
                const response = await fetch('/users/alerts?limit=100', {
                    headers: { 'X-User-Token': sessionToken }
                });

                if (!response.ok) throw new Error('Failed to load alerts');

                const data = await response.json();
                allowedAlertTypes = data.allowed_alert_types || [];
                const lockedTypes = data.locked_alert_types || [];
                const lockedSamples = data.locked_samples || [];
                
                allAlerts = data.alerts || [];
                
                initializeFilters();
                renderAlerts(allAlerts, allowedAlertTypes);
                renderAllowedAlertTypes(allowedAlertTypes, lockedTypes);
                renderLockedSamples(lockedSamples);
            } catch (error) {
                console.error('Error loading alerts:', error);
                document.getElementById('recentAlerts').innerHTML = '<div class="empty-state">Failed to load alerts</div>';
                document.getElementById('allAlerts').innerHTML = '<div class="empty-state">Failed to load alerts</div>';
            }
        }
        
        function initializeFilters() {
            const now = new Date();
            const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            
            document.getElementById('filterFromDate').value = yesterday.toISOString().split('T')[0];
            document.getElementById('filterFromTime').value = yesterday.toTimeString().slice(0, 5);
            document.getElementById('filterToDate').value = now.toISOString().split('T')[0];
            document.getElementById('filterToTime').value = now.toTimeString().slice(0, 5);
            document.getElementById('filterRegion').value = '';
            document.getElementById('filterOil').classList.add('active');
            document.getElementById('filterGas').classList.add('active');
            document.getElementById('filterFX').classList.add('active');
        }
        
        function toggleFilter(type) {
            const btn = document.getElementById('filter' + type);
            btn.classList.toggle('active');
        }
        
        function applyFilters() {
            const fromDate = document.getElementById('filterFromDate').value;
            const fromTime = document.getElementById('filterFromTime').value || '00:00';
            const toDate = document.getElementById('filterToDate').value;
            const toTime = document.getElementById('filterToTime').value || '23:59';
            const selectedRegion = document.getElementById('filterRegion').value;
            const showOil = document.getElementById('filterOil').classList.contains('active');
            const showGas = document.getElementById('filterGas').classList.contains('active');
            const showFX = document.getElementById('filterFX').classList.contains('active');
            
            let filtered = allAlerts;
            
            if (fromDate && toDate) {
                const fromDateTime = new Date(`${fromDate}T${fromTime}`);
                const toDateTime = new Date(`${toDate}T${toTime}`);
                filtered = filtered.filter(alert => {
                    const alertDate = new Date(alert.created_at);
                    return alertDate >= fromDateTime && alertDate <= toDateTime;
                });
            }
            
            if (selectedRegion) {
                filtered = filtered.filter(alert => {
                    const alertRegion = (alert.region || '').toLowerCase().replace(/\s+/g, '_');
                    return alertRegion === selectedRegion;
                });
            }
            
            if (!showOil || !showGas || !showFX) {
                filtered = filtered.filter(alert => {
                    const asset = (alert.asset || '').toLowerCase();
                    if (asset.includes('oil') || asset.includes('brent') || asset.includes('wti') || asset.includes('crude')) {
                        return showOil;
                    }
                    if (asset.includes('gas') || asset.includes('lng') || asset.includes('natural')) {
                        return showGas;
                    }
                    if (asset.includes('fx') || asset.includes('eur') || asset.includes('usd') || asset.includes('currency')) {
                        return showFX;
                    }
                    return true;
                });
            }
            
            renderAlertsGrid(filtered, allowedAlertTypes, document.getElementById('allAlerts'));
        }
        
        function resetFilters() {
            initializeFilters();
            renderAlerts(allAlerts, allowedAlertTypes);
        }

        function renderAllowedAlertTypes(allowedTypes, lockedTypes) {
            const allTypes = ['HIGH_IMPACT_EVENT', 'REGIONAL_RISK_SPIKE', 'ASSET_RISK_SPIKE', 'DAILY_DIGEST'];
            const container = document.getElementById('alertTypesInfo');
            if (!container) return;

            const html = allTypes.map(type => {
                const isAllowed = allowedTypes.includes(type) || allowedTypes.includes('ALL');
                const displayName = type.replace(/_/g, ' ');
                return `
                    <div class="alert-type-item ${isAllowed ? 'allowed' : 'locked'}">
                        <span class="alert-type-icon">${isAllowed ? '&#10003;' : '&#128274;'}</span>
                        <span class="alert-type-name">${displayName}</span>
                        ${!isAllowed ? '<span class="upgrade-hint">Upgrade to unlock</span>' : ''}
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }
        
        function renderLockedSamples(lockedSamples) {
            const container = document.getElementById('lockedSamplesSection');
            if (!container) return;
            
            if (lockedSamples.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            const iconSvg = {
                REGIONAL_RISK_SPIKE: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
                ASSET_RISK_SPIKE: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>',
                HIGH_IMPACT_EVENT: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>',
                DAILY_DIGEST: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>'
            };

            const iconClass = {
                REGIONAL_RISK_SPIKE: 'regional',
                ASSET_RISK_SPIKE: 'asset',
                HIGH_IMPACT_EVENT: 'high-impact',
                DAILY_DIGEST: 'digest'
            };
            
            const getTypeLabel = (type) => {
                const labels = {
                    'HIGH_IMPACT_EVENT': 'High Impact Event',
                    'REGIONAL_RISK_SPIKE': 'Regional Risk Spike',
                    'ASSET_RISK_SPIKE': 'Asset Risk Spike',
                    'DAILY_DIGEST': 'Daily Digest'
                };
                return labels[type] || type.replace(/_/g, ' ');
            };
            
            container.style.display = 'block';
            const html = `
                <div class="card-header" style="border-bottom: 1px solid #334155;">
                    <h2 class="card-title" style="color: #f59e0b;">
                        <span style="margin-right: 8px;">&#128274;</span>
                        Upgrade to Unlock More Alerts
                    </h2>
                </div>
                <div class="card-body">
                    <p style="color: #94a3b8; margin-bottom: 20px;">Here's a preview of alerts available on higher plans:</p>
                    <div class="alerts-grid">
                        ${lockedSamples.map(sample => {
                            const alertType = sample.alert_type || 'REGIONAL_RISK_SPIKE';
                            const icon = iconSvg[alertType] || iconSvg.REGIONAL_RISK_SPIKE;
                            const iconCls = iconClass[alertType] || 'regional';
                            return `
                                <div class="sample-card locked">
                                    <div class="card-timestamp">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        ${formatDate(sample.created_at)}
                                    </div>
                                    <div class="card-header">
                                        <div class="alert-icon ${iconCls}">
                                            ${icon}
                                        </div>
                                        <div class="card-header-text">
                                            <h3>${sample.title || 'Alert Preview'}</h3>
                                            <span class="type-badge">${getTypeLabel(alertType)}</span>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="alert-content">${sample.preview || 'Upgrade to see full alert content'}</div>
                                    </div>
                                    <div class="card-footer">
                                        <span>${sample.region || ''}${sample.asset ? ' - ' + sample.asset.toUpperCase() : ''}</span>
                                    </div>
                                    <div class="card-lock-overlay">
                                        <span class="lock-icon">&#128274;</span>
                                        <span>Upgrade your plan to unlock</span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            container.innerHTML = html;
        }

        function cleanAlertMessage(message) {
            if (!message) return '';
            return message
                .replace(/Upgrade to \w+ for.*?https:\/\/energyriskiq\.com\/upgrade/gi, '')
                .replace(/https:\/\/energyriskiq\.com\/upgrade/gi, '')
                .trim();
        }
        
        function isLatestAlert(createdAt) {
            if (!createdAt) return false;
            const alertTime = new Date(createdAt);
            const now = new Date();
            const threeHoursAgo = new Date(now.getTime() - 3 * 60 * 60 * 1000);
            return alertTime >= threeHoursAgo;
        }
        
        function filterLast24Hours(alerts) {
            const now = new Date();
            const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            return alerts.filter(alert => {
                const alertDate = new Date(alert.created_at);
                return alertDate >= yesterday;
            });
        }
        
        function filterLast3Hours(alerts) {
            const now = new Date();
            const threeHoursAgo = new Date(now.getTime() - 3 * 60 * 60 * 1000);
            return alerts.filter(alert => {
                const alertDate = new Date(alert.created_at);
                return alertDate >= threeHoursAgo;
            });
        }
        
        function renderAlerts(alerts, allowedTypes) {
            const last24h = filterLast24Hours(alerts);
            const last3h = filterLast3Hours(alerts);
            document.getElementById('alertsCount').textContent = last24h.length;

            if (last3h.length === 0) {
                document.getElementById('recentAlerts').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">&#128276;</div>
                        <p>No alerts in the last 3 hours. Check the Alerts section for older activity.</p>
                    </div>
                `;
            } else {
                renderAlertsGrid(last3h.slice(0, 4), allowedTypes, document.getElementById('recentAlerts'));
            }

            if (last24h.length === 0) {
                document.getElementById('allAlerts').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">&#128276;</div>
                        <p>No alerts in the last 24 hours. You'll see alerts here once they're triggered.</p>
                    </div>
                `;
            } else {
                renderAlertsGrid(last24h, allowedTypes, document.getElementById('allAlerts'));
            }
        }
        
        function renderAlertsGrid(alerts, allowedTypes, container) {
            if (alerts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">&#128276;</div>
                        <p>No alerts match your filter criteria.</p>
                    </div>
                `;
                return;
            }
            
            const iconSvg = {
                REGIONAL_RISK_SPIKE: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
                ASSET_RISK_SPIKE: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>',
                HIGH_IMPACT_EVENT: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>',
                DAILY_DIGEST: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>'
            };

            const iconClass = {
                REGIONAL_RISK_SPIKE: 'regional',
                ASSET_RISK_SPIKE: 'asset',
                HIGH_IMPACT_EVENT: 'high-impact',
                DAILY_DIGEST: 'digest'
            };
            
            const getTypeLabel = (type) => {
                const labels = {
                    'HIGH_IMPACT_EVENT': 'High Impact Event',
                    'REGIONAL_RISK_SPIKE': 'Regional Risk Spike',
                    'ASSET_RISK_SPIKE': 'Asset Risk Spike',
                    'DAILY_DIGEST': 'Daily Digest'
                };
                return labels[type] || type.replace(/_/g, ' ');
            };
            
            const alertCardHTML = (alert) => {
                const isAllowed = alert.allowed_by_plan;
                const isLatest = isLatestAlert(alert.created_at);
                const alertType = alert.alert_type || 'REGIONAL_RISK_SPIKE';
                const icon = iconSvg[alertType] || iconSvg.REGIONAL_RISK_SPIKE;
                const iconCls = iconClass[alertType] || 'regional';
                const channel = alert.channel || 'email';
                
                return `
                    <div class="sample-card ${!isAllowed ? 'locked' : ''}">
                        <div class="card-timestamp">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            ${formatDate(alert.created_at)}
                            ${isLatest ? '<span class="latest-badge">Latest</span>' : ''}
                        </div>
                        <div class="card-header">
                            <div class="alert-icon ${iconCls}">
                                ${icon}
                            </div>
                            <div class="card-header-text">
                                <h3>${alert.title || 'Alert'}</h3>
                                <span class="type-badge">${getTypeLabel(alertType)}</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="alert-content">${alert.message || 'No message content'}</div>
                        </div>
                        <div class="card-footer">
                            <span class="channel-badge ${channel}">${channel.toUpperCase()}</span>
                            <span>${alert.region || ''}${alert.asset ? ' - ' + alert.asset.toUpperCase() : ''}</span>
                        </div>
                        ${!isAllowed ? `
                            <div class="card-lock-overlay">
                                <span class="lock-icon">&#128274;</span>
                                <span>Available on higher tier plans</span>
                            </div>
                        ` : ''}
                    </div>
                `;
            };

            container.innerHTML = `
                <div class="alerts-grid">
                    ${alerts.map(alert => alertCardHTML(alert)).join('')}
                </div>
            `;
        }

        function formatDate(isoString) {
            if (!isoString) return '--';
            const date = new Date(isoString);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        /* ============================================
           EERI Pro Module - Encapsulated JavaScript
           ============================================ */
        
        let eeriProChart = null;
        let eeriProState = {
            loaded: false,
            days: 30,
            smoothing: 'raw',
            data: null
        };

        const EERI_BAND_COLORS = {
            'LOW': '#22c55e',
            'MODERATE': '#eab308',
            'ELEVATED': '#f97316',
            'CRITICAL': '#ef4444'
        };

        async function loadEeriProData() {
            const plan = currentUser?.plan || 'free';
            const eeriEnabled = ['pro', 'enterprise'].includes(plan);
            
            const loadingEl = document.getElementById('eeriProLoading');
            const lockedEl = document.getElementById('eeriProLocked');
            const dashboardEl = document.getElementById('eeriProDashboard');
            
            if (!eeriEnabled) {
                if (loadingEl) loadingEl.style.display = 'none';
                if (lockedEl) lockedEl.style.display = 'flex';
                if (dashboardEl) dashboardEl.style.display = 'none';
                return;
            }
            
            if (loadingEl) loadingEl.style.display = 'block';
            if (lockedEl) lockedEl.style.display = 'none';
            if (dashboardEl) dashboardEl.style.display = 'none';
            
            try {
                const [realtimeRes, summaryRes, regimeRes] = await Promise.all([
                    fetch('/api/v1/eeri-pro/realtime'),
                    fetch('/api/v1/eeri-pro/daily-summary'),
                    fetch('/api/v1/eeri-pro/regime-stats')
                ]);
                
                const realtimeData = await realtimeRes.json();
                const summaryData = await summaryRes.json();
                const regimeData = await regimeRes.json();
                
                if (loadingEl) loadingEl.style.display = 'none';
                if (dashboardEl) dashboardEl.style.display = 'flex';
                
                if (realtimeData.success && realtimeData.data) {
                    renderEeriMainDisplay(realtimeData.data);
                    renderEeriComponents(realtimeData.data.component_breakdown);
                    renderEeriAssetStress(realtimeData.data.asset_stress);
                    renderEeriTopDrivers(realtimeData.data.top_drivers);
                }
                
                if (summaryData.success && summaryData.data) {
                    renderEeriSummary(summaryData.data);
                }
                
                if (regimeData.success) {
                    renderEeriRegimeStats(regimeData);
                }
                
                loadEeriHistoryChart(eeriProState.days, eeriProState.smoothing);
                initEeriTimeControls();
                
                eeriProState.loaded = true;
                
            } catch (error) {
                console.error('Error loading EERI Pro data:', error);
                if (loadingEl) loadingEl.innerHTML = '<p style="color: #f87171;">Error loading EERI data. Please try again.</p>';
            }
        }

        function renderEeriMainDisplay(data) {
            const valueEl = document.getElementById('eeriValue');
            const bandEl = document.getElementById('eeriBandLabel');
            const trendIconEl = document.getElementById('eeriTrendIcon');
            const trendTextEl = document.getElementById('eeriTrendText');
            const computedAtEl = document.getElementById('eeriComputedAt');
            
            if (valueEl) valueEl.textContent = Math.round(data.value);
            if (bandEl) {
                bandEl.textContent = data.band;
                bandEl.style.color = EERI_BAND_COLORS[data.band] || '#94a3b8';
            }
            
            const trend7d = data.trend_7d || 0;
            let trendIcon = '→';
            let trendText = 'Stable (7d)';
            let trendColor = '#94a3b8';
            
            if (trend7d > 5) {
                trendIcon = '↑';
                trendText = `+${trend7d.toFixed(1)} (7d)`;
                trendColor = '#f87171';
            } else if (trend7d < -5) {
                trendIcon = '↓';
                trendText = `${trend7d.toFixed(1)} (7d)`;
                trendColor = '#4ade80';
            }
            
            if (trendIconEl) {
                trendIconEl.textContent = trendIcon;
                trendIconEl.style.color = trendColor;
            }
            if (trendTextEl) trendTextEl.textContent = trendText;
            
            if (computedAtEl && data.computed_at) {
                const date = new Date(data.computed_at);
                computedAtEl.textContent = `Updated: ${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} at ${date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}`;
            }
        }

        function renderEeriComponents(breakdown) {
            const chartEl = document.getElementById('eeriComponentsChart');
            const legendEl = document.getElementById('eeriComponentsLegend');
            
            if (!breakdown || !breakdown.components) return;
            
            const total = breakdown.components.reduce((sum, c) => sum + c.contribution, 0);
            
            chartEl.innerHTML = breakdown.components.map(comp => {
                const width = total > 0 ? (comp.contribution / total * 100) : 25;
                return `<div class="eeri-component-bar" style="width: ${width}%; background: ${comp.color};" title="${comp.name}: ${comp.contribution.toFixed(1)}"></div>`;
            }).join('');
            
            legendEl.innerHTML = breakdown.components.map(comp => `
                <div class="eeri-legend-item">
                    <div class="eeri-legend-color" style="background: ${comp.color};"></div>
                    <span class="eeri-legend-label">${comp.short_name}</span>
                    <span class="eeri-legend-value">${comp.contribution.toFixed(1)} (${comp.percentage.toFixed(0)}%)</span>
                </div>
            `).join('');
        }

        function renderEeriAssetStress(assets) {
            const gridEl = document.getElementById('eeriAssetStressGrid');
            if (!assets || !gridEl) return;
            
            gridEl.innerHTML = assets.map(asset => `
                <div class="eeri-asset-item">
                    <div class="eeri-asset-name">${asset.display_name}</div>
                    <div class="eeri-asset-score" style="color: ${asset.color};">${Math.round(asset.score)}</div>
                    <div class="eeri-asset-status" style="color: ${asset.color};">
                        <span class="eeri-asset-trend">${asset.trend}</span>
                        ${asset.status_label}
                    </div>
                </div>
            `).join('');
        }

        function renderEeriTopDrivers(drivers) {
            const listEl = document.getElementById('eeriDriversList');
            if (!drivers || !listEl) return;
            
            if (drivers.length === 0) {
                listEl.innerHTML = '<p style="color: #64748b; text-align: center; padding: 20px;">No drivers available</p>';
                return;
            }
            
            listEl.innerHTML = drivers.map(driver => {
                const assetsText = driver.assets_affected && driver.assets_affected.length > 0 
                    ? driver.assets_affected.slice(0, 3).join(', ') 
                    : '';
                
                return `
                    <div class="eeri-driver-item">
                        <div class="eeri-driver-rank">${driver.rank}</div>
                        <div class="eeri-driver-content">
                            <div class="eeri-driver-headline">${driver.headline}</div>
                            <div class="eeri-driver-meta">
                                <span class="eeri-driver-tag theme">${driver.theme}</span>
                                <span class="eeri-driver-tag severity">Severity: ${driver.severity}</span>
                                <span class="eeri-driver-tag confidence">Conf: ${driver.confidence}%</span>
                                ${assetsText ? `<span class="eeri-driver-tag assets">${assetsText}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderEeriSummary(data) {
            const dateEl = document.getElementById('eeriSummaryDate');
            const textEl = document.getElementById('eeriSummaryText');
            const driversEl = document.getElementById('eeriSummaryDrivers');
            
            if (dateEl && data.date) {
                const date = new Date(data.date);
                dateEl.textContent = date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
            }
            
            if (textEl && data.interpretation) {
                const paragraphs = data.interpretation.split(/\n\n+|\. (?=[A-Z])/g)
                    .filter(p => p.trim())
                    .map(p => p.trim().endsWith('.') ? p.trim() : p.trim() + '.');
                
                if (paragraphs.length > 1) {
                    textEl.innerHTML = paragraphs.map(p => `<p>${p}</p>`).join('');
                } else {
                    const text = data.interpretation;
                    const sentences = text.match(/[^.!?]+[.!?]+/g) || [text];
                    if (sentences.length >= 4) {
                        const mid = Math.ceil(sentences.length / 2);
                        const para1 = sentences.slice(0, mid).join(' ').trim();
                        const para2 = sentences.slice(mid).join(' ').trim();
                        textEl.innerHTML = `<p>${para1}</p><p>${para2}</p>`;
                    } else {
                        textEl.innerHTML = `<p>${text}</p>`;
                    }
                }
            }
            
            if (driversEl && data.key_drivers) {
                driversEl.textContent = `Key Drivers: ${data.key_drivers.slice(0, 3).join(' • ')}`;
            }
        }

        const eeriModalContent = {
            components: {
                title: 'Component Breakdown',
                body: `
                    <h4>What is the Component Breakdown?</h4>
                    <p>The Component Breakdown displays how different risk factors contribute to today's overall EERI (Europe Energy Risk Index) value. Each component represents a distinct category of risk that affects European energy markets.</p>
                    
                    <h4>Understanding the Components</h4>
                    <ul>
                        <li><strong>RERI_EU (Regional Risk):</strong> Base regional escalation risk for Europe, measuring geopolitical tensions and regional instability.</li>
                        <li><strong>Theme Pressure:</strong> Aggregate pressure from thematic risk categories like supply disruptions, infrastructure threats, and policy changes.</li>
                        <li><strong>Asset Transmission:</strong> How risks propagate across energy asset classes (gas, oil, power, etc.).</li>
                        <li><strong>Contagion:</strong> Spillover effects from neighboring regions that could impact European energy markets.</li>
                    </ul>
                    
                    <div class="eeri-modal-highlight">
                        <strong>How to interpret:</strong> Larger bars indicate components contributing more to overall risk. Use this to identify which risk categories are driving market conditions.
                    </div>
                `
            },
            assetStress: {
                title: 'Asset Stress Panel',
                body: `
                    <h4>What is the Asset Stress Panel?</h4>
                    <p>The Asset Stress Panel shows real-time stress levels across different energy asset classes in European markets. It helps you understand which commodities and markets are under pressure.</p>
                    
                    <h4>Asset Classes Monitored</h4>
                    <ul>
                        <li><strong>Natural Gas:</strong> European gas markets including TTF pricing and supply dynamics.</li>
                        <li><strong>Crude Oil:</strong> Brent crude and European oil market stress.</li>
                        <li><strong>Freight/Shipping:</strong> LNG tanker rates and energy transportation costs.</li>
                        <li><strong>Currency/FX:</strong> EUR/USD and energy-linked currency movements.</li>
                        <li><strong>Power:</strong> European electricity markets and grid stress.</li>
                        <li><strong>LNG:</strong> Liquefied natural gas import dynamics and pricing.</li>
                        <li><strong>Electricity:</strong> Spot and forward power market conditions.</li>
                    </ul>
                    
                    <h4>Stress Levels</h4>
                    <p>Each asset shows a score from 0-100 with status labels: Minimal (green), Low (blue), Moderate (yellow), Elevated (orange), or Critical (red). The trend arrow indicates direction of change.</p>
                    
                    <div class="eeri-modal-highlight">
                        <strong>How to interpret:</strong> Focus on assets showing "Elevated" or "Critical" status for immediate attention. Upward trends suggest worsening conditions.
                    </div>
                `
            },
            history: {
                title: 'Historical Intelligence',
                body: `
                    <h4>What is Historical Intelligence?</h4>
                    <p>This chart displays the EERI index over time, allowing you to identify trends, patterns, and significant risk events in European energy markets.</p>
                    
                    <h4>Time Range Controls</h4>
                    <ul>
                        <li><strong>7D:</strong> Last 7 days - ideal for spotting recent developments.</li>
                        <li><strong>30D:</strong> Last 30 days - shows monthly patterns and trends.</li>
                        <li><strong>90D:</strong> Last 90 days - reveals seasonal patterns and longer-term trends.</li>
                        <li><strong>All:</strong> Full historical data - comprehensive view for strategic analysis.</li>
                    </ul>
                    
                    <h4>Smoothing Options</h4>
                    <ul>
                        <li><strong>Raw:</strong> Actual daily values with full volatility visible.</li>
                        <li><strong>3D MA:</strong> 3-day moving average - smooths short-term noise.</li>
                        <li><strong>7D MA:</strong> 7-day moving average - shows underlying trend direction.</li>
                    </ul>
                    
                    <div class="eeri-modal-highlight">
                        <strong>How to interpret:</strong> Use Raw for detail, moving averages for trend direction. The color bands indicate risk levels: green (LOW), yellow (MODERATE), orange (ELEVATED), red (CRITICAL).
                    </div>
                `
            },
            regime: {
                title: 'Regime Statistics',
                body: `
                    <h4>What are Regime Statistics?</h4>
                    <p>Regime Statistics show how much time the EERI index has spent in each risk band over the past 90 days, along with recent transitions between risk levels.</p>
                    
                    <h4>Risk Bands</h4>
                    <ul>
                        <li><strong>LOW (0-25):</strong> Calm conditions, minimal market stress.</li>
                        <li><strong>MODERATE (26-50):</strong> Normal market volatility, standard risk.</li>
                        <li><strong>ELEVATED (51-75):</strong> Heightened risk, increased attention needed.</li>
                        <li><strong>CRITICAL (76-100):</strong> Severe stress, potential market disruption.</li>
                    </ul>
                    
                    <h4>Band Distribution</h4>
                    <p>The percentage bars show how many days (out of the last 90) the market spent in each risk band. A healthy market typically spends most time in LOW or MODERATE.</p>
                    
                    <h4>Regime Transitions</h4>
                    <p>Shows recent shifts between risk bands, helping you track when markets moved from one state to another.</p>
                    
                    <div class="eeri-modal-highlight">
                        <strong>How to interpret:</strong> High percentage in ELEVATED or CRITICAL suggests persistent stress. Frequent transitions indicate volatility in market conditions.
                    </div>
                `
            },
            behavioral: {
                title: 'Conceptual, Behavioral Interpretation',
                body: `
                    <p style="margin-bottom: 20px; color: #94a3b8;">Below is a conceptual, behavioral interpretation of each band — what is happening in the world, how markets tend to behave, and how users should mentally respond.</p>
                    
                    <div class="eeri-band-section" style="border-left: 4px solid #22c55e; padding-left: 16px; margin-bottom: 24px;">
                        <h4 style="color: #22c55e;">🟩 0–20 — NORMAL</h4>
                        <p><strong>Background risk</strong></p>
                        <p><strong>What's happening:</strong> Geopolitical and energy-related events are isolated. Supply chains function normally. Markets absorb news without stress. No clustering, no persistence. Risk exists — but it's ambient, not directional.</p>
                        <p><strong>How markets behave:</strong> Prices respond mostly to fundamentals. Volatility is low and mean-reverting. Headlines fade quickly.</p>
                        <div class="eeri-modal-highlight"><strong>How to interpret:</strong> "The system is stable. Risk is not the dominant variable." This is when markets are efficient, noise dominates signal, and overreacting is the biggest danger.</div>
                    </div>
                    
                    <div class="eeri-band-section" style="border-left: 4px solid #facc15; padding-left: 16px; margin-bottom: 24px;">
                        <h4 style="color: #facc15;">🟨 21–40 — ELEVATED</h4>
                        <p><strong>Early tension / alert phase</strong></p>
                        <p><strong>What's happening:</strong> Early signs of geopolitical or supply stress. Narratives begin to repeat. Markets are attentive but not alarmed. Stress is forming, not spreading.</p>
                        <p><strong>How markets behave:</strong> Selective sensitivity to news. Brief volatility spikes. Divergence between assets.</p>
                        <div class="eeri-modal-highlight"><strong>How to interpret:</strong> "Something is forming — pay attention." This is a watch phase: Don't act yet. Start monitoring drivers. Check which assets are reacting. This band is often underestimated.</div>
                    </div>
                    
                    <div class="eeri-band-section" style="border-left: 4px solid #f97316; padding-left: 16px; margin-bottom: 24px;">
                        <h4 style="color: #f97316;">🟧 41–60 — HIGH</h4>
                        <p><strong>Active stress regime</strong></p>
                        <p><strong>What's happening:</strong> Multiple high-impact events. Clear thematic dominance (war, supply, logistics). Early clustering. Risk becomes persistent. This is no longer background noise.</p>
                        <p><strong>How markets behave:</strong> Volatility increases. Correlations begin to rise. Safe-haven behavior emerges. Assets start reacting together.</p>
                        <div class="eeri-modal-highlight"><strong>How to interpret:</strong> "Risk is now a key market driver." This is where risk management matters, narratives start driving price, and false calm becomes dangerous.</div>
                    </div>
                    
                    <div class="eeri-band-section" style="border-left: 4px solid #ef4444; padding-left: 16px; margin-bottom: 24px;">
                        <h4 style="color: #ef4444;">🟥 61–80 — SEVERE</h4>
                        <p><strong>System under strain</strong></p>
                        <p><strong>What's happening:</strong> Escalation is sustained. Supply or logistics constraints are binding. Second-order effects appear. Market psychology shifts. The system is tense.</p>
                        <p><strong>How markets behave:</strong> Non-linear moves. Correlations spike. Liquidity thins. Reactions become asymmetric.</p>
                        <div class="eeri-modal-highlight"><strong>How to interpret:</strong> "The system is fragile. Expect surprises." This is when historical analogs matter, timing becomes difficult, and overconfidence is punished.</div>
                    </div>
                    
                    <div class="eeri-band-section" style="border-left: 4px solid #b91c1c; padding-left: 16px; margin-bottom: 24px;">
                        <h4 style="color: #b91c1c;">🟥 81–100 — CRITICAL</h4>
                        <p><strong>Crisis conditions</strong></p>
                        <p><strong>What's happening:</strong> Systemic stress dominates. Multiple components fully aligned. Shock propagation is active. Control narratives break down. This is not about <em>if</em> something breaks — it's about <em>where</em>.</p>
                        <p><strong>How markets behave:</strong> Dislocations. Gap moves. Policy intervention risk. Decoupling from fundamentals.</p>
                        <div class="eeri-modal-highlight"><strong>How to interpret:</strong> "The environment itself is dangerous." In this regime: Preservation > optimization. Liquidity > return. Awareness > precision. This is when EERI is most valuable.</div>
                    </div>
                    
                    <div style="background: #1e293b; border: 1px solid #475569; border-radius: 8px; padding: 16px; margin-top: 20px;">
                        <h4 style="color: #f1f5f9; margin-top: 0;">⚠️ One Critical Conceptual Point</h4>
                        <p style="margin-bottom: 8px;"><strong>These bands are not linear.</strong></p>
                        <p style="margin-bottom: 4px;">The jump from:</p>
                        <ul style="margin: 0 0 8px 20px;">
                            <li>20 → 30 is <strong>mild</strong></li>
                            <li>50 → 60 is <strong>meaningful</strong></li>
                            <li>75 → 85 is <strong>dramatic</strong></li>
                        </ul>
                        <p style="margin: 0;"><strong>Risk accelerates non-linearly as bands increase. That's why the bands exist.</strong></p>
                    </div>
                    
                    <hr style="border: none; border-top: 1px solid #475569; margin: 28px 0;">
                    
                    <h4 style="color: #f1f5f9;">🎯 How You Should Use These Bands</h4>
                    
                    <div style="display: flex; gap: 40px; flex-wrap: wrap; margin: 16px 0;">
                        <div>
                            <p style="color: #ef4444; margin-bottom: 8px;"><strong>NOT as:</strong></p>
                            <ul style="margin: 0 0 0 20px; color: #94a3b8;">
                                <li>Trading signals</li>
                                <li>Predictions</li>
                                <li>Alarms</li>
                            </ul>
                        </div>
                        <div>
                            <p style="color: #22c55e; margin-bottom: 8px;"><strong>BUT as:</strong></p>
                            <ul style="margin: 0 0 0 20px; color: #94a3b8;">
                                <li>Context</li>
                                <li>Attention allocation</li>
                                <li>Risk framing</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="eeri-modal-highlight" style="margin-top: 16px;">
                        <strong>Each band answers one question:</strong> "How careful should I be right now?"
                    </div>
                    
                    <hr style="border: none; border-top: 1px solid #475569; margin: 28px 0;">
                    
                    <h4 style="color: #f1f5f9;">💡 How This Positions EERI Uniquely</h4>
                    
                    <div style="display: flex; gap: 24px; flex-wrap: wrap; margin: 16px 0;">
                        <div style="flex: 1; min-width: 200px; background: #334155; padding: 16px; border-radius: 8px;">
                            <p style="color: #94a3b8; margin: 0 0 8px 0; font-size: 13px;">Most indices say:</p>
                            <p style="color: #f1f5f9; margin: 0; font-size: 16px;"><em>"Volatility is X"</em></p>
                        </div>
                        <div style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #1e40af, #7c3aed); padding: 16px; border-radius: 8px;">
                            <p style="color: #c4b5fd; margin: 0 0 8px 0; font-size: 13px;">EERI says:</p>
                            <p style="color: #ffffff; margin: 0; font-size: 16px;"><strong><em>"This is the kind of world you are operating in today."</em></strong></p>
                        </div>
                    </div>
                    
                    <p style="text-align: center; color: #60a5fa; margin-top: 16px;"><strong>That's a much deeper insight.</strong></p>
                    
                    <hr style="border: none; border-top: 1px solid #475569; margin: 28px 0;">
                    
                    <div style="background: linear-gradient(135deg, #0f172a, #1e293b); border: 2px solid #60a5fa; border-radius: 12px; padding: 20px; text-align: center;">
                        <h4 style="color: #60a5fa; margin: 0 0 16px 0;">🏁 Final Takeaway</h4>
                        <p style="color: #f1f5f9; margin-bottom: 16px;"><strong>EERI Risk Bands tell users:</strong></p>
                        <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; margin-bottom: 20px;">
                            <span style="background: #22c55e; color: #000; padding: 6px 12px; border-radius: 20px; font-size: 13px;"><strong>Normal</strong> → Ignore noise</span>
                            <span style="background: #facc15; color: #000; padding: 6px 12px; border-radius: 20px; font-size: 13px;"><strong>Elevated</strong> → Start watching</span>
                            <span style="background: #f97316; color: #000; padding: 6px 12px; border-radius: 20px; font-size: 13px;"><strong>High</strong> → Risk is active</span>
                            <span style="background: #ef4444; color: #fff; padding: 6px 12px; border-radius: 20px; font-size: 13px;"><strong>Severe</strong> → System is strained</span>
                            <span style="background: #b91c1c; color: #fff; padding: 6px 12px; border-radius: 20px; font-size: 13px;"><strong>Critical</strong> → Crisis environment</span>
                        </div>
                        <p style="color: #94a3b8; margin: 0; font-style: italic;">Once users internalize this ladder, they stop reacting emotionally — and start thinking structurally.</p>
                        <p style="color: #60a5fa; margin: 16px 0 0 0;"><strong>That's exactly the behavior EERI is designed to support.</strong></p>
                    </div>
                `
            }
        };

        function openEeriModal(type) {
            const content = eeriModalContent[type];
            if (!content) return;
            
            const overlay = document.getElementById('eeriModalOverlay');
            const titleEl = document.getElementById('eeriModalTitle');
            const bodyEl = document.getElementById('eeriModalBody');
            
            if (titleEl) titleEl.textContent = content.title;
            if (bodyEl) bodyEl.innerHTML = content.body;
            if (overlay) overlay.classList.add('active');
        }

        function closeEeriModal() {
            const overlay = document.getElementById('eeriModalOverlay');
            if (overlay) overlay.classList.remove('active');
        }

        function renderEeriRegimeStats(data) {
            const distEl = document.getElementById('eeriBandDistribution');
            const transEl = document.getElementById('eeriTransitionsList');
            
            if (distEl && data.statistics) {
                const percentages = data.statistics.band_percentages || {};
                distEl.innerHTML = ['CRITICAL', 'ELEVATED', 'MODERATE', 'LOW'].map(band => {
                    const pct = percentages[band] || 0;
                    return `
                        <div class="eeri-band-row">
                            <span class="eeri-band-label" style="color: ${EERI_BAND_COLORS[band]};">${band}</span>
                            <div class="eeri-band-bar-container">
                                <div class="eeri-band-bar" style="width: ${pct}%; background: ${EERI_BAND_COLORS[band]};"></div>
                            </div>
                            <span class="eeri-band-percent">${pct.toFixed(1)}%</span>
                        </div>
                    `;
                }).join('');
            }
            
            if (transEl && data.recent_transitions) {
                if (data.recent_transitions.length === 0) {
                    transEl.innerHTML = '<p style="color: #64748b; font-size: 12px;">No regime transitions in period</p>';
                } else {
                    transEl.innerHTML = data.recent_transitions.slice(-5).reverse().map(t => `
                        <div class="eeri-transition-item">
                            <span class="eeri-transition-date">${new Date(t.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>
                            <span style="color: ${EERI_BAND_COLORS[t.from_band]};">${t.from_band}</span>
                            <span class="eeri-transition-arrow">→</span>
                            <span style="color: ${EERI_BAND_COLORS[t.to_band]};">${t.to_band}</span>
                        </div>
                    `).join('');
                }
            }
        }

        async function loadEeriHistoryChart(days, smoothing) {
            const statsAvg = document.getElementById('eeriStatAvg');
            const statsMax = document.getElementById('eeriStatMax');
            const statsMin = document.getElementById('eeriStatMin');
            const statsVol = document.getElementById('eeriStatVol');
            
            try {
                const response = await fetch(`/api/v1/eeri-pro/history?days=${days}&smoothing=${smoothing}`);
                const result = await response.json();
                
                if (!result.success || !result.data) return;
                
                eeriProState.data = result.data;
                
                if (statsAvg) statsAvg.textContent = result.statistics.average;
                if (statsMax) statsMax.textContent = result.statistics.max;
                if (statsMin) statsMin.textContent = result.statistics.min;
                if (statsVol) statsVol.textContent = (result.statistics.max - result.statistics.min).toFixed(1);
                
                renderEeriHistoryChart(result.data, smoothing);
                
            } catch (error) {
                console.error('Error loading EERI history:', error);
            }
        }

        const riskBandPlugin = {
            id: 'riskBandBackground',
            beforeDraw: (chart) => {
                const { ctx, chartArea, scales } = chart;
                if (!chartArea) return;
                
                const bands = [
                    { min: 0, max: 20, color: 'rgba(34, 197, 94, 0.15)' },
                    { min: 20, max: 40, color: 'rgba(250, 204, 21, 0.12)' },
                    { min: 40, max: 60, color: 'rgba(249, 115, 22, 0.12)' },
                    { min: 60, max: 80, color: 'rgba(239, 68, 68, 0.12)' },
                    { min: 80, max: 100, color: 'rgba(185, 28, 28, 0.18)' },
                ];
                
                bands.forEach(band => {
                    const yTop = scales.y.getPixelForValue(band.max);
                    const yBottom = scales.y.getPixelForValue(band.min);
                    
                    ctx.save();
                    ctx.fillStyle = band.color;
                    ctx.fillRect(chartArea.left, yTop, chartArea.right - chartArea.left, yBottom - yTop);
                    ctx.restore();
                });
            }
        };

        function renderEeriHistoryChart(data, smoothing) {
            const canvas = document.getElementById('eeriHistoryChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            if (eeriProChart) {
                eeriProChart.destroy();
            }
            
            const labels = data.map(d => {
                const date = new Date(d.date);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            
            const values = data.map(d => d.value);
            const smoothedValues = data.map(d => d.smoothed || null);
            
            const datasets = [{
                label: 'EERI',
                data: values,
                borderColor: '#8b5cf6',
                backgroundColor: 'rgba(139, 92, 246, 0.2)',
                borderWidth: 2,
                fill: true,
                tension: 0.3,
                pointRadius: values.length > 60 ? 0 : 3,
                pointHoverRadius: 5,
            }];
            
            if (smoothing !== 'raw' && smoothedValues.some(v => v !== null)) {
                datasets.push({
                    label: smoothing === 'ma3' ? '3-Day MA' : '7-Day MA',
                    data: smoothedValues,
                    borderColor: '#3b82f6',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.3,
                    pointRadius: 0,
                });
            }
            
            eeriProChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                plugins: [riskBandPlugin],
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: datasets.length > 1,
                            position: 'top',
                            labels: { color: '#94a3b8', font: { size: 11 } }
                        },
                        tooltip: {
                            backgroundColor: '#1e293b',
                            titleColor: '#f1f5f9',
                            bodyColor: '#e2e8f0',
                            borderColor: '#334155',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}`;
                                }
                            }
                        },
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(51, 65, 85, 0.5)' },
                            ticks: { color: '#64748b', maxRotation: 45, font: { size: 10 } }
                        },
                        y: {
                            min: 0,
                            max: 100,
                            grid: { color: 'rgba(51, 65, 85, 0.5)' },
                            ticks: { color: '#64748b', font: { size: 11 } }
                        }
                    }
                }
            });
        }

        function initEeriTimeControls() {
            document.querySelectorAll('.eeri-time-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.eeri-time-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    eeriProState.days = parseInt(this.dataset.days);
                    loadEeriHistoryChart(eeriProState.days, eeriProState.smoothing);
                });
            });
            
            document.querySelectorAll('.eeri-smooth-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.eeri-smooth-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    eeriProState.smoothing = this.dataset.smooth;
                    loadEeriHistoryChart(eeriProState.days, eeriProState.smoothing);
                });
            });
        }

        function setupEeriProNavAccess() {
            const plan = currentUser?.plan || 'free';
            const eeriEnabled = ['pro', 'enterprise'].includes(plan);
            
            const eeriNavItem = document.getElementById('eeriNavItem');
            const eeriBadge = document.getElementById('eeriBadge');
            const eeriUpgradeHint = document.getElementById('eeriUpgradeHint');
            
            if (eeriNavItem) {
                if (eeriEnabled) {
                    eeriNavItem.classList.remove('nav-item-disabled');
                    if (eeriBadge) eeriBadge.classList.remove('pro-badge-locked');
                    if (eeriUpgradeHint) eeriUpgradeHint.style.display = 'none';
                } else {
                    if (eeriBadge) {
                        eeriBadge.classList.add('pro-badge-locked');
                        eeriBadge.textContent = 'PRO';
                    }
                    if (eeriUpgradeHint) eeriUpgradeHint.style.display = 'block';
                }
            }
        }

        /* End EERI Pro Module */

        function showSection(sectionId) {
            document.querySelectorAll('.section-content').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            document.getElementById('section-' + sectionId).classList.add('active');
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }

            if (sectionId === 'plans') {
                loadPlans();
            } else if (sectionId === 'settings') {
                loadAlertSettings();
            } else if (sectionId === 'geri') {
                loadGeriData();
            } else if (sectionId === 'eeri-pro') {
                loadEeriProData();
            }
        }

        async function loadPlans() {
            const grid = document.getElementById('plansGrid');
            
            try {
                const response = await fetch('/billing/plans');
                const data = await response.json();
                const plans = data.plans || [];
                
                const planOrder = ['free', 'personal', 'trader', 'pro', 'enterprise'];
                plans.sort((a, b) => planOrder.indexOf(a.plan_code) - planOrder.indexOf(b.plan_code));
                
                const currentPlan = currentUser?.plan || 'free';
                const currentPlanIndex = planOrder.indexOf(currentPlan);

                grid.innerHTML = plans.map(plan => {
                    const planIndex = planOrder.indexOf(plan.plan_code);
                    const isCurrent = plan.plan_code === currentPlan;
                    const isUpgrade = planIndex > currentPlanIndex;
                    const isDowngrade = planIndex < currentPlanIndex && plan.plan_code !== 'free';
                    const isFree = plan.plan_code === 'free';
                    
                    let btnClass = 'plan-btn';
                    let btnText = '';
                    let btnDisabled = '';
                    
                    if (isCurrent) {
                        btnClass += ' current';
                        btnText = 'Current Plan';
                        btnDisabled = 'disabled';
                    } else if (isUpgrade) {
                        btnClass += ' upgrade';
                        btnText = `Upgrade to ${plan.display_name}`;
                    } else if (isDowngrade || (isFree && currentPlan !== 'free')) {
                        btnClass += ' downgrade';
                        btnText = `Downgrade to ${plan.display_name}`;
                    }
                    
                    const features = plan.features ? [
                        ...(['pro', 'enterprise'].includes(plan.plan_code) ? ['Real-Time GERI'] : []),
                        ...(plan.plan_code === 'enterprise' ? ['Current RERI'] : []),
                        `${plan.features.max_email_alerts_per_day} email alerts/day`,
                        ...(['pro', 'enterprise'].includes(plan.plan_code) ? ['Live Telegram Alerts'] : []),
                        `${plan.features.max_regions === -1 ? 'Unlimited' : plan.features.max_regions} regions`,
                        `${plan.features.alert_types?.length || 0} alert types`
                    ] : [];
                    
                    return `
                        <div class="plan-card ${isCurrent ? 'current' : ''}">
                            <div class="plan-name">${plan.display_name}</div>
                            <div class="plan-price">${plan.price > 0 ? '€' + plan.price.toFixed(2) : 'Free'}<span>${plan.price > 0 ? '/mo' : ''}</span></div>
                            <ul class="plan-features">
                                ${features.map(f => `<li>${f}</li>`).join('')}
                            </ul>
                            <button class="${btnClass}" 
                                    ${btnDisabled}
                                    onclick="openPlanModal('${plan.plan_code}', '${plan.display_name}', ${plan.price}, '${isUpgrade ? 'upgrade' : 'downgrade'}')">
                                ${btnText}
                            </button>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading plans:', error);
                grid.innerHTML = '<p style="color: #f87171;">Failed to load plans</p>';
            }
        }

        function openPlanModal(planCode, planName, price, action) {
            const modal = document.getElementById('planModal');
            const modalTitle = document.getElementById('planModalTitle');
            const modalBody = document.getElementById('planModalBody');
            const modalBtn = document.getElementById('planModalBtn');
            
            const planLimits = {
                'free': { regions: 1, types: ['HIGH_IMPACT_EVENT'] },
                'personal': { regions: 2, types: ['HIGH_IMPACT_EVENT', 'REGIONAL_RISK_SPIKE'] },
                'trader': { regions: 3, types: ['HIGH_IMPACT_EVENT', 'REGIONAL_RISK_SPIKE', 'ASSET_RISK_SPIKE'] },
                'pro': { regions: 4, types: ['HIGH_IMPACT_EVENT', 'REGIONAL_RISK_SPIKE', 'ASSET_RISK_SPIKE', 'DAILY_DIGEST'] },
                'enterprise': { regions: -1, types: ['HIGH_IMPACT_EVENT', 'REGIONAL_RISK_SPIKE', 'ASSET_RISK_SPIKE', 'DAILY_DIGEST'] }
            };
            
            const limits = planLimits[planCode] || planLimits['free'];
            const regionsText = limits.regions === -1 ? 'Unlimited regions' : `${limits.regions} region${limits.regions > 1 ? 's' : ''}`;
            const typesText = limits.types.map(t => t.replace(/_/g, ' ')).join(', ');
            
            const settingsNote = `
                <div style="background: #1e3a5f; border: 1px solid #3b82f6; border-radius: 8px; padding: 12px; margin-top: 16px;">
                    <p style="color: #60a5fa; font-weight: 600; margin-bottom: 8px;">Plan Includes:</p>
                    <ul style="color: #94a3b8; margin: 0; padding-left: 20px; font-size: 13px;">
                        <li>${regionsText}</li>
                        <li>Alert types: ${typesText}</li>
                    </ul>
                    <p style="color: #fbbf24; font-size: 12px; margin-top: 12px; margin-bottom: 0;">
                        After changing your plan, visit the Settings tab to adjust your alert preferences.
                    </p>
                </div>
            `;
            
            if (planCode === 'free') {
                modalTitle.textContent = 'Downgrade to Free';
                modalBody.innerHTML = `
                    <p>Are you sure you want to downgrade to the Free plan?</p>
                    <p style="color: #94a3b8; margin-top: 12px;">Your current plan benefits will remain active until the end of your billing period.</p>
                    <p style="color: #f87171; margin-top: 12px; font-size: 13px;">
                        <strong>Note:</strong> Your current alert settings that exceed Free plan limits will be automatically adjusted.
                    </p>
                    ${settingsNote}
                `;
                modalBtn.textContent = 'Downgrade to Free';
                modalBtn.className = 'plan-btn downgrade';
                modalBtn.onclick = () => cancelSubscription();
            } else {
                const actionText = action === 'upgrade' ? 'Upgrade' : 'Downgrade';
                modalTitle.textContent = `${actionText} to ${planName}`;
                modalBody.innerHTML = `
                    <p>You are about to ${action} to the <strong>${planName}</strong> plan.</p>
                    <div style="background: #1e293b; border-radius: 8px; padding: 16px; margin: 16px 0;">
                        <div style="font-size: 24px; font-weight: 700; color: #f1f5f9;">€${price.toFixed(2)}<span style="font-size: 14px; color: #94a3b8;">/month</span></div>
                    </div>
                    ${action === 'upgrade' ? '<p style="color: #4ade80;">Your new plan will be activated immediately.</p>' : '<p style="color: #fbbf24;">Changes will take effect at the end of your current billing period. Settings exceeding the new plan limits will be adjusted.</p>'}
                    ${settingsNote}
                `;
                modalBtn.textContent = `${actionText} to ${planName}`;
                modalBtn.className = action === 'upgrade' ? 'plan-btn upgrade' : 'plan-btn downgrade';
                modalBtn.onclick = () => startCheckout(planCode);
            }
            
            modal.style.display = 'flex';
        }

        function closePlanModal() {
            document.getElementById('planModal').style.display = 'none';
        }

        async function startCheckout(planCode) {
            const btn = document.getElementById('planModalBtn');
            const originalText = btn.textContent;
            btn.textContent = 'Processing...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/billing/checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-Token': sessionToken
                    },
                    body: JSON.stringify({ plan_code: planCode })
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Failed to create checkout');
                }
                
                const data = await response.json();
                
                if (data.checkout_url) {
                    window.location.href = data.checkout_url;
                } else if (data.success) {
                    closePlanModal();
                    alert('Your plan has been updated successfully!');
                    loadPlans();
                }
            } catch (error) {
                console.error('Checkout error:', error);
                alert('Failed to start checkout: ' + error.message);
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        async function cancelSubscription() {
            const btn = document.getElementById('planModalBtn');
            const originalText = btn.textContent;
            btn.textContent = 'Cancelling...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/billing/cancel', {
                    method: 'POST',
                    headers: { 'X-User-Token': sessionToken }
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Failed to cancel subscription');
                }
                
                closePlanModal();
                alert('Your subscription has been cancelled. It will remain active until the end of your billing period.');
                loadPlans();
            } catch (error) {
                console.error('Cancel error:', error);
                alert('Failed to cancel subscription: ' + error.message);
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        async function openBillingPortal() {
            try {
                const response = await fetch('/billing/portal', {
                    method: 'POST',
                    headers: { 'X-User-Token': sessionToken }
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Failed to open billing portal');
                }
                
                const data = await response.json();
                if (data.portal_url) {
                    window.location.href = data.portal_url;
                }
            } catch (error) {
                console.error('Portal error:', error);
                alert('Failed to open billing portal: ' + error.message);
            }
        }

        async function logout() {
            try {
                await fetch('/users/signout', {
                    method: 'POST',
                    headers: { 'X-User-Token': sessionToken }
                });
            } catch (e) {}

            localStorage.removeItem('userSession');
            window.location.href = '/users';
        }

        async function loadAlertSettings() {
            try {
                const response = await fetch('/users/settings', {
                    headers: { 'X-User-Token': sessionToken }
                });

                if (!response.ok) throw new Error('Failed to load settings');

                userSettings = await response.json();
                renderAlertSettings();
            } catch (error) {
                console.error('Error loading alert settings:', error);
                document.getElementById('currentSettingsList').innerHTML = 
                    '<p style="color: #f87171;">Failed to load settings</p>';
            }
        }

        function renderSettingsFromDashboard(settings) {
            userSettings = {
                plan: settings.plan,
                allowed_alert_types: settings.allowed_alert_types,
                max_regions: settings.max_regions,
                current_region_count: settings.current_region_count,
                available_regions: settings.available_regions,
                settings: settings.items
            };
            renderAlertSettings();
        }

        function renderPlans(plans) {
            const grid = document.getElementById('plansGrid');
            if (!grid) return;
            
            const planOrder = ['free', 'personal', 'trader', 'pro', 'enterprise'];
            plans.sort((a, b) => planOrder.indexOf(a.plan_code) - planOrder.indexOf(b.plan_code));
            
            const currentPlan = currentUser?.plan || 'free';
            const currentPlanIndex = planOrder.indexOf(currentPlan);

            grid.innerHTML = plans.map(plan => {
                const planIndex = planOrder.indexOf(plan.plan_code);
                const isCurrent = plan.plan_code === currentPlan;
                const isUpgrade = planIndex > currentPlanIndex;
                const isDowngrade = planIndex < currentPlanIndex && plan.plan_code !== 'free';
                const isFree = plan.plan_code === 'free';
                
                let btnClass = 'plan-btn';
                let btnText = '';
                let btnDisabled = '';
                
                if (isCurrent) {
                    btnClass += ' current';
                    btnText = 'Current Plan';
                    btnDisabled = 'disabled';
                } else if (isUpgrade) {
                    btnClass += ' upgrade';
                    btnText = `Upgrade to ${plan.display_name}`;
                } else if (isDowngrade || (isFree && currentPlan !== 'free')) {
                    btnClass += ' downgrade';
                    btnText = `Downgrade to ${plan.display_name}`;
                }
                
                const features = plan.features ? [
                    ...(['pro', 'enterprise'].includes(plan.plan_code) ? ['Real-Time GERI'] : []),
                    ...(plan.plan_code === 'enterprise' ? ['Current RERI'] : []),
                    `${plan.features.max_email_alerts_per_day} email alerts/day`,
                    ...(['pro', 'enterprise'].includes(plan.plan_code) ? ['Live Telegram Alerts'] : []),
                    `${plan.features.max_regions === -1 ? 'Unlimited' : plan.features.max_regions} regions`,
                    `${plan.features.alert_types?.length || 0} alert types`
                ] : [];
                
                return `
                    <div class="plan-card ${isCurrent ? 'current' : ''}">
                        <div class="plan-name">${plan.display_name}</div>
                        <div class="plan-price">${plan.price > 0 ? '€' + plan.price.toFixed(2) : 'Free'}<span>${plan.price > 0 ? '/mo' : ''}</span></div>
                        <ul class="plan-features">
                            ${features.map(f => `<li>${f}</li>`).join('')}
                        </ul>
                        <button class="${btnClass}" 
                                ${btnDisabled}
                                onclick="openPlanModal('${plan.plan_code}', '${plan.display_name}', ${plan.price}, '${isUpgrade ? 'upgrade' : 'downgrade'}')">
                            ${btnText}
                        </button>
                    </div>
                `;
            }).join('');
        }

        function renderAlertSettings() {
            if (!userSettings) return;

            const plan = userSettings.plan || 'free';
            const planDisplay = plan.charAt(0).toUpperCase() + plan.slice(1);
            const maxRegions = userSettings.max_regions === -1 ? 'Unlimited' : userSettings.max_regions;
            const regionCountText = userSettings.max_regions === -1 
                ? `${userSettings.current_region_count}` 
                : `${userSettings.current_region_count} / ${userSettings.max_regions}`;

            document.getElementById('settingsPlanBadge').textContent = planDisplay;
            document.getElementById('settingsPlanBadge').className = 'stat-badge ' + plan;
            document.getElementById('settingsRegionCount').textContent = regionCountText;

            const typeSelect = document.getElementById('newAlertType');
            typeSelect.innerHTML = '<option value="">Select alert type...</option>';
            userSettings.allowed_alert_types.forEach(type => {
                const displayName = type.replace(/_/g, ' ');
                typeSelect.innerHTML += `<option value="${type}">${displayName}</option>`;
            });

            const regionSelect = document.getElementById('newAlertRegion');
            regionSelect.innerHTML = '<option value="">Select region...</option>';
            if (userSettings.max_regions === -1) {
                regionSelect.innerHTML += '<option value="__all__">All Regions (Unlimited)</option>';
            }
            userSettings.available_regions.forEach(region => {
                regionSelect.innerHTML += `<option value="${region}">${region}</option>`;
            });

            const listContainer = document.getElementById('currentSettingsList');
            const noSettingsMsg = document.getElementById('noSettingsMessage');

            if (!userSettings.settings || userSettings.settings.length === 0) {
                listContainer.innerHTML = '';
                noSettingsMsg.style.display = 'block';
                return;
            }

            noSettingsMsg.style.display = 'none';
            listContainer.innerHTML = userSettings.settings.map(setting => `
                <div class="info-row" style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <span class="type-badge" style="background: rgba(59, 130, 246, 0.2); color: #60a5fa;">
                            ${setting.alert_type.replace(/_/g, ' ')}
                        </span>
                        <span style="color: #f1f5f9; font-weight: 500;">
                            ${setting.region || 'All Regions'}
                        </span>
                        ${setting.enabled ? 
                            '<span style="color: #4ade80; font-size: 12px;">Active</span>' : 
                            '<span style="color: #64748b; font-size: 12px;">Disabled</span>'
                        }
                    </div>
                    <button class="filter-btn secondary" onclick="deleteSetting(${setting.id})" 
                            style="padding: 6px 12px; font-size: 12px;">
                        Remove
                    </button>
                </div>
            `).join('');
        }

        async function addAlertSetting() {
            const alertType = document.getElementById('newAlertType').value;
            let region = document.getElementById('newAlertRegion').value;
            const errorEl = document.getElementById('addSettingError');

            if (!alertType) {
                errorEl.textContent = 'Please select an alert type';
                errorEl.style.display = 'block';
                return;
            }

            if (!region) {
                errorEl.textContent = 'Please select a region';
                errorEl.style.display = 'block';
                return;
            }

            if (region === '__all__') {
                region = null;
            }

            errorEl.style.display = 'none';

            try {
                const response = await fetch('/users/settings', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-User-Token': sessionToken 
                    },
                    body: JSON.stringify({
                        alert_type: alertType,
                        region: region,
                        enabled: true
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Failed to add setting');
                }

                document.getElementById('newAlertType').value = '';
                document.getElementById('newAlertRegion').value = '';
                
                await loadAlertSettings();
            } catch (error) {
                errorEl.textContent = error.message;
                errorEl.style.display = 'block';
            }
        }

        async function deleteSetting(settingId) {
            if (!confirm('Are you sure you want to remove this alert setting?')) return;

            try {
                const response = await fetch(`/users/settings/${settingId}`, {
                    method: 'DELETE',
                    headers: { 'X-User-Token': sessionToken }
                });

                if (!response.ok) throw new Error('Failed to delete setting');

                await loadAlertSettings();
            } catch (error) {
                alert('Failed to remove setting. Please try again.');
            }
        }

        window.onerror = function(msg, url, line, col, error) {
            console.error('Global error:', msg, 'at', url, 'line', line);
            document.getElementById('recentAlerts').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">&#9888;</div>
                    <p>An error occurred. Please refresh the page.</p>
                </div>
            `;
            return false;
        };

        try {
            if (checkSession()) {
                loadDashboard().catch(function(err) {
                    console.error('Dashboard load error:', err);
                    document.getElementById('recentAlerts').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">&#9888;</div>
                            <p>Failed to load dashboard. Please refresh the page.</p>
                        </div>
                    `;
                });
            }
        } catch (initError) {
            console.error('Initialization error:', initError);
            document.getElementById('recentAlerts').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">&#9888;</div>
                    <p>Failed to initialize. Please refresh the page.</p>
                </div>
            `;
        }

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('billing') === 'success') {
            const expectedPlan = urlParams.get('plan');
            window.history.replaceState({}, document.title, '/users/account');
            
            async function waitForPlanUpdate(expectedPlan, maxAttempts = 10) {
                const statusEl = document.createElement('div');
                statusEl.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#1e293b;border:1px solid #3b82f6;border-radius:12px;padding:24px 32px;z-index:9999;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,0.4);';
                statusEl.innerHTML = '<div style="font-size:18px;font-weight:600;color:#e2e8f0;margin-bottom:8px;">Activating your plan...</div><div style="color:#94a3b8;font-size:14px;">Please wait while we confirm your upgrade</div>';
                document.body.appendChild(statusEl);
                
                for (let i = 0; i < maxAttempts; i++) {
                    try {
                        const response = await fetch('/users/me', {
                            headers: { 'X-User-Token': sessionToken }
                        });
                        if (response.ok) {
                            const user = await response.json();
                            if (!expectedPlan || user.plan === expectedPlan) {
                                statusEl.remove();
                                await loadDashboard();
                                alert('Payment successful! Your plan has been upgraded to ' + (user.plan || 'your new plan').charAt(0).toUpperCase() + (user.plan || '').slice(1) + '.\n\nPlease visit the Settings tab to configure your alert preferences.');
                                return;
                            }
                        }
                    } catch (e) {
                        console.error('Plan check error:', e);
                    }
                    await new Promise(r => setTimeout(r, 1500));
                }
                
                statusEl.remove();
                await loadDashboard();
                alert('Payment successful! Your plan upgrade is being processed.\n\nIf your plan does not update within a few minutes, please refresh the page.');
            }
            
            waitForPlanUpdate(expectedPlan);
        } else if (urlParams.get('billing') === 'cancelled') {
            window.history.replaceState({}, document.title, '/users/account');
        }
    </script>

    <!-- Plan Upgrade/Downgrade Modal -->
    <div id="planModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <button class="modal-close" onclick="closePlanModal()">&times;</button>
            <h2 id="planModalTitle" class="modal-title">Upgrade Plan</h2>
            <div id="planModalBody" class="modal-body">
            </div>
            <div class="modal-actions">
                <button class="plan-btn secondary" onclick="closePlanModal()">Cancel</button>
                <button id="planModalBtn" class="plan-btn upgrade">Confirm</button>
            </div>
        </div>
    </div>

    <style>
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: #1e293b;
            border-radius: 16px;
            padding: 32px;
            max-width: 480px;
            width: 90%;
            position: relative;
            border: 1px solid #334155;
        }
        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 24px;
            cursor: pointer;
        }
        .modal-close:hover {
            color: #f1f5f9;
        }
        .modal-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 16px;
            color: #f1f5f9;
        }
        .modal-body {
            color: #cbd5e1;
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 24px;
        }
        .modal-body strong {
            color: #f1f5f9;
        }
        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        .plan-btn.secondary {
            background: transparent;
            border: 1px solid #475569;
            color: #94a3b8;
        }
        .plan-btn.secondary:hover {
            background: #334155;
            color: #f1f5f9;
        }
        .plan-btn.downgrade {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        .plan-btn.downgrade:hover {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        }
    </style>
<!-- GERI Interpretation Modal -->
    <div id="interpretationModal" class="interpretation-modal-overlay" onclick="closeInterpretationModal(event)">
        <div class="interpretation-modal-content" onclick="event.stopPropagation()">
            <button class="interpretation-modal-close" onclick="closeInterpretationModal()">&times;</button>
            <h2 class="interpretation-modal-title">GERI Interpretation</h2>
            <div id="interpretationModalBody" class="interpretation-modal-body"></div>
        </div>
    </div>

    <script>
        function openInterpretationModal() {
            const modal = document.getElementById('interpretationModal');
            const body = document.getElementById('interpretationModalBody');
            if (modal && body && window.fullGeriInterpretation) {
                body.innerHTML = '"' + window.fullGeriInterpretation + '"';
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeInterpretationModal(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('interpretationModal');
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeInterpretationModal();
            }
        });
    </script>
</body>
</html>
