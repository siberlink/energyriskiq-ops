<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZDXY4E2P1N"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-ZDXY4E2P1N');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account - EnergyRiskIQ</title>
    <link rel="canonical" href="https://energyriskiq.com/users/account">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
        }

        .header {
            background: #1e293b;
            border-bottom: 1px solid #334155;
            padding: 0 24px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-logo {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-badge {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }

        .user-email {
            font-size: 14px;
            font-weight: 500;
        }

        .logout-btn {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #f87171;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        .sidebar {
            position: fixed;
            top: 64px;
            left: 0;
            bottom: 0;
            width: 260px;
            background: #1e293b;
            border-right: 1px solid #334155;
            padding: 24px 16px;
            overflow-y: auto;
        }

        .sidebar-section {
            margin-bottom: 32px;
        }

        .sidebar-title {
            font-size: 11px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0 12px;
            margin-bottom: 12px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            color: #94a3b8;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 4px;
            text-decoration: none;
        }

        .nav-item:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #e2e8f0;
        }

        .nav-item.active {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .main {
            margin-left: 260px;
            margin-top: 64px;
            padding: 32px;
            min-height: calc(100vh - 64px);
        }

        .page-header {
            margin-bottom: 32px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: #f1f5f9;
            margin-bottom: 8px;
        }

        .page-subtitle {
            color: #94a3b8;
            font-size: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 24px;
        }

        .stat-label {
            font-size: 13px;
            color: #94a3b8;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #f1f5f9;
        }

        .stat-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
        }

        .stat-badge.free {
            background: rgba(100, 116, 139, 0.2);
            color: #94a3b8;
        }

        .stat-badge.personal {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        .stat-badge.trader {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        .stat-badge.pro {
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
        }

        .stat-badge.enterprise {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }

        .content-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 24px;
        }

        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid #334155;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #f1f5f9;
        }

        .card-body {
            padding: 24px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid #334155;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-size: 14px;
            color: #94a3b8;
        }

        .info-value {
            font-size: 14px;
            color: #f1f5f9;
            font-weight: 500;
        }

        .alerts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .sample-card {
            background: #1e293b;
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid #334155;
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .sample-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 8px 10px -6px rgba(0, 0, 0, 0.2);
            border-color: rgba(59, 130, 246, 0.4);
        }

        .card-timestamp {
            background: linear-gradient(135deg, #334155, #475569);
            color: #e2e8f0;
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-timestamp svg {
            width: 14px;
            height: 14px;
            opacity: 0.7;
        }

        .card-timestamp .latest-badge {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 10px;
            text-transform: uppercase;
            margin-left: auto;
        }

        .sample-card .card-header {
            padding: 1.25rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            border-bottom: 1px solid #334155;
            background: transparent;
        }

        .alert-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .alert-icon svg {
            width: 24px;
            height: 24px;
        }

        .alert-icon.regional {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1));
            color: #fbbf24;
        }

        .alert-icon.asset {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.1));
            color: #60a5fa;
        }

        .alert-icon.high-impact {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));
            color: #f87171;
        }

        .alert-icon.digest {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(139, 92, 246, 0.1));
            color: #a78bfa;
        }

        .card-header-text h3 {
            font-size: 1rem;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 0.25rem;
        }

        .card-header-text .type-badge {
            display: inline-block;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            background: rgba(100, 116, 139, 0.3);
            color: #94a3b8;
        }

        .sample-card .card-body {
            padding: 1.25rem 1.5rem;
            flex: 1;
        }

        .alert-content {
            background: #0f172a;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Mono', monospace;
            font-size: 0.8rem;
            line-height: 1.6;
            color: #94a3b8;
            white-space: pre-wrap;
            overflow-x: auto;
            max-height: 280px;
            overflow-y: auto;
        }

        .sample-card .card-footer {
            padding: 1rem 1.5rem;
            background: rgba(15, 23, 42, 0.5);
            border-top: 1px solid #334155;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .channel-badge {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .channel-badge.email {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        .channel-badge.telegram {
            background: rgba(0, 136, 204, 0.2);
            color: #38bdf8;
        }

        .channel-badge.sms {
            background: rgba(16, 185, 129, 0.2);
            color: #4ade80;
        }

        .sample-card .card-footer span {
            font-size: 0.8rem;
            color: #64748b;
        }

        .sample-card.locked {
            opacity: 0.6;
            filter: grayscale(30%);
        }

        .sample-card.locked .alert-content {
            filter: blur(3px);
        }

        .card-lock-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px 20px;
            background: linear-gradient(180deg, transparent 0%, rgba(139, 92, 246, 0.15) 100%);
            border-top: 1px solid rgba(139, 92, 246, 0.2);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #a78bfa;
        }

        .lock-icon {
            font-size: 14px;
        }

        .alert-filters {
            display: flex;
            gap: 16px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-label {
            font-size: 13px;
            color: #94a3b8;
            font-weight: 500;
        }

        .filter-input {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 13px;
            color: #e2e8f0;
            font-family: inherit;
        }

        .filter-input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .filter-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .filter-btn.secondary {
            background: rgba(100, 116, 139, 0.2);
            color: #94a3b8;
        }

        .filter-btn.secondary:hover {
            background: rgba(100, 116, 139, 0.3);
            box-shadow: none;
            transform: none;
        }

        .filter-toggle {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid #334155;
            background: #1e293b;
            color: #94a3b8;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-toggle:hover {
            border-color: #3b82f6;
            color: #e2e8f0;
        }

        .filter-toggle.active {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .filter-toggle-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-divider {
            width: 1px;
            height: 24px;
            background: #334155;
            margin: 0 8px;
        }

        @media (max-width: 768px) {
            .alert-filters {
                flex-direction: column;
                align-items: flex-start;
            }
            .filter-divider {
                display: none;
            }
            .filter-toggle-group {
                width: 100%;
            }
        }

        .upgrade-sidebar-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(59, 130, 246, 0.15) 100%);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }

        .upgrade-sidebar-title {
            font-size: 14px;
            font-weight: 600;
            color: #a78bfa;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .upgrade-sidebar-text {
            font-size: 12px;
            color: #94a3b8;
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .upgrade-sidebar-btn {
            width: 100%;
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            border: none;
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upgrade-sidebar-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        .upgrade-banner-small {
            margin-top: 12px;
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 10px;
            font-size: 13px;
            color: #a78bfa;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .alert-types-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 16px;
        }

        .alert-type-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            border-radius: 8px;
            background: #1e293b;
            border: 1px solid #334155;
        }

        .alert-type-item.allowed {
            border-color: rgba(34, 197, 94, 0.3);
            background: rgba(34, 197, 94, 0.05);
        }

        .alert-type-item.locked {
            border-color: #334155;
            opacity: 0.6;
        }

        .alert-type-icon {
            font-size: 16px;
        }

        .alert-type-item.allowed .alert-type-icon {
            color: #4ade80;
        }

        .alert-type-item.locked .alert-type-icon {
            color: #64748b;
        }

        .alert-type-name {
            font-size: 13px;
            font-weight: 500;
            flex: 1;
        }

        .upgrade-hint {
            font-size: 11px;
            color: #a78bfa;
            background: rgba(139, 92, 246, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
        }

        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .upgrade-banner {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .upgrade-content h3 {
            font-size: 18px;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 8px;
        }

        .upgrade-content p {
            color: #94a3b8;
            font-size: 14px;
        }

        .upgrade-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }

        .upgrade-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .section-content {
            display: none;
        }

        .section-content.active {
            display: block;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 60px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #334155;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .plans-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .plan-card {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 24px;
            position: relative;
        }

        .plan-card.current {
            border-color: #3b82f6;
        }

        .plan-card.current::before {
            content: 'Current Plan';
            position: absolute;
            top: -10px;
            left: 20px;
            background: #3b82f6;
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 4px 12px;
            border-radius: 4px;
        }

        .plan-name {
            font-size: 20px;
            font-weight: 700;
            color: #f1f5f9;
            margin-bottom: 8px;
        }

        .plan-price {
            font-size: 32px;
            font-weight: 700;
            color: #22c55e;
            margin-bottom: 16px;
        }

        .plan-price span {
            font-size: 14px;
            color: #64748b;
            font-weight: 400;
        }

        .plan-features {
            list-style: none;
            margin-bottom: 24px;
        }

        .plan-features li {
            padding: 8px 0;
            font-size: 13px;
            color: #94a3b8;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .plan-features li::before {
            content: '\\2713';
            color: #22c55e;
            font-weight: bold;
        }

        .plan-btn {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .plan-btn.current {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #60a5fa;
        }

        .plan-btn.upgrade {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border: none;
            color: white;
        }

        /* Mobile Menu Toggle Button */
        .mobile-menu-btn {
            display: none;
            background: transparent;
            border: none;
            color: #e2e8f0;
            cursor: pointer;
            padding: 8px;
            margin-right: 8px;
        }

        .mobile-menu-btn svg {
            width: 24px;
            height: 24px;
        }

        /* Mobile Overlay */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 64px;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 89;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* Tablet Responsive (768px) */
        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }

            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 90;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main {
                margin-left: 0;
                padding: 24px 16px;
            }

            .header {
                padding: 0 16px;
            }

            .user-email {
                display: none;
            }

            .page-title {
                font-size: 24px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .stat-card {
                padding: 16px;
            }

            .stat-value {
                font-size: 24px;
            }

            .alerts-grid {
                grid-template-columns: 1fr;
            }

            .plans-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }

            .upgrade-banner {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }

            .card-header {
                padding: 16px;
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .card-body {
                padding: 16px;
            }

            .info-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
        }

        /* Mobile Responsive (576px) */
        @media (max-width: 576px) {
            .header-badge {
                display: none;
            }

            .header-logo {
                font-size: 18px;
            }

            .logout-btn {
                padding: 6px 12px;
                font-size: 12px;
            }

            .user-avatar {
                width: 32px;
                height: 32px;
                font-size: 12px;
            }

            .main {
                padding: 16px 12px;
            }

            .page-header {
                margin-bottom: 20px;
            }

            .page-title {
                font-size: 20px;
            }

            .page-subtitle {
                font-size: 13px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .stat-card {
                padding: 16px;
            }

            .stat-label {
                font-size: 12px;
            }

            .stat-value {
                font-size: 28px;
            }

            .content-card {
                border-radius: 8px;
            }

            .card-title {
                font-size: 16px;
            }

            .plans-grid {
                grid-template-columns: 1fr;
            }

            .plan-card {
                padding: 20px;
            }

            .plan-name {
                font-size: 18px;
            }

            .plan-price {
                font-size: 28px;
            }

            .sample-card .card-header {
                padding: 1rem;
            }

            .alert-icon {
                width: 40px;
                height: 40px;
            }

            .alert-icon svg {
                width: 20px;
                height: 20px;
            }

            .card-header-text h3 {
                font-size: 14px;
            }

            .card-header-text p {
                font-size: 11px;
            }

            .sample-card .card-body {
                padding: 1rem;
            }

            .card-actions {
                flex-direction: column;
            }

            .card-actions .btn {
                width: 100%;
                justify-content: center;
            }

            .upgrade-banner {
                padding: 16px;
            }

            .upgrade-content h3 {
                font-size: 16px;
            }

            .upgrade-content p {
                font-size: 13px;
            }

            .upgrade-btn {
                width: 100%;
                padding: 12px 20px;
            }

            .nav-item {
                padding: 14px 12px;
                font-size: 15px;
            }

            .sidebar {
                width: 280px;
                padding: 20px 12px;
            }
        }

        /* Small Mobile (400px) */
        @media (max-width: 400px) {
            .header {
                padding: 0 12px;
            }

            .header-logo {
                font-size: 16px;
            }

            .main {
                padding: 12px 10px;
            }

            .stat-value {
                font-size: 24px;
            }

            .plan-price {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Toggle menu">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="3" y1="6" x2="21" y2="6"/>
                    <line x1="3" y1="12" x2="21" y2="12"/>
                    <line x1="3" y1="18" x2="21" y2="18"/>
                </svg>
            </button>
            <a href="/" style="text-decoration: none;">
                <span class="header-logo">EnergyRiskIQ</span>
            </a>
            <span class="header-badge" id="planBadge">Free</span>
        </div>
        <div class="header-right">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">U</div>
                <span class="user-email" id="userEmail">Loading...</span>
            </div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </header>

    <div class="sidebar-overlay" onclick="closeMobileMenu()"></div>
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-section">
            <div class="sidebar-title">Account</div>
            <a class="nav-item active" onclick="showSection('dashboard'); closeMobileMenu();">
                <span class="nav-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="9" rx="1"/>
                        <rect x="14" y="3" width="7" height="5" rx="1"/>
                        <rect x="14" y="12" width="7" height="9" rx="1"/>
                        <rect x="3" y="16" width="7" height="5" rx="1"/>
                    </svg>
                </span>
                Dashboard
            </a>
            <a class="nav-item" onclick="showSection('alerts'); closeMobileMenu();">
                <span class="nav-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                    </svg>
                </span>
                My Alerts
            </a>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-title">Subscription</div>
            <a class="nav-item" onclick="showSection('plans'); closeMobileMenu();">
                <span class="nav-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                </span>
                Upgrade Plan
            </a>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-title">Settings</div>
            <a class="nav-item" onclick="showSection('settings'); closeMobileMenu();">
                <span class="nav-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                </span>
                Settings
            </a>
        </div>

        <div id="upgradeSidebarCard" class="upgrade-sidebar-card" style="display: none;">
            <div class="upgrade-sidebar-title">
                <span>&#9889;</span> Unlock More Alerts
            </div>
            <p class="upgrade-sidebar-text">
                Get real-time alerts, asset risk tracking, and priority notifications with an upgraded plan.
            </p>
            <button class="upgrade-sidebar-btn" onclick="showSection('plans'); closeMobileMenu();">
                View Upgrade Options
            </button>
        </div>
    </nav>

    <main class="main">
        <!-- Dashboard Section -->
        <div class="section-content active" id="section-dashboard">
            <div class="page-header">
                <h1 class="page-title">Welcome back!</h1>
                <p class="page-subtitle">Your energy risk intelligence dashboard</p>
            </div>

            <div id="upgradeBanner" class="upgrade-banner" style="display: none;">
                <div class="upgrade-content">
                    <h3>Upgrade to unlock more features</h3>
                    <p>Get real-time alerts, asset risk tracking, and more with a paid plan.</p>
                </div>
                <button class="upgrade-btn" onclick="showSection('plans')">View Plans</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Current Plan</div>
                    <div class="stat-value" id="currentPlan">Free</div>
                    <span class="stat-badge free" id="planBadgeCard">Free Tier</span>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Alerts Received</div>
                    <div class="stat-value" id="alertsCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Member Since</div>
                    <div class="stat-value" id="memberSince">--</div>
                </div>
            </div>

            <div class="content-card">
                <div class="card-header">
                    <h2 class="card-title">Recent Alerts</h2>
                </div>
                <div class="card-body" id="recentAlerts">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alerts Section -->
        <div class="section-content" id="section-alerts">
            <div class="page-header">
                <h1 class="page-title">My Alerts</h1>
                <p class="page-subtitle">View your alert history and available alert types</p>
            </div>

            <div class="content-card">
                <div class="card-header">
                    <h2 class="card-title">Your Alert Types</h2>
                </div>
                <div class="card-body">
                    <p style="color: #94a3b8; font-size: 14px; margin-bottom: 12px;">
                        Based on your current plan, you have access to the following alert types:
                    </p>
                    <div class="alert-types-grid" id="alertTypesInfo">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>
            </div>

            <div class="content-card" style="margin-top: 24px;">
                <div class="card-header">
                    <h2 class="card-title">Alert History (Last 24 Hours)</h2>
                </div>
                <div class="card-body">
                    <div class="alert-filters">
                        <div class="filter-group">
                            <span class="filter-label">From:</span>
                            <input type="date" id="filterFromDate" class="filter-input">
                            <input type="time" id="filterFromTime" class="filter-input" style="width: 100px;">
                        </div>
                        <div class="filter-group">
                            <span class="filter-label">To:</span>
                            <input type="date" id="filterToDate" class="filter-input">
                            <input type="time" id="filterToTime" class="filter-input" style="width: 100px;">
                        </div>
                        <div class="filter-divider"></div>
                        <div class="filter-group">
                            <span class="filter-label">Region:</span>
                            <select id="filterRegion" class="filter-input" style="min-width: 120px;">
                                <option value="">All Regions</option>
                                <option value="europe">Europe</option>
                                <option value="north_america">North America</option>
                                <option value="asia">Asia</option>
                                <option value="middle_east">Middle East</option>
                                <option value="global">Global</option>
                            </select>
                        </div>
                        <div class="filter-divider"></div>
                        <div class="filter-toggle-group">
                            <button type="button" class="filter-toggle active" id="filterOil" onclick="toggleFilter('Oil')">Oil</button>
                            <button type="button" class="filter-toggle active" id="filterGas" onclick="toggleFilter('Gas')">Gas</button>
                            <button type="button" class="filter-toggle active" id="filterFX" onclick="toggleFilter('FX')">FX</button>
                        </div>
                        <div class="filter-divider"></div>
                        <button class="filter-btn" onclick="applyFilters()">Apply</button>
                        <button class="filter-btn secondary" onclick="resetFilters()">Reset</button>
                    </div>
                    <div id="allAlerts">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="content-card" style="margin-top: 24px; display: none;" id="lockedSamplesSection">
            </div>
        </div>

        <!-- Plans Section -->
        <div class="section-content" id="section-plans">
            <div class="page-header">
                <h1 class="page-title">Upgrade Your Plan</h1>
                <p class="page-subtitle">Choose the plan that fits your needs</p>
            </div>

            <div class="plans-grid" id="plansGrid">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div class="section-content" id="section-settings">
            <div class="page-header">
                <h1 class="page-title">Settings</h1>
                <p class="page-subtitle">Manage your account settings</p>
            </div>

            <div class="content-card">
                <div class="card-header">
                    <h2 class="card-title">Account Information</h2>
                </div>
                <div class="card-body" id="accountInfo">
                    <div class="info-row">
                        <span class="info-label">Email</span>
                        <span class="info-value" id="settingsEmail">--</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Plan</span>
                        <span class="info-value" id="settingsPlan">--</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Account Created</span>
                        <span class="info-value" id="settingsCreated">--</span>
                    </div>
                </div>
            </div>

            <div class="content-card" style="margin-top: 24px;">
                <div class="card-header">
                    <h2 class="card-title">Telegram Notifications</h2>
                </div>
                <div class="card-body">
                    <div id="telegramNotAvailable" style="display: none;">
                        <p style="color: #94a3b8; font-size: 14px; margin-bottom: 16px;">
                            Telegram notifications are available on Trader, Pro, and Enterprise plans.
                        </p>
                        <a href="#" onclick="showSection('plans')" class="filter-btn" style="text-decoration: none; display: inline-block;">
                            Upgrade to Enable
                        </a>
                    </div>
                    
                    <div id="telegramLinked" style="display: none;">
                        <div class="info-row">
                            <span class="info-label">Status</span>
                            <span class="info-value" style="color: #4ade80;">
                                <span style="display: inline-block; width: 8px; height: 8px; background: #4ade80; border-radius: 50%; margin-right: 8px;"></span>
                                Connected
                            </span>
                        </div>
                        <div style="margin-top: 16px;">
                            <button class="filter-btn secondary" onclick="unlinkTelegram()">
                                Unlink Telegram
                            </button>
                        </div>
                    </div>
                    
                    <div id="telegramNotLinked" style="display: none;">
                        <p style="color: #94a3b8; font-size: 14px; margin-bottom: 16px;">
                            Link your Telegram account to receive instant alerts on your phone.
                        </p>
                        
                        <div id="telegramLinkStep1">
                            <button class="filter-btn" onclick="generateTelegramCode()">
                                Link Telegram Account
                            </button>
                        </div>
                        
                        <div id="telegramLinkStep2" style="display: none;">
                            <div style="background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                                <p style="color: #94a3b8; font-size: 13px; margin-bottom: 12px;">Step 1: Open Telegram and search for</p>
                                <p style="font-size: 18px; font-weight: 600; color: #60a5fa; margin-bottom: 16px;">@<span id="telegramBotUsername">EnergyRiskIQBot</span></p>
                                
                                <p style="color: #94a3b8; font-size: 13px; margin-bottom: 12px;">Step 2: Send this code to the bot</p>
                                <div style="background: #0f172a; border: 2px dashed #3b82f6; border-radius: 8px; padding: 16px; text-align: center;">
                                    <span id="telegramLinkCode" style="font-size: 28px; font-weight: 700; letter-spacing: 4px; color: #f1f5f9;">--------</span>
                                </div>
                                <p style="color: #64748b; font-size: 12px; margin-top: 12px; text-align: center;">
                                    Code expires in <span id="telegramCodeExpiry">15</span> minutes
                                </p>
                            </div>
                            
                            <button class="filter-btn secondary" onclick="cancelTelegramLink()">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alert Settings Section -->
            <div class="content-card" style="margin-top: 24px;">
                <div class="card-header">
                    <h2 class="card-title">Alert Preferences</h2>
                </div>
                <div class="card-body">
                    <p style="color: #94a3b8; font-size: 14px; margin-bottom: 16px;">
                        Configure which alerts you want to receive based on your plan.
                    </p>
                    
                    <div id="alertSettingsInfo" style="margin-bottom: 20px;">
                        <div style="display: flex; gap: 24px; flex-wrap: wrap; margin-bottom: 16px;">
                            <div>
                                <span style="color: #64748b; font-size: 13px;">Plan:</span>
                                <span id="settingsPlanBadge" class="stat-badge" style="margin-left: 8px;">--</span>
                            </div>
                            <div>
                                <span style="color: #64748b; font-size: 13px;">Regions Used:</span>
                                <span id="settingsRegionCount" style="color: #f1f5f9; font-weight: 600; margin-left: 8px;">0 / 1</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Add New Setting Form -->
                    <div style="background: #0f172a; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                        <h3 style="font-size: 15px; font-weight: 600; color: #f1f5f9; margin-bottom: 16px;">Add Alert Setting</h3>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end;">
                            <div style="flex: 1; min-width: 180px;">
                                <label style="display: block; font-size: 13px; color: #94a3b8; margin-bottom: 6px;">Alert Type</label>
                                <select id="newAlertType" class="filter-input" style="width: 100%;">
                                    <option value="">Select alert type...</option>
                                </select>
                            </div>
                            <div style="flex: 1; min-width: 180px;">
                                <label style="display: block; font-size: 13px; color: #94a3b8; margin-bottom: 6px;">Region</label>
                                <select id="newAlertRegion" class="filter-input" style="width: 100%;">
                                    <option value="">Select region...</option>
                                </select>
                            </div>
                            <button class="filter-btn" onclick="addAlertSetting()" style="height: 38px;">
                                Add Setting
                            </button>
                        </div>
                        <p id="addSettingError" style="color: #f87171; font-size: 13px; margin-top: 12px; display: none;"></p>
                    </div>
                    
                    <!-- Current Settings List -->
                    <div>
                        <h3 style="font-size: 15px; font-weight: 600; color: #f1f5f9; margin-bottom: 16px;">Your Active Settings</h3>
                        <div id="currentSettingsList">
                            <div class="loading"><div class="spinner"></div></div>
                        </div>
                        <div id="noSettingsMessage" style="display: none; text-align: center; padding: 32px; color: #64748b;">
                            <p style="font-size: 14px;">No alert settings configured yet.</p>
                            <p style="font-size: 13px; margin-top: 8px;">Add a setting above to start receiving alerts.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let sessionToken = null;
        let currentUser = null;
        let allAlerts = [];
        let userSettings = null;

        // Mobile Menu Functions
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        }

        function closeMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
        }

        function checkSession() {
            try {
                const session = localStorage.getItem('userSession');
                if (!session) {
                    window.location.href = '/users';
                    return false;
                }

                const data = JSON.parse(session);
                if (!data || !data.token || !data.expires) {
                    localStorage.removeItem('userSession');
                    window.location.href = '/users';
                    return false;
                }
                
                if (data.expires < Date.now()) {
                    localStorage.removeItem('userSession');
                    window.location.href = '/users';
                    return false;
                }

                sessionToken = data.token;
                return true;
            } catch (error) {
                console.error('Session check error:', error);
                localStorage.removeItem('userSession');
                window.location.href = '/users';
                return false;
            }
        }

        async function loadDashboard() {
            console.log('loadDashboard started, sessionToken:', sessionToken ? 'present' : 'missing');
            const controller = new AbortController();
            const timeout = setTimeout(() => {
                console.log('Dashboard request timed out after 15s');
                controller.abort();
            }, 15000);
            
            try {
                const startTime = performance.now();
                console.log('Making API calls...');
                
                const [dashboardResponse, plansResponse] = await Promise.all([
                    fetch('/users/dashboard?alerts_limit=100', {
                        headers: { 'X-User-Token': sessionToken },
                        signal: controller.signal
                    }),
                    fetch('/billing/plans', { signal: controller.signal })
                ]);
                
                clearTimeout(timeout);
                console.log('API responses received:', dashboardResponse.status, plansResponse.status);

                if (!dashboardResponse.ok) {
                    if (dashboardResponse.status === 401) {
                        localStorage.removeItem('userSession');
                        window.location.href = '/users';
                        return;
                    }
                    throw new Error('Failed to load dashboard');
                }

                const dashboard = await dashboardResponse.json();
                
                currentUser = dashboard.user;
                allAlerts = dashboard.alerts.items || [];
                userSettings = dashboard.settings;
                allowedAlertTypes = dashboard.alerts.allowed_types || [];
                
                updateUI();
                initializeFilters();
                renderAlerts(allAlerts, allowedAlertTypes);
                renderAllowedAlertTypes(allowedAlertTypes, dashboard.alerts.locked_types || []);
                renderLockedSamples(dashboard.alerts.locked_samples || []);
                renderSettingsFromDashboard(dashboard.settings);
                
                if (plansResponse.ok) {
                    const plansData = await plansResponse.json();
                    renderPlans(plansData.plans || []);
                }
                
                console.log(`Dashboard loaded in ${(performance.now() - startTime).toFixed(0)}ms`);
            } catch (error) {
                clearTimeout(timeout);
                console.error('Error loading dashboard:', error);
                
                const errorMessage = error.name === 'AbortError' 
                    ? 'Request timed out. Please check your connection and refresh the page.'
                    : 'Failed to load alerts. Please refresh the page or try again later.';
                
                document.getElementById('recentAlerts').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">&#9888;</div>
                        <p>${errorMessage}</p>
                    </div>
                `;
                document.getElementById('allAlerts').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">&#9888;</div>
                        <p>${errorMessage}</p>
                    </div>
                `;
            }
        }

        async function loadUserData() {
            try {
                const response = await fetch('/users/me', {
                    headers: { 'X-User-Token': sessionToken }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('userSession');
                        window.location.href = '/users';
                        return;
                    }
                    throw new Error('Failed to load user');
                }

                currentUser = await response.json();
                updateUI();
                loadAlerts();
            } catch (error) {
                console.error('Error loading user:', error);
            }
        }

        function updateUI() {
            if (!currentUser) return;

            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('userAvatar').textContent = currentUser.email.charAt(0).toUpperCase();

            const plan = currentUser.plan || 'free';
            const planDisplay = plan.charAt(0).toUpperCase() + plan.slice(1);

            document.getElementById('planBadge').textContent = planDisplay;
            document.getElementById('planBadge').className = 'header-badge';

            document.getElementById('currentPlan').textContent = planDisplay;
            document.getElementById('planBadgeCard').textContent = planDisplay + ' Tier';
            document.getElementById('planBadgeCard').className = 'stat-badge ' + plan;

            if (currentUser.created_at) {
                const date = new Date(currentUser.created_at);
                document.getElementById('memberSince').textContent = date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    year: 'numeric' 
                });
                document.getElementById('settingsCreated').textContent = date.toLocaleDateString();
            }

            document.getElementById('settingsEmail').textContent = currentUser.email;
            document.getElementById('settingsPlan').textContent = planDisplay;

            if (plan === 'free') {
                document.getElementById('upgradeBanner').style.display = 'flex';
            }
            
            if (plan !== 'enterprise') {
                document.getElementById('upgradeSidebarCard').style.display = 'block';
            }
            
            updateTelegramUI();
        }

        function updateTelegramUI() {
            if (!currentUser) return;
            
            const plan = currentUser.plan || 'free';
            const telegramEnabled = ['trader', 'pro', 'enterprise'].includes(plan);
            const isLinked = !!currentUser.telegram_chat_id;
            
            document.getElementById('telegramNotAvailable').style.display = telegramEnabled ? 'none' : 'block';
            document.getElementById('telegramLinked').style.display = (telegramEnabled && isLinked) ? 'block' : 'none';
            document.getElementById('telegramNotLinked').style.display = (telegramEnabled && !isLinked) ? 'block' : 'none';
        }

        async function generateTelegramCode() {
            try {
                const response = await fetch('/users/telegram/generate-code', {
                    method: 'POST',
                    headers: { 'X-User-Token': sessionToken }
                });
                
                if (!response.ok) {
                    const err = await response.json().catch(() => ({}));
                    throw new Error(err.detail || 'Failed to generate code');
                }
                
                const data = await response.json();
                
                document.getElementById('telegramLinkCode').textContent = data.code;
                document.getElementById('telegramBotUsername').textContent = data.bot_username;
                document.getElementById('telegramCodeExpiry').textContent = data.expires_in_minutes;
                
                document.getElementById('telegramLinkStep1').style.display = 'none';
                document.getElementById('telegramLinkStep2').style.display = 'block';
                
                telegramPollCount = 0;
                setTimeout(() => {
                    checkTelegramLinked();
                }, 5000);
            } catch (error) {
                console.error('Error generating Telegram code:', error);
                alert(error.message || 'Failed to generate linking code. Please try again.');
            }
        }

        function cancelTelegramLink() {
            document.getElementById('telegramLinkStep1').style.display = 'block';
            document.getElementById('telegramLinkStep2').style.display = 'none';
        }

        let telegramPollCount = 0;
        const MAX_TELEGRAM_POLLS = 180;
        
        async function checkTelegramLinked() {
            telegramPollCount++;
            
            if (telegramPollCount > MAX_TELEGRAM_POLLS) {
                cancelTelegramLink();
                alert('Linking code expired. Please generate a new code.');
                return;
            }
            
            try {
                const response = await fetch('/users/me', {
                    headers: { 'X-User-Token': sessionToken }
                });
                
                if (response.ok) {
                    const user = await response.json();
                    if (user.telegram_chat_id) {
                        currentUser = user;
                        updateTelegramUI();
                        cancelTelegramLink();
                        telegramPollCount = 0;
                    } else if (document.getElementById('telegramLinkStep2').style.display === 'block') {
                        setTimeout(checkTelegramLinked, 5000);
                    }
                }
            } catch (error) {
                console.error('Error checking Telegram status:', error);
            }
        }

        async function unlinkTelegram() {
            if (!confirm('Are you sure you want to unlink your Telegram account?')) return;
            
            try {
                const response = await fetch('/users/telegram/unlink', {
                    method: 'POST',
                    headers: { 'X-User-Token': sessionToken }
                });
                
                if (!response.ok) throw new Error('Failed to unlink');
                
                currentUser.telegram_chat_id = null;
                updateTelegramUI();
            } catch (error) {
                console.error('Error unlinking Telegram:', error);
                alert('Failed to unlink Telegram. Please try again.');
            }
        }

        let allowedAlertTypes = [];

        async function loadAlerts() {
            try {
                const response = await fetch('/users/alerts?limit=100', {
                    headers: { 'X-User-Token': sessionToken }
                });

                if (!response.ok) throw new Error('Failed to load alerts');

                const data = await response.json();
                allowedAlertTypes = data.allowed_alert_types || [];
                const lockedTypes = data.locked_alert_types || [];
                const lockedSamples = data.locked_samples || [];
                
                allAlerts = data.alerts || [];
                
                initializeFilters();
                renderAlerts(allAlerts, allowedAlertTypes);
                renderAllowedAlertTypes(allowedAlertTypes, lockedTypes);
                renderLockedSamples(lockedSamples);
            } catch (error) {
                console.error('Error loading alerts:', error);
                document.getElementById('recentAlerts').innerHTML = '<div class="empty-state">Failed to load alerts</div>';
                document.getElementById('allAlerts').innerHTML = '<div class="empty-state">Failed to load alerts</div>';
            }
        }
        
        function initializeFilters() {
            const now = new Date();
            const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            
            document.getElementById('filterFromDate').value = yesterday.toISOString().split('T')[0];
            document.getElementById('filterFromTime').value = yesterday.toTimeString().slice(0, 5);
            document.getElementById('filterToDate').value = now.toISOString().split('T')[0];
            document.getElementById('filterToTime').value = now.toTimeString().slice(0, 5);
            document.getElementById('filterRegion').value = '';
            document.getElementById('filterOil').classList.add('active');
            document.getElementById('filterGas').classList.add('active');
            document.getElementById('filterFX').classList.add('active');
        }
        
        function toggleFilter(type) {
            const btn = document.getElementById('filter' + type);
            btn.classList.toggle('active');
        }
        
        function applyFilters() {
            const fromDate = document.getElementById('filterFromDate').value;
            const fromTime = document.getElementById('filterFromTime').value || '00:00';
            const toDate = document.getElementById('filterToDate').value;
            const toTime = document.getElementById('filterToTime').value || '23:59';
            const selectedRegion = document.getElementById('filterRegion').value;
            const showOil = document.getElementById('filterOil').classList.contains('active');
            const showGas = document.getElementById('filterGas').classList.contains('active');
            const showFX = document.getElementById('filterFX').classList.contains('active');
            
            let filtered = allAlerts;
            
            if (fromDate && toDate) {
                const fromDateTime = new Date(`${fromDate}T${fromTime}`);
                const toDateTime = new Date(`${toDate}T${toTime}`);
                filtered = filtered.filter(alert => {
                    const alertDate = new Date(alert.created_at);
                    return alertDate >= fromDateTime && alertDate <= toDateTime;
                });
            }
            
            if (selectedRegion) {
                filtered = filtered.filter(alert => {
                    const alertRegion = (alert.region || '').toLowerCase().replace(/\s+/g, '_');
                    return alertRegion === selectedRegion;
                });
            }
            
            if (!showOil || !showGas || !showFX) {
                filtered = filtered.filter(alert => {
                    const asset = (alert.asset || '').toLowerCase();
                    if (asset.includes('oil') || asset.includes('brent') || asset.includes('wti') || asset.includes('crude')) {
                        return showOil;
                    }
                    if (asset.includes('gas') || asset.includes('lng') || asset.includes('natural')) {
                        return showGas;
                    }
                    if (asset.includes('fx') || asset.includes('eur') || asset.includes('usd') || asset.includes('currency')) {
                        return showFX;
                    }
                    return true;
                });
            }
            
            renderAlertsGrid(filtered, allowedAlertTypes, document.getElementById('allAlerts'));
        }
        
        function resetFilters() {
            initializeFilters();
            renderAlerts(allAlerts, allowedAlertTypes);
        }

        function renderAllowedAlertTypes(allowedTypes, lockedTypes) {
            const allTypes = ['HIGH_IMPACT_EVENT', 'REGIONAL_RISK_SPIKE', 'ASSET_RISK_SPIKE', 'DAILY_DIGEST'];
            const container = document.getElementById('alertTypesInfo');
            if (!container) return;

            const html = allTypes.map(type => {
                const isAllowed = allowedTypes.includes(type) || allowedTypes.includes('ALL');
                const displayName = type.replace(/_/g, ' ');
                return `
                    <div class="alert-type-item ${isAllowed ? 'allowed' : 'locked'}">
                        <span class="alert-type-icon">${isAllowed ? '&#10003;' : '&#128274;'}</span>
                        <span class="alert-type-name">${displayName}</span>
                        ${!isAllowed ? '<span class="upgrade-hint">Upgrade to unlock</span>' : ''}
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }
        
        function renderLockedSamples(lockedSamples) {
            const container = document.getElementById('lockedSamplesSection');
            if (!container) return;
            
            if (lockedSamples.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            const iconSvg = {
                REGIONAL_RISK_SPIKE: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
                ASSET_RISK_SPIKE: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>',
                HIGH_IMPACT_EVENT: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>',
                DAILY_DIGEST: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>'
            };

            const iconClass = {
                REGIONAL_RISK_SPIKE: 'regional',
                ASSET_RISK_SPIKE: 'asset',
                HIGH_IMPACT_EVENT: 'high-impact',
                DAILY_DIGEST: 'digest'
            };
            
            const getTypeLabel = (type) => {
                const labels = {
                    'HIGH_IMPACT_EVENT': 'High Impact Event',
                    'REGIONAL_RISK_SPIKE': 'Regional Risk Spike',
                    'ASSET_RISK_SPIKE': 'Asset Risk Spike',
                    'DAILY_DIGEST': 'Daily Digest'
                };
                return labels[type] || type.replace(/_/g, ' ');
            };
            
            container.style.display = 'block';
            const html = `
                <div class="card-header" style="border-bottom: 1px solid #334155;">
                    <h2 class="card-title" style="color: #f59e0b;">
                        <span style="margin-right: 8px;">&#128274;</span>
                        Upgrade to Unlock More Alerts
                    </h2>
                </div>
                <div class="card-body">
                    <p style="color: #94a3b8; margin-bottom: 20px;">Here's a preview of alerts available on higher plans:</p>
                    <div class="alerts-grid">
                        ${lockedSamples.map(sample => {
                            const alertType = sample.alert_type || 'REGIONAL_RISK_SPIKE';
                            const icon = iconSvg[alertType] || iconSvg.REGIONAL_RISK_SPIKE;
                            const iconCls = iconClass[alertType] || 'regional';
                            return `
                                <div class="sample-card locked">
                                    <div class="card-timestamp">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        ${formatDate(sample.created_at)}
                                    </div>
                                    <div class="card-header">
                                        <div class="alert-icon ${iconCls}">
                                            ${icon}
                                        </div>
                                        <div class="card-header-text">
                                            <h3>${sample.title || 'Alert Preview'}</h3>
                                            <span class="type-badge">${getTypeLabel(alertType)}</span>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="alert-content">${sample.preview || 'Upgrade to see full alert content'}</div>
                                    </div>
                                    <div class="card-footer">
                                        <span>${sample.region || ''}${sample.asset ? ' - ' + sample.asset.toUpperCase() : ''}</span>
                                    </div>
                                    <div class="card-lock-overlay">
                                        <span class="lock-icon">&#128274;</span>
                                        <span>Upgrade your plan to unlock</span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            container.innerHTML = html;
        }

        function cleanAlertMessage(message) {
            if (!message) return '';
            return message
                .replace(/Upgrade to \w+ for.*?https:\/\/energyriskiq\.com\/upgrade/gi, '')
                .replace(/https:\/\/energyriskiq\.com\/upgrade/gi, '')
                .trim();
        }
        
        function isLatestAlert(createdAt) {
            if (!createdAt) return false;
            const alertTime = new Date(createdAt);
            const now = new Date();
            const threeHoursAgo = new Date(now.getTime() - 3 * 60 * 60 * 1000);
            return alertTime >= threeHoursAgo;
        }
        
        function filterLast24Hours(alerts) {
            const now = new Date();
            const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            return alerts.filter(alert => {
                const alertDate = new Date(alert.created_at);
                return alertDate >= yesterday;
            });
        }
        
        function filterLast3Hours(alerts) {
            const now = new Date();
            const threeHoursAgo = new Date(now.getTime() - 3 * 60 * 60 * 1000);
            return alerts.filter(alert => {
                const alertDate = new Date(alert.created_at);
                return alertDate >= threeHoursAgo;
            });
        }
        
        function renderAlerts(alerts, allowedTypes) {
            const last24h = filterLast24Hours(alerts);
            const last3h = filterLast3Hours(alerts);
            document.getElementById('alertsCount').textContent = last24h.length;

            if (last3h.length === 0) {
                document.getElementById('recentAlerts').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">&#128276;</div>
                        <p>No alerts in the last 3 hours. Check the Alerts section for older activity.</p>
                    </div>
                `;
            } else {
                renderAlertsGrid(last3h.slice(0, 4), allowedTypes, document.getElementById('recentAlerts'));
            }

            if (last24h.length === 0) {
                document.getElementById('allAlerts').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">&#128276;</div>
                        <p>No alerts in the last 24 hours. You'll see alerts here once they're triggered.</p>
                    </div>
                `;
            } else {
                renderAlertsGrid(last24h, allowedTypes, document.getElementById('allAlerts'));
            }
        }
        
        function renderAlertsGrid(alerts, allowedTypes, container) {
            if (alerts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">&#128276;</div>
                        <p>No alerts match your filter criteria.</p>
                    </div>
                `;
                return;
            }
            
            const iconSvg = {
                REGIONAL_RISK_SPIKE: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
                ASSET_RISK_SPIKE: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>',
                HIGH_IMPACT_EVENT: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>',
                DAILY_DIGEST: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>'
            };

            const iconClass = {
                REGIONAL_RISK_SPIKE: 'regional',
                ASSET_RISK_SPIKE: 'asset',
                HIGH_IMPACT_EVENT: 'high-impact',
                DAILY_DIGEST: 'digest'
            };
            
            const getTypeLabel = (type) => {
                const labels = {
                    'HIGH_IMPACT_EVENT': 'High Impact Event',
                    'REGIONAL_RISK_SPIKE': 'Regional Risk Spike',
                    'ASSET_RISK_SPIKE': 'Asset Risk Spike',
                    'DAILY_DIGEST': 'Daily Digest'
                };
                return labels[type] || type.replace(/_/g, ' ');
            };
            
            const alertCardHTML = (alert) => {
                const isAllowed = alert.allowed_by_plan;
                const isLatest = isLatestAlert(alert.created_at);
                const alertType = alert.alert_type || 'REGIONAL_RISK_SPIKE';
                const icon = iconSvg[alertType] || iconSvg.REGIONAL_RISK_SPIKE;
                const iconCls = iconClass[alertType] || 'regional';
                const channel = alert.channel || 'email';
                
                return `
                    <div class="sample-card ${!isAllowed ? 'locked' : ''}">
                        <div class="card-timestamp">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            ${formatDate(alert.created_at)}
                            ${isLatest ? '<span class="latest-badge">Latest</span>' : ''}
                        </div>
                        <div class="card-header">
                            <div class="alert-icon ${iconCls}">
                                ${icon}
                            </div>
                            <div class="card-header-text">
                                <h3>${alert.title || 'Alert'}</h3>
                                <span class="type-badge">${getTypeLabel(alertType)}</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="alert-content">${alert.message || 'No message content'}</div>
                        </div>
                        <div class="card-footer">
                            <span class="channel-badge ${channel}">${channel.toUpperCase()}</span>
                            <span>${alert.region || ''}${alert.asset ? ' - ' + alert.asset.toUpperCase() : ''}</span>
                        </div>
                        ${!isAllowed ? `
                            <div class="card-lock-overlay">
                                <span class="lock-icon">&#128274;</span>
                                <span>Available on higher tier plans</span>
                            </div>
                        ` : ''}
                    </div>
                `;
            };

            container.innerHTML = `
                <div class="alerts-grid">
                    ${alerts.map(alert => alertCardHTML(alert)).join('')}
                </div>
            `;
        }

        function formatDate(isoString) {
            if (!isoString) return '--';
            const date = new Date(isoString);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section-content').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            document.getElementById('section-' + sectionId).classList.add('active');
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }

            if (sectionId === 'plans') {
                loadPlans();
            } else if (sectionId === 'settings') {
                loadAlertSettings();
            }
        }

        async function loadPlans() {
            const grid = document.getElementById('plansGrid');
            
            try {
                const response = await fetch('/billing/plans');
                const data = await response.json();
                const plans = data.plans || [];
                
                const planOrder = ['free', 'personal', 'trader', 'pro', 'enterprise'];
                plans.sort((a, b) => planOrder.indexOf(a.plan_code) - planOrder.indexOf(b.plan_code));
                
                const currentPlan = currentUser?.plan || 'free';
                const currentPlanIndex = planOrder.indexOf(currentPlan);

                grid.innerHTML = plans.map(plan => {
                    const planIndex = planOrder.indexOf(plan.plan_code);
                    const isCurrent = plan.plan_code === currentPlan;
                    const isUpgrade = planIndex > currentPlanIndex;
                    const isDowngrade = planIndex < currentPlanIndex && plan.plan_code !== 'free';
                    const isFree = plan.plan_code === 'free';
                    
                    let btnClass = 'plan-btn';
                    let btnText = '';
                    let btnDisabled = '';
                    
                    if (isCurrent) {
                        btnClass += ' current';
                        btnText = 'Current Plan';
                        btnDisabled = 'disabled';
                    } else if (isUpgrade) {
                        btnClass += ' upgrade';
                        btnText = `Upgrade to ${plan.display_name}`;
                    } else if (isDowngrade || (isFree && currentPlan !== 'free')) {
                        btnClass += ' downgrade';
                        btnText = `Downgrade to ${plan.display_name}`;
                    }
                    
                    const features = plan.features ? [
                        `${plan.features.max_email_alerts_per_day} email alerts/day`,
                        `${plan.features.max_regions === -1 ? 'Unlimited' : plan.features.max_regions} regions`,
                        `${plan.features.alert_types?.length || 0} alert types`
                    ] : [];
                    
                    return `
                        <div class="plan-card ${isCurrent ? 'current' : ''}">
                            <div class="plan-name">${plan.display_name}</div>
                            <div class="plan-price">${plan.price > 0 ? '' + plan.price.toFixed(2) : 'Free'}<span>${plan.price > 0 ? '/mo' : ''}</span></div>
                            <ul class="plan-features">
                                ${features.map(f => `<li>${f}</li>`).join('')}
                            </ul>
                            <button class="${btnClass}" 
                                    ${btnDisabled}
                                    onclick="openPlanModal('${plan.plan_code}', '${plan.display_name}', ${plan.price}, '${isUpgrade ? 'upgrade' : 'downgrade'}')">
                                ${btnText}
                            </button>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading plans:', error);
                grid.innerHTML = '<p style="color: #f87171;">Failed to load plans</p>';
            }
        }

        function openPlanModal(planCode, planName, price, action) {
            const modal = document.getElementById('planModal');
            const modalTitle = document.getElementById('planModalTitle');
            const modalBody = document.getElementById('planModalBody');
            const modalBtn = document.getElementById('planModalBtn');
            
            const planLimits = {
                'free': { regions: 1, types: ['HIGH_IMPACT_EVENT'] },
                'personal': { regions: 2, types: ['HIGH_IMPACT_EVENT', 'REGIONAL_RISK_SPIKE'] },
                'trader': { regions: 3, types: ['HIGH_IMPACT_EVENT', 'REGIONAL_RISK_SPIKE', 'ASSET_RISK_SPIKE'] },
                'pro': { regions: 4, types: ['HIGH_IMPACT_EVENT', 'REGIONAL_RISK_SPIKE', 'ASSET_RISK_SPIKE', 'DAILY_DIGEST'] },
                'enterprise': { regions: -1, types: ['HIGH_IMPACT_EVENT', 'REGIONAL_RISK_SPIKE', 'ASSET_RISK_SPIKE', 'DAILY_DIGEST'] }
            };
            
            const limits = planLimits[planCode] || planLimits['free'];
            const regionsText = limits.regions === -1 ? 'Unlimited regions' : `${limits.regions} region${limits.regions > 1 ? 's' : ''}`;
            const typesText = limits.types.map(t => t.replace(/_/g, ' ')).join(', ');
            
            const settingsNote = `
                <div style="background: #1e3a5f; border: 1px solid #3b82f6; border-radius: 8px; padding: 12px; margin-top: 16px;">
                    <p style="color: #60a5fa; font-weight: 600; margin-bottom: 8px;">Plan Includes:</p>
                    <ul style="color: #94a3b8; margin: 0; padding-left: 20px; font-size: 13px;">
                        <li>${regionsText}</li>
                        <li>Alert types: ${typesText}</li>
                    </ul>
                    <p style="color: #fbbf24; font-size: 12px; margin-top: 12px; margin-bottom: 0;">
                        After changing your plan, visit the Settings tab to adjust your alert preferences.
                    </p>
                </div>
            `;
            
            if (planCode === 'free') {
                modalTitle.textContent = 'Downgrade to Free';
                modalBody.innerHTML = `
                    <p>Are you sure you want to downgrade to the Free plan?</p>
                    <p style="color: #94a3b8; margin-top: 12px;">Your current plan benefits will remain active until the end of your billing period.</p>
                    <p style="color: #f87171; margin-top: 12px; font-size: 13px;">
                        <strong>Note:</strong> Your current alert settings that exceed Free plan limits will be automatically adjusted.
                    </p>
                    ${settingsNote}
                `;
                modalBtn.textContent = 'Downgrade to Free';
                modalBtn.className = 'plan-btn downgrade';
                modalBtn.onclick = () => cancelSubscription();
            } else {
                const actionText = action === 'upgrade' ? 'Upgrade' : 'Downgrade';
                modalTitle.textContent = `${actionText} to ${planName}`;
                modalBody.innerHTML = `
                    <p>You are about to ${action} to the <strong>${planName}</strong> plan.</p>
                    <div style="background: #1e293b; border-radius: 8px; padding: 16px; margin: 16px 0;">
                        <div style="font-size: 24px; font-weight: 700; color: #f1f5f9;">${price.toFixed(2)}<span style="font-size: 14px; color: #94a3b8;">/month</span></div>
                    </div>
                    ${action === 'upgrade' ? '<p style="color: #4ade80;">Your new plan will be activated immediately.</p>' : '<p style="color: #fbbf24;">Changes will take effect at the end of your current billing period. Settings exceeding the new plan limits will be adjusted.</p>'}
                    ${settingsNote}
                `;
                modalBtn.textContent = `${actionText} to ${planName}`;
                modalBtn.className = action === 'upgrade' ? 'plan-btn upgrade' : 'plan-btn downgrade';
                modalBtn.onclick = () => startCheckout(planCode);
            }
            
            modal.style.display = 'flex';
        }

        function closePlanModal() {
            document.getElementById('planModal').style.display = 'none';
        }

        async function startCheckout(planCode) {
            const btn = document.getElementById('planModalBtn');
            const originalText = btn.textContent;
            btn.textContent = 'Processing...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/billing/checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-Token': sessionToken
                    },
                    body: JSON.stringify({ plan_code: planCode })
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Failed to create checkout');
                }
                
                const data = await response.json();
                
                if (data.checkout_url) {
                    window.location.href = data.checkout_url;
                } else if (data.success) {
                    closePlanModal();
                    alert('Your plan has been updated successfully!');
                    loadPlans();
                }
            } catch (error) {
                console.error('Checkout error:', error);
                alert('Failed to start checkout: ' + error.message);
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        async function cancelSubscription() {
            const btn = document.getElementById('planModalBtn');
            const originalText = btn.textContent;
            btn.textContent = 'Cancelling...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/billing/cancel', {
                    method: 'POST',
                    headers: { 'X-User-Token': sessionToken }
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Failed to cancel subscription');
                }
                
                closePlanModal();
                alert('Your subscription has been cancelled. It will remain active until the end of your billing period.');
                loadPlans();
            } catch (error) {
                console.error('Cancel error:', error);
                alert('Failed to cancel subscription: ' + error.message);
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        async function openBillingPortal() {
            try {
                const response = await fetch('/billing/portal', {
                    method: 'POST',
                    headers: { 'X-User-Token': sessionToken }
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Failed to open billing portal');
                }
                
                const data = await response.json();
                if (data.portal_url) {
                    window.location.href = data.portal_url;
                }
            } catch (error) {
                console.error('Portal error:', error);
                alert('Failed to open billing portal: ' + error.message);
            }
        }

        async function logout() {
            try {
                await fetch('/users/signout', {
                    method: 'POST',
                    headers: { 'X-User-Token': sessionToken }
                });
            } catch (e) {}

            localStorage.removeItem('userSession');
            window.location.href = '/users';
        }

        async function loadAlertSettings() {
            try {
                const response = await fetch('/users/settings', {
                    headers: { 'X-User-Token': sessionToken }
                });

                if (!response.ok) throw new Error('Failed to load settings');

                userSettings = await response.json();
                renderAlertSettings();
            } catch (error) {
                console.error('Error loading alert settings:', error);
                document.getElementById('currentSettingsList').innerHTML = 
                    '<p style="color: #f87171;">Failed to load settings</p>';
            }
        }

        function renderSettingsFromDashboard(settings) {
            userSettings = {
                plan: settings.plan,
                allowed_alert_types: settings.allowed_alert_types,
                max_regions: settings.max_regions,
                current_region_count: settings.current_region_count,
                available_regions: settings.available_regions,
                settings: settings.items
            };
            renderAlertSettings();
        }

        function renderPlans(plans) {
            const grid = document.getElementById('plansGrid');
            if (!grid) return;
            
            const planOrder = ['free', 'personal', 'trader', 'pro', 'enterprise'];
            plans.sort((a, b) => planOrder.indexOf(a.plan_code) - planOrder.indexOf(b.plan_code));
            
            const currentPlan = currentUser?.plan || 'free';
            const currentPlanIndex = planOrder.indexOf(currentPlan);

            grid.innerHTML = plans.map(plan => {
                const planIndex = planOrder.indexOf(plan.plan_code);
                const isCurrent = plan.plan_code === currentPlan;
                const isUpgrade = planIndex > currentPlanIndex;
                const isDowngrade = planIndex < currentPlanIndex && plan.plan_code !== 'free';
                const isFree = plan.plan_code === 'free';
                
                let btnClass = 'plan-btn';
                let btnText = '';
                let btnDisabled = '';
                
                if (isCurrent) {
                    btnClass += ' current';
                    btnText = 'Current Plan';
                    btnDisabled = 'disabled';
                } else if (isUpgrade) {
                    btnClass += ' upgrade';
                    btnText = `Upgrade to ${plan.display_name}`;
                } else if (isDowngrade || (isFree && currentPlan !== 'free')) {
                    btnClass += ' downgrade';
                    btnText = `Downgrade to ${plan.display_name}`;
                }
                
                const features = plan.features ? [
                    `${plan.features.max_email_alerts_per_day} email alerts/day`,
                    `${plan.features.max_regions === -1 ? 'Unlimited' : plan.features.max_regions} regions`,
                    `${plan.features.alert_types?.length || 0} alert types`
                ] : [];
                
                return `
                    <div class="plan-card ${isCurrent ? 'current' : ''}">
                        <div class="plan-name">${plan.display_name}</div>
                        <div class="plan-price">${plan.price > 0 ? '' + plan.price.toFixed(2) : 'Free'}<span>${plan.price > 0 ? '/mo' : ''}</span></div>
                        <ul class="plan-features">
                            ${features.map(f => `<li>${f}</li>`).join('')}
                        </ul>
                        <button class="${btnClass}" 
                                ${btnDisabled}
                                onclick="openPlanModal('${plan.plan_code}', '${plan.display_name}', ${plan.price}, '${isUpgrade ? 'upgrade' : 'downgrade'}')">
                            ${btnText}
                        </button>
                    </div>
                `;
            }).join('');
        }

        function renderAlertSettings() {
            if (!userSettings) return;

            const plan = userSettings.plan || 'free';
            const planDisplay = plan.charAt(0).toUpperCase() + plan.slice(1);
            const maxRegions = userSettings.max_regions === -1 ? 'Unlimited' : userSettings.max_regions;
            const regionCountText = userSettings.max_regions === -1 
                ? `${userSettings.current_region_count}` 
                : `${userSettings.current_region_count} / ${userSettings.max_regions}`;

            document.getElementById('settingsPlanBadge').textContent = planDisplay;
            document.getElementById('settingsPlanBadge').className = 'stat-badge ' + plan;
            document.getElementById('settingsRegionCount').textContent = regionCountText;

            const typeSelect = document.getElementById('newAlertType');
            typeSelect.innerHTML = '<option value="">Select alert type...</option>';
            userSettings.allowed_alert_types.forEach(type => {
                const displayName = type.replace(/_/g, ' ');
                typeSelect.innerHTML += `<option value="${type}">${displayName}</option>`;
            });

            const regionSelect = document.getElementById('newAlertRegion');
            regionSelect.innerHTML = '<option value="">Select region...</option>';
            if (userSettings.max_regions === -1) {
                regionSelect.innerHTML += '<option value="__all__">All Regions (Unlimited)</option>';
            }
            userSettings.available_regions.forEach(region => {
                regionSelect.innerHTML += `<option value="${region}">${region}</option>`;
            });

            const listContainer = document.getElementById('currentSettingsList');
            const noSettingsMsg = document.getElementById('noSettingsMessage');

            if (!userSettings.settings || userSettings.settings.length === 0) {
                listContainer.innerHTML = '';
                noSettingsMsg.style.display = 'block';
                return;
            }

            noSettingsMsg.style.display = 'none';
            listContainer.innerHTML = userSettings.settings.map(setting => `
                <div class="info-row" style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <span class="type-badge" style="background: rgba(59, 130, 246, 0.2); color: #60a5fa;">
                            ${setting.alert_type.replace(/_/g, ' ')}
                        </span>
                        <span style="color: #f1f5f9; font-weight: 500;">
                            ${setting.region || 'All Regions'}
                        </span>
                        ${setting.enabled ? 
                            '<span style="color: #4ade80; font-size: 12px;">Active</span>' : 
                            '<span style="color: #64748b; font-size: 12px;">Disabled</span>'
                        }
                    </div>
                    <button class="filter-btn secondary" onclick="deleteSetting(${setting.id})" 
                            style="padding: 6px 12px; font-size: 12px;">
                        Remove
                    </button>
                </div>
            `).join('');
        }

        async function addAlertSetting() {
            const alertType = document.getElementById('newAlertType').value;
            let region = document.getElementById('newAlertRegion').value;
            const errorEl = document.getElementById('addSettingError');

            if (!alertType) {
                errorEl.textContent = 'Please select an alert type';
                errorEl.style.display = 'block';
                return;
            }

            if (!region) {
                errorEl.textContent = 'Please select a region';
                errorEl.style.display = 'block';
                return;
            }

            if (region === '__all__') {
                region = null;
            }

            errorEl.style.display = 'none';

            try {
                const response = await fetch('/users/settings', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-User-Token': sessionToken 
                    },
                    body: JSON.stringify({
                        alert_type: alertType,
                        region: region,
                        enabled: true
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Failed to add setting');
                }

                document.getElementById('newAlertType').value = '';
                document.getElementById('newAlertRegion').value = '';
                
                await loadAlertSettings();
            } catch (error) {
                errorEl.textContent = error.message;
                errorEl.style.display = 'block';
            }
        }

        async function deleteSetting(settingId) {
            if (!confirm('Are you sure you want to remove this alert setting?')) return;

            try {
                const response = await fetch(`/users/settings/${settingId}`, {
                    method: 'DELETE',
                    headers: { 'X-User-Token': sessionToken }
                });

                if (!response.ok) throw new Error('Failed to delete setting');

                await loadAlertSettings();
            } catch (error) {
                alert('Failed to remove setting. Please try again.');
            }
        }

        window.onerror = function(msg, url, line, col, error) {
            console.error('Global error:', msg, 'at', url, 'line', line);
            document.getElementById('recentAlerts').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">&#9888;</div>
                    <p>An error occurred. Please refresh the page.</p>
                </div>
            `;
            return false;
        };

        try {
            if (checkSession()) {
                loadDashboard().catch(function(err) {
                    console.error('Dashboard load error:', err);
                    document.getElementById('recentAlerts').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">&#9888;</div>
                            <p>Failed to load dashboard. Please refresh the page.</p>
                        </div>
                    `;
                });
            }
        } catch (initError) {
            console.error('Initialization error:', initError);
            document.getElementById('recentAlerts').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">&#9888;</div>
                    <p>Failed to initialize. Please refresh the page.</p>
                </div>
            `;
        }

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('billing') === 'success') {
            const expectedPlan = urlParams.get('plan');
            window.history.replaceState({}, document.title, '/users/account');
            
            async function waitForPlanUpdate(expectedPlan, maxAttempts = 10) {
                const statusEl = document.createElement('div');
                statusEl.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#1e293b;border:1px solid #3b82f6;border-radius:12px;padding:24px 32px;z-index:9999;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,0.4);';
                statusEl.innerHTML = '<div style="font-size:18px;font-weight:600;color:#e2e8f0;margin-bottom:8px;">Activating your plan...</div><div style="color:#94a3b8;font-size:14px;">Please wait while we confirm your upgrade</div>';
                document.body.appendChild(statusEl);
                
                for (let i = 0; i < maxAttempts; i++) {
                    try {
                        const response = await fetch('/users/me', {
                            headers: { 'X-User-Token': sessionToken }
                        });
                        if (response.ok) {
                            const user = await response.json();
                            if (!expectedPlan || user.plan === expectedPlan) {
                                statusEl.remove();
                                await loadDashboard();
                                alert('Payment successful! Your plan has been upgraded to ' + (user.plan || 'your new plan').charAt(0).toUpperCase() + (user.plan || '').slice(1) + '.\n\nPlease visit the Settings tab to configure your alert preferences.');
                                return;
                            }
                        }
                    } catch (e) {
                        console.error('Plan check error:', e);
                    }
                    await new Promise(r => setTimeout(r, 1500));
                }
                
                statusEl.remove();
                await loadDashboard();
                alert('Payment successful! Your plan upgrade is being processed.\n\nIf your plan does not update within a few minutes, please refresh the page.');
            }
            
            waitForPlanUpdate(expectedPlan);
        } else if (urlParams.get('billing') === 'cancelled') {
            window.history.replaceState({}, document.title, '/users/account');
        }
    </script>

    <!-- Plan Upgrade/Downgrade Modal -->
    <div id="planModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <button class="modal-close" onclick="closePlanModal()">&times;</button>
            <h2 id="planModalTitle" class="modal-title">Upgrade Plan</h2>
            <div id="planModalBody" class="modal-body">
            </div>
            <div class="modal-actions">
                <button class="plan-btn secondary" onclick="closePlanModal()">Cancel</button>
                <button id="planModalBtn" class="plan-btn upgrade">Confirm</button>
            </div>
        </div>
    </div>

    <style>
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: #1e293b;
            border-radius: 16px;
            padding: 32px;
            max-width: 480px;
            width: 90%;
            position: relative;
            border: 1px solid #334155;
        }
        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 24px;
            cursor: pointer;
        }
        .modal-close:hover {
            color: #f1f5f9;
        }
        .modal-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 16px;
            color: #f1f5f9;
        }
        .modal-body {
            color: #cbd5e1;
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 24px;
        }
        .modal-body strong {
            color: #f1f5f9;
        }
        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        .plan-btn.secondary {
            background: transparent;
            border: 1px solid #475569;
            color: #94a3b8;
        }
        .plan-btn.secondary:hover {
            background: #334155;
            color: #f1f5f9;
        }
        .plan-btn.downgrade {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        .plan-btn.downgrade:hover {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        }
    </style>
</body>
</html>
