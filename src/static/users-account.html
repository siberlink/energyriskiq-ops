<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZDXY4E2P1N"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-ZDXY4E2P1N');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account - EnergyRiskIQ</title>
    <link rel="canonical" href="https://energyriskiq.com/users/account">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
        }

        .header {
            background: #1e293b;
            border-bottom: 1px solid #334155;
            padding: 0 24px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-logo {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-badge {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }

        .user-email {
            font-size: 14px;
            font-weight: 500;
        }

        .logout-btn {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #f87171;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        .sidebar {
            position: fixed;
            top: 64px;
            left: 0;
            bottom: 0;
            width: 260px;
            background: #1e293b;
            border-right: 1px solid #334155;
            padding: 24px 16px;
            overflow-y: auto;
        }

        .sidebar-section {
            margin-bottom: 32px;
        }

        .sidebar-title {
            font-size: 11px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0 12px;
            margin-bottom: 12px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            color: #94a3b8;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 4px;
            text-decoration: none;
        }

        .nav-item:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #e2e8f0;
        }

        .nav-item.active {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
        }

        .pro-badge-nav {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            font-size: 9px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: auto;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .pro-badge-nav.pro-badge-locked {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            font-size: 8px;
        }

        .pro-badge-nav.badge-free { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); }
        .pro-badge-nav.badge-personal { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .pro-badge-nav.badge-trader { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); }
        .pro-badge-nav.badge-pro { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .pro-badge-nav.badge-enterprise { background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%); }

        .eeri-plan-badge-header {
            display: inline-block;
            font-size: 11px;
            font-weight: 700;
            padding: 3px 10px;
            border-radius: 6px;
            margin-left: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: white;
            vertical-align: middle;
        }
        .eeri-plan-badge-header.badge-free { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); }
        .eeri-plan-badge-header.badge-personal { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .eeri-plan-badge-header.badge-trader { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); }
        .eeri-plan-badge-header.badge-pro { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .eeri-plan-badge-header.badge-enterprise { background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%); }

        .nav-item-disabled {
            opacity: 0.6;
            cursor: not-allowed !important;
            pointer-events: none;
        }

        .nav-item-disabled:hover {
            background: transparent !important;
            color: rgba(255, 255, 255, 0.6) !important;
        }

        .geri-upgrade-hint {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            padding: 4px 12px 8px 44px;
            margin-top: -4px;
            font-style: italic;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .main {
            margin-left: 260px;
            margin-top: 64px;
            padding: 32px;
            min-height: calc(100vh - 64px);
        }

        .page-header {
            margin-bottom: 32px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: #f1f5f9;
            margin-bottom: 8px;
        }

        .page-subtitle {
            color: #94a3b8;
            font-size: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 24px;
        }

        .stat-label {
            font-size: 13px;
            color: #94a3b8;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #f1f5f9;
        }

        .stat-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
        }

        .stat-badge.free {
            background: rgba(100, 116, 139, 0.2);
            color: #94a3b8;
        }

        .stat-badge.personal {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        .stat-badge.trader {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        .stat-badge.pro {
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
        }

        .stat-badge.enterprise {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }

        .snapshot-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }
        .snapshot-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 24px;
            cursor: pointer;
            transition: border-color 0.2s, transform 0.2s;
            display: flex;
            flex-direction: column;
            min-height: 200px;
        }
        .snapshot-card:hover {
            border-color: #60a5fa;
            transform: translateY(-2px);
        }
        .snapshot-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        .snapshot-card-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .snapshot-card-icon.geri { background: rgba(239, 68, 68, 0.15); color: #f87171; }
        .snapshot-card-icon.eeri { background: rgba(245, 158, 11, 0.15); color: #fbbf24; }
        .snapshot-card-icon.digest { background: rgba(59, 130, 246, 0.15); color: #60a5fa; }
        .snapshot-card-icon.egsi { background: rgba(16, 185, 129, 0.15); color: #34d399; }
        .snapshot-card-title {
            font-size: 16px;
            font-weight: 600;
            color: #f1f5f9;
        }
        .snapshot-card-subtitle {
            font-size: 12px;
            color: #64748b;
        }
        .snapshot-card-value {
            font-size: 36px;
            font-weight: 700;
            color: #f1f5f9;
            margin-bottom: 4px;
        }
        .snapshot-card-band {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 12px;
        }
        .band-elevated { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
        .band-high { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        .band-critical { background: rgba(220, 38, 38, 0.3); color: #fca5a5; }
        .band-low { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .band-moderate { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .band-default { background: rgba(100, 116, 139, 0.2); color: #94a3b8; }
        .snapshot-card-meta {
            margin-top: auto;
            font-size: 12px;
            color: #64748b;
        }
        .snapshot-card-trend {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            margin-bottom: 4px;
        }
        .trend-up { color: #f87171; }
        .trend-down { color: #4ade80; }
        .trend-flat { color: #94a3b8; }
        .snapshot-card-detail {
            font-size: 13px;
            color: #94a3b8;
            line-height: 1.5;
        }
        .snapshot-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
        }

        .content-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 24px;
        }

        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid #334155;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #f1f5f9;
        }

        .card-body {
            padding: 24px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid #334155;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-size: 14px;
            color: #94a3b8;
        }

        .info-value {
            font-size: 14px;
            color: #f1f5f9;
            font-weight: 500;
        }

        .alerts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .sample-card {
            background: #1e293b;
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid #334155;
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .sample-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 8px 10px -6px rgba(0, 0, 0, 0.2);
            border-color: rgba(59, 130, 246, 0.4);
        }

        .card-timestamp {
            background: linear-gradient(135deg, #334155, #475569);
            color: #e2e8f0;
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-timestamp svg {
            width: 14px;
            height: 14px;
            opacity: 0.7;
        }

        .card-timestamp .latest-badge {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 10px;
            text-transform: uppercase;
            margin-left: auto;
        }

        .sample-card .card-header {
            padding: 1.25rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            border-bottom: 1px solid #334155;
            background: transparent;
        }

        .alert-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .alert-icon svg {
            width: 24px;
            height: 24px;
        }

        .alert-icon.regional {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1));
            color: #fbbf24;
        }

        .alert-icon.asset {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.1));
            color: #60a5fa;
        }

        .alert-icon.high-impact {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));
            color: #f87171;
        }

        .alert-icon.digest {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(139, 92, 246, 0.1));
            color: #a78bfa;
        }

        .card-header-text h3 {
            font-size: 1rem;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 0.25rem;
        }

        .card-header-text .type-badge {
            display: inline-block;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            background: rgba(100, 116, 139, 0.3);
            color: #94a3b8;
        }

        .sample-card .card-body {
            padding: 1.25rem 1.5rem;
            flex: 1;
        }

        .alert-content {
            background: #0f172a;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Mono', monospace;
            font-size: 0.8rem;
            line-height: 1.6;
            color: #94a3b8;
            white-space: pre-wrap;
            overflow-x: auto;
            max-height: 280px;
            overflow-y: auto;
        }

        .sample-card .card-footer {
            padding: 1rem 1.5rem;
            background: rgba(15, 23, 42, 0.5);
            border-top: 1px solid #334155;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .channel-badge {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .channel-badge.email {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        .channel-badge.telegram {
            background: rgba(0, 136, 204, 0.2);
            color: #38bdf8;
        }

        .channel-badge.sms {
            background: rgba(16, 185, 129, 0.2);
            color: #4ade80;
        }

        .sample-card .card-footer span {
            font-size: 0.8rem;
            color: #64748b;
        }

        .sample-card.locked {
            opacity: 0.6;
            filter: grayscale(30%);
        }

        .sample-card.locked .alert-content {
            filter: blur(3px);
        }

        .card-lock-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px 20px;
            background: linear-gradient(180deg, transparent 0%, rgba(139, 92, 246, 0.15) 100%);
            border-top: 1px solid rgba(139, 92, 246, 0.2);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #a78bfa;
        }

        .lock-icon {
            font-size: 14px;
        }

        .alert-filters {
            display: flex;
            gap: 16px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-label {
            font-size: 13px;
            color: #94a3b8;
            font-weight: 500;
        }

        .filter-input {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 13px;
            color: #e2e8f0;
            font-family: inherit;
        }

        .filter-input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .filter-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .filter-btn.secondary {
            background: rgba(100, 116, 139, 0.2);
            color: #94a3b8;
        }

        .filter-btn.secondary:hover {
            background: rgba(100, 116, 139, 0.3);
            box-shadow: none;
            transform: none;
        }

        .filter-toggle {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid #334155;
            background: #1e293b;
            color: #94a3b8;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-toggle:hover {
            border-color: #3b82f6;
            color: #e2e8f0;
        }

        .filter-toggle.active {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .filter-toggle-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-divider {
            width: 1px;
            height: 24px;
            background: #334155;
            margin: 0 8px;
        }

        @media (max-width: 768px) {
            .alert-filters {
                flex-direction: column;
                align-items: flex-start;
            }
            .filter-divider {
                display: none;
            }
            .filter-toggle-group {
                width: 100%;
            }
        }

        .upgrade-sidebar-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(59, 130, 246, 0.15) 100%);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }

        .upgrade-sidebar-title {
            font-size: 14px;
            font-weight: 600;
            color: #a78bfa;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .upgrade-sidebar-text {
            font-size: 12px;
            color: #94a3b8;
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .upgrade-sidebar-btn {
            width: 100%;
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            border: none;
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upgrade-sidebar-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        /* GERI Display Styles */
        .geri-display-card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid #334155;
            border-radius: 16px;
            padding: 32px;
            text-align: center;
            max-width: 500px;
            margin: 0 auto 24px;
        }

        .geri-loading {
            padding: 40px;
            text-align: center;
        }

        .geri-loading p {
            color: #9ca3af;
            margin-top: 16px;
        }

        .geri-value-display {
            font-size: 80px;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 8px;
        }

        .geri-band-display {
            font-size: 24px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 8px;
        }

        .geri-trend-display {
            font-size: 16px;
            margin-bottom: 16px;
        }

        .geri-date-display {
            color: #9ca3af;
            font-size: 14px;
        }

        .geri-realtime-badge {
            display: inline-block;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            font-size: 12px;
            font-weight: 600;
            padding: 4px 12px;
            border-radius: 20px;
            margin-bottom: 24px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .geri-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-top: 24px;
        }

        .geri-detail-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 20px;
        }

        .geri-detail-title {
            color: #9ca3af;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .geri-detail-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .geri-detail-list li {
            color: #e2e8f0;
            font-size: 14px;
            padding: 6px 0;
            border-bottom: 1px solid #334155;
        }

        .geri-detail-list li:last-child {
            border-bottom: none;
        }

        .geri-methodology-link {
            text-align: center;
            margin-top: 24px;
        }

        .geri-methodology-link a {
            color: #60a5fa;
            text-decoration: none;
            font-size: 14px;
        }

        .geri-methodology-link a:hover {
            text-decoration: underline;
        }

        .geri-methodology-header-link {
            display: inline-block;
            color: #60a5fa;
            text-decoration: none;
            font-size: 14px;
            margin-top: 8px;
        }

        .geri-methodology-header-link:hover {
            text-decoration: underline;
        }

        /* Interpretation Preview Section */
        .geri-interpretation-preview {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 20px;
            margin-top: 24px;
        }

        .geri-interpretation-title {
            font-size: 16px;
            font-weight: 600;
            color: #60a5fa;
            margin-bottom: 12px;
        }

        .geri-interpretation-text {
            color: #9ca3af;
            font-style: italic;
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .geri-see-more-link {
            color: #3b82f6;
            text-decoration: none;
            font-size: 14px;
            cursor: pointer;
        }

        .geri-see-more-link:hover {
            text-decoration: underline;
        }

        .geri-trader-intel-section {
            margin-top: 24px;
        }
        .geri-trader-panel {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 14px;
            padding: 22px;
            margin-bottom: 16px;
        }
        .geri-trader-panel h4 {
            font-size: 15px;
            font-weight: 600;
            color: #e2e8f0;
            margin: 0 0 4px 0;
        }
        .geri-trader-panel .gti-subtitle {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 14px;
        }
        .gti-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .gti-table th {
            text-align: left;
            color: #94a3b8;
            font-weight: 500;
            padding: 6px 10px;
            border-bottom: 1px solid #334155;
        }
        .gti-table td {
            padding: 8px 10px;
            color: #e2e8f0;
            border-bottom: 1px solid rgba(51, 65, 85, 0.4);
        }
        .gti-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .gti-badge-aligned { background: rgba(34,197,94,0.15); color: #4ade80; }
        .gti-badge-moderate { background: rgba(234,179,8,0.15); color: #facc15; }
        .gti-badge-strong { background: rgba(239,68,68,0.15); color: #f87171; }
        .gti-badge-insufficient { background: rgba(100,116,139,0.15); color: #94a3b8; }
        .gti-confirmation-score {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 0;
        }
        .gti-score-number {
            font-size: 2rem;
            font-weight: 700;
            min-width: 80px;
            text-align: center;
        }
        .gti-score-bar {
            flex: 1;
            height: 10px;
            background: #0f172a;
            border-radius: 5px;
            overflow: hidden;
        }
        .gti-score-bar-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.5s ease;
        }
        .gti-storage-card {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px 18px;
            background: #0f172a;
            border-radius: 10px;
        }
        .gti-storage-pct {
            font-size: 1.8rem;
            font-weight: 700;
            color: #10b981;
            min-width: 80px;
            text-align: center;
        }
        .gti-storage-detail {
            flex: 1;
        }
        .gti-storage-narrative {
            font-size: 13px;
            color: #e2e8f0;
        }
        .gti-storage-diff {
            font-size: 12px;
            margin-top: 4px;
        }
        .gti-regime-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            background: #0f172a;
            border-radius: 10px;
        }
        .gti-regime-arrow {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .gti-regime-text {
            font-size: 15px;
            font-weight: 600;
            color: #e2e8f0;
        }
        .gti-reaction-summary {
            padding: 14px 18px;
            background: linear-gradient(135deg, rgba(59,130,246,0.08), rgba(59,130,246,0.02));
            border: 1px solid rgba(59,130,246,0.2);
            border-radius: 10px;
            font-size: 14px;
            color: #cbd5e1;
            line-height: 1.6;
            font-style: italic;
        }
        .gti-alert-preview {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .gti-alert-preview li {
            padding: 10px 14px;
            border-bottom: 1px solid rgba(51, 65, 85, 0.4);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
        }
        .gti-alert-preview li:last-child { border-bottom: none; }
        .gti-alert-headline {
            font-size: 13px;
            color: #e2e8f0;
            flex: 1;
        }
        .gti-alert-meta {
            font-size: 11px;
            color: #64748b;
            white-space: nowrap;
        }
        .gti-alert-severity {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        .gti-sev-critical { background: rgba(239,68,68,0.15); color: #f87171; }
        .gti-sev-high { background: rgba(249,115,22,0.15); color: #fb923c; }
        .gti-sev-medium { background: rgba(234,179,8,0.15); color: #facc15; }
        .gti-sev-low { background: rgba(34,197,94,0.15); color: #4ade80; }
        .gti-upgrade-cta {
            text-align: center;
            padding: 12px;
            font-size: 12px;
            color: #64748b;
        }
        .gti-upgrade-cta a {
            color: #3b82f6;
            text-decoration: none;
            font-weight: 600;
        }
        .gti-last-updated {
            font-size: 12px;
            color: #64748b;
            text-align: right;
            margin-top: 8px;
        }

        .gti-tier-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.5px;
            margin-right: 6px;
            vertical-align: middle;
        }
        .gti-tier-pro {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: #fff;
        }
        .gti-tier-enterprise {
            background: linear-gradient(135deg, #f59e0b, #ef4444);
            color: #fff;
        }
        .gti-pro-panel {
            border-left: 3px solid #3b82f6;
        }
        .gti-enterprise-panel {
            border-left: 3px solid #f59e0b;
        }
        .gti-regime-prob-card {
            flex: 1;
            min-width: 100px;
            background: #0f172a;
            border: 1px solid #1e293b;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }
        .gti-regime-prob-label {
            font-size: 11px;
            color: #94a3b8;
            margin-bottom: 6px;
        }
        .gti-regime-prob-value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .gti-upgrade-section {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-top: 16px;
        }
        .gti-upgrade-title {
            font-size: 16px;
            font-weight: 700;
            color: #e2e8f0;
            margin-bottom: 10px;
        }
        .gti-upgrade-features {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 14px;
        }
        .gti-upgrade-features span {
            background: #1e293b;
            color: #94a3b8;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            border: 1px solid #334155;
        }
        .gti-upgrade-btn {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: #fff;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .gti-upgrade-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        /* Interpretation Modal */
        .interpretation-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .interpretation-modal-overlay.active {
            display: flex;
        }

        .interpretation-modal-content {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 16px;
            max-width: 700px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 32px;
            position: relative;
        }

        .interpretation-modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: transparent;
            border: none;
            color: #94a3b8;
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
            line-height: 1;
        }

        .interpretation-modal-close:hover {
            color: #e2e8f0;
        }

        .interpretation-modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 20px;
            padding-right: 30px;
        }

        .interpretation-modal-body {
            color: #cbd5e1;
            font-style: italic;
            line-height: 1.8;
            font-size: 15px;
            border-left: 4px solid #60a5fa;
            padding-left: 20px;
        }

        /* GERI Charts Section */
        .geri-charts-section {
            margin-top: 32px;
        }

        .geri-charts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .geri-charts-title {
            font-size: 18px;
            font-weight: 600;
            color: #f1f5f9;
        }

        .geri-charts-title span {
            font-size: 13px;
            color: #64748b;
            font-weight: 400;
        }

        .geri-chart-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .chart-range-btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid #334155;
            background: #1e293b;
            color: #94a3b8;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chart-range-btn:hover:not(:disabled) {
            border-color: #3b82f6;
            color: #e2e8f0;
        }

        .chart-range-btn.active {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .chart-range-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .chart-range-btn .tooltip-hint {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            border: 1px solid #334155;
            color: #94a3b8;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 10;
            margin-bottom: 6px;
        }

        .chart-range-btn:disabled:hover .tooltip-hint {
            display: block;
        }

        .chart-range-btn {
            position: relative;
        }

        .geri-chart-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .geri-chart-container {
            position: relative;
            height: 320px;
            width: 100%;
        }

        .geri-trend-indicators {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .trend-indicator-card {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 16px;
            text-align: center;
        }

        .trend-indicator-label {
            font-size: 12px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .trend-indicator-value {
            font-size: 24px;
            font-weight: 700;
            color: #f1f5f9;
        }

        .trend-indicator-value.positive {
            color: #f87171;
        }

        .trend-indicator-value.negative {
            color: #4ade80;
        }

        .trend-indicator-value.neutral {
            color: #94a3b8;
        }

        .trend-indicator-subtext {
            font-size: 11px;
            color: #64748b;
            margin-top: 4px;
        }

        .market-overlay-toggles {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .overlay-toggle {
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid #334155;
            background: transparent;
            color: #64748b;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .overlay-toggle:hover {
            border-color: #475569;
            color: #94a3b8;
        }

        .overlay-toggle.active {
            border-color: var(--overlay-color, #3b82f6);
            background: rgba(59, 130, 246, 0.1);
            color: var(--overlay-color, #3b82f6);
        }

        .overlay-toggle .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--overlay-color, #64748b);
        }

        .chart-zoom-hint {
            font-size: 11px;
            color: #64748b;
            text-align: right;
            margin-top: 8px;
        }

        @media (max-width: 768px) {
            .geri-charts-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .geri-chart-container {
                height: 280px;
            }

            .geri-chart-card {
                padding: 16px;
            }

            .geri-trend-indicators {
                grid-template-columns: repeat(2, 1fr);
            }

            .trend-indicator-value {
                font-size: 20px;
            }

            .market-overlay-toggles {
                justify-content: flex-start;
            }
        }

        @media (max-width: 576px) {
            .geri-chart-container {
                height: 240px;
            }

            .geri-trend-indicators {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }

            .trend-indicator-card {
                padding: 12px;
            }

            .trend-indicator-label {
                font-size: 10px;
            }

            .trend-indicator-value {
                font-size: 18px;
            }

            .chart-range-btn {
                padding: 6px 12px;
                font-size: 12px;
            }

            .overlay-toggle {
                padding: 5px 10px;
                font-size: 11px;
            }
        }

        @media (max-width: 400px) {
            .geri-chart-container {
                height: 200px;
            }

            .geri-trend-indicators {
                grid-template-columns: 1fr 1fr;
            }

            .trend-indicator-value {
                font-size: 16px;
            }
        }

        .geri-upgrade-required {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid #334155;
            border-radius: 16px;
            padding: 48px 32px;
            text-align: center;
            max-width: 500px;
            margin: 0 auto;
        }

        .geri-upgrade-required h3 {
            color: #e2e8f0;
            font-size: 20px;
            margin-bottom: 12px;
        }

        .geri-upgrade-required p {
            color: #9ca3af;
            margin-bottom: 24px;
        }

        .geri-upgrade-btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            border: none;
            padding: 12px 32px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .geri-upgrade-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        @media (max-width: 768px) {
            .geri-details-grid {
                grid-template-columns: 1fr;
            }
            .geri-value-display {
                font-size: 60px;
            }
            .geri-display-card {
                padding: 24px 16px;
            }
        }

        .geri-plan-badge {
            display: inline-block;
            font-size: 11px;
            font-weight: 700;
            padding: 3px 10px;
            border-radius: 6px;
            margin-left: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: white;
            vertical-align: middle;
        }
        .geri-plan-badge.badge-free { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); }
        .geri-plan-badge.badge-personal { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .geri-plan-badge.badge-trader { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); }
        .geri-plan-badge.badge-pro { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .geri-plan-badge.badge-enterprise { background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%); }

        .geri-delayed-badge {
            display: inline-block;
            background: linear-gradient(135deg, #eab308 0%, #ca8a04 100%);
            color: #1e293b;
            font-size: 12px;
            font-weight: 600;
            padding: 4px 12px;
            border-radius: 20px;
            margin-bottom: 24px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .geri-upgrade-prompt {
            margin-top: 16px;
            padding: 14px 18px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.08) 0%, rgba(59, 130, 246, 0.08) 100%);
            border: 1px solid rgba(139, 92, 246, 0.25);
            border-radius: 10px;
            font-size: 13px;
            color: #a78bfa;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .geri-upgrade-prompt a {
            color: #818cf8;
            text-decoration: underline;
            cursor: pointer;
            font-weight: 600;
        }

        .geri-asset-reaction {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 14px 18px;
            margin-top: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .geri-asset-reaction-icon {
            font-size: 16px;
            flex-shrink: 0;
        }
        .geri-asset-reaction-label {
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            flex-shrink: 0;
        }
        .geri-asset-reaction-text {
            font-size: 13px;
            color: #94a3b8;
            line-height: 1.5;
        }

        .geri-risk-watchlist {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 20px;
            margin-top: 16px;
        }
        .geri-risk-watchlist-title {
            font-size: 14px;
            font-weight: 600;
            color: #f59e0b;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .geri-risk-watchlist ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .geri-risk-watchlist li {
            color: #cbd5e1;
            font-size: 13px;
            line-height: 1.6;
            padding: 6px 0;
            border-bottom: 1px solid rgba(51, 65, 85, 0.4);
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        .geri-risk-watchlist li:last-child {
            border-bottom: none;
        }
        .geri-watchlist-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #f59e0b;
            flex-shrink: 0;
            margin-top: 7px;
        }

        .geri-chart-axis-label {
            position: absolute;
            bottom: 4px;
            right: 12px;
            font-size: 10px;
            color: #4b5563;
            font-style: italic;
            pointer-events: none;
            z-index: 1;
        }

        .geri-band-tooltip {
            position: relative;
            cursor: help;
        }
        .geri-band-tooltip .geri-band-tip-text {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 11px;
            color: #94a3b8;
            line-height: 1.5;
            white-space: nowrap;
            z-index: 10;
            transition: opacity 0.2s;
            pointer-events: none;
        }
        .geri-band-tooltip:hover .geri-band-tip-text {
            visibility: visible;
            opacity: 1;
        }
        @media (max-width: 640px) {
            .geri-band-tooltip .geri-band-tip-text {
                white-space: normal;
                min-width: 200px;
                left: 0;
                transform: none;
            }
        }

        .geri-simplified-drivers {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-top: 24px;
        }
        .geri-simplified-driver-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        .geri-simplified-driver-card .driver-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }
        .geri-simplified-driver-card .driver-label {
            font-size: 13px;
            color: #94a3b8;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        .geri-simplified-driver-card .driver-level {
            font-size: 16px;
            font-weight: 700;
            padding: 4px 14px;
            border-radius: 20px;
            display: inline-block;
        }
        .driver-level.level-high { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        .driver-level.level-medium { background: rgba(234, 179, 8, 0.2); color: #facc15; }
        .driver-level.level-low { background: rgba(34, 197, 94, 0.2); color: #4ade80; }

        @media (max-width: 576px) {
            .geri-simplified-drivers {
                grid-template-columns: 1fr;
            }
        }

        .geri-asset-selector {
            padding: 8px 14px;
            border-radius: 8px;
            border: 1px solid #334155;
            background: #1e293b;
            color: #e2e8f0;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            appearance: auto;
        }

        .geri-smoothing-selector {
            padding: 8px 14px;
            border-radius: 8px;
            border: 1px solid #334155;
            background: #1e293b;
            color: #e2e8f0;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            appearance: auto;
            margin-left: 8px;
        }

        .overlay-limit-toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            border: 1px solid #f59e0b;
            color: #fbbf24;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 500;
            z-index: 9999;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            transition: opacity 0.3s;
        }

        .geri-driver-severity {
            display: inline-block;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 6px;
        }
        .severity-high { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        .severity-medium { background: rgba(234, 179, 8, 0.2); color: #facc15; }
        .severity-low { background: rgba(34, 197, 94, 0.2); color: #4ade80; }

        .geri-driver-rank {
            display: inline-block;
            font-size: 11px;
            font-weight: 700;
            color: #60a5fa;
            margin-right: 6px;
        }

        .upgrade-banner-small {
            margin-top: 12px;
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 10px;
            font-size: 13px;
            color: #a78bfa;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .alert-types-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 16px;
        }

        .alert-type-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            border-radius: 8px;
            background: #1e293b;
            border: 1px solid #334155;
        }

        .alert-type-item.allowed {
            border-color: rgba(34, 197, 94, 0.3);
            background: rgba(34, 197, 94, 0.05);
        }

        .alert-type-item.locked {
            border-color: #334155;
            opacity: 0.6;
        }

        .alert-type-icon {
            font-size: 16px;
        }

        .alert-type-item.allowed .alert-type-icon {
            color: #4ade80;
        }

        .alert-type-item.locked .alert-type-icon {
            color: #64748b;
        }

        .alert-type-name {
            font-size: 13px;
            font-weight: 500;
            flex: 1;
        }

        .upgrade-hint {
            font-size: 11px;
            color: #a78bfa;
            background: rgba(139, 92, 246, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
        }

        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .upgrade-banner {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .upgrade-content h3 {
            font-size: 18px;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 8px;
        }

        .upgrade-content p {
            color: #94a3b8;
            font-size: 14px;
        }

        .upgrade-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }

        .upgrade-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .section-content {
            display: none;
        }

        .section-content.active {
            display: block;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 60px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #334155;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .plans-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .plan-card {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 24px;
            position: relative;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .plan-card.current {
            border-color: #3b82f6;
        }

        .plan-card.current::before {
            content: 'Current Plan';
            position: absolute;
            top: -10px;
            left: 20px;
            background: #3b82f6;
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 4px 12px;
            border-radius: 4px;
        }

        .plan-name {
            font-size: 20px;
            font-weight: 700;
            color: #f1f5f9;
            margin-bottom: 2px;
        }

        .plan-tagline {
            font-size: 12px;
            color: #64748b;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .delivery-prefs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
        }

        .delivery-pref-card {
            background: #0f172a;
            border: 1px solid #1e293b;
            border-radius: 12px;
            padding: 16px;
            transition: border-color 0.2s;
        }

        .delivery-pref-card:hover {
            border-color: #334155;
        }

        .delivery-pref-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 12px;
            margin-bottom: 12px;
            border-bottom: 1px solid;
            border-color: inherit;
        }

        .delivery-pref-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .delivery-pref-title {
            font-size: 15px;
            font-weight: 700;
            color: #f1f5f9;
        }

        .delivery-pref-desc {
            font-size: 12px;
            color: #64748b;
            margin-top: 2px;
        }

        .delivery-pref-channels {
            display: flex;
            gap: 16px;
        }

        .delivery-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
        }

        .delivery-toggle input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #3b82f6;
            cursor: pointer;
        }

        .delivery-toggle-label {
            font-size: 13px;
            color: #94a3b8;
        }

        .plan-price {
            font-size: 32px;
            font-weight: 700;
            color: #22c55e;
            margin-bottom: 16px;
        }

        .plan-price span {
            font-size: 14px;
            color: #64748b;
            font-weight: 400;
        }

        .plan-features {
            list-style: none;
            margin-bottom: 24px;
            flex: 1;
        }

        .plan-features li {
            padding: 5px 0;
            font-size: 12px;
            color: #94a3b8;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .plan-features li::before {
            content: '';
            color: #22c55e;
            font-weight: bold;
            flex-shrink: 0;
            margin-top: 1px;
        }

        .plan-features .pf-section {
            padding: 6px 0 2px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #cbd5e1;
            display: block;
            border-top: 1px solid #1e293b;
            margin-top: 6px;
            padding-top: 8px;
        }

        .plan-features .pf-section::before {
            display: none;
        }

        .plan-features .pf-section:first-child {
            border-top: none;
            margin-top: 0;
            padding-top: 0;
        }

        .plan-features .pf-section.pf-geri { color: #60a5fa; }
        .plan-features .pf-section.pf-eeri { color: #f59e0b; }
        .plan-features .pf-section.pf-egsi { color: #34d399; }
        .plan-features .pf-section.pf-digest { color: #a78bfa; }

        .plan-features .pf-miss {
            color: #64748b;
            text-decoration: line-through;
            opacity: 0.6;
        }

        .plan-features .pf-miss::before {
            content: '';
            color: #64748b;
        }

        .plan-btn {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: auto;
        }

        .plan-btn.current {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #60a5fa;
        }

        .plan-btn.upgrade {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border: none;
            color: white;
        }

        /* Mobile Menu Toggle Button */
        .mobile-menu-btn {
            display: none;
            background: transparent;
            border: none;
            color: #e2e8f0;
            cursor: pointer;
            padding: 8px;
            margin-right: 8px;
        }

        .mobile-menu-btn svg {
            width: 24px;
            height: 24px;
        }

        /* Mobile Overlay */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 64px;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 89;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* Tablet Responsive (768px) */
        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }

            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 90;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main {
                margin-left: 0;
                padding: 24px 16px;
            }

            .header {
                padding: 0 16px;
            }

            .user-email {
                display: none;
            }

            .page-title {
                font-size: 24px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .snapshot-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .snapshot-card {
                min-height: auto;
            }

            .stat-card {
                padding: 16px;
            }

            .stat-value {
                font-size: 24px;
            }

            .alerts-grid {
                grid-template-columns: 1fr;
            }

            .plans-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }

            .upgrade-banner {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }

            .card-header {
                padding: 16px;
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .card-body {
                padding: 16px;
            }

            .info-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
        }

        /* Mobile Responsive (576px) */
        @media (max-width: 576px) {
            .header-badge {
                display: none;
            }

            .header-logo {
                font-size: 18px;
            }

            .logout-btn {
                padding: 6px 12px;
                font-size: 12px;
            }

            .user-avatar {
                width: 32px;
                height: 32px;
                font-size: 12px;
            }

            .main {
                padding: 16px 12px;
            }

            .page-header {
                margin-bottom: 20px;
            }

            .page-title {
                font-size: 20px;
            }

            .page-subtitle {
                font-size: 13px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .stat-card {
                padding: 16px;
            }

            .stat-label {
                font-size: 12px;
            }

            .stat-value {
                font-size: 28px;
            }

            .content-card {
                border-radius: 8px;
            }

            .card-title {
                font-size: 16px;
            }

            .plans-grid {
                grid-template-columns: 1fr;
            }

            .plan-card {
                padding: 20px;
            }

            .plan-name {
                font-size: 18px;
            }

            .plan-price {
                font-size: 28px;
            }

            .sample-card .card-header {
                padding: 1rem;
            }

            .alert-icon {
                width: 40px;
                height: 40px;
            }

            .alert-icon svg {
                width: 20px;
                height: 20px;
            }

            .card-header-text h3 {
                font-size: 14px;
            }

            .card-header-text p {
                font-size: 11px;
            }

            .sample-card .card-body {
                padding: 1rem;
            }

            .card-actions {
                flex-direction: column;
            }

            .card-actions .btn {
                width: 100%;
                justify-content: center;
            }

            .upgrade-banner {
                padding: 16px;
            }

            .upgrade-content h3 {
                font-size: 16px;
            }

            .upgrade-content p {
                font-size: 13px;
            }

            .upgrade-btn {
                width: 100%;
                padding: 12px 20px;
            }

            .nav-item {
                padding: 14px 12px;
                font-size: 15px;
            }

            .sidebar {
                width: 280px;
                padding: 20px 12px;
            }
        }

        /* Small Mobile (400px) */
        @media (max-width: 400px) {
            .header {
                padding: 0 12px;
            }

            .header-logo {
                font-size: 16px;
            }

            .main {
                padding: 12px 10px;
            }

            .stat-value {
                font-size: 24px;
            }

            .plan-price {
                font-size: 24px;
            }
        }

        /* ============================================
           Daily Digest Styles
           ============================================ */
        .digest-header-bar {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 20px 24px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }
        .digest-header-bar .digest-date {
            color: #94a3b8;
            font-size: 13px;
        }
        .digest-header-bar .digest-date strong {
            color: #e2e8f0;
        }
        .digest-delayed-badge {
            background: rgba(251, 191, 36, 0.15);
            border: 1px solid rgba(251, 191, 36, 0.3);
            color: #fbbf24;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .digest-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            margin-bottom: 16px;
            overflow: hidden;
        }
        .digest-card-header {
            padding: 16px 20px;
            border-bottom: 1px solid #334155;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .digest-card-header h3 {
            font-size: 15px;
            font-weight: 600;
            color: #f1f5f9;
            margin: 0;
        }
        .digest-card-header .digest-section-icon {
            font-size: 16px;
        }
        .digest-card-body {
            padding: 20px;
        }
        .digest-risk-tone {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            border-radius: 10px;
            margin-bottom: 16px;
        }
        .digest-risk-tone.tone-red { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); }
        .digest-risk-tone.tone-orange { background: rgba(249, 115, 22, 0.1); border: 1px solid rgba(249, 115, 22, 0.3); }
        .digest-risk-tone.tone-yellow { background: rgba(234, 179, 8, 0.1); border: 1px solid rgba(234, 179, 8, 0.3); }
        .digest-risk-tone.tone-green { background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); }
        .digest-risk-tone.tone-gray { background: rgba(148, 163, 184, 0.1); border: 1px solid rgba(148, 163, 184, 0.3); }
        .digest-risk-tone .tone-label {
            font-size: 18px;
            font-weight: 700;
        }
        .digest-risk-tone.tone-red .tone-label { color: #ef4444; }
        .digest-risk-tone.tone-orange .tone-label { color: #f97316; }
        .digest-risk-tone.tone-yellow .tone-label { color: #eab308; }
        .digest-risk-tone.tone-green .tone-label { color: #22c55e; }
        .digest-risk-tone.tone-gray .tone-label { color: #94a3b8; }
        .digest-index-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }
        .digest-index-card {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 16px;
            text-align: center;
        }
        .digest-index-card .index-name {
            color: #94a3b8;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }
        .digest-index-card .index-value {
            font-size: 28px;
            font-weight: 700;
            color: #f1f5f9;
        }
        .digest-index-card .index-band {
            font-size: 11px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 4px;
            margin-top: 4px;
            display: inline-block;
        }
        .digest-index-card .index-trend {
            font-size: 12px;
            margin-top: 4px;
        }
        .digest-index-card .index-trend.up { color: #ef4444; }
        .digest-index-card .index-trend.down { color: #22c55e; }
        .digest-index-card .index-trend.flat { color: #94a3b8; }
        .digest-asset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 10px;
        }
        .digest-asset-item {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 14px;
            text-align: center;
        }
        .digest-asset-item .asset-label {
            color: #94a3b8;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        .digest-asset-item .asset-value {
            font-size: 20px;
            font-weight: 700;
            color: #f1f5f9;
        }
        .digest-asset-item .asset-change {
            font-size: 13px;
            font-weight: 600;
            margin-top: 2px;
        }
        .digest-asset-item .asset-change.positive { color: #22c55e; }
        .digest-asset-item .asset-change.negative { color: #ef4444; }
        .digest-asset-item .asset-change.neutral { color: #94a3b8; }
        .digest-alert-item {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 14px 16px;
            margin-bottom: 10px;
        }
        .digest-alert-item .alert-headline {
            font-weight: 600;
            color: #f1f5f9;
            font-size: 14px;
            margin-bottom: 6px;
        }
        .digest-alert-item .alert-meta {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            font-size: 12px;
            color: #94a3b8;
        }
        .digest-alert-item .alert-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .digest-severity-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .digest-severity-dot.sev-5 { background: #ef4444; }
        .digest-severity-dot.sev-4 { background: #f97316; }
        .digest-severity-dot.sev-3 { background: #eab308; }
        .digest-severity-dot.sev-2 { background: #3b82f6; }
        .digest-severity-dot.sev-1 { background: #22c55e; }
        .digest-narrative {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 20px;
            line-height: 1.7;
            color: #cbd5e1;
            font-size: 14px;
        }
        .digest-narrative h2 {
            color: #f1f5f9;
            font-size: 16px;
            margin: 20px 0 10px 0;
            padding-bottom: 6px;
            border-bottom: 1px solid #334155;
        }
        .digest-narrative h2:first-child {
            margin-top: 0;
        }
        .digest-narrative strong {
            color: #e2e8f0;
        }
        .digest-narrative ul, .digest-narrative ol {
            padding-left: 20px;
            margin: 8px 0;
        }
        .digest-narrative li {
            margin-bottom: 4px;
        }
        .digest-locked-section {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
            border: 1px dashed rgba(59, 130, 246, 0.3);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-bottom: 16px;
        }
        .digest-locked-section .lock-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        .digest-locked-section .lock-title {
            color: #60a5fa;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }
        .digest-locked-section .lock-desc {
            color: #94a3b8;
            font-size: 12px;
            margin-bottom: 12px;
        }
        .digest-locked-section .lock-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }
        .digest-locked-section .lock-btn:hover {
            opacity: 0.9;
        }
        .digest-correlation-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
        }
        .digest-correlation-table th,
        .digest-correlation-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #334155;
            font-size: 13px;
        }
        .digest-correlation-table th {
            color: #94a3b8;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 11px;
        }
        .digest-correlation-table td {
            color: #e2e8f0;
        }
        .digest-regime-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        @media (max-width: 768px) {
            .digest-header-bar {
                flex-direction: column;
                align-items: flex-start;
            }
            .digest-index-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .digest-asset-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* ============================================
           EERI Pro Dashboard Styles
           Encapsulated module - do not affect other sections
           ============================================ */
        
        .eeri-header-links {
            display: flex;
            gap: 24px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .eeri-methodology-header-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: #60a5fa;
            text-decoration: none;
            font-size: 14px;
            padding: 6px 12px;
            border: 1px solid #334155;
            border-radius: 6px;
            background: rgba(59, 130, 246, 0.1);
            transition: all 0.2s;
        }

        .eeri-methodology-header-link:hover {
            text-decoration: none;
            background: rgba(59, 130, 246, 0.2);
            border-color: #60a5fa;
        }

        .eeri-pro-loading {
            text-align: center;
            padding: 60px 20px;
        }

        .eeri-pro-loading p {
            color: #9ca3af;
            margin-top: 16px;
        }

        /* EERI Locked State */
        .eeri-pro-locked {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px 20px;
        }

        .eeri-locked-card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid #334155;
            border-radius: 20px;
            padding: 48px 40px;
            text-align: center;
            max-width: 520px;
        }

        .eeri-locked-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .eeri-locked-card h2 {
            color: #f1f5f9;
            font-size: 24px;
            margin-bottom: 12px;
        }

        .eeri-locked-card p {
            color: #9ca3af;
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .eeri-locked-features {
            list-style: none;
            padding: 0;
            margin: 0 0 24px 0;
            text-align: left;
        }

        .eeri-locked-features li {
            color: #e2e8f0;
            font-size: 14px;
            padding: 8px 0;
            padding-left: 28px;
            position: relative;
        }

        .eeri-locked-features li::before {
            content: "";
            position: absolute;
            left: 0;
            color: #8b5cf6;
            font-weight: 700;
        }

        .eeri-upgrade-btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            border: none;
            padding: 14px 36px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .eeri-upgrade-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
        }

        .eeri-upgrade-hint {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            padding: 4px 12px 8px 44px;
            margin-top: -4px;
            font-style: italic;
        }

        /* EERI Pro Dashboard */
        .eeri-pro-dashboard {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* Daily Summary Card */
        .eeri-summary-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 16px;
            padding: 24px;
        }

        .eeri-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .eeri-summary-label {
            color: #a78bfa;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .eeri-summary-date {
            color: #64748b;
            font-size: 13px;
        }

        .eeri-summary-text {
            color: #e2e8f0;
            font-size: 15px;
            line-height: 1.7;
            font-style: italic;
        }

        .eeri-summary-text p {
            margin: 0 0 12px 0;
        }

        .eeri-summary-text p:last-child {
            margin-bottom: 0;
        }

        .eeri-summary-meta {
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid rgba(139, 92, 246, 0.2);
        }

        .eeri-summary-drivers {
            color: #94a3b8;
            font-size: 12px;
        }

        /* Main Row */
        .eeri-main-row {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 24px;
        }

        @media (max-width: 900px) {
            .eeri-main-row {
                grid-template-columns: 1fr;
            }
        }

        /* EERI Value Card */
        .eeri-value-card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid #334155;
            border-radius: 16px;
            padding: 28px;
            text-align: center;
        }

        .eeri-value-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .eeri-value-label {
            color: #64748b;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .eeri-realtime-badge {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .eeri-value-display {
            margin-bottom: 12px;
        }

        .eeri-value-number {
            font-size: 72px;
            font-weight: 700;
            line-height: 1;
            background: linear-gradient(135deg, #f1f5f9 0%, #94a3b8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .eeri-value-band {
            display: block;
            font-size: 18px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 8px;
        }

        .eeri-value-trend {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .eeri-trend-icon {
            font-size: 20px;
        }

        .eeri-trend-text {
            color: #94a3b8;
            font-size: 14px;
        }

        .eeri-computed-at {
            color: #64748b;
            font-size: 12px;
        }

        /* Component Breakdown Card */
        .eeri-components-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 16px;
            padding: 24px;
        }

        .eeri-components-header {
            margin-bottom: 20px;
        }

        .eeri-components-title {
            color: #f1f5f9;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .eeri-components-hint {
            color: #64748b;
            font-size: 12px;
        }

        .eeri-components-chart {
            display: flex;
            height: 24px;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .eeri-component-bar {
            height: 100%;
            transition: all 0.3s ease;
            position: relative;
        }

        .eeri-component-bar:hover {
            filter: brightness(1.2);
        }

        .eeri-components-legend {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        @media (max-width: 600px) {
            .eeri-components-legend {
                grid-template-columns: 1fr;
            }
        }

        .eeri-legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .eeri-legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
            flex-shrink: 0;
        }

        .eeri-legend-label {
            color: #94a3b8;
            font-size: 13px;
            flex: 1;
        }

        .eeri-legend-value {
            color: #e2e8f0;
            font-size: 13px;
            font-weight: 600;
        }

        /* Asset Stress Card */
        .eeri-asset-stress-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 16px;
            padding: 24px;
        }

        .eeri-asset-stress-header {
            margin-bottom: 20px;
        }

        .eeri-section-title {
            color: #f1f5f9;
            font-size: 16px;
            font-weight: 600;
            margin: 0 0 4px 0;
        }

        .eeri-section-subtitle {
            color: #64748b;
            font-size: 12px;
        }

        .eeri-asset-stress-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .eeri-asset-item {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            transition: all 0.2s;
        }

        .eeri-asset-item:hover {
            border-color: #475569;
        }

        .eeri-asset-name {
            color: #94a3b8;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .eeri-asset-score {
            font-size: 28px;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 6px;
        }

        .eeri-asset-status {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .eeri-asset-trend {
            font-size: 14px;
        }

        /* Drivers Card */
        .eeri-drivers-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 16px;
            padding: 24px;
        }

        .eeri-drivers-header {
            margin-bottom: 20px;
        }

        .eeri-drivers-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .eeri-driver-item {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: flex-start;
            gap: 16px;
        }

        .eeri-driver-rank {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
        }

        .eeri-driver-content {
            flex: 1;
        }

        .eeri-driver-headline {
            color: #e2e8f0;
            font-size: 14px;
            font-weight: 500;
            line-height: 1.4;
            margin-bottom: 8px;
        }

        .eeri-driver-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .eeri-driver-tag {
            font-size: 10px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .eeri-driver-tag.theme {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        .eeri-driver-tag.severity {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .eeri-driver-tag.confidence {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        .eeri-driver-tag.assets {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }

        /* History Card */
        .eeri-history-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 16px;
            padding: 24px;
        }

        .eeri-history-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 20px;
        }

        .eeri-time-controls {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .eeri-time-range-group,
        .eeri-smoothing-group {
            display: flex;
            gap: 4px;
        }

        .eeri-time-btn,
        .eeri-smooth-btn {
            background: transparent;
            border: 1px solid #334155;
            color: #64748b;
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .eeri-time-btn:hover,
        .eeri-smooth-btn:hover {
            border-color: #475569;
            color: #94a3b8;
        }

        .eeri-time-btn.active,
        .eeri-smooth-btn.active {
            background: rgba(59, 130, 246, 0.15);
            border-color: #3b82f6;
            color: #60a5fa;
        }

        .eeri-asset-toggles {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .eeri-asset-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: transparent;
            border: 1px solid #334155;
            color: #64748b;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .eeri-asset-btn:hover {
            border-color: #475569;
            color: #94a3b8;
        }

        .eeri-asset-btn .eeri-asset-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .eeri-asset-btn.active {
            background: rgba(255,255,255,0.06);
            color: #e2e8f0;
        }

        .eeri-asset-subtitle {
            font-size: 11px;
            color: #64748b;
            margin-top: 8px;
            font-style: italic;
        }

        .eeri-chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 16px;
        }

        .eeri-stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            padding-top: 16px;
            border-top: 1px solid #334155;
        }

        @media (max-width: 600px) {
            .eeri-stats-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .eeri-stat {
            text-align: center;
        }

        .eeri-stat-label {
            color: #64748b;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
            display: block;
        }

        .eeri-stat-value {
            color: #e2e8f0;
            font-size: 20px;
            font-weight: 700;
        }

        /* Regime Card */
        .eeri-regime-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 16px;
            padding: 24px;
        }

        .eeri-regime-header {
            margin-bottom: 20px;
        }

        .eeri-regime-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        @media (max-width: 768px) {
            .eeri-regime-content {
                grid-template-columns: 1fr;
            }
        }

        .eeri-band-distribution {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .eeri-band-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .eeri-band-label {
            width: 80px;
            color: #94a3b8;
            font-size: 12px;
            font-weight: 500;
        }

        .eeri-band-bar-container {
            flex: 1;
            height: 20px;
            background: #0f172a;
            border-radius: 10px;
            overflow: hidden;
        }

        .eeri-band-bar {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .eeri-band-percent {
            width: 50px;
            color: #e2e8f0;
            font-size: 13px;
            font-weight: 600;
            text-align: right;
        }

        .eeri-transitions-title {
            color: #94a3b8;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .eeri-transitions-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .eeri-transition-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .eeri-transition-date {
            color: #64748b;
            width: 80px;
        }

        .eeri-transition-arrow {
            color: #64748b;
        }

        /* EERI Tooltip Icon */
        .eeri-tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            font-size: 14px;
            color: #64748b;
            cursor: pointer;
            transition: color 0.2s ease;
            margin-left: 6px;
            vertical-align: middle;
        }

        .eeri-tooltip-icon:hover {
            color: #3b82f6;
        }

        /* EERI Modal */
        .eeri-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .eeri-modal-overlay.active {
            display: flex;
        }

        .eeri-modal {
            background: #1e293b;
            border-radius: 16px;
            max-width: 560px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid #334155;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .eeri-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid #334155;
        }

        .eeri-modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #f8fafc;
            margin: 0;
        }

        .eeri-modal-close {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            transition: color 0.2s ease;
        }

        .eeri-modal-close:hover {
            color: #f8fafc;
        }

        .eeri-modal-body {
            padding: 24px;
            color: #cbd5e1;
            line-height: 1.7;
        }

        .eeri-modal-body h4 {
            color: #f8fafc;
            margin: 0 0 12px 0;
            font-size: 15px;
        }

        .eeri-modal-body p {
            margin: 0 0 16px 0;
            font-size: 14px;
        }

        .eeri-modal-body p:last-child {
            margin-bottom: 0;
        }

        .eeri-modal-body ul {
            margin: 0 0 16px 0;
            padding-left: 20px;
        }

        .eeri-modal-body li {
            margin-bottom: 8px;
            font-size: 14px;
        }

        .eeri-modal-body .eeri-modal-highlight {
            background: #0f172a;
            border-radius: 8px;
            padding: 12px 16px;
            margin: 16px 0;
            border-left: 3px solid #3b82f6;
        }

        .eeri-weekly-snapshot-card {
            background: #0f172a;
            border: 1px solid #1e293b;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
        }

        .eeri-hidden {
            display: none !important;
        }
        .eeri-trader-only {
            /* Hidden by default via .eeri-hidden class, shown by JS for Trader+ plans */
        }
        .eeri-pro-only {
            /* Hidden by default via .eeri-hidden class, shown by JS for Pro+ plans */
        }
        .eeri-trader-panel {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
        }
        .eeri-data-timestamp-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            padding: 14px 18px;
            background: #0f172a;
            border-radius: 10px;
        }
        .eeri-data-timestamp-bar .ts-item {
            font-size: 12px;
            color: #94a3b8;
        }
        .eeri-data-timestamp-bar .ts-item strong {
            color: #e2e8f0;
            font-weight: 600;
        }
        .eeri-shock-banner {
            background: rgba(239, 68, 68, 0.12);
            border: 1px solid rgba(239, 68, 68, 0.35);
            border-radius: 12px;
            padding: 16px 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            color: #fca5a5;
            font-size: 14px;
            line-height: 1.6;
        }
        .eeri-shock-banner .shock-icon {
            font-size: 22px;
            flex-shrink: 0;
            margin-top: 2px;
        }
        .eeri-shock-banner .shock-delta {
            font-weight: 700;
            color: #f87171;
        }
        .eeri-insight-banner {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.08) 100%);
            border: 1px solid rgba(59, 130, 246, 0.25);
            border-radius: 12px;
            padding: 18px 22px;
            font-size: 15px;
            font-weight: 500;
            color: #e2e8f0;
            line-height: 1.6;
            font-style: italic;
        }
        .eeri-lag-table,
        .eeri-key-dates-table {
            width: 100%;
            border-collapse: collapse;
        }
        .eeri-lag-table th,
        .eeri-key-dates-table th {
            text-align: left;
            font-size: 11px;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px 12px;
            border-bottom: 1px solid #334155;
        }
        .eeri-lag-table td,
        .eeri-key-dates-table td {
            padding: 10px 12px;
            font-size: 14px;
            color: #e2e8f0;
            border-bottom: 1px solid rgba(51, 65, 85, 0.5);
        }
        .eeri-lag-table tr:last-child td,
        .eeri-key-dates-table tr:last-child td {
            border-bottom: none;
        }
        .eeri-lag-table td:nth-child(3) {
            font-size: 13px;
            color: #94a3b8;
        }
        .eeri-correlation-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid rgba(51, 65, 85, 0.5);
        }
        .eeri-correlation-row:last-child {
            border-bottom: none;
        }
        .eeri-correlation-row .corr-asset {
            width: 100px;
            font-size: 14px;
            font-weight: 500;
            color: #e2e8f0;
            flex-shrink: 0;
        }
        .eeri-correlation-row .corr-bar-wrap {
            flex: 1;
            height: 20px;
            background: #0f172a;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }
        .eeri-correlation-row .corr-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.4s ease;
        }
        .eeri-correlation-row .corr-bar.positive { background: #22c55e; }
        .eeri-correlation-row .corr-bar.negative { background: #ef4444; }
        .eeri-correlation-row .corr-val {
            width: 55px;
            text-align: right;
            font-size: 14px;
            font-weight: 600;
            color: #f1f5f9;
            flex-shrink: 0;
        }
        .eeri-correlation-row .corr-strength {
            width: 60px;
            font-size: 11px;
            text-transform: uppercase;
            font-weight: 600;
            flex-shrink: 0;
        }
        .corr-strength.strong { color: #4ade80; }
        .corr-strength.moderate { color: #fbbf24; }
        .corr-strength.weak { color: #94a3b8; }
        .eeri-persistence-badge {
            text-align: center;
            padding: 20px;
        }
        .eeri-persistence-badge .persist-value {
            font-size: 56px;
            font-weight: 800;
            color: #f1f5f9;
            line-height: 1;
        }
        .eeri-persistence-badge .persist-label {
            font-size: 14px;
            color: #94a3b8;
            margin-top: 6px;
        }
        .eeri-persistence-badge .persist-narrative {
            font-size: 14px;
            color: #cbd5e1;
            line-height: 1.6;
            margin-top: 16px;
            text-align: left;
        }
        .eeri-persistence-badge .persist-meta {
            font-size: 12px;
            color: #64748b;
            margin-top: 12px;
        }
        .eeri-impact-rank {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 12px 0;
            border-bottom: 1px solid rgba(51, 65, 85, 0.5);
        }
        .eeri-impact-rank:last-child {
            border-bottom: none;
        }
        .eeri-impact-rank .rank-num {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
            font-size: 13px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .eeri-impact-rank .rank-asset {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
            color: #e2e8f0;
        }
        .eeri-impact-rank .rank-value {
            font-size: 14px;
            color: #f1f5f9;
            font-weight: 600;
            text-align: right;
        }
        .eeri-impact-rank .rank-move {
            font-size: 13px;
            width: 70px;
            text-align: right;
        }
        .eeri-impact-rank .rank-move.up { color: #f87171; }
        .eeri-impact-rank .rank-move.down { color: #4ade80; }
        .eeri-impact-rank .rank-score {
            font-size: 12px;
            color: #94a3b8;
            width: 60px;
            text-align: right;
        }
        .eeri-weekend-note {
            font-size: 12px;
            color: #64748b;
            font-style: italic;
            padding: 8px 0 0 0;
        }
        @media (max-width: 768px) {
            .eeri-data-timestamp-bar { flex-direction: column; gap: 6px; }
            .eeri-correlation-row .corr-asset { width: 70px; font-size: 12px; }
            .eeri-correlation-row .corr-strength { display: none; }
            .eeri-impact-rank .rank-score { display: none; }
        }
        .ws-dash-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 8px;
        }
        .ws-dash-loading {
            text-align: center;
            padding: 40px 20px;
        }
        .ws-dash-loading p {
            color: #9ca3af;
            margin-top: 12px;
        }
        .ws-overview-dash {
            background: linear-gradient(135deg, #1A1A2E 0%, #16213E 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 16px;
        }
        @media (max-width: 768px) {
            .ws-overview-dash { grid-template-columns: 1fr 1fr; }
        }
        .ws-stat-item { text-align: center; }
        .ws-stat-label {
            font-size: 11px;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .ws-stat-value {
            font-size: 22px;
            font-weight: 700;
            color: #f1f5f9;
        }
        .ws-stat-sub {
            font-size: 12px;
            color: #64748b;
            margin-top: 2px;
        }
        .ws-asset-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 16px;
        }
        .ws-asset-table th {
            text-align: left;
            font-size: 11px;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px 12px;
            border-bottom: 1px solid #1e293b;
        }
        .ws-asset-table td {
            padding: 10px 12px;
            font-size: 14px;
            color: #e2e8f0;
            border-bottom: 1px solid #1e293b;
        }
        .ws-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .ws-badge-confirming { background: rgba(34,197,94,0.15); color: #4ade80; }
        .ws-badge-neutral { background: rgba(148,163,184,0.15); color: #94a3b8; }
        .ws-badge-diverging { background: rgba(239,68,68,0.15); color: #f87171; }
        .ws-badge-fast { background: rgba(34,197,94,0.15); color: #4ade80; }
        .ws-badge-medium { background: rgba(234,179,8,0.15); color: #eab308; }
        .ws-badge-lagging { background: rgba(239,68,68,0.15); color: #f87171; }
        .ws-narrative-block {
            background: #1e293b;
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 16px;
            color: #cbd5e1;
            font-size: 14px;
            line-height: 1.7;
        }
        .ws-narrative-block h4 {
            color: #f1f5f9;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .ws-momentum-card {
            background: #1e293b;
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .ws-momentum-label {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        .ws-scenarios-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }
        @media (max-width: 768px) {
            .ws-scenarios-grid { grid-template-columns: 1fr; }
        }
        .ws-scenario-card {
            background: #1e293b;
            border-radius: 10px;
            padding: 14px;
            border-left: 3px solid;
        }
        .ws-scenario-card h5 {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 6px;
        }
        .ws-scenario-card p {
            font-size: 13px;
            color: #94a3b8;
            line-height: 1.5;
        }
        .ws-persistence-card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 16px;
            text-align: center;
        }
        .ws-persistence-value {
            font-size: 28px;
            font-weight: 700;
            color: #f1f5f9;
        }
        .ws-persistence-label {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 4px;
        }
        .ws-chart-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }
        @media (max-width: 768px) {
            .ws-chart-row { grid-template-columns: 1fr; }
        }
        .ws-mini-chart {
            background: #1e293b;
            border-radius: 10px;
            padding: 12px;
            height: 180px;
            position: relative;
        }
        .ws-mini-chart canvas {
            max-height: 120px;
        }
        .ws-mini-chart h5 {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 8px;
        }
        .ws-upgrade-hint {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px dashed #334155;
            border-radius: 10px;
            padding: 24px;
            text-align: center;
            margin-bottom: 16px;
        }
        .ws-upgrade-hint p {
            color: #94a3b8;
            font-size: 13px;
            margin-bottom: 12px;
        }
        .ws-upgrade-hint button {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: #fff;
            border: none;
            padding: 8px 20px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }
        .ws-upgrade-title {
            color: #e2e8f0;
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 6px;
        }
        .ws-upgrade-subtitle {
            color: #94a3b8;
            font-size: 13px;
            margin-bottom: 20px;
        }
        .ws-upgrade-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 14px;
            margin-bottom: 20px;
        }
        .ws-plan-card {
            background: #0f172a;
            border: 1px solid #1e293b;
            border-radius: 10px;
            padding: 18px 16px;
            text-align: left;
            transition: border-color 0.2s, transform 0.2s;
            position: relative;
        }
        .ws-plan-card:hover {
            transform: translateY(-2px);
        }
        .ws-plan-card.card-personal { border-top: 3px solid #3b82f6; }
        .ws-plan-card.card-trader { border-top: 3px solid #f59e0b; }
        .ws-plan-card.card-pro { border-top: 3px solid #ef4444; }
        .ws-plan-card.card-enterprise { border-top: 3px solid #a855f7; }
        .ws-plan-card:hover.card-personal { border-color: #3b82f6; }
        .ws-plan-card:hover.card-trader { border-color: #f59e0b; }
        .ws-plan-card:hover.card-pro { border-color: #ef4444; }
        .ws-plan-card:hover.card-enterprise { border-color: #a855f7; }
        .ws-plan-card-name {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 2px;
        }
        .ws-plan-card-name.plan-personal { color: #3b82f6; }
        .ws-plan-card-name.plan-trader { color: #f59e0b; }
        .ws-plan-card-name.plan-pro { color: #ef4444; }
        .ws-plan-card-name.plan-enterprise { color: #a855f7; }
        .ws-plan-card-price {
            color: #cbd5e1;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .ws-plan-card-tagline {
            color: #94a3b8;
            font-size: 12px;
            font-style: italic;
            margin-bottom: 10px;
            line-height: 1.4;
        }
        .ws-plan-card-features {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .ws-plan-card-features li {
            color: #cbd5e1;
            font-size: 12px;
            padding: 3px 0;
            padding-left: 18px;
            position: relative;
            line-height: 1.4;
        }
        .ws-plan-card-features li::before {
            content: '+';
            position: absolute;
            left: 0;
            font-weight: 700;
            font-size: 13px;
        }
        .ws-plan-card.card-personal .ws-plan-card-features li::before { color: #3b82f6; }
        .ws-plan-card.card-trader .ws-plan-card-features li::before { color: #f59e0b; }
        .ws-plan-card.card-pro .ws-plan-card-features li::before { color: #ef4444; }
        .ws-plan-card.card-enterprise .ws-plan-card-features li::before { color: #a855f7; }
        .ws-plan-card-includes {
            color: #64748b;
            font-size: 11px;
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px solid #1e293b;
        }
        .ws-component-bars {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
        }
        .ws-comp-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .ws-comp-label {
            font-size: 12px;
            color: #94a3b8;
            width: 160px;
            flex-shrink: 0;
        }
        .ws-comp-bar-track {
            flex: 1;
            height: 8px;
            background: #0f172a;
            border-radius: 4px;
            overflow: hidden;
        }
        .ws-comp-bar-fill {
            height: 100%;
            border-radius: 4px;
        }
        .ws-comp-value {
            font-size: 12px;
            color: #e2e8f0;
            width: 40px;
            text-align: right;
        }
        .ws-tendencies-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 16px;
        }
        .ws-tendencies-table th {
            text-align: left;
            font-size: 11px;
            color: #94a3b8;
            text-transform: uppercase;
            padding: 8px 10px;
            border-bottom: 1px solid #1e293b;
        }
        .ws-tendencies-table td {
            padding: 8px 10px;
            font-size: 13px;
            color: #e2e8f0;
            border-bottom: 1px solid #1e293b;
        }
        /* ========== EGSI Dashboard Styles ========== */
        .egsi-plan-badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; background: linear-gradient(135deg, #10b981, #059669); color: white; margin-left: 8px; vertical-align: middle; }
        .egsi-loading { text-align: center; padding: 60px 20px; color: #94a3b8; }
        .egsi-loading .spinner { width: 40px; height: 40px; border: 3px solid #10b981; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px; }
        .egsi-dual-index-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
        .egsi-index-card { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 24px; }
        .egsi-m-card { border-left: 3px solid #10b981; }
        .egsi-s-card { border-left: 3px solid #06b6d4; }
        .egsi-card-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
        .egsi-card-label { font-size: 18px; font-weight: 700; color: #f1f5f9; }
        .egsi-card-sublabel { font-size: 12px; color: #64748b; }
        .egsi-realtime-badge { background: rgba(16, 185, 129, 0.2); color: #34d399; font-size: 9px; font-weight: 700; padding: 2px 8px; border-radius: 10px; letter-spacing: 0.5px; }
        .egsi-delayed-badge { background: rgba(245, 158, 11, 0.2); color: #fbbf24; font-size: 9px; font-weight: 700; padding: 2px 8px; border-radius: 10px; letter-spacing: 0.5px; }
        .egsi-value-display { display: flex; align-items: baseline; gap: 12px; margin-bottom: 8px; }
        .egsi-value-number { font-size: 42px; font-weight: 800; color: #f1f5f9; line-height: 1; }
        .egsi-value-band { display: inline-block; padding: 3px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .egsi-band-low { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .egsi-band-normal { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .egsi-band-elevated { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
        .egsi-band-high { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        .egsi-band-critical { background: rgba(220, 38, 38, 0.3); color: #fca5a5; }
        .egsi-trend-row { display: flex; gap: 16px; margin-bottom: 8px; }
        .egsi-trend { font-size: 13px; display: flex; align-items: center; gap: 4px; }
        .egsi-trend-up { color: #f87171; }
        .egsi-trend-down { color: #4ade80; }
        .egsi-trend-flat { color: #94a3b8; }
        .egsi-date { font-size: 12px; color: #64748b; }
        .egsi-section-title { font-size: 16px; font-weight: 600; color: #e2e8f0; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid #334155; }
        .egsi-components-section, .egsi-drivers-section, .egsi-chokepoint-section, .egsi-storage-panel, .egsi-interpretation-section, .egsi-history-section { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 24px; margin-bottom: 20px; }
        .egsi-components-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .egsi-component-group-title { font-size: 13px; font-weight: 600; color: #94a3b8; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        .egsi-component-item { margin-bottom: 12px; }
        .egsi-component-label { display: flex; justify-content: space-between; font-size: 13px; color: #cbd5e1; margin-bottom: 4px; }
        .egsi-component-bar { height: 8px; background: #334155; border-radius: 4px; overflow: hidden; }
        .egsi-component-fill { height: 100%; border-radius: 4px; transition: width 0.6s ease; }
        .egsi-component-fill.egsi-m-fill { background: linear-gradient(90deg, #10b981, #34d399); }
        .egsi-component-fill.egsi-s-fill { background: linear-gradient(90deg, #06b6d4, #22d3ee); }
        .egsi-component-bar-placeholder { color: #64748b; font-size: 13px; padding: 12px; text-align: center; }
        .egsi-drivers-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .egsi-drivers-col-title { font-size: 13px; font-weight: 600; color: #94a3b8; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        .egsi-driver-item { display: flex; align-items: flex-start; gap: 10px; padding: 10px 12px; background: #0f172a; border: 1px solid #1e293b; border-radius: 8px; margin-bottom: 8px; }
        .egsi-driver-rank { width: 24px; height: 24px; border-radius: 50%; background: rgba(16, 185, 129, 0.2); color: #34d399; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; flex-shrink: 0; }
        .egsi-driver-text { font-size: 13px; color: #cbd5e1; line-height: 1.4; }
        .egsi-driver-meta { font-size: 11px; color: #64748b; margin-top: 2px; }
        .egsi-chokepoint-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: #0f172a; border: 1px solid #1e293b; border-radius: 8px; margin-bottom: 8px; }
        .egsi-chokepoint-name { font-size: 14px; font-weight: 600; color: #e2e8f0; flex: 1; }
        .egsi-chokepoint-cat { font-size: 11px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }
        .egsi-chokepoint-weight { font-size: 13px; font-weight: 600; color: #10b981; }
        .egsi-storage-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
        .egsi-storage-item { background: #0f172a; border: 1px solid #1e293b; border-radius: 8px; padding: 16px; }
        .egsi-storage-label { font-size: 12px; color: #64748b; margin-bottom: 4px; }
        .egsi-storage-value { font-size: 20px; font-weight: 700; color: #f1f5f9; }
        .egsi-storage-bar { height: 6px; background: #334155; border-radius: 3px; margin-top: 8px; overflow: hidden; }
        .egsi-storage-fill { height: 100%; background: linear-gradient(90deg, #10b981, #34d399); border-radius: 3px; }
        .egsi-interpretation-box { background: #0f172a; border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 8px; padding: 20px; font-size: 14px; color: #cbd5e1; line-height: 1.6; }
        .egsi-history-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .egsi-history-info { font-size: 12px; color: #64748b; }
        .egsi-history-table-wrap { overflow-x: auto; }
        .egsi-history-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .egsi-history-table th { background: #0f172a; color: #94a3b8; padding: 10px 12px; text-align: left; font-weight: 600; border-bottom: 2px solid #334155; white-space: nowrap; }
        .egsi-history-table td { padding: 8px 12px; border-bottom: 1px solid #1e293b; color: #cbd5e1; white-space: nowrap; }
        .egsi-history-table tr:hover td { background: rgba(16, 185, 129, 0.05); }
        .egsi-upgrade-prompt { background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(6, 182, 212, 0.1)); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; padding: 24px; display: flex; align-items: center; gap: 16px; margin-bottom: 20px; }
        .egsi-upgrade-icon { font-size: 28px; flex-shrink: 0; }
        .egsi-upgrade-text { flex: 1; }
        .egsi-upgrade-text strong { color: #f1f5f9; font-size: 15px; }
        .egsi-upgrade-text p { color: #94a3b8; font-size: 13px; margin-top: 4px; }
        .egsi-upgrade-btn { background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; padding: 10px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: opacity 0.2s; }
        .egsi-upgrade-btn:hover { opacity: 0.9; }
        .egsi-history-view-toggle { display: flex; gap: 0; border: 1px solid #334155; border-radius: 8px; overflow: hidden; }
        .egsi-view-btn { background: transparent; border: none; color: #94a3b8; padding: 6px 16px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .egsi-view-btn.active { background: rgba(16,185,129,0.2); color: #34d399; }
        .egsi-chart-range-btns { display: flex; gap: 4px; }
        .egsi-range-btn { background: transparent; border: 1px solid #334155; color: #94a3b8; padding: 4px 12px; font-size: 11px; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .egsi-range-btn.active { background: rgba(16,185,129,0.2); color: #34d399; border-color: #10b981; }
        .egsi-trajectory { font-size: 12px; font-weight: 700; padding: 3px 10px; border-radius: 6px; display: inline-block; margin-bottom: 4px; }
        .egsi-trajectory-rising { background: rgba(239,68,68,0.15); color: #f87171; }
        .egsi-trajectory-declining { background: rgba(34,197,94,0.15); color: #4ade80; }
        .egsi-trajectory-stable { background: rgba(245,158,11,0.15); color: #fbbf24; }
        .egsi-trajectory-recovering { background: rgba(59,130,246,0.15); color: #60a5fa; }
        .egsi-velocity-tag { font-size: 10px; color: #64748b; margin-top: 4px; }
        .egsi-regime-badge { font-size: 10px; font-weight: 600; padding: 2px 8px; border-radius: 4px; display: inline-block; margin-top: 4px; letter-spacing: 0.3px; }
        .egsi-percentile { font-size: 11px; color: #94a3b8; margin-top: 4px; font-style: italic; }
        .egsi-driver-impact { font-size: 11px; color: #64748b; margin-top: 4px; line-height: 1.5; }
        .egsi-driver-trend-tag { font-size: 11px; margin-top: 2px; }
        .egsi-driver-trend-escalating { color: #f87171; }
        .egsi-driver-trend-active { color: #fbbf24; }
        .egsi-driver-trend-monitoring { color: #4ade80; }
        .egsi-what-changed { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 24px; margin-bottom: 20px; }
        .egsi-change-item { display: flex; align-items: center; gap: 8px; padding: 8px 0; border-bottom: 1px solid #1e293b; font-size: 13px; color: #cbd5e1; }
        .egsi-change-item:last-child { border-bottom: none; }
        .egsi-change-up { color: #f87171; }
        .egsi-change-down { color: #4ade80; }
        .egsi-change-icon { font-weight: 700; width: 20px; text-align: center; }
        .egsi-outlook-panel { background: linear-gradient(135deg, rgba(16,185,129,0.08), rgba(6,182,212,0.08)); border: 1px solid rgba(16,185,129,0.25); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .egsi-outlook-title { font-size: 14px; font-weight: 700; color: #10b981; margin-bottom: 8px; }
        .egsi-outlook-text { font-size: 13px; color: #cbd5e1; line-height: 1.5; }
        .egsi-outlook-basis { font-size: 11px; color: #64748b; margin-top: 8px; font-style: italic; }
        .egsi-narrative-panel { background: #1e293b; border: 1px solid rgba(16,185,129,0.2); border-radius: 12px; padding: 24px; margin-bottom: 20px; }
        .egsi-narrative-title { font-size: 14px; font-weight: 700; color: #e2e8f0; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .egsi-narrative-text { font-size: 14px; color: #cbd5e1; line-height: 1.7; }
        .egsi-regime-change-row td { background: rgba(245,158,11,0.08) !important; border-left: 3px solid #f59e0b; }
        .egsi-component-tooltip { position: relative; cursor: help; }
        @media (max-width: 768px) {
            .egsi-dual-index-row { grid-template-columns: 1fr; }
            .egsi-components-grid { grid-template-columns: 1fr; }
            .egsi-drivers-grid { grid-template-columns: 1fr; }
            .egsi-upgrade-prompt { flex-direction: column; text-align: center; }
        }
        /* ========== EGSI Trader Intelligence Styles ========== */
        .egsi-section-divider { margin-top: 32px; margin-bottom: 20px; padding-top: 20px; border-top: 2px solid rgba(16,185,129,0.3); }
        .egsi-tier-badge { font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 10px; margin-left: 8px; vertical-align: middle; }
        .egsi-tier-badge.trader { background: rgba(245,158,11,0.2); color: #fbbf24; }
        .egsi-trader-top-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 16px; }
        .egsi-trader-card { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 20px; margin-bottom: 16px; }
        .egsi-trader-card-title { font-size: 14px; font-weight: 700; color: #e2e8f0; margin-bottom: 12px; display: flex; align-items: center; gap: 6px; }
        .egsi-momentum-gauge { text-align: center; margin-bottom: 12px; }
        .egsi-momentum-value { font-size: 36px; font-weight: 800; color: #f1f5f9; }
        .egsi-momentum-label { font-size: 12px; font-weight: 700; letter-spacing: 1px; margin-top: 2px; }
        .egsi-momentum-bar-wrap { height: 8px; background: #0f172a; border-radius: 4px; overflow: hidden; margin-bottom: 8px; }
        .egsi-momentum-bar { height: 100%; border-radius: 4px; transition: width 0.6s ease; }
        .egsi-momentum-overbought { background: linear-gradient(90deg, #ef4444, #dc2626); }
        .egsi-momentum-building { background: linear-gradient(90deg, #f59e0b, #ef4444); }
        .egsi-momentum-neutral { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
        .egsi-momentum-easing { background: linear-gradient(90deg, #22c55e, #3b82f6); }
        .egsi-momentum-oversold { background: linear-gradient(90deg, #10b981, #22c55e); }
        .egsi-momentum-desc { font-size: 12px; color: #94a3b8; }
        .egsi-divergence-signal { font-size: 22px; font-weight: 800; margin-bottom: 4px; }
        .egsi-div-overpriced { color: #f87171; }
        .egsi-div-underpriced { color: #4ade80; }
        .egsi-div-slight-up { color: #fbbf24; }
        .egsi-div-slight-down { color: #60a5fa; }
        .egsi-div-aligned { color: #94a3b8; }
        .egsi-divergence-zscore { font-size: 16px; font-weight: 600; color: #cbd5e1; margin-bottom: 6px; }
        .egsi-divergence-desc { font-size: 12px; color: #94a3b8; line-height: 1.4; margin-bottom: 4px; }
        .egsi-divergence-meta { font-size: 11px; color: #64748b; }
        .egsi-weekly-headline { font-size: 15px; font-weight: 600; color: #f1f5f9; line-height: 1.4; margin-bottom: 8px; }
        .egsi-weekly-meta { font-size: 11px; color: #64748b; }
        .egsi-radar-badge { display: inline-block; font-size: 13px; font-weight: 700; padding: 6px 16px; border-radius: 20px; letter-spacing: 1px; margin-bottom: 12px; }
        .egsi-radar-risk-on { background: rgba(239,68,68,0.2); color: #f87171; }
        .egsi-radar-leaning-up { background: rgba(245,158,11,0.2); color: #fbbf24; }
        .egsi-radar-neutral { background: rgba(100,116,139,0.2); color: #94a3b8; }
        .egsi-radar-leaning-down { background: rgba(59,130,246,0.2); color: #60a5fa; }
        .egsi-radar-risk-off { background: rgba(34,197,94,0.2); color: #4ade80; }
        .egsi-radar-signal-row { display: flex; align-items: flex-start; gap: 10px; padding: 8px 0; border-bottom: 1px solid rgba(51,65,85,0.5); }
        .egsi-radar-signal-row:last-child { border-bottom: none; }
        .egsi-radar-up { color: #f87171; font-size: 14px; }
        .egsi-radar-down { color: #4ade80; font-size: 14px; }
        .egsi-radar-flat { color: #94a3b8; font-size: 14px; }
        .egsi-radar-signal-info { display: flex; flex-direction: column; gap: 2px; }
        .egsi-radar-signal-info strong { font-size: 13px; color: #e2e8f0; }
        .egsi-radar-signal-info span { font-size: 12px; color: #94a3b8; }
        .egsi-impact-current { font-size: 13px; color: #cbd5e1; margin-bottom: 12px; }
        .egsi-impact-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
        .egsi-scenario-card { background: #0f172a; border-radius: 10px; padding: 14px; border: 1px solid #334155; }
        .egsi-scenario-up { border-left: 3px solid #ef4444; }
        .egsi-scenario-base { border-left: 3px solid #f59e0b; }
        .egsi-scenario-down { border-left: 3px solid #22c55e; }
        .egsi-scenario-label { font-size: 12px; font-weight: 700; color: #e2e8f0; margin-bottom: 6px; }
        .egsi-scenario-range { font-size: 14px; font-weight: 600; color: #f1f5f9; margin-bottom: 4px; }
        .egsi-scenario-band { font-size: 11px; color: #94a3b8; margin-bottom: 2px; }
        .egsi-scenario-ttf { font-size: 11px; color: #64748b; }
        .egsi-regime-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .egsi-regime-band-label { font-size: 12px; font-weight: 600; color: #cbd5e1; width: 70px; text-align: right; }
        .egsi-regime-bar-bg { flex: 1; height: 22px; background: #0f172a; border-radius: 6px; overflow: hidden; }
        .egsi-regime-bar-fill { height: 100%; border-radius: 6px; transition: width 0.6s ease; }
        .egsi-regime-days { font-size: 12px; color: #94a3b8; width: 80px; }
        .egsi-regime-stats { font-size: 12px; color: #64748b; margin-top: 8px; }
        .egsi-overlay-controls { display: flex; gap: 12px; margin-bottom: 12px; flex-wrap: wrap; }
        .egsi-overlay-toggle { display: flex; align-items: center; gap: 4px; font-size: 12px; color: #cbd5e1; cursor: pointer; }
        .egsi-overlay-toggle input { accent-color: #10b981; }
        .egsi-storage-seasonal-meta { font-size: 12px; color: #94a3b8; margin-top: 8px; text-align: center; }
        .egsi-analog-item { background: #0f172a; border-radius: 8px; padding: 12px; margin-bottom: 8px; border: 1px solid #334155; }
        .egsi-analog-dates { font-size: 13px; font-weight: 600; color: #e2e8f0; margin-bottom: 4px; }
        .egsi-analog-meta { font-size: 12px; color: #94a3b8; margin-bottom: 4px; }
        .egsi-analog-outcome { font-size: 12px; font-weight: 600; }
        @media (max-width: 768px) {
            .egsi-trader-top-row { grid-template-columns: 1fr; }
            .egsi-impact-grid { grid-template-columns: 1fr; }
        }
        /* ========== End EGSI Dashboard Styles ========== */
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Toggle menu">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="3" y1="6" x2="21" y2="6"/>
                    <line x1="3" y1="12" x2="21" y2="12"/>
                    <line x1="3" y1="18" x2="21" y2="18"/>
                </svg>
            </button>
            <a href="/" style="text-decoration: none;">
                <span class="header-logo">EnergyRiskIQ</span>
            </a>
            <span class="header-badge" id="planBadge">Free</span>
        </div>
        <div class="header-right">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">U</div>
                <span class="user-email" id="userEmail">Loading...</span>
            </div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </header>

    <div class="sidebar-overlay" onclick="closeMobileMenu()"></div>
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-section">
            <div class="sidebar-title">Account</div>
            <a class="nav-item active" onclick="showSection('dashboard'); closeMobileMenu();">
                <span class="nav-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="9" rx="1"/>
                        <rect x="14" y="3" width="7" height="5" rx="1"/>
                        <rect x="14" y="12" width="7" height="9" rx="1"/>
                        <rect x="3" y="16" width="7" height="5" rx="1"/>
                    </svg>
                </span>
                Dashboard
            </a>
            <!-- My Alerts nav hidden -->

            <a class="nav-item" id="geriNavItem" onclick="showSection('geri'); closeMobileMenu();">
                <span class="nav-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2v20"/>
                        <path d="M2 12h20"/>
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6l4 6-4 6-4-6 4-6z"/>
                    </svg>
                </span>
                GERI Dashboard
                <span class="pro-badge-nav" id="geriBadge">FREE</span>
            </a>
            <a class="nav-item" id="eeriNavItem" onclick="showSection('eeri-pro'); closeMobileMenu();">
                <span class="nav-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                    </svg>
                </span>
                EERI Dashboard
                <span class="pro-badge-nav" id="eeriBadge">FREE</span>
            </a>
            <div class="eeri-upgrade-hint" id="eeriUpgradeHint" style="display: none;">
                (Upgrade to Pro for full EERI access)
            </div>
            <a class="nav-item" id="egsiNavItem" onclick="showSection('egsi'); closeMobileMenu();">
                <span class="nav-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                    </svg>
                </span>
                EGSI Dashboard
                <span class="pro-badge-nav" id="egsiBadge">FREE</span>
            </a>
            <a class="nav-item" id="digestNavItem" onclick="showSection('digest'); closeMobileMenu();">
                <span class="nav-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10 9 9 9 8 9"/>
                    </svg>
                </span>
                Daily Digest
                <span class="pro-badge-nav" id="digestBadge" style="background: linear-gradient(135deg, #f59e0b, #d97706); font-size: 9px; padding: 2px 6px;">NEW</span>
            </a>
            <a class="nav-item" id="eriqNavItem" onclick="showSection('eriq'); closeMobileMenu();">
                <span class="nav-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                        <path d="M8 9h8"/>
                        <path d="M8 13h6"/>
                    </svg>
                </span>
                ERIQ Analyst
                <span class="pro-badge-nav" style="background: linear-gradient(135deg, #8b5cf6, #6d28d9); font-size: 9px; padding: 2px 6px;">AI</span>
            </a>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-title">Subscription</div>
            <a class="nav-item" onclick="showSection('plans'); closeMobileMenu();">
                <span class="nav-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                </span>
                Upgrade Plan
            </a>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-title">Settings</div>
            <a class="nav-item" onclick="showSection('settings'); closeMobileMenu();">
                <span class="nav-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                </span>
                Settings
            </a>
        </div>

        <div id="upgradeSidebarCard" class="upgrade-sidebar-card" style="display: none;">
            <div class="upgrade-sidebar-title">
                <span>&#9889;</span> Unlock More Intelligence
            </div>
            <p class="upgrade-sidebar-text">
                Get real-time indices, AI analysis, and deeper risk intelligence with an upgraded plan.
            </p>
            <button class="upgrade-sidebar-btn" onclick="showSection('plans'); closeMobileMenu();">
                View Upgrade Options
            </button>
        </div>
    </nav>

    <main class="main">
        <!-- Dashboard Section -->
        <div class="section-content active" id="section-dashboard">
            <div class="page-header">
                <h1 class="page-title">Welcome back!</h1>
                <p class="page-subtitle">Your energy risk intelligence dashboard</p>
            </div>

            <div id="upgradeBanner" class="upgrade-banner" style="display: none;">
                <div class="upgrade-content">
                    <h3>Upgrade to unlock more features</h3>
                    <p>Get real-time alerts, asset risk tracking, and more with a paid plan.</p>
                </div>
                <button class="upgrade-btn" onclick="showSection('plans')">View Plans</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Current Plan</div>
                    <div class="stat-value" id="currentPlan">Free</div>
                    <span class="stat-badge free" id="planBadgeCard">Free Tier</span>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Member Since</div>
                    <div class="stat-value" id="memberSince">--</div>
                </div>
            </div>

            <div class="snapshot-grid">
                <div class="snapshot-card" onclick="showSection('geri');" id="snapshotGeri">
                    <div class="snapshot-card-header">
                        <div class="snapshot-card-icon geri">
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 6l4 6-4 6-4-6 4-6z"/>
                            </svg>
                        </div>
                        <div>
                            <div class="snapshot-card-title">GERI</div>
                            <div class="snapshot-card-subtitle">Global Energy Risk Index</div>
                        </div>
                    </div>
                    <div id="snapshotGeriBody">
                        <div class="snapshot-loading"><div class="spinner"></div></div>
                    </div>
                </div>

                <div class="snapshot-card" onclick="showSection('eeri-pro');" id="snapshotEeri">
                    <div class="snapshot-card-header">
                        <div class="snapshot-card-icon eeri">
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                            </svg>
                        </div>
                        <div>
                            <div class="snapshot-card-title">EERI</div>
                            <div class="snapshot-card-subtitle">Energy Escalation Risk Index</div>
                        </div>
                    </div>
                    <div id="snapshotEeriBody">
                        <div class="snapshot-loading"><div class="spinner"></div></div>
                    </div>
                </div>

                <div class="snapshot-card" onclick="showSection('digest');" id="snapshotDigest">
                    <div class="snapshot-card-header">
                        <div class="snapshot-card-icon digest">
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                                <line x1="16" y1="13" x2="8" y2="13"/>
                                <line x1="16" y1="17" x2="8" y2="17"/>
                            </svg>
                        </div>
                        <div>
                            <div class="snapshot-card-title">Daily Digest</div>
                            <div class="snapshot-card-subtitle">AI Intelligence Briefing</div>
                        </div>
                    </div>
                    <div id="snapshotDigestBody">
                        <div class="snapshot-loading"><div class="spinner"></div></div>
                    </div>
                </div>

                <div class="snapshot-card" onclick="showSection('egsi');" id="snapshotEgsi">
                    <div class="snapshot-card-header">
                        <div class="snapshot-card-icon egsi">
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                            </svg>
                        </div>
                        <div>
                            <div class="snapshot-card-title">EGSI</div>
                            <div class="snapshot-card-subtitle">Europe Gas Stress Index</div>
                        </div>
                    </div>
                    <div id="snapshotEgsiBody">
                        <div class="snapshot-loading"><div class="spinner"></div></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alerts Section -->
        <div class="section-content" id="section-alerts">
            <div class="page-header">
                <h1 class="page-title">My Alerts</h1>
                <p class="page-subtitle">View your alert history and available alert types</p>
            </div>

            <div class="content-card">
                <div class="card-header">
                    <h2 class="card-title">Your Alert Types</h2>
                </div>
                <div class="card-body">
                    <p style="color: #94a3b8; font-size: 14px; margin-bottom: 12px;">
                        Based on your current plan, you have access to the following alert types:
                    </p>
                    <div class="alert-types-grid" id="alertTypesInfo">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>
            </div>

            <div class="content-card" style="margin-top: 24px;">
                <div class="card-header">
                    <h2 class="card-title">Alert History (Last 24 Hours)</h2>
                </div>
                <div class="card-body">
                    <div class="alert-filters">
                        <div class="filter-group">
                            <span class="filter-label">From:</span>
                            <input type="date" id="filterFromDate" class="filter-input">
                            <input type="time" id="filterFromTime" class="filter-input" style="width: 100px;">
                        </div>
                        <div class="filter-group">
                            <span class="filter-label">To:</span>
                            <input type="date" id="filterToDate" class="filter-input">
                            <input type="time" id="filterToTime" class="filter-input" style="width: 100px;">
                        </div>
                        <div class="filter-divider"></div>
                        <div class="filter-group">
                            <span class="filter-label">Region:</span>
                            <select id="filterRegion" class="filter-input" style="min-width: 120px;">
                                <option value="">All Regions</option>
                                <option value="europe">Europe</option>
                                <option value="north_america">North America</option>
                                <option value="asia">Asia</option>
                                <option value="middle_east">Middle East</option>
                                <option value="global">Global</option>
                            </select>
                        </div>
                        <div class="filter-divider"></div>
                        <div class="filter-toggle-group">
                            <button type="button" class="filter-toggle active" id="filterOil" onclick="toggleFilter('Oil')">Oil</button>
                            <button type="button" class="filter-toggle active" id="filterGas" onclick="toggleFilter('Gas')">Gas</button>
                            <button type="button" class="filter-toggle active" id="filterFX" onclick="toggleFilter('FX')">FX</button>
                        </div>
                        <div class="filter-divider"></div>
                        <button class="filter-btn" onclick="applyFilters()">Apply</button>
                        <button class="filter-btn secondary" onclick="resetFilters()">Reset</button>
                    </div>
                    <div id="allAlerts">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="content-card" style="margin-top: 24px; display: none;" id="lockedSamplesSection">
            </div>
        </div>

        <!-- EGSI Dashboard Section -->
        <div class="section-content" id="section-egsi">
            <div class="page-header">
                <h1 class="page-title">EGSI Dashboard <span class="egsi-plan-badge" id="egsiHeaderBadge"></span></h1>
                <p class="page-subtitle" id="egsiHeaderSubtitle">Europe Gas Stress Index - Market & System intelligence</p>
            </div>
            <div id="egsiContent">
                <div class="egsi-loading" id="egsiLoading">
                    <div class="spinner"></div>
                    <p>Loading EGSI data...</p>
                </div>
                <div class="egsi-dashboard" id="egsiDashboard" style="display: none;">
                    <div class="egsi-dual-index-row">
                        <div class="egsi-index-card egsi-m-card" id="egsiMCard">
                            <div class="egsi-card-header">
                                <span class="egsi-card-label">EGSI-M</span>
                                <span class="egsi-card-sublabel">Market / Transmission</span>
                                <span class="egsi-realtime-badge" id="egsiMRealtimeBadge" style="display:none;">REAL-TIME</span>
                                <span class="egsi-delayed-badge" id="egsiMDelayedBadge" style="display:none;">24H DELAYED</span>
                            </div>
                            <div class="egsi-value-display">
                                <span class="egsi-value-number" id="egsiMValue">--</span>
                                <span class="egsi-value-band" id="egsiMBand">--</span>
                            </div>
                            <div class="egsi-trend-row">
                                <span class="egsi-trend" id="egsiMTrend1d"></span>
                                <span class="egsi-trend" id="egsiMTrend7d"></span>
                            </div>
                            <div id="egsiMExtras"></div>
                            <div class="egsi-date" id="egsiMDate"></div>
                        </div>
                        <div class="egsi-index-card egsi-s-card" id="egsiSCard">
                            <div class="egsi-card-header">
                                <span class="egsi-card-label">EGSI-S</span>
                                <span class="egsi-card-sublabel">System / Storage</span>
                            </div>
                            <div class="egsi-value-display">
                                <span class="egsi-value-number" id="egsiSValue">--</span>
                                <span class="egsi-value-band" id="egsiSBand">--</span>
                            </div>
                            <div class="egsi-trend-row">
                                <span class="egsi-trend" id="egsiSTrend1d"></span>
                                <span class="egsi-trend" id="egsiSTrend7d"></span>
                            </div>
                            <div id="egsiSExtras"></div>
                            <div class="egsi-date" id="egsiSDate"></div>
                        </div>
                    </div>
                    <div class="egsi-what-changed" id="egsiWhatChanged" style="display:none;">
                        <h3 class="egsi-section-title">What Changed Today</h3>
                        <div id="egsiWhatChangedList"></div>
                    </div>
                    <div class="egsi-components-section" id="egsiComponentsSection" style="display:none;">
                        <h3 class="egsi-section-title">Component Breakdown</h3>
                        <div class="egsi-components-grid">
                            <div class="egsi-component-group">
                                <h4 class="egsi-component-group-title">EGSI-M Components</h4>
                                <div id="egsiMComponents"><div class="egsi-component-bar-placeholder">Loading...</div></div>
                            </div>
                            <div class="egsi-component-group" id="egsiSComponentsGroup">
                                <h4 class="egsi-component-group-title">EGSI-S Components</h4>
                                <div id="egsiSComponents"><div class="egsi-component-bar-placeholder">Loading...</div></div>
                            </div>
                        </div>
                    </div>
                    <div class="egsi-drivers-section" id="egsiDriversSection" style="display:none;">
                        <h3 class="egsi-section-title">Top Risk Drivers</h3>
                        <div class="egsi-drivers-grid">
                            <div class="egsi-drivers-col">
                                <h4 class="egsi-drivers-col-title">Market Drivers</h4>
                                <div id="egsiMDrivers"></div>
                            </div>
                            <div class="egsi-drivers-col" id="egsiSDriversCol">
                                <h4 class="egsi-drivers-col-title">System Drivers</h4>
                                <div id="egsiSDrivers"></div>
                            </div>
                        </div>
                    </div>
                    <div class="egsi-chokepoint-section" id="egsiChokepointSection" style="display:none;">
                        <h3 class="egsi-section-title">Chokepoint Watch</h3>
                        <div id="egsiChokepointList"></div>
                    </div>
                    <div class="egsi-storage-panel" id="egsiStoragePanel" style="display:none;">
                        <h3 class="egsi-section-title">EU Gas Storage Status</h3>
                        <div class="egsi-storage-grid" id="egsiStorageGrid"></div>
                    </div>
                    <div class="egsi-interpretation-section" id="egsiInterpretationSection" style="display:none;">
                        <h3 class="egsi-section-title">AI Interpretation</h3>
                        <div class="egsi-interpretation-box" id="egsiInterpretation"></div>
                    </div>
                    <div class="egsi-outlook-panel" id="egsiOutlookPanel" style="display:none;">
                        <div class="egsi-outlook-title">&#9889; Stress Outlook (Next 14 Days)</div>
                        <div class="egsi-outlook-text" id="egsiOutlookText"></div>
                        <div class="egsi-outlook-basis" id="egsiOutlookBasis"></div>
                    </div>
                    <div class="egsi-narrative-panel" id="egsiNarrativePanel" style="display:none;">
                        <div class="egsi-narrative-title">&#128202; Stress Narrative Summary</div>
                        <div class="egsi-narrative-text" id="egsiNarrativeText"></div>
                    </div>
                    <div class="egsi-history-section" id="egsiHistorySection" style="display:none;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                            <h3 class="egsi-section-title" style="margin-bottom:0;border-bottom:none;">Historical Trend</h3>
                            <div class="egsi-history-view-toggle">
                                <button class="egsi-view-btn active" id="egsiChartViewBtn" onclick="egsiSwitchView('chart')">Chart</button>
                                <button class="egsi-view-btn" id="egsiTableViewBtn" onclick="egsiSwitchView('table')">Table</button>
                            </div>
                        </div>
                        <div class="egsi-history-controls" id="egsiHistoryControls">
                            <span class="egsi-history-info" id="egsiHistoryInfo"></span>
                            <div class="egsi-chart-range-btns" id="egsiChartRangeBtns">
                                <button class="egsi-range-btn active" onclick="egsiSetRange(30)">30D</button>
                                <button class="egsi-range-btn" onclick="egsiSetRange(90)">90D</button>
                                <button class="egsi-range-btn" onclick="egsiSetRange(0)">YTD</button>
                            </div>
                        </div>
                        <div id="egsiChartView">
                            <div style="position:relative;height:350px;">
                                <canvas id="egsiHistoryChart"></canvas>
                            </div>
                        </div>
                        <div id="egsiTableView" style="display:none;">
                            <div class="egsi-history-table-wrap">
                                <table class="egsi-history-table" id="egsiHistoryTable">
                                    <thead><tr><th>Date</th><th>EGSI-M</th><th>Band</th><th>1d</th><th>7d Avg</th><th>&#11014;&#11015;</th><th>EGSI-S</th><th>Band</th><th>1d</th></tr></thead>
                                    <tbody id="egsiHistoryBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <!-- EGSI Trader Intelligence Section (Trader+ only) -->
                    <div id="egsiTraderIntelSection" style="display:none;">
                        <div class="egsi-section-divider">
                            <h3 class="egsi-section-title" style="font-size:18px;color:#f1f5f9;">&#9889; Trader Intelligence <span class="egsi-tier-badge trader">TRADER+</span></h3>
                        </div>

                        <div class="egsi-trader-top-row">
                            <div class="egsi-trader-card egsi-momentum-card" id="egsiMomentumCard">
                                <div class="egsi-trader-card-title">Stress Momentum</div>
                                <div class="egsi-momentum-gauge" id="egsiMomentumGauge">
                                    <div class="egsi-momentum-value" id="egsiMomentumValue">--</div>
                                    <div class="egsi-momentum-label" id="egsiMomentumLabel">Loading...</div>
                                </div>
                                <div class="egsi-momentum-bar-wrap">
                                    <div class="egsi-momentum-bar" id="egsiMomentumBar" style="width:50%"></div>
                                </div>
                                <div class="egsi-momentum-desc" id="egsiMomentumDesc"></div>
                            </div>

                            <div class="egsi-trader-card egsi-divergence-card" id="egsiDivergenceCard">
                                <div class="egsi-trader-card-title">TTF vs EGSI Divergence</div>
                                <div class="egsi-divergence-signal" id="egsiDivergenceSignal">--</div>
                                <div class="egsi-divergence-zscore" id="egsiDivergenceZScore"></div>
                                <div class="egsi-divergence-desc" id="egsiDivergenceDesc"></div>
                                <div class="egsi-divergence-meta" id="egsiDivergenceMeta"></div>
                            </div>

                            <div class="egsi-trader-card egsi-weekly-driver-card" id="egsiWeeklyDriverCard">
                                <div class="egsi-trader-card-title">&#128293; Top Risk Driver This Week</div>
                                <div class="egsi-weekly-headline" id="egsiWeeklyHeadline">--</div>
                                <div class="egsi-weekly-meta" id="egsiWeeklyMeta"></div>
                            </div>
                        </div>

                        <div class="egsi-trader-card" id="egsiRiskRadarCard">
                            <div class="egsi-trader-card-title">Risk Radar  30-Day Outlook</div>
                            <div class="egsi-radar-overall" id="egsiRadarOverall"></div>
                            <div class="egsi-radar-signals" id="egsiRadarSignals"></div>
                        </div>

                        <div class="egsi-trader-card" id="egsiAlertImpactCard">
                            <div class="egsi-trader-card-title">&#9888;&#65039; Scenario Impact Analysis</div>
                            <div class="egsi-impact-scenarios" id="egsiImpactScenarios"></div>
                        </div>

                        <div class="egsi-trader-card" id="egsiRegimeHistoryCard">
                            <div class="egsi-trader-card-title">Regime History (12 months)</div>
                            <div class="egsi-regime-bars" id="egsiRegimeBars"></div>
                            <div class="egsi-regime-stats" id="egsiRegimeStats"></div>
                        </div>

                        <div class="egsi-trader-card" id="egsiAssetOverlayCard">
                            <div class="egsi-trader-card-title">EGSI vs Assets Overlay</div>
                            <div class="egsi-overlay-controls" id="egsiOverlayControls">
                                <label class="egsi-overlay-toggle"><input type="checkbox" id="egsiOverlayTTF" checked onchange="renderEgsiOverlayChart()"> TTF</label>
                                <label class="egsi-overlay-toggle"><input type="checkbox" id="egsiOverlayBrent" onchange="renderEgsiOverlayChart()"> Brent</label>
                                <label class="egsi-overlay-toggle"><input type="checkbox" id="egsiOverlayVIX" onchange="renderEgsiOverlayChart()"> VIX</label>
                                <label class="egsi-overlay-toggle"><input type="checkbox" id="egsiOverlayEURUSD" onchange="renderEgsiOverlayChart()"> EUR/USD</label>
                                <label class="egsi-overlay-toggle"><input type="checkbox" id="egsiOverlayStorage" onchange="renderEgsiOverlayChart()"> Storage</label>
                            </div>
                            <div style="position:relative;height:350px;">
                                <canvas id="egsiOverlayChart"></canvas>
                            </div>
                        </div>

                        <div class="egsi-trader-card" id="egsiStorageSeasonalCard">
                            <div class="egsi-trader-card-title">EU Gas Storage vs Seasonal Average</div>
                            <div style="position:relative;height:280px;">
                                <canvas id="egsiStorageSeasonalChart"></canvas>
                            </div>
                            <div class="egsi-storage-seasonal-meta" id="egsiStorageSeasonalMeta"></div>
                        </div>

                        <div class="egsi-trader-card" id="egsiAnalogFinderCard">
                            <div class="egsi-trader-card-title">&#128269; Analog Event Finder</div>
                            <div class="egsi-analog-list" id="egsiAnalogList"></div>
                        </div>
                    </div>

                    <!-- EGSI Trader Upgrade Prompt (for lower tiers) -->
                    <div id="egsiTraderUpgradePrompt" style="display:none;">
                        <div class="egsi-upgrade-prompt" style="display:flex;">
                            <div class="egsi-upgrade-icon">&#9889;</div>
                            <div class="egsi-upgrade-text">
                                <strong>Unlock EGSI Trader Intelligence</strong>
                                <p>Upgrade to Trader to access: Asset overlays, TTF divergence signals, regime history, risk radar, stress momentum, scenario analysis, and more.</p>
                            </div>
                            <button class="egsi-upgrade-btn" onclick="showSection('plans');">Upgrade Now</button>
                        </div>
                    </div>

                    <div class="egsi-upgrade-prompt" id="egsiUpgradePrompt" style="display:none;">
                        <div class="egsi-upgrade-icon">&#9889;</div>
                        <div class="egsi-upgrade-text">
                            <strong id="egsiUpgradeTitle">Unlock deeper EGSI intelligence</strong>
                            <p id="egsiUpgradeDesc">Upgrade your plan to access real-time data, extended history, component breakdowns, AI interpretations, and more.</p>
                        </div>
                        <button class="egsi-upgrade-btn" onclick="showSection('plans');">Upgrade Now</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Plans Section -->
        <div class="section-content" id="section-plans">
            <div class="page-header">
                <h1 class="page-title">Upgrade Your Plan</h1>
                <p class="page-subtitle">Choose the plan that fits your needs</p>
            </div>

            <div class="plans-grid" id="plansGrid">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- GERI Section (All Plans) -->
        <div class="section-content" id="section-geri">
            <div class="page-header">
                <h1 class="page-title">GERI Dashboard <span class="geri-plan-badge" id="geriHeaderBadge"></span></h1>
                <p class="page-subtitle" id="geriHeaderSubtitle">Global Energy Risk Index</p>
                <a href="/geri/methodology" target="_blank" class="geri-methodology-header-link"> View GERI Methodology & Construction</a>
            </div>

            <div id="geriContent">
                <div class="geri-display-card">
                    <div class="geri-loading">
                        <div class="spinner"></div>
                        <p>Loading GERI data...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- EERI Pro Section -->
        <div class="section-content" id="section-eeri-pro">
            <div class="page-header">
                <h1 class="page-title">EERI Dashboard <span class="eeri-plan-badge-header" id="eeriHeaderBadge"></span></h1>
                <p class="page-subtitle" id="eeriHeaderSubtitle">European Energy Risk Index - Intelligence tailored to your plan</p>
                <div class="eeri-header-links">
                    <a href="/eeri/methodology" target="_blank" class="eeri-methodology-header-link"> View EERI Methodology</a>
                    <a href="javascript:void(0)" onclick="openEeriModal('behavioral')" class="eeri-methodology-header-link"> Conceptual, Behavioral Interpretation</a>
                </div>
            </div>

            <div id="eeriProContent">
                <!-- Loading State -->
                <div class="eeri-pro-loading" id="eeriProLoading">
                    <div class="spinner"></div>
                    <p>Loading EERI Pro data...</p>
                </div>

                <!-- Locked State for non-Pro users -->
                <div class="eeri-pro-locked" id="eeriProLocked" style="display: none;">
                    <div class="eeri-locked-card">
                        <div class="eeri-locked-icon"></div>
                        <h2>EERI Dashboard</h2>
                        <p>Unlock European energy risk intelligence with weekly snapshots, market analysis, and progressive intelligence depth.</p>
                        <ul class="eeri-locked-features">
                            <li>Weekly risk overview and market direction</li>
                            <li>Cross-asset confirmation analysis</li>
                            <li>Historical tendencies and probability outlooks</li>
                            <li>Reaction speed and momentum tracking</li>
                            <li>Component attribution and scenario modeling</li>
                        </ul>
                        <button class="eeri-upgrade-btn" onclick="showSection('plans')">Upgrade Now</button>
                    </div>
                </div>

                <!-- Pro Dashboard Content -->
                <div class="eeri-pro-dashboard" id="eeriProDashboard" style="display: none;">

                    <!-- Main Index Display Row (Pro/Enterprise only) -->
                    <div class="eeri-main-row eeri-pro-only eeri-hidden">
                        <!-- EERI Value Card -->
                        <div class="eeri-value-card">
                            <div class="eeri-value-header">
                                <span class="eeri-value-label">EERI</span>
                                <span class="eeri-realtime-badge">REAL-TIME</span>
                            </div>
                            <div class="eeri-value-display">
                                <span class="eeri-value-number" id="eeriValue">--</span>
                                <span class="eeri-value-band" id="eeriBandLabel">--</span>
                            </div>
                            <div class="eeri-value-trend">
                                <span class="eeri-trend-icon" id="eeriTrendIcon"></span>
                                <span class="eeri-trend-text" id="eeriTrendText">Stable</span>
                            </div>
                            <div class="eeri-computed-at" id="eeriComputedAt">--</div>
                        </div>

                        <!-- Component Breakdown Card -->
                        <div class="eeri-components-card">
                            <div class="eeri-components-header">
                                <span class="eeri-components-title">Component Breakdown <span class="eeri-tooltip-icon" onclick="openEeriModal('components')"></span></span>
                                <span class="eeri-components-hint">Contribution to today's EERI</span>
                            </div>
                            <div class="eeri-components-chart" id="eeriComponentsChart">
                                <!-- Component bars rendered by JS -->
                            </div>
                            <div class="eeri-components-legend" id="eeriComponentsLegend">
                                <!-- Legend items rendered by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Asset Stress Panel (Pro/Enterprise only) -->
                    <div class="eeri-asset-stress-card eeri-pro-only eeri-hidden">
                        <div class="eeri-asset-stress-header">
                            <h3 class="eeri-section-title">Asset Stress Panel <span class="eeri-tooltip-icon" onclick="openEeriModal('assetStress')"></span></h3>
                            <span class="eeri-section-subtitle">Current stress levels across energy asset classes</span>
                        </div>
                        <div class="eeri-asset-stress-grid" id="eeriAssetStressGrid">
                            <!-- Asset stress items rendered by JS -->
                        </div>
                    </div>

                    <!-- Top Drivers Section (Pro/Enterprise only) -->
                    <div class="eeri-drivers-card eeri-pro-only eeri-hidden">
                        <div class="eeri-drivers-header">
                            <h3 class="eeri-section-title">Top Risk Drivers</h3>
                            <span class="eeri-section-subtitle">Key factors driving today's EERI level</span>
                        </div>
                        <div class="eeri-drivers-list" id="eeriDriversList">
                            <!-- Driver items rendered by JS -->
                        </div>
                    </div>

                    <!-- Weekly Snapshot Section (All Paid Plans) -->
                    <div class="eeri-weekly-snapshot-card" id="eeriWeeklySnapshotSection">
                        <div class="ws-dash-header">
                            <h3 class="eeri-section-title">Weekly Intelligence Snapshot</h3>
                            <span class="eeri-section-subtitle" id="wsWeekRange">Loading...</span>
                        </div>
                        <div id="wsContent">
                            <div class="ws-dash-loading">
                                <div class="spinner"></div>
                                <p>Loading weekly snapshot...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Trader Intelligence Modules (Trader/Pro/Enterprise) -->
                    <div class="eeri-trader-only eeri-hidden eeri-trader-panel" id="eeriDataTimestamps">
                        <h3 class="eeri-section-title">Data Sources  Last Updated</h3>
                        <div class="eeri-data-timestamp-bar" id="eeriTimestampBar"></div>
                    </div>

                    <div class="eeri-trader-only eeri-hidden eeri-shock-banner" id="eeriShockBanner" style="display:none;">
                        <span class="shock-icon">&#9888;</span>
                        <div id="eeriShockMessage"></div>
                    </div>

                    <div class="eeri-trader-only eeri-hidden eeri-insight-banner" id="eeriInsightBanner"></div>

                    <div class="eeri-trader-only eeri-hidden eeri-trader-panel" id="eeriReactionLagPanel">
                        <h3 class="eeri-section-title">Reaction Lag Analysis</h3>
                        <span class="eeri-section-subtitle">How quickly each asset responds to EERI shifts</span>
                        <table class="eeri-lag-table" style="margin-top:14px;">
                            <thead><tr><th>Asset</th><th>Avg Reaction Lag</th><th>Note</th></tr></thead>
                            <tbody id="eeriLagBody"></tbody>
                        </table>
                    </div>

                    <div class="eeri-trader-only eeri-hidden eeri-trader-panel" id="eeriCorrelationPanel">
                        <h3 class="eeri-section-title">30-Day Rolling Correlations</h3>
                        <span class="eeri-section-subtitle">Correlation between EERI and key assets</span>
                        <div id="eeriCorrelationList" style="margin-top:14px;"></div>
                    </div>

                    <div class="eeri-trader-only eeri-hidden eeri-trader-panel" id="eeriPersistencePanel">
                        <h3 class="eeri-section-title">Regime Persistence Probability</h3>
                        <span class="eeri-section-subtitle">Likelihood the current risk band continues next week</span>
                        <div class="eeri-persistence-badge" id="eeriPersistenceBadge"></div>
                    </div>

                    <div class="eeri-trader-only eeri-hidden eeri-trader-panel" id="eeriImpactRankPanel">
                        <h3 class="eeri-section-title">Asset Impact Ranking</h3>
                        <span class="eeri-section-subtitle">Ranked by EERI sensitivity score</span>
                        <div id="eeriImpactRankList" style="margin-top:14px;"></div>
                    </div>

                    <div class="eeri-trader-only eeri-hidden eeri-trader-panel" id="eeriKeyDatesPanel">
                        <h3 class="eeri-section-title">Key Energy Market Dates</h3>
                        <table class="eeri-key-dates-table" style="margin-top:14px;">
                            <thead><tr><th>Category</th><th>Event</th><th>Frequency</th></tr></thead>
                            <tbody id="eeriKeyDatesBody"></tbody>
                        </table>
                    </div>

                    <div class="eeri-trader-only eeri-hidden eeri-weekend-note" id="eeriWeekendNote"></div>

                    <!-- Historical Intelligence Section (Pro/Enterprise only) -->
                    <div class="eeri-history-card eeri-pro-only eeri-hidden">
                        <div class="eeri-history-header">
                            <h3 class="eeri-section-title">Historical Intelligence <span class="eeri-tooltip-icon" onclick="openEeriModal('history')"></span></h3>
                            <div class="eeri-time-controls">
                                <div class="eeri-time-range-group">
                                    <button class="eeri-time-btn active" data-days="7">7D</button>
                                    <button class="eeri-time-btn" data-days="30">30D</button>
                                    <button class="eeri-time-btn" data-days="90">90D</button>
                                    <button class="eeri-time-btn" data-days="365">All</button>
                                </div>
                                <div class="eeri-smoothing-group">
                                    <button class="eeri-smooth-btn active" data-smooth="raw">Raw</button>
                                    <button class="eeri-smooth-btn" data-smooth="ma3">3D MA</button>
                                    <button class="eeri-smooth-btn" data-smooth="ma7">7D MA</button>
                                </div>
                            </div>
                            <div class="eeri-asset-toggles">
                                <button class="eeri-asset-btn" data-asset="brent" style="--asset-color: #f59e0b;">
                                    <span class="eeri-asset-dot" style="background: #f59e0b;"></span>Brent Oil
                                </button>
                                <button class="eeri-asset-btn" data-asset="ttf" style="--asset-color: #10b981;">
                                    <span class="eeri-asset-dot" style="background: #10b981;"></span>TTF Gas
                                </button>
                                <button class="eeri-asset-btn" data-asset="vix" style="--asset-color: #ef4444;">
                                    <span class="eeri-asset-dot" style="background: #ef4444;"></span>VIX
                                </button>
                                <button class="eeri-asset-btn" data-asset="eurusd" style="--asset-color: #3b82f6;">
                                    <span class="eeri-asset-dot" style="background: #3b82f6;"></span>EUR/USD
                                </button>
                                <button class="eeri-asset-btn" data-asset="storage" style="--asset-color: #06b6d4;">
                                    <span class="eeri-asset-dot" style="background: #06b6d4;"></span>EU Storage
                                </button>
                            </div>
                        </div>
                        <p class="eeri-asset-subtitle" id="eeriAssetSubtitle" style="display:none;">Assets rebased to 100 at start of range for comparability</p>
                        <div class="eeri-chart-container">
                            <canvas id="eeriHistoryChart" height="300"></canvas>
                        </div>
                        <div class="eeri-stats-row" id="eeriStatsRow">
                            <div class="eeri-stat">
                                <span class="eeri-stat-label">Period Avg</span>
                                <span class="eeri-stat-value" id="eeriStatAvg">--</span>
                            </div>
                            <div class="eeri-stat">
                                <span class="eeri-stat-label">Max</span>
                                <span class="eeri-stat-value" id="eeriStatMax">--</span>
                            </div>
                            <div class="eeri-stat">
                                <span class="eeri-stat-label">Min</span>
                                <span class="eeri-stat-value" id="eeriStatMin">--</span>
                            </div>
                            <div class="eeri-stat">
                                <span class="eeri-stat-label">Volatility</span>
                                <span class="eeri-stat-value" id="eeriStatVol">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- Regime Statistics -->
                    <div class="eeri-regime-card eeri-pro-only eeri-hidden">
                        <div class="eeri-regime-header">
                            <h3 class="eeri-section-title">Regime Statistics <span class="eeri-tooltip-icon" onclick="openEeriModal('regime')"></span></h3>
                            <span class="eeri-section-subtitle">Risk band distribution (last 90 days)</span>
                        </div>
                        <div class="eeri-regime-content">
                            <div class="eeri-band-distribution" id="eeriBandDistribution">
                                <!-- Band distribution bars rendered by JS -->
                            </div>
                            <div class="eeri-transitions" id="eeriTransitions">
                                <h4 class="eeri-transitions-title">Recent Regime Transitions</h4>
                                <div class="eeri-transitions-list" id="eeriTransitionsList">
                                    <!-- Transitions rendered by JS -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Daily Intelligence Summary Card (moved to bottom) -->
                    <div class="eeri-summary-card eeri-pro-only eeri-hidden" id="eeriDailySummary">
                        <div class="eeri-summary-header">
                            <div class="eeri-summary-label">Daily Intelligence Summary</div>
                            <div class="eeri-summary-date" id="eeriSummaryDate">--</div>
                        </div>
                        <div class="eeri-summary-text" id="eeriSummaryText">
                            Loading intelligence summary...
                        </div>
                        <div class="eeri-summary-meta">
                            <span class="eeri-summary-drivers" id="eeriSummaryDrivers"></span>
                        </div>
                    </div>

                </div>

                <!-- EERI Tooltip Modal -->
                <div class="eeri-modal-overlay" id="eeriModalOverlay" onclick="closeEeriModal()">
                    <div class="eeri-modal" onclick="event.stopPropagation()">
                        <div class="eeri-modal-header">
                            <h3 class="eeri-modal-title" id="eeriModalTitle">Information</h3>
                            <button class="eeri-modal-close" onclick="closeEeriModal()">&times;</button>
                        </div>
                        <div class="eeri-modal-body" id="eeriModalBody">
                            <!-- Modal content rendered by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Daily Digest Section -->
        <div class="section-content" id="section-digest">
            <div class="page-header">
                <h1 class="page-title" style="display: flex; align-items: center; gap: 12px;">
                    Daily Geo-Energy Intelligence Digest
                    <span id="digestPlanBadge" class="eeri-plan-badge-header" style="font-size: 11px;">...</span>
                </h1>
                <p class="page-subtitle">AI-powered daily briefing synthesizing global energy risk into actionable intelligence</p>
            </div>
            <div id="digestContent">
                <div style="text-align: center; padding: 60px 20px;">
                    <div style="width: 40px; height: 40px; border: 3px solid #3b82f6; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div>
                    <p style="color: #94a3b8;">Loading your daily intelligence digest...</p>
                </div>
            </div>
        </div>

        <!-- ERIQ Expert Analyst Section -->
        <div class="section-content" id="section-eriq">
            <div class="page-header">
                <h1 style="display: flex; align-items: center; gap: 12px;">
                    <span style="background: linear-gradient(135deg, #8b5cf6, #6d28d9); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">ERIQ</span>
                    Expert Analyst
                </h1>
                <p style="color: #94a3b8; margin-top: 4px;">AI-powered risk intelligence  ask anything about EnergyRiskIQ indices, alerts, and energy markets</p>
            </div>

            <div class="eriq-chat-container" id="eriqChatContainer">
                <div class="eriq-status-bar" id="eriqStatusBar">
                    <div class="eriq-status-left">
                        <span class="eriq-status-dot"></span>
                        <span id="eriqStatusText">ERIQ Online</span>
                    </div>
                    <div class="eriq-status-right">
                        <span id="eriqQuotaText">Loading...</span>
                    </div>
                </div>

                <div class="eriq-messages" id="eriqMessages">
                    <div class="eriq-welcome">
                        <div class="eriq-avatar">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                                <path d="M8 9h8" stroke-opacity="0.6"/>
                                <path d="M8 13h6" stroke-opacity="0.6"/>
                            </svg>
                        </div>
                        <h3>Welcome to ERIQ</h3>
                        <p>I'm your Expert Risk Intelligence Analyst. I can explain our indices, interpret market signals, and help you understand the energy risk landscape.</p>
                        <div class="eriq-suggestions" id="eriqSuggestions">
                            <button class="eriq-suggestion-btn" onclick="eriqAskSuggestion('What is the current GERI reading and what does it mean?')">What is the current GERI?</button>
                            <button class="eriq-suggestion-btn" onclick="eriqAskSuggestion('Explain today\'s top risk alerts')">Today's top alerts</button>
                            <button class="eriq-suggestion-btn" onclick="eriqAskSuggestion('How does EnergyRiskIQ calculate the EERI?')">How is EERI calculated?</button>
                            <button class="eriq-suggestion-btn" onclick="eriqAskSuggestion('What is the current risk regime?')">Current risk regime</button>
                        </div>
                    </div>
                </div>

                <div class="eriq-input-area">
                    <div class="eriq-input-wrapper">
                        <textarea class="eriq-input" id="eriqInput" placeholder="Ask ERIQ about risk indices, alerts, energy markets..." rows="1" maxlength="2000" onkeydown="eriqHandleKeydown(event)" oninput="eriqAutoResize(this)"></textarea>
                        <button class="eriq-send-btn" id="eriqSendBtn" onclick="eriqSendMessage()" disabled>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"/>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                            </svg>
                        </button>
                    </div>
                    <div class="eriq-disclaimer">ERIQ provides risk intelligence, not financial advice. All analysis is grounded in EnergyRiskIQ data.</div>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div class="section-content" id="section-settings">
            <div class="page-header">
                <h1 class="page-title">Settings</h1>
                <p class="page-subtitle">Manage your account settings</p>
            </div>

            <div class="content-card">
                <div class="card-header">
                    <h2 class="card-title">Account Information</h2>
                </div>
                <div class="card-body" id="accountInfo">
                    <div class="info-row">
                        <span class="info-label">Email</span>
                        <span class="info-value" id="settingsEmail">--</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Plan</span>
                        <span class="info-value" id="settingsPlan">--</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Account Created</span>
                        <span class="info-value" id="settingsCreated">--</span>
                    </div>
                </div>
            </div>

            <div class="content-card" style="margin-top: 24px;">
                <div class="card-header">
                    <h2 class="card-title">Telegram Notifications</h2>
                </div>
                <div class="card-body">
                    <div id="telegramNotAvailable" style="display: none;">
                        <p style="color: #94a3b8; font-size: 14px; margin-bottom: 16px;">
                            Connect your Telegram account to receive daily intelligence reports directly on your phone.
                        </p>
                    </div>
                    
                    <div id="telegramLinked" style="display: none;">
                        <div class="info-row">
                            <span class="info-label">Status</span>
                            <span class="info-value" style="color: #4ade80;">
                                <span style="display: inline-block; width: 8px; height: 8px; background: #4ade80; border-radius: 50%; margin-right: 8px;"></span>
                                Connected
                            </span>
                        </div>
                        <div style="margin-top: 16px;">
                            <button class="filter-btn secondary" onclick="unlinkTelegram()">
                                Unlink Telegram
                            </button>
                        </div>
                    </div>
                    
                    <div id="telegramNotLinked" style="display: none;">
                        <p style="color: #94a3b8; font-size: 14px; margin-bottom: 16px;">
                            Link your Telegram account to receive instant alerts on your phone.
                        </p>
                        
                        <div id="telegramLinkStep1">
                            <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px;">
                                <button class="filter-btn" onclick="generateTelegramCode()">
                                    Connect via Telegram
                                </button>
                                <button class="filter-btn secondary" onclick="showManualChatIdEntry()">
                                    Enter Chat ID Manually
                                </button>
                            </div>
                        </div>
                        
                        <div id="telegramLinkStep2" style="display: none;">
                            <div style="background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                                <p style="color: #94a3b8; font-size: 13px; margin-bottom: 12px;">Click the button below to open Telegram and connect:</p>
                                
                                <a id="telegramDeepLink" href="#" target="_blank" style="display: inline-block; background: #0088cc; color: white; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600; margin-bottom: 16px;">
                                    Open @energyriskiq_bot in Telegram
                                </a>
                                
                                <p style="color: #64748b; font-size: 12px; margin-top: 8px;">
                                    Or search for <span style="color: #60a5fa; font-weight: 600;">@<span id="telegramBotUsername">energyriskiq_bot</span></span> and send this code:
                                </p>
                                <div style="background: #0f172a; border: 2px dashed #3b82f6; border-radius: 8px; padding: 16px; text-align: center; margin-top: 12px;">
                                    <span id="telegramLinkCode" style="font-size: 28px; font-weight: 700; letter-spacing: 4px; color: #f1f5f9;">--------</span>
                                </div>
                                <p style="color: #64748b; font-size: 12px; margin-top: 12px; text-align: center;">
                                    Code expires in <span id="telegramCodeExpiry">15</span> minutes
                                </p>
                            </div>
                            
                            <button class="filter-btn secondary" onclick="cancelTelegramLink()">
                                Cancel
                            </button>
                        </div>
                        
                        <div id="telegramManualEntry" style="display: none;">
                            <div style="background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                                <p style="color: #94a3b8; font-size: 13px; margin-bottom: 12px;">Enter your Telegram Chat ID:</p>
                                <p style="color: #64748b; font-size: 12px; margin-bottom: 16px;">
                                    To find your Chat ID, message <span style="color: #60a5fa;">@energyriskiq_bot</span> with <span style="color: #f1f5f9; font-family: monospace;">/start</span> - it will show your Chat ID.
                                </p>
                                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                    <input type="text" id="manualChatIdInput" placeholder="e.g., 123456789" style="flex: 1; min-width: 150px; padding: 12px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: #f1f5f9; font-size: 16px;">
                                    <button class="filter-btn" onclick="linkManualChatId()">Link</button>
                                </div>
                            </div>
                            <button class="filter-btn secondary" onclick="cancelManualEntry()">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Delivery Preferences Section -->
            <div class="content-card" style="margin-top: 24px;">
                <div class="card-header">
                    <h2 class="card-title">Daily Delivery Preferences</h2>
                </div>
                <div class="card-body">
                    <p style="color: #94a3b8; font-size: 14px; margin-bottom: 20px;">
                        Choose which daily intelligence reports you want to receive. Deliveries are sent once per day.
                    </p>
                    
                    <div id="deliveryPrefsContainer">
                        <div class="delivery-prefs-grid">
                            <div class="delivery-pref-card" data-index="geri">
                                <div class="delivery-pref-header" style="border-color: #3b82f6;">
                                    <span class="delivery-pref-icon" style="background: rgba(59, 130, 246, 0.15); color: #60a5fa;">G</span>
                                    <div>
                                        <div class="delivery-pref-title">GERI</div>
                                        <div class="delivery-pref-desc">Global Energy Risk Index</div>
                                    </div>
                                </div>
                                <div class="delivery-pref-channels">
                                    <label class="delivery-toggle">
                                        <input type="checkbox" id="pref_geri_email" onchange="saveDeliveryPreferences()">
                                        <span class="delivery-toggle-label">Email</span>
                                    </label>
                                    <label class="delivery-toggle">
                                        <input type="checkbox" id="pref_geri_telegram" onchange="saveDeliveryPreferences()">
                                        <span class="delivery-toggle-label">Telegram</span>
                                    </label>
                                </div>
                            </div>

                            <div class="delivery-pref-card" data-index="eeri">
                                <div class="delivery-pref-header" style="border-color: #f59e0b;">
                                    <span class="delivery-pref-icon" style="background: rgba(245, 158, 11, 0.15); color: #fbbf24;">E</span>
                                    <div>
                                        <div class="delivery-pref-title">EERI</div>
                                        <div class="delivery-pref-desc">European Energy Risk Index</div>
                                    </div>
                                </div>
                                <div class="delivery-pref-channels">
                                    <label class="delivery-toggle">
                                        <input type="checkbox" id="pref_eeri_email" onchange="saveDeliveryPreferences()">
                                        <span class="delivery-toggle-label">Email</span>
                                    </label>
                                    <label class="delivery-toggle">
                                        <input type="checkbox" id="pref_eeri_telegram" onchange="saveDeliveryPreferences()">
                                        <span class="delivery-toggle-label">Telegram</span>
                                    </label>
                                </div>
                            </div>

                            <div class="delivery-pref-card" data-index="egsi">
                                <div class="delivery-pref-header" style="border-color: #34d399;">
                                    <span class="delivery-pref-icon" style="background: rgba(52, 211, 153, 0.15); color: #34d399;">S</span>
                                    <div>
                                        <div class="delivery-pref-title">EGSI</div>
                                        <div class="delivery-pref-desc">Gas Stress Index</div>
                                    </div>
                                </div>
                                <div class="delivery-pref-channels">
                                    <label class="delivery-toggle">
                                        <input type="checkbox" id="pref_egsi_email" onchange="saveDeliveryPreferences()">
                                        <span class="delivery-toggle-label">Email</span>
                                    </label>
                                    <label class="delivery-toggle">
                                        <input type="checkbox" id="pref_egsi_telegram" onchange="saveDeliveryPreferences()">
                                        <span class="delivery-toggle-label">Telegram</span>
                                    </label>
                                </div>
                            </div>

                            <div class="delivery-pref-card" data-index="daily_digest">
                                <div class="delivery-pref-header" style="border-color: #a78bfa;">
                                    <span class="delivery-pref-icon" style="background: rgba(167, 139, 250, 0.15); color: #a78bfa;">D</span>
                                    <div>
                                        <div class="delivery-pref-title">Daily Digest</div>
                                        <div class="delivery-pref-desc">AI Intelligence Briefing</div>
                                    </div>
                                </div>
                                <div class="delivery-pref-channels">
                                    <label class="delivery-toggle">
                                        <input type="checkbox" id="pref_daily_digest_email" onchange="saveDeliveryPreferences()">
                                        <span class="delivery-toggle-label">Email</span>
                                    </label>
                                    <label class="delivery-toggle">
                                        <input type="checkbox" id="pref_daily_digest_telegram" onchange="saveDeliveryPreferences()">
                                        <span class="delivery-toggle-label">Telegram</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div id="deliveryPrefStatus" style="margin-top: 12px; font-size: 13px; color: #4ade80; display: none;"></div>
                        <div id="deliveryPrefError" style="margin-top: 12px; font-size: 13px; color: #f87171; display: none;"></div>
                        <p id="telegramPrefNote" style="display: none; margin-top: 12px; font-size: 12px; color: #64748b;">
                            To receive Telegram messages, connect your Telegram account in the section above.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let sessionToken = null;
        let currentUser = null;
        let allAlerts = [];
        let userSettings = null;

        const planTaglines = {
            'free': 'Market Awareness',
            'personal': 'Active Monitoring',
            'trader': 'Trading Edge',
            'pro': 'Institutional Analytics',
            'enterprise': 'Strategic Infrastructure'
        };

        function getPlanCardFeatures(planCode) {
            const s = (label, cls) => `<li class="pf-section ${cls}">${label}</li>`;
            const allFeatures = {
                'free': [
                    s('GERI  Global Energy Risk', 'pf-geri'),
                    '24h delayed GERI score & band',
                    '14-day Brent price chart',
                    '3 simplified driver categories',
                    s('EERI  European Energy Risk', 'pf-eeri'),
                    'Weekly overview (avg, band, trend)',
                    'Cross-asset direction table',
                    'Basic market interpretation',
                    s('EGSI  Gas Stress', 'pf-egsi'),
                    'Public delayed EGSI-M & EGSI-S',
                    'Basic storage level display',
                    s('Daily Digest', 'pf-digest'),
                    'Executive snapshot (24h delayed)',
                    '2 top alerts summary',
                    'GERI direction indicator'
                ],
                'personal': [
                    s('GERI  Global Energy Risk', 'pf-geri'),
                    'Real-time GERI score & band',
                    '90-day history chart',
                    'Single asset overlay selector',
                    'Expanded drivers with regions',
                    s('EERI  European Energy Risk', 'pf-eeri'),
                    'Mini overlay charts (EERI vs assets)',
                    'Alignment labels (Confirm / Mixed / Diverge)',
                    'Historical context & percentiles',
                    'Probability outlook with ranges',
                    s('EGSI  Gas Stress', 'pf-egsi'),
                    'Real-time EGSI-M & EGSI-S',
                    'Storage trajectory & refill rate',
                    'TTF price correlation',
                    s('Daily Digest', 'pf-digest'),
                    'Multi-index summary (real-time)',
                    '7-day trend analysis',
                    'Cross-index correlations'
                ],
                'trader': [
                    s('GERI  Global Energy Risk', 'pf-geri'),
                    'Full GERI history access',
                    '2 simultaneous chart overlays',
                    'Smoothing (Raw / 3D MA / 7D MA)',
                    'Regime markers & momentum panel',
                    s('EERI  European Energy Risk', 'pf-eeri'),
                    'Reaction speed analysis',
                    'Risk acceleration tracking',
                    'Conditional historical tendencies',
                    'Volatility expectation commentary',
                    s('EGSI  Gas Stress', 'pf-egsi'),
                    'EGSI component decomposition',
                    'Winter stress probability',
                    'Storage vs 5-year avg comparison',
                    s('Daily Digest', 'pf-digest'),
                    'Regime classification',
                    'Probability scoring per risk',
                    'Conditional trigger alerts'
                ],
                'pro': [
                    s('GERI  Global Energy Risk', 'pf-geri'),
                    '4 simultaneous chart overlays',
                    'AI narrative & commentary',
                    'Regime persistence probability',
                    s('EERI  European Energy Risk', 'pf-eeri'),
                    'Component attribution summary',
                    'Analog weeks identification',
                    'Scenario outlook (Esc / Stab / De-esc)',
                    'Real-time EERI + asset stress panel',
                    'Daily AI-generated risk summary',
                    s('EGSI  Gas Stress', 'pf-egsi'),
                    'EGSI forward scenario modelling',
                    'Injection/withdrawal rate analysis',
                    'Cross-commodity stress signals',
                    s('Daily Digest', 'pf-digest'),
                    'Beta sensitivities',
                    'Scenario forecasts',
                    'Macro event impact analysis'
                ],
                'enterprise': [
                    s('GERI  Global Energy Risk', 'pf-geri'),
                    '5 overlays + team workspace',
                    'Full decomposition & attribution',
                    'Custom alert thresholds',
                    s('EERI  European Energy Risk', 'pf-eeri'),
                    'Multi-region spillover analysis',
                    'Sector impact forecast',
                    'Portfolio exposure commentary',
                    'Multi-week risk path forecast',
                    s('EGSI  Gas Stress', 'pf-egsi'),
                    'Custom storage threshold alerts',
                    'Multi-country storage comparison',
                    'Pipeline flow disruption signals',
                    s('Daily Digest', 'pf-digest'),
                    'Full institutional intelligence',
                    'Custom briefing schedules',
                    'API access for digest data'
                ]
            };
            return allFeatures[planCode] || allFeatures['free'];
        }

        function renderPlanFeaturesList(features) {
            return features.map(f => {
                if (f.startsWith('<li class="pf-section')) return f;
                return `<li>${f}</li>`;
            }).join('');
        }

        // Mobile Menu Functions
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        }

        function closeMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
        }

        function checkSession() {
            try {
                const session = localStorage.getItem('userSession');
                if (!session) {
                    window.location.href = '/users';
                    return false;
                }

                const data = JSON.parse(session);
                if (!data || !data.token || !data.expires) {
                    localStorage.removeItem('userSession');
                    window.location.href = '/users';
                    return false;
                }
                
                if (data.expires < Date.now()) {
                    localStorage.removeItem('userSession');
                    window.location.href = '/users';
                    return false;
                }

                sessionToken = data.token;
                return true;
            } catch (error) {
                console.error('Session check error:', error);
                localStorage.removeItem('userSession');
                window.location.href = '/users';
                return false;
            }
        }

        async function loadDashboard() {
            console.log('loadDashboard started, sessionToken:', sessionToken ? 'present' : 'missing');
            const controller = new AbortController();
            const timeout = setTimeout(() => {
                console.log('Dashboard request timed out after 15s');
                controller.abort();
            }, 15000);
            
            try {
                const startTime = performance.now();
                
                const [dashboardResponse, plansResponse] = await Promise.all([
                    fetch('/users/dashboard?alerts_limit=100', {
                        headers: { 'X-User-Token': sessionToken },
                        signal: controller.signal
                    }),
                    fetch('/billing/plans', { signal: controller.signal })
                ]);
                
                clearTimeout(timeout);

                if (!dashboardResponse.ok) {
                    if (dashboardResponse.status === 401) {
                        localStorage.removeItem('userSession');
                        window.location.href = '/users';
                        return;
                    }
                    throw new Error('Failed to load dashboard');
                }

                const dashboard = await dashboardResponse.json();
                
                currentUser = dashboard.user;
                allAlerts = dashboard.alerts.items || [];
                userSettings = dashboard.settings;
                allowedAlertTypes = dashboard.alerts.allowed_types || [];
                
                updateUI();
                initializeFilters();
                renderAlerts(allAlerts, allowedAlertTypes);
                renderAllowedAlertTypes(allowedAlertTypes, dashboard.alerts.locked_types || []);
                renderLockedSamples(dashboard.alerts.locked_samples || []);
                renderSettingsFromDashboard(dashboard.settings);
                if (dashboard.delivery_preferences) {
                    renderDeliveryPreferences(dashboard.delivery_preferences);
                }
                
                if (plansResponse.ok) {
                    const plansData = await plansResponse.json();
                    renderPlans(plansData.plans || []);
                }
                
                console.log(`Dashboard loaded in ${(performance.now() - startTime).toFixed(0)}ms`);
            } catch (error) {
                clearTimeout(timeout);
                console.error('Error loading dashboard:', error);
            } finally {
                loadSnapshotCards();
            }
        }

        async function loadSnapshotCards() {
            loadGeriSnapshot();
            loadEeriSnapshot();
            loadDigestSnapshot();
            loadEgsiSnapshot();
        }

        async function loadGeriSnapshot() {
            const body = document.getElementById('snapshotGeriBody');
            try {
                const plan = currentUser?.plan || 'free';
                const endpoint = (plan === 'free') ? '/api/v1/indices/geri/public' : '/api/v1/indices/geri/latest';
                const headers = (plan === 'free') ? {} : { 'X-User-Token': sessionToken };
                const resp = await fetch(endpoint, { headers });
                const json = await resp.json();
                const d = json.data || json;
                if (!d || (!d.value && d.value !== 0)) {
                    body.innerHTML = '<div class="snapshot-card-detail">No data available yet</div>';
                    return;
                }
                const val = typeof d.value === 'number' ? d.value.toFixed(1) : d.value;
                const band = d.band || 'N/A';
                const bandCls = 'band-' + (band || '').toLowerCase().replace(/\s+/g, '-');
                let trendHtml = '';
                if (d.trend_1d !== undefined && d.trend_1d !== null) {
                    const t = parseFloat(d.trend_1d);
                    const cls = t > 0 ? 'trend-up' : t < 0 ? 'trend-down' : 'trend-flat';
                    const arrow = t > 0 ? '&#9650;' : t < 0 ? '&#9660;' : '&#8212;';
                    trendHtml = '<div class="snapshot-card-trend ' + cls + '">' + arrow + ' ' + (t > 0 ? '+' : '') + t.toFixed(1) + ' (1d)</div>';
                }
                const dateStr = d.date ? new Date(d.date + 'T00:00:00').toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) : '';
                body.innerHTML = '<div class="snapshot-card-value">' + val + '</div>' +
                    '<span class="snapshot-card-band ' + bandCls + '">' + band + '</span>' +
                    trendHtml +
                    '<div class="snapshot-card-meta">' + dateStr + (plan === 'free' ? ' (24h delayed)' : '') + '</div>';
            } catch (e) {
                console.error('GERI snapshot error:', e);
                body.innerHTML = '<div class="snapshot-card-detail">Unable to load</div>';
            }
        }

        async function loadEeriSnapshot() {
            const body = document.getElementById('snapshotEeriBody');
            try {
                const resp = await fetch('/api/v1/indices/eeri/public');
                const json = await resp.json();
                const d = json.data || json;
                if (!d || (!d.value && d.value !== 0)) {
                    body.innerHTML = '<div class="snapshot-card-detail">No data available yet</div>';
                    return;
                }
                const val = typeof d.value === 'number' ? d.value.toFixed(1) : d.value;
                const band = d.band || 'N/A';
                const bandCls = 'band-' + (band || '').toLowerCase().replace(/\s+/g, '-');
                let trendHtml = '';
                if (d.trend_1d !== undefined && d.trend_1d !== null) {
                    const t = parseFloat(d.trend_1d);
                    const cls = t > 0 ? 'trend-up' : t < 0 ? 'trend-down' : 'trend-flat';
                    const arrow = t > 0 ? '&#9650;' : t < 0 ? '&#9660;' : '&#8212;';
                    trendHtml = '<div class="snapshot-card-trend ' + cls + '">' + arrow + ' ' + (t > 0 ? '+' : '') + t.toFixed(1) + ' (1d)</div>';
                }
                const dateStr = d.date ? new Date(d.date + 'T00:00:00').toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) : '';
                body.innerHTML = '<div class="snapshot-card-value">' + val + '</div>' +
                    '<span class="snapshot-card-band ' + bandCls + '">' + band + '</span>' +
                    trendHtml +
                    '<div class="snapshot-card-meta">' + dateStr + '</div>';
            } catch (e) {
                console.error('EERI snapshot error:', e);
                body.innerHTML = '<div class="snapshot-card-detail">Unable to load</div>';
            }
        }

        async function loadDigestSnapshot() {
            const body = document.getElementById('snapshotDigestBody');
            try {
                const resp = await fetch('/api/v1/digest/daily', {
                    headers: { 'X-User-Token': sessionToken }
                });
                if (!resp.ok) {
                    body.innerHTML = '<div class="snapshot-card-detail">No digest available yet</div>';
                    return;
                }
                const json = await resp.json();
                const d = json.data || json;
                const snapshot = d?.executive_snapshot || d?.sections?.executive_snapshot || null;
                if (snapshot) {
                    const text = typeof snapshot === 'string' ? snapshot : (snapshot.summary || snapshot.text || JSON.stringify(snapshot));
                    const truncated = text.length > 140 ? text.substring(0, 140) + '...' : text;
                    const dateStr = d.date ? new Date(d.date + 'T00:00:00').toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) : 'Today';
                    body.innerHTML = '<div class="snapshot-card-detail">' + truncated + '</div>' +
                        '<div class="snapshot-card-meta">' + dateStr + '</div>';
                } else {
                    const dateStr = d.date ? new Date(d.date + 'T00:00:00').toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) : '';
                    body.innerHTML = '<div class="snapshot-card-detail">Daily intelligence briefing available</div>' +
                        '<div class="snapshot-card-meta">' + (dateStr || 'Click to view') + '</div>';
                }
            } catch (e) {
                console.error('Digest snapshot error:', e);
                body.innerHTML = '<div class="snapshot-card-detail">Click to view daily briefing</div>';
            }
        }

        async function loadUserData() {
            try {
                const response = await fetch('/users/me', {
                    headers: { 'X-User-Token': sessionToken }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('userSession');
                        window.location.href = '/users';
                        return;
                    }
                    throw new Error('Failed to load user');
                }

                currentUser = await response.json();
                updateUI();
                loadAlerts();
            } catch (error) {
                console.error('Error loading user:', error);
            }
        }

        function updateUI() {
            if (!currentUser) return;

            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('userAvatar').textContent = currentUser.email.charAt(0).toUpperCase();

            const plan = currentUser.plan || 'free';
            const planDisplay = plan.charAt(0).toUpperCase() + plan.slice(1);

            document.getElementById('planBadge').textContent = planDisplay;
            document.getElementById('planBadge').className = 'header-badge';

            document.getElementById('currentPlan').textContent = planDisplay;
            document.getElementById('planBadgeCard').textContent = planDisplay + ' Tier';
            document.getElementById('planBadgeCard').className = 'stat-badge ' + plan;

            if (currentUser.created_at) {
                const date = new Date(currentUser.created_at);
                document.getElementById('memberSince').textContent = date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    year: 'numeric' 
                });
                document.getElementById('settingsCreated').textContent = date.toLocaleDateString();
            }

            document.getElementById('settingsEmail').textContent = currentUser.email;
            document.getElementById('settingsPlan').textContent = planDisplay;

            if (plan === 'free') {
                document.getElementById('upgradeBanner').style.display = 'flex';
            }
            
            if (plan !== 'enterprise') {
                document.getElementById('upgradeSidebarCard').style.display = 'block';
            }
            
            updateTelegramUI();
        }

        function updateTelegramUI() {
            if (!currentUser) return;
            
            const isLinked = !!currentUser.telegram_chat_id;
            
            document.getElementById('telegramNotAvailable').style.display = 'none';
            document.getElementById('telegramLinked').style.display = isLinked ? 'block' : 'none';
            document.getElementById('telegramNotLinked').style.display = !isLinked ? 'block' : 'none';
            
            const geriNavItem = document.getElementById('geriNavItem');
            const geriBadge = document.getElementById('geriBadge');
            const geriTierLabels = {'free': 'FREE', 'personal': 'PERSONAL', 'trader': 'TRADER', 'pro': 'PRO', 'enterprise': 'ENTERPRISE'};
            const geriSubtitles = {
                'free': 'Global Energy Risk Index - Awareness Dashboard',
                'personal': 'Global Energy Risk Index - Daily Monitoring Dashboard',
                'trader': 'Global Energy Risk Index - Decision Support Dashboard',
                'pro': 'Global Energy Risk Index - Institutional Analytics Dashboard',
                'enterprise': 'Global Energy Risk Index - Institutional Workspace'
            };
            
            if (geriNavItem) {
                geriNavItem.classList.remove('nav-item-disabled');
                geriNavItem.onclick = function() { showSection('geri'); closeMobileMenu(); };
                if (geriBadge) {
                    geriBadge.textContent = geriTierLabels[plan] || 'FREE';
                    geriBadge.className = 'pro-badge-nav badge-' + (plan || 'free');
                }
            }
            
            const geriHeaderBadge = document.getElementById('geriHeaderBadge');
            if (geriHeaderBadge) {
                geriHeaderBadge.textContent = geriTierLabels[plan] || 'FREE';
                geriHeaderBadge.className = 'geri-plan-badge badge-' + (plan || 'free');
            }
            const geriHeaderSubtitle = document.getElementById('geriHeaderSubtitle');
            if (geriHeaderSubtitle) {
                geriHeaderSubtitle.textContent = geriSubtitles[plan] || geriSubtitles['free'];
            }
            
            const eeriNavItem = document.getElementById('eeriNavItem');
            const eeriBadge = document.getElementById('eeriBadge');
            const eeriUpgradeHint = document.getElementById('eeriUpgradeHint');
            const eeriTierLabels = {'free': 'FREE', 'personal': 'PERSONAL', 'trader': 'TRADER', 'pro': 'PRO', 'enterprise': 'ENTERPRISE'};
            
            if (eeriNavItem) {
                eeriNavItem.classList.remove('nav-item-disabled');
                eeriNavItem.onclick = function() { showSection('eeri-pro'); closeMobileMenu(); };
                if (eeriBadge) {
                    eeriBadge.textContent = eeriTierLabels[plan] || 'FREE';
                    eeriBadge.className = 'pro-badge-nav badge-' + (plan || 'free');
                }
                if (eeriUpgradeHint) eeriUpgradeHint.style.display = 'none';
            }

            const egsiNavItem = document.getElementById('egsiNavItem');
            const egsiBadge = document.getElementById('egsiBadge');
            if (egsiNavItem) {
                egsiNavItem.onclick = function() { showSection('egsi'); closeMobileMenu(); };
                if (egsiBadge) {
                    egsiBadge.textContent = eeriTierLabels[plan] || 'FREE';
                    egsiBadge.className = 'pro-badge-nav badge-' + (plan || 'free');
                }
            }
        }

        const GERI_PLAN_CONFIG = {
            free: {
                label: 'Awareness',
                maxHistoryDays: 14,
                maxOverlays: 1,
                selectableAssets: ['brent'],
                rangeOptions: ['14'],
                showDriverRegions: false,
                showDriverSeverity: false,
                showTrendIndicators: false,
                showOverlayToggles: false,
                showSmoothing: false,
                showNormalization: false,
                showRegimeMarkers: false,
                showEventMarkers: false,
                showMomentumPanel: false,
                showInterpretation: true,
                useDelayedData: true,
                showRealtimeBadge: false
            },
            personal: {
                label: 'Monitoring',
                maxHistoryDays: 90,
                maxOverlays: 1,
                selectableAssets: ['brent', 'ttf', 'vix', 'eurusd', 'storage'],
                rangeOptions: ['7', '30', '90'],
                showDriverRegions: true,
                showDriverSeverity: true,
                showTrendIndicators: true,
                showOverlayToggles: true,
                showSmoothing: false,
                showNormalization: false,
                showRegimeMarkers: false,
                showEventMarkers: false,
                showMomentumPanel: false,
                showInterpretation: true,
                useDelayedData: false,
                showRealtimeBadge: false,
                showAssetReaction: true,
                showRiskWatchlist: true,
                showChartAnnotations: true
            },
            trader: {
                label: 'Decision Support',
                maxHistoryDays: -1,
                maxOverlays: 2,
                selectableAssets: ['brent', 'ttf', 'vix', 'eurusd', 'storage'],
                rangeOptions: ['7', '30', '90', '365', 'all'],
                showDriverRegions: true,
                showDriverSeverity: true,
                showTrendIndicators: true,
                showOverlayToggles: true,
                showSmoothing: true,
                showNormalization: true,
                showRegimeMarkers: true,
                showEventMarkers: true,
                showMomentumPanel: true,
                showInterpretation: true,
                useDelayedData: false,
                showRealtimeBadge: true,
                showAssetReaction: true,
                showRiskWatchlist: true,
                showChartAnnotations: true
            },
            pro: {
                label: 'Institutional Analytics',
                maxHistoryDays: -1,
                maxOverlays: 4,
                selectableAssets: ['brent', 'ttf', 'vix', 'eurusd', 'storage'],
                rangeOptions: ['7', '30', '90', '365', 'all'],
                showDriverRegions: true,
                showDriverSeverity: true,
                showTrendIndicators: true,
                showOverlayToggles: true,
                showSmoothing: true,
                showNormalization: true,
                showRegimeMarkers: true,
                showEventMarkers: true,
                showMomentumPanel: true,
                showInterpretation: true,
                useDelayedData: false,
                showRealtimeBadge: true,
                showAssetReaction: true,
                showRiskWatchlist: true,
                showChartAnnotations: true
            },
            enterprise: {
                label: 'Institutional Workspace',
                maxHistoryDays: -1,
                maxOverlays: 5,
                selectableAssets: ['brent', 'ttf', 'vix', 'eurusd', 'storage'],
                rangeOptions: ['7', '30', '90', '365', 'all'],
                showDriverRegions: true,
                showDriverSeverity: true,
                showTrendIndicators: true,
                showOverlayToggles: true,
                showSmoothing: true,
                showNormalization: true,
                showRegimeMarkers: true,
                showEventMarkers: true,
                showMomentumPanel: true,
                showInterpretation: true,
                useDelayedData: false,
                showRealtimeBadge: true,
                showAssetReaction: true,
                showRiskWatchlist: true,
                showChartAnnotations: true
            }
        };

        let currentGeriSmoothing = 'raw';

        function computeMovingAverage(values, window) {
            return values.map((val, i) => {
                if (i < window - 1) return val;
                let sum = 0;
                let count = 0;
                for (let j = i - window + 1; j <= i; j++) {
                    if (values[j] !== null && values[j] !== undefined) {
                        sum += values[j];
                        count++;
                    }
                }
                return count > 0 ? sum / count : val;
            });
        }

        function buildSimplifiedDrivers(topDrivers) {
            const cats = { geopolitical: 0, energy: 0, market: 0 };
            const geoCats = ['geopolitical', 'war', 'military', 'conflict', 'sanctions'];
            const energyCats = ['energy', 'supply_chain', 'supply_disruption', 'strike'];
            const marketCats = ['political', 'diplomacy'];
            
            (topDrivers || []).forEach(d => {
                const cat = (d.category || '').toLowerCase();
                const sevRaw = d.severity;
                const sev = typeof sevRaw === 'number' ? (sevRaw >= 4 ? 'high' : sevRaw >= 3 ? 'medium' : 'low') : String(sevRaw || '').toLowerCase();
                if (geoCats.some(g => cat.includes(g))) cats.geopolitical++;
                if (energyCats.some(e => cat.includes(e))) cats.energy++;
                if (marketCats.some(m => cat.includes(m)) || sev === 'high') cats.market++;
            });

            function levelFor(count) {
                if (count >= 3) return { text: 'High', cls: 'level-high' };
                if (count >= 1) return { text: 'Medium', cls: 'level-medium' };
                return { text: 'Low', cls: 'level-low' };
            }

            const geo = levelFor(cats.geopolitical);
            const ene = levelFor(cats.energy);
            const mkt = levelFor(cats.market);

            return '<div class="geri-simplified-drivers">' +
                '<div class="geri-simplified-driver-card">' +
                    '<div class="driver-icon"></div>' +
                    '<div class="driver-label">Geopolitical Risk</div>' +
                    '<div class="driver-level ' + geo.cls + '">' + geo.text + '</div>' +
                '</div>' +
                '<div class="geri-simplified-driver-card">' +
                    '<div class="driver-icon"></div>' +
                    '<div class="driver-label">Energy Supply</div>' +
                    '<div class="driver-level ' + ene.cls + '">' + ene.text + '</div>' +
                '</div>' +
                '<div class="geri-simplified-driver-card">' +
                    '<div class="driver-icon"></div>' +
                    '<div class="driver-label">Market Stress</div>' +
                    '<div class="driver-level ' + mkt.cls + '">' + mkt.text + '</div>' +
                '</div>' +
            '</div>';
        }

        function getBandTooltip(band) {
            var b = (band || '').toUpperCase();
            if (b === 'LOW') return 'Low = Stable conditions, no significant structural risk';
            if (b === 'MODERATE') return 'Moderate = Rising structural stress, not crisis';
            if (b === 'ELEVATED') return 'Elevated = Active risk drivers requiring close monitoring';
            if (b === 'CRITICAL') return 'Critical = Systemic stress, multiple risk factors converging';
            return '';
        }

        function buildAssetReactionSummary(geriData, overlayData) {
            var activeAsset = null;
            var activeKey = null;
            var assetNames = { brent: 'Brent Oil', ttf: 'TTF Gas', vix: 'VIX', eurusd: 'EUR/USD', gas_storage: 'EU Gas Storage' };
            var keys = ['brent', 'ttf', 'vix', 'eurusd', 'gas_storage'];
            for (var i = 0; i < keys.length; i++) {
                if (overlayData[keys[i]] && overlayData[keys[i]].active && overlayData[keys[i]].rawData.length >= 2) {
                    activeAsset = assetNames[keys[i]];
                    activeKey = keys[i];
                    break;
                }
            }
            if (!activeAsset || !activeKey) return '';

            var raw = overlayData[activeKey].rawData;
            var recent = raw.slice(-5);
            if (recent.length < 2) return '';
            var lastVal = recent[recent.length - 1].value;
            var prevVal = recent[0].value;
            var pctChange = prevVal !== 0 ? Math.abs(((lastVal - prevVal) / prevVal) * 100) : 0;

            var geriHist = geriData || [];
            var geriRecent = geriHist.slice(-5);
            var geriDelta = 0;
            if (geriRecent.length >= 2) {
                geriDelta = geriRecent[geriRecent.length - 1].value - geriRecent[0].value;
            }

            var text = '';
            if (pctChange < 1.5) {
                text = activeAsset + ' has shown limited reaction to recent risk changes.';
            } else if (Math.abs(geriDelta) > 3 && pctChange < 3) {
                text = activeAsset + ' has remained relatively stable despite recent shifts in risk conditions.';
            } else if (geriDelta > 3 && lastVal > prevVal) {
                text = activeAsset + ' has moved higher alongside rising risk indicators.';
            } else if (geriDelta > 3 && lastVal < prevVal) {
                text = activeAsset + ' has softened even as risk indicators have increased.';
            } else if (geriDelta < -3 && lastVal > prevVal) {
                text = activeAsset + ' continues to firm despite easing risk conditions.';
            } else {
                text = activeAsset + ' is tracking broadly in line with current risk dynamics.';
            }

            return '<div class="geri-asset-reaction">' +
                '<span class="geri-asset-reaction-icon"></span>' +
                '<span class="geri-asset-reaction-label">Market context:</span>' +
                '<span class="geri-asset-reaction-text">' + text + '</span>' +
            '</div>';
        }

        function buildRiskWatchlist(topDrivers) {
            var watchItems = [];
            var seen = {};
            for (var i = 0; i < topDrivers.length && watchItems.length < 3; i++) {
                var d = topDrivers[i];
                var headline = d.headline || d.type || '';
                if (!headline) continue;

                var region = d.region || '';
                var category = d.category || '';
                var sevRaw = d.severity;
                var sev = typeof sevRaw === 'number' ? sevRaw : (sevRaw === 'high' ? 4 : sevRaw === 'medium' ? 3 : 2);

                var watchText = '';
                if (headline.toLowerCase().indexOf('russia') !== -1 || headline.toLowerCase().indexOf('ukraine') !== -1) {
                    watchText = 'Russia\u2013Ukraine escalation';
                } else if (headline.toLowerCase().indexOf('middle east') !== -1 || headline.toLowerCase().indexOf('iran') !== -1 || headline.toLowerCase().indexOf('israel') !== -1) {
                    watchText = 'Middle East conflict spillover';
                } else if (headline.toLowerCase().indexOf('opec') !== -1) {
                    watchText = 'OPEC supply decision uncertainty';
                } else if (headline.toLowerCase().indexOf('lng') !== -1 || headline.toLowerCase().indexOf('gas') !== -1) {
                    watchText = 'LNG supply flow disruption';
                } else if (headline.toLowerCase().indexOf('sanction') !== -1) {
                    watchText = 'Sanctions regime shift';
                } else if (headline.toLowerCase().indexOf('storage') !== -1 || headline.toLowerCase().indexOf('refill') !== -1) {
                    watchText = 'Gas storage trajectory divergence';
                } else if (headline.toLowerCase().indexOf('pipeline') !== -1) {
                    watchText = 'Pipeline infrastructure risk';
                } else if (headline.toLowerCase().indexOf('china') !== -1 || headline.toLowerCase().indexOf('demand') !== -1) {
                    watchText = 'Asian demand surge pressure';
                } else {
                    var words = headline.split(/\s+/).slice(0, 5).join(' ');
                    if (region) watchText = region + ': ' + words;
                    else watchText = words;
                }

                if (!seen[watchText]) {
                    seen[watchText] = true;
                    watchItems.push(watchText);
                }
            }

            if (watchItems.length === 0) return '';

            var itemsHtml = watchItems.map(function(item) {
                return '<li><span class="geri-watchlist-dot"></span><span>' + item + '</span></li>';
            }).join('');

            return '<div class="geri-risk-watchlist">' +
                '<div class="geri-risk-watchlist-title"><span></span> Risk Watch (next 48\u201372h)</div>' +
                '<ul>' + itemsHtml + '</ul>' +
            '</div>';
        }

        function buildGeriUpgradeCards(plan) {
            const planLevel = {'free': 0, 'personal': 1, 'trader': 2, 'pro': 3, 'enterprise': 4}[plan] || 0;
            if (planLevel >= 4) return '';

            var html = '<div class="ws-upgrade-hint">';
            html += '<div class="ws-upgrade-title">Unlock Deeper GERI Intelligence</div>';
            html += '<div class="ws-upgrade-subtitle">See what each plan adds to your Global Energy Risk Dashboard</div>';
            html += '<div class="ws-upgrade-cards">';

            if (planLevel < 1) {
                html += '<div class="ws-plan-card card-personal">';
                html += '<div class="ws-plan-card-name plan-personal">Personal</div>';
                html += '<div class="ws-plan-card-price">9.95 / month</div>';
                html += '<div class="ws-plan-card-tagline">Real-time GERI data with asset overlays, trend indicators, and 90 days of risk history for active monitoring.</div>';
                html += '<ul class="ws-plan-card-features">';
                html += '<li>Real-time GERI data (no 24h delay)</li>';
                html += '<li>90-day history with 7d / 30d / 90d ranges</li>';
                html += '<li>5 asset overlays (Brent, TTF, VIX, EUR/USD, Storage)</li>';
                html += '<li>Driver region & severity breakdown</li>';
                html += '<li>7-day trend indicators & direction signals</li>';
                html += '<li>Asset reaction summary & risk watchlist</li>';
                html += '<li>Chart annotations for risk spikes & drops</li>';
                html += '</ul>';
                html += '</div>';
            }

            if (planLevel < 2) {
                html += '<div class="ws-plan-card card-trader">';
                html += '<div class="ws-plan-card-name plan-trader">Trader</div>';
                html += '<div class="ws-plan-card-price">29 / month</div>';
                html += '<div class="ws-plan-card-tagline">Advanced analytical tools with smoothing, regime detection, and momentum tracking for tactical risk positioning.</div>';
                html += '<ul class="ws-plan-card-features">';
                html += '<li>Full history with all date ranges including "All"</li>';
                html += '<li>2 simultaneous asset overlays</li>';
                html += '<li>Smoothing modes (Raw / 3-Day MA / 7-Day MA)</li>';
                html += '<li>Regime markers on chart (Critical, Elevated thresholds)</li>';
                html += '<li>Momentum panel with acceleration tracking</li>';
                html += '<li>Event markers for key risk inflection points</li>';
                html += '</ul>';
                if (planLevel >= 1) { html += '<div class="ws-plan-card-includes">Includes all Personal features</div>'; }
                html += '</div>';
            }

            if (planLevel < 3) {
                html += '<div class="ws-plan-card card-pro">';
                html += '<div class="ws-plan-card-name plan-pro">Pro</div>';
                html += '<div class="ws-plan-card-price">49 / month</div>';
                html += '<div class="ws-plan-card-tagline">Institutional-grade analytics with 4-asset overlays, AI narrative access, and deep structural risk decomposition.</div>';
                html += '<ul class="ws-plan-card-features">';
                html += '<li>4 simultaneous asset overlays</li>';
                html += '<li>AI-powered risk narrative & scenario analysis</li>';
                html += '<li>GERI decomposition by risk category</li>';
                html += '<li>Cross-asset correlation intelligence</li>';
                html += '<li>Forward risk regime probability</li>';
                html += '</ul>';
                if (planLevel >= 2) { html += '<div class="ws-plan-card-includes">Includes all Trader features</div>'; }
                else if (planLevel >= 1) { html += '<div class="ws-plan-card-includes">Includes all Personal + Trader features</div>'; }
                else { html += '<div class="ws-plan-card-includes">Includes all Personal + Trader features</div>'; }
                html += '</div>';
            }

            html += '<div class="ws-plan-card card-enterprise">';
            html += '<div class="ws-plan-card-name plan-enterprise">Enterprise</div>';
            html += '<div class="ws-plan-card-price">129 / month</div>';
            html += '<div class="ws-plan-card-tagline">Full institutional workspace with 5-asset overlays, team collaboration, portfolio exposure modeling, and custom risk alerts.</div>';
            html += '<ul class="ws-plan-card-features">';
            html += '<li>5 simultaneous asset overlays</li>';
            html += '<li>Team workspace with shared dashboards</li>';
            html += '<li>Portfolio exposure & sector impact modeling</li>';
            html += '<li>Custom risk threshold alerts</li>';
            html += '<li>Multi-region spillover risk analysis</li>';
            html += '</ul>';
            if (planLevel >= 3) { html += '<div class="ws-plan-card-includes">Includes all Pro features</div>'; }
            else if (planLevel >= 2) { html += '<div class="ws-plan-card-includes">Includes all Trader + Pro features</div>'; }
            else if (planLevel >= 1) { html += '<div class="ws-plan-card-includes">Includes all Personal + Trader + Pro features</div>'; }
            else { html += '<div class="ws-plan-card-includes">Includes all Personal + Trader + Pro features</div>'; }
            html += '</div>';

            html += '</div>';
            html += '<button onclick="showSection(\'plans\')">Upgrade Your Plan</button>';
            html += '</div>';

            return html;
        }

        function showOverlayLimitToast(maxOverlays) {
            let existing = document.querySelector('.overlay-limit-toast');
            if (existing) existing.remove();
            const toast = document.createElement('div');
            toast.className = 'overlay-limit-toast';
            toast.textContent = 'Your plan allows up to ' + maxOverlays + ' overlay(s). Upgrade to unlock more.';
            document.body.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
        }

        async function loadGeriData() {
            const plan = currentUser?.plan || 'free';
            const cfg = GERI_PLAN_CONFIG[plan] || GERI_PLAN_CONFIG.free;
            
            const contentDiv = document.getElementById('geriContent');
            if (!contentDiv) return;
            
            try {
                let result;
                const endpoint = cfg.useDelayedData ? '/api/v1/indices/geri/public' : '/api/v1/indices/geri/latest';
                const headers = cfg.useDelayedData ? {} : { 'X-User-Token': sessionToken };
                console.log('GERI: fetching', endpoint, 'plan=', plan);
                
                try {
                    const response = await fetch(endpoint, { headers });
                    console.log('GERI: response status', response.status);
                    if (response.ok) {
                        const text = await response.text();
                        try {
                            result = JSON.parse(text);
                        } catch (parseErr) {
                            console.error('GERI: JSON parse error on primary', parseErr, 'body:', text.substring(0, 200));
                        }
                    }
                } catch (fetchErr) {
                    console.error('GERI: fetch error on primary', fetchErr);
                }
                
                if (!result || !result.success || !result.data) {
                    if (!cfg.useDelayedData) {
                        console.log('GERI: primary failed, trying fallback /geri/public');
                        try {
                            const fallbackResp = await fetch('/api/v1/indices/geri/public');
                            console.log('GERI: fallback status', fallbackResp.status);
                            if (fallbackResp.ok) {
                                const fallbackText = await fallbackResp.text();
                                try {
                                    const fallbackResult = JSON.parse(fallbackText);
                                    if (fallbackResult.success && fallbackResult.data) {
                                        result = fallbackResult;
                                        console.log('GERI: fallback succeeded');
                                    }
                                } catch (parseErr) {
                                    console.error('GERI: JSON parse error on fallback', parseErr);
                                }
                            }
                        } catch (fetchErr) {
                            console.error('GERI: fetch error on fallback', fetchErr);
                        }
                    }
                }
                
                if (!result || !result.success || !result.data) {
                    console.log('GERI: no data available after all attempts');
                    contentDiv.innerHTML = '<div class="geri-display-card"><p style="color: #9ca3af;">No GERI data available yet.</p></div>';
                    return;
                }
                
                console.log('GERI: data received, value=', result.data?.value, 'band=', result.data?.band);
                
                const geri = result.data;
                const bandColors = {
                    'LOW': '#22c55e',
                    'MODERATE': '#eab308',
                    'ELEVATED': '#f97316',
                    'CRITICAL': '#ef4444'
                };
                const bandColor = bandColors[geri.band] || '#6b7280';
                
                let trendLabel = 'Stable';
                const trendVal = geri.trend_7d || 0;
                if (trendVal >= 10) trendLabel = 'Rising Sharply';
                else if (trendVal >= 3) trendLabel = 'Rising';
                else if (trendVal > 0) trendLabel = 'Slightly Rising';
                else if (trendVal <= -10) trendLabel = 'Falling Sharply';
                else if (trendVal <= -3) trendLabel = 'Falling';
                else if (trendVal < 0) trendLabel = 'Slightly Falling';
                
                const trendSign = trendVal > 0 ? '+' : '';
                
                let components = geri.components || {};
                if (typeof components === 'string') {
                    try { components = JSON.parse(components); } catch(e) { components = {}; }
                }
                const topDrivers = components.top_drivers || [];
                const topRegions = components.top_regions || [];
                const interpretation = components.interpretation || '';

                if (cfg.useDelayedData && !components.top_drivers && geri.top_drivers_detailed) {
                    topDrivers.push(...(geri.top_drivers_detailed || []));
                }
                
                const computedAt = geri.computed_at ? geri.computed_at.substring(0, 10) : geri.date || 'N/A';
                
                let badgeHtml = '';
                if (cfg.useDelayedData) {
                    badgeHtml = '<div class="geri-delayed-badge"> 24h Delayed</div>';
                } else if (cfg.showRealtimeBadge) {
                    badgeHtml = '<div class="geri-realtime-badge"> Real-Time</div>';
                }
                
                let trendDisplay = '';
                if (!cfg.useDelayedData) {
                    trendDisplay = '<div class="geri-trend-display" style="color: #4ade80;">7-Day Trend: ' + trendLabel + ' (' + trendSign + trendVal.toFixed(0) + ')</div>';
                }

                let snapshotHtml = '<div class="geri-display-card">' +
                    badgeHtml +
                    '<div class="geri-header-row" style="display: flex; align-items: center; gap: 12px; justify-content: center; margin-bottom: 8px;">' +
                        '<span style="font-size: 2rem;"></span>' +
                        '<span style="font-size: 1.25rem; font-weight: 600; color: #e2e8f0;">Global Energy Risk Index:</span>' +
                    '</div>' +
                    '<div class="geri-value-line" style="font-size: 1.5rem; font-weight: bold; color: ' + bandColor + '; margin-bottom: 8px;">' + (geri.value || '--') + ' / 100 <span class="geri-band-tooltip">(' + (geri.band || 'N/A') + ')<span class="geri-band-tip-text">' + getBandTooltip(geri.band) + '</span></span></div>' +
                    '<div class="geri-scale-ref" style="font-size: 0.75rem; color: #9ca3af; margin-bottom: 12px;">0 = minimal risk  100 = extreme systemic stress</div>' +
                    trendDisplay +
                    '<div class="geri-date-display" style="margin-top: 8px;">Date Computed: ' + computedAt + '</div>' +
                '</div>';

                let rangeLabels = { '7': '7D', '14': '14D', '30': '30D', '90': '90D', '365': '1Y', 'all': 'Since Launch' };
                let rangeButtonsHtml = '';
                if (cfg.rangeOptions.length > 1) {
                    rangeButtonsHtml = '<div class="geri-chart-controls">';
                    cfg.rangeOptions.forEach((r, i) => {
                        const activeClass = (i === cfg.rangeOptions.length - 1 && r === 'all') || (cfg.rangeOptions.length === 1) ? ' active' : (i === 0 && !cfg.rangeOptions.includes('all') ? ' active' : '');
                        rangeButtonsHtml += '<button class="chart-range-btn' + (i === 0 ? ' active' : '') + '" data-range="' + r + '">' + (rangeLabels[r] || r) + '</button>';
                    });
                    rangeButtonsHtml += '</div>';
                }

                let smoothingHtml = '';
                if (cfg.showSmoothing) {
                    smoothingHtml = '<select class="geri-smoothing-selector" id="geriSmoothingSelect">' +
                        '<option value="raw">Raw</option>' +
                        '<option value="3">3D MA</option>' +
                        '<option value="7">7D MA</option>' +
                    '</select>';
                }

                let overlayAssetNames = {
                    'brent': { label: 'Brent Oil', color: '#f59e0b', key: 'brent' },
                    'ttf': { label: 'TTF Gas', color: '#8b5cf6', key: 'ttf' },
                    'vix': { label: 'VIX', color: '#ef4444', key: 'vix' },
                    'eurusd': { label: 'EUR/USD', color: '#06b6d4', key: 'eurusd' },
                    'storage': { label: 'EU Gas Storage', color: '#10b981', key: 'gas_storage' }
                };

                let overlaySection = '';
                if (cfg.showOverlayToggles && cfg.maxOverlays === 1 && plan === 'personal') {
                    let optionsHtml = '<option value="">Select asset overlay...</option>';
                    cfg.selectableAssets.forEach(a => {
                        const info = overlayAssetNames[a];
                        if (info) optionsHtml += '<option value="' + info.key + '">' + info.label + '</option>';
                    });
                    overlaySection = '<select class="geri-asset-selector" id="geriAssetSelect">' + optionsHtml + '</select>';
                } else if (cfg.showOverlayToggles) {
                    overlaySection = '<div class="market-overlay-toggles">';
                    cfg.selectableAssets.forEach(a => {
                        const info = overlayAssetNames[a];
                        if (info) {
                            overlaySection += '<button class="overlay-toggle" data-overlay="' + info.key + '" style="--overlay-color: ' + info.color + ';">' +
                                '<span class="dot"></span> ' + info.label +
                            '</button>';
                        }
                    });
                    overlaySection += '</div>';
                }

                let trendIndicatorsHtml = '';
                if (cfg.showTrendIndicators) {
                    trendIndicatorsHtml = '<div class="geri-trend-indicators">' +
                        '<div class="trend-indicator-card">' +
                            '<div class="trend-indicator-label">1-Day Change</div>' +
                            '<div class="trend-indicator-value" id="trend1d">--</div>' +
                            '<div class="trend-indicator-subtext">vs yesterday</div>' +
                        '</div>' +
                        '<div class="trend-indicator-card">' +
                            '<div class="trend-indicator-label">7-Day Change</div>' +
                            '<div class="trend-indicator-value" id="trend7d">--</div>' +
                            '<div class="trend-indicator-subtext">vs 7-day avg</div>' +
                        '</div>' +
                        '<div class="trend-indicator-card">' +
                            '<div class="trend-indicator-label">Momentum</div>' +
                            '<div class="trend-indicator-value" id="trendMomentum">--</div>' +
                            '<div class="trend-indicator-subtext">slope direction</div>' +
                        '</div>' +
                        '<div class="trend-indicator-card">' +
                            '<div class="trend-indicator-label">Current Band</div>' +
                            '<div class="trend-indicator-value" id="currentBand">--</div>' +
                            '<div class="trend-indicator-subtext" id="currentBandValue">--/100</div>' +
                        '</div>' +
                    '</div>';
                }

                let chartsHtml = '<div class="geri-charts-section">' +
                    '<div class="geri-charts-header">' +
                        '<h3 class="geri-charts-title">GERI History <span>(since Jan 2026)</span></h3>' +
                        '<div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">' +
                            rangeButtonsHtml +
                            smoothingHtml +
                        '</div>' +
                    '</div>' +
                    trendIndicatorsHtml +
                    overlaySection +
                    '<div class="geri-chart-card">' +
                        '<div class="geri-chart-container" style="position:relative;">' +
                            '<canvas id="geriHistoryChart"></canvas>' +
                            '<div class="geri-chart-axis-label" id="geriChartAxisLabel"></div>' +
                        '</div>' +
                        '<p class="chart-zoom-hint"> Pinch/scroll to zoom  Double-click to reset</p>' +
                    '</div>' +
                    '<div id="geriAssetReaction"></div>' +
                '</div>';

                let driversHtml = '';
                if (plan === 'free') {
                    driversHtml = buildSimplifiedDrivers(topDrivers);
                } else {
                    const driverItems = topDrivers.slice(0, 5).map((d, idx) => {
                        let parts = d.headline || d.type || 'Unknown';
                        let tagParts = [];
                        if (cfg.showDriverRegions && d.region) tagParts.push(d.region);
                        if (d.category) tagParts.push(d.category);
                        const tagText = tagParts.length > 0 ? ' <span style="color: #9ca3af; font-size: 0.85rem;">(' + tagParts.join('  ') + ')</span>' : '';
                        let severityHtml = '';
                        if (cfg.showDriverSeverity) {
                            let sevRaw = d.severity;
                            let sev;
                            if (typeof sevRaw === 'number') {
                                sev = sevRaw >= 4 ? 'high' : sevRaw >= 3 ? 'medium' : 'low';
                            } else {
                                sev = (String(sevRaw || 'medium')).toLowerCase();
                            }
                            const sevCls = sev === 'high' ? 'severity-high' : sev === 'low' ? 'severity-low' : 'severity-medium';
                            severityHtml = ' <span class="geri-driver-severity ' + sevCls + '">' + sev.charAt(0).toUpperCase() + sev.slice(1) + '</span>';
                        }
                        let rankHtml = '';
                        if (cfg.showMomentumPanel) {
                            rankHtml = '<span class="geri-driver-rank">#' + (idx + 1) + '</span>';
                        }
                        return '<li>' + rankHtml + parts + tagText + severityHtml + '</li>';
                    }).join('') || '<li>No data</li>';

                    driversHtml = '<div class="geri-detail-card" style="margin-top: 24px;">' +
                        '<div class="geri-detail-title" style="color: #60a5fa;">Primary Risk Drivers:</div>' +
                        '<ul class="geri-detail-list">' + driverItems + '</ul>' +
                    '</div>';

                    if (cfg.showDriverRegions) {
                        const regionLabels = ['Primary', 'Secondary', 'Tertiary', 'Quaternary', 'Quinary'];
                        const regionsItems = topRegions.slice(0, 5).map((r, i) => {
                            const label = regionLabels[i] || '';
                            return '<li>' + (r.region || 'Unknown') + ' <span style="color: #9ca3af; font-size: 0.85rem;">(' + label + ')</span></li>';
                        }).join('') || '<li>No data</li>';

                        driversHtml += '<div class="geri-detail-card" style="margin-top: 16px;">' +
                            '<div class="geri-detail-title" style="color: #60a5fa;">Top Regions Under Pressure:</div>' +
                            '<ul class="geri-detail-list">' + regionsItems + '</ul>' +
                        '</div>';
                    }
                }

                let interpretationHtml = '';
                if (cfg.showInterpretation && interpretation) {
                    const interpretationWords = interpretation.split(/\s+/);
                    const previewLen = plan === 'free' ? 30 : 15;
                    const interpretationPreview = interpretationWords.slice(0, previewLen).join(' ');
                    const hasMore = interpretationWords.length > previewLen;
                    interpretationHtml = '<div class="geri-interpretation-preview">' +
                        '<div class="geri-interpretation-title">GERI Interpretation</div>' +
                        '<p class="geri-interpretation-text">"' + interpretationPreview + (hasMore ? '..."' : '"') + '</p>' +
                        (hasMore ? '<a class="geri-see-more-link" onclick="openInterpretationModal()">See more...</a>' : '') +
                    '</div>';
                    window.fullGeriInterpretation = interpretation;
                }

                let riskWatchlistHtml = '';
                if (cfg.showRiskWatchlist && topDrivers.length > 0) {
                    riskWatchlistHtml = buildRiskWatchlist(topDrivers);
                }

                let traderIntelHtml = '';
                const isTraderPlus = ['trader', 'pro', 'enterprise'].includes(plan);
                if (isTraderPlus) {
                    traderIntelHtml = '<div class="geri-trader-intel-section" id="geriTraderIntelSection"><div class="geri-trader-panel" style="text-align:center; color:#64748b; padding:30px;"><div class="spinner" style="margin:0 auto 10px;"></div>Loading Trader Intelligence...</div></div>';
                }

                let upgradeCardsHtml = buildGeriUpgradeCards(plan);

                contentDiv.innerHTML = snapshotHtml + chartsHtml + driversHtml + interpretationHtml + traderIntelHtml + riskWatchlistHtml + upgradeCardsHtml;
                
                if (plan === 'free') {
                    marketOverlays.brent.active = true;
                }

                loadGeriChartData(geri);

                if (isTraderPlus) {
                    loadGeriTraderIntel();
                }
                
            } catch (error) {
                console.error('Error loading GERI:', error.message, error.stack);
                contentDiv.innerHTML = '<div class="geri-display-card"><p style="color: #ef4444;">Error loading GERI data: ' + (error.message || 'Unknown error') + '</p><p style="color: #9ca3af; font-size: 0.8rem; margin-top: 8px;">Check browser console for details. Try refreshing the page.</p></div>';
            }
        }
        
        async function loadGeriTraderIntel() {
            const section = document.getElementById('geriTraderIntelSection');
            if (!section) return;
            try {
                const planLevel = {'free': 0, 'personal': 1, 'trader': 2, 'pro': 3, 'enterprise': 4}[currentUser?.plan || 'trader'] || 2;
                const resp = await fetch('/api/v1/indices/geri/trader-intel', { headers: { 'X-User-Token': sessionToken } });
                const result = await resp.json();
                if (!result.success || !result.data) {
                    section.innerHTML = '<div class="geri-trader-panel" style="text-align:center; color:#64748b;">Trader intelligence data is not yet available.</div>';
                    return;
                }
                const d = result.data;
                let html = '';

                if (d.regime_transition && d.regime_transition.text && d.regime_transition.text !== 'Insufficient data') {
                    const rt = d.regime_transition;
                    const arrowColor = rt.transition === 'escalating' ? '#f87171' : (rt.transition === 'de-escalating' ? '#4ade80' : '#94a3b8');
                    const arrow = rt.transition === 'escalating' ? '' : (rt.transition === 'de-escalating' ? '' : '');
                    html += '<div class="geri-trader-panel"><h4>Risk Regime Status</h4><div class="gti-subtitle">Current regime transition direction</div>' +
                        '<div class="gti-regime-card"><span class="gti-regime-arrow" style="color:' + arrowColor + ';">' + arrow + '</span>' +
                        '<span class="gti-regime-text">' + rt.text + '</span></div></div>';
                }

                if (d.confirmation && d.confirmation.score !== null) {
                    const cs = d.confirmation;
                    const scoreColor = cs.score >= 80 ? '#4ade80' : (cs.score >= 60 ? '#facc15' : (cs.score >= 40 ? '#f97316' : '#f87171'));
                    html += '<div class="geri-trader-panel"><h4>Cross-Asset Confirmation</h4><div class="gti-subtitle">Are markets pricing risk consistently?</div>' +
                        '<div class="gti-confirmation-score">' +
                        '<div class="gti-score-number" style="color:' + scoreColor + ';">' + cs.score + '<span style="font-size:1rem; color:#64748b;">/100</span></div>' +
                        '<div style="flex:1;"><div class="gti-score-bar"><div class="gti-score-bar-fill" style="width:' + cs.score + '%; background:' + scoreColor + ';"></div></div>' +
                        '<div style="font-size:13px; color:' + scoreColor + '; margin-top:6px; font-weight:600;">' + cs.label + '</div></div></div>';
                    if (cs.details && cs.details.length > 0) {
                        html += '<div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:8px;">';
                        cs.details.forEach(function(det) {
                            var name = det.asset.replace('_', ' ').replace('gas storage', 'Storage').replace('brent','Brent').replace('ttf','TTF').replace('vix','VIX').replace('eurusd','EUR/USD');
                            var cls = det.status === 'confirming' ? 'gti-badge-aligned' : 'gti-badge-strong';
                            html += '<span class="gti-badge ' + cls + '">' + name + ': ' + det.status + ' (' + (det.move_pct > 0 ? '+' : '') + det.move_pct + '%)</span>';
                        });
                        html += '</div>';
                    }
                    html += '</div>';
                }

                if (d.divergence && d.divergence.length > 0) {
                    var hasDivData = d.divergence.some(function(x) { return x.status !== 'insufficient data'; });
                    if (hasDivData) {
                        html += '<div class="geri-trader-panel"><h4>Divergence Indicator</h4><div class="gti-subtitle">Asset direction vs GERI direction (7-day)</div>' +
                            '<table class="gti-table"><thead><tr><th>Asset</th><th>Status</th></tr></thead><tbody>';
                        d.divergence.forEach(function(dv) {
                            var badgeCls = 'gti-badge-insufficient';
                            if (dv.status === 'Aligned') badgeCls = 'gti-badge-aligned';
                            else if (dv.status === 'Moderate divergence') badgeCls = 'gti-badge-moderate';
                            else if (dv.status === 'Strong divergence') badgeCls = 'gti-badge-strong';
                            html += '<tr><td>' + dv.asset + '</td><td><span class="gti-badge ' + badgeCls + '">' + dv.status + '</span></td></tr>';
                        });
                        html += '</tbody></table></div>';
                    }
                }

                if (d.lead_lag) {
                    var llKeys = Object.keys(d.lead_lag);
                    var hasLLData = llKeys.some(function(k) { return d.lead_lag[k].lag !== null; });
                    if (hasLLData) {
                        html += '<div class="geri-trader-panel"><h4>Lead/Lag Intelligence</h4><div class="gti-subtitle">Asset reaction timing relative to GERI risk changes</div>' +
                            '<table class="gti-table"><thead><tr><th>Asset</th><th>Timing</th><th>Direction</th></tr></thead><tbody>';
                        llKeys.forEach(function(k) {
                            var ll = d.lead_lag[k];
                            if (ll.lag !== null) {
                                html += '<tr><td>' + ll.asset + '</td><td>' + (ll.lag_text || '--') + '</td><td style="color:#94a3b8;">' + (ll.direction || '--') + '</td></tr>';
                            }
                        });
                        html += '</tbody></table></div>';
                    }
                }

                if (d.storage_context && d.storage_context.current_pct !== null) {
                    var sc = d.storage_context;
                    var diffColor = sc.vs_seasonal > 0 ? '#4ade80' : (sc.vs_seasonal < -5 ? '#f87171' : '#facc15');
                    var pctColor = sc.current_pct > 60 ? '#4ade80' : (sc.current_pct > 40 ? '#facc15' : '#f87171');
                    html += '<div class="geri-trader-panel"><h4>EU Gas Storage Context</h4><div class="gti-subtitle">Current storage vs seasonal norms</div>' +
                        '<div class="gti-storage-card"><div class="gti-storage-pct" style="color:' + pctColor + ';">' + sc.current_pct + '%</div>' +
                        '<div class="gti-storage-detail"><div class="gti-storage-narrative">' + sc.narrative + '</div>' +
                        '<div class="gti-storage-diff" style="color:' + diffColor + ';">' + sc.status + '</div></div></div></div>';
                }

                if (d.reaction_summary) {
                    html += '<div class="geri-trader-panel"><h4>Asset Reaction Summary</h4><div class="gti-subtitle">How markets are responding to risk</div>' +
                        '<div class="gti-reaction-summary">' + d.reaction_summary + '</div></div>';
                }

                if (d.alert_preview && d.alert_preview.length > 0) {
                    html += '<div class="geri-trader-panel"><h4>Recent Risk Alerts</h4><div class="gti-subtitle">Latest events driving GERI</div>' +
                        '<ul class="gti-alert-preview">';
                    d.alert_preview.forEach(function(a) {
                        var rawSev = a.severity;
                        var sevLabel = 'medium';
                        if (typeof rawSev === 'number') {
                            if (rawSev >= 8) sevLabel = 'critical';
                            else if (rawSev >= 6) sevLabel = 'high';
                            else if (rawSev >= 4) sevLabel = 'medium';
                            else sevLabel = 'low';
                        } else if (typeof rawSev === 'string') {
                            sevLabel = rawSev.toLowerCase();
                        }
                        var sevCls = 'gti-sev-' + sevLabel;
                        var sevDisplay = sevLabel.charAt(0).toUpperCase() + sevLabel.slice(1);
                        html += '<li><div class="gti-alert-headline">' + (a.headline || 'Unnamed alert') + '</div>' +
                            '<div style="display:flex; flex-direction:column; align-items:flex-end; gap:4px;">' +
                            '<span class="gti-alert-severity ' + sevCls + '">' + sevDisplay + '</span>' +
                            '<span class="gti-alert-meta">' + (a.date || '') + '</span></div></li>';
                    });
                    html += '</ul>';
                    if (planLevel < 3) {
                        html += '<div class="gti-upgrade-cta"><a href="javascript:void(0)" onclick="showSection(\'plans\')">Upgrade to Pro for full alert intelligence </a></div>';
                    }
                    html += '</div>';
                }

                if (planLevel >= 3 && d.rolling_correlations && d.rolling_correlations.length > 0) {
                    html += '<div class="geri-trader-panel gti-pro-panel"><h4><span class="gti-tier-badge gti-tier-pro">PRO</span> Cross-Asset Correlation Intelligence</h4>' +
                        '<div class="gti-subtitle">30-day rolling Pearson correlations with GERI</div>' +
                        '<table class="gti-table"><thead><tr><th>Asset</th><th>Correlation</th><th>Strength</th><th>Sample</th></tr></thead><tbody>';
                    d.rolling_correlations.forEach(function(rc) {
                        var corrColor = rc.correlation === null ? '#64748b' : (rc.correlation > 0.4 ? '#4ade80' : (rc.correlation < -0.4 ? '#f87171' : '#facc15'));
                        html += '<tr><td>' + rc.asset + '</td>' +
                            '<td style="color:' + corrColor + '; font-weight:600;">' + (rc.correlation !== null ? rc.correlation.toFixed(3) : '') + '</td>' +
                            '<td><span class="gti-badge ' + (rc.strength === 'Strong' ? 'gti-badge-strong' : (rc.strength === 'Moderate' ? 'gti-badge-moderate' : 'gti-badge-insufficient')) + '">' + rc.strength + '</span></td>' +
                            '<td style="color:#64748b;">' + rc.sample_size + 'd</td></tr>';
                    });
                    html += '</tbody></table></div>';
                }

                if (planLevel >= 3 && d.risk_decomposition && d.risk_decomposition.breakdown && d.risk_decomposition.breakdown.length > 0) {
                    html += '<div class="geri-trader-panel gti-pro-panel"><h4><span class="gti-tier-badge gti-tier-pro">PRO</span> GERI Risk Decomposition</h4>' +
                        '<div class="gti-subtitle">Breakdown of risk contributions by category</div>';
                    d.risk_decomposition.breakdown.forEach(function(b) {
                        var barColor = b.category === 'Geopolitical' ? '#f87171' : (b.category === 'Energy Supply' ? '#f97316' : (b.category === 'Market Stress' ? '#facc15' : (b.category === 'Infrastructure' ? '#38bdf8' : '#a78bfa')));
                        html += '<div style="margin-bottom:10px;">' +
                            '<div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:4px;"><span style="color:#e2e8f0;">' + b.category + '</span><span style="color:' + barColor + '; font-weight:600;">' + b.contribution_pct + '%</span></div>' +
                            '<div style="height:8px; background:#1e293b; border-radius:4px; overflow:hidden;"><div style="width:' + b.contribution_pct + '%; height:100%; background:' + barColor + '; border-radius:4px;"></div></div></div>';
                    });
                    html += '</div>';
                }

                if (planLevel >= 3 && d.regime_probability && d.regime_probability.current_band) {
                    var rp = d.regime_probability;
                    var bandColors = {'LOW': '#4ade80', 'MODERATE': '#facc15', 'ELEVATED': '#f97316', 'SEVERE': '#f87171', 'CRITICAL': '#dc2626'};
                    html += '<div class="geri-trader-panel gti-pro-panel"><h4><span class="gti-tier-badge gti-tier-pro">PRO</span> Regime Transition Probability</h4>' +
                        '<div class="gti-subtitle">Forward-looking regime change likelihood based on historical transitions</div>' +
                        '<div style="display:flex; gap:16px; flex-wrap:wrap; margin-bottom:12px;">' +
                        '<div class="gti-regime-prob-card"><div class="gti-regime-prob-label">Stay in ' + rp.current_band + '</div><div class="gti-regime-prob-value" style="color:' + (bandColors[rp.current_band] || '#94a3b8') + ';">' + rp.stay_probability + '%</div></div>' +
                        '<div class="gti-regime-prob-card"><div class="gti-regime-prob-label">Escalation Risk</div><div class="gti-regime-prob-value" style="color:#f87171;">' + rp.escalation_probability + '%</div></div>' +
                        '<div class="gti-regime-prob-card"><div class="gti-regime-prob-label">De-escalation</div><div class="gti-regime-prob-value" style="color:#4ade80;">' + rp.deescalation_probability + '%</div></div></div>' +
                        '<div style="font-size:12px; color:#94a3b8;">Band probabilities: ';
                    Object.keys(rp.probabilities).forEach(function(band, i) {
                        if (i > 0) html += '  ';
                        html += '<span style="color:' + (bandColors[band] || '#94a3b8') + ';">' + band + ': ' + rp.probabilities[band] + '%</span>';
                    });
                    html += '</div></div>';
                }

                if (planLevel >= 4 && d.spillover_analysis && d.spillover_analysis.length > 0) {
                    html += '<div class="geri-trader-panel gti-enterprise-panel"><h4><span class="gti-tier-badge gti-tier-enterprise">ENTERPRISE</span> Multi-Region Spillover Analysis</h4>' +
                        '<div class="gti-subtitle">Asset sensitivity to GERI risk spikes (3pts)</div>' +
                        '<table class="gti-table"><thead><tr><th>Asset</th><th>Avg Reaction</th><th>Lag</th><th>Sensitivity</th><th>Events</th></tr></thead><tbody>';
                    d.spillover_analysis.forEach(function(sp) {
                        var sensColor = sp.sensitivity === 'High' ? '#f87171' : (sp.sensitivity === 'Moderate' ? '#facc15' : '#4ade80');
                        html += '<tr><td>' + sp.asset + '</td>' +
                            '<td style="color:' + (sp.avg_reaction_pct > 0 ? '#4ade80' : '#f87171') + '; font-weight:600;">' + (sp.avg_reaction_pct > 0 ? '+' : '') + sp.avg_reaction_pct + '%</td>' +
                            '<td style="color:#94a3b8;">' + sp.avg_reaction_lag_days + 'd</td>' +
                            '<td><span class="gti-badge" style="background:' + sensColor + '22; color:' + sensColor + '; border:1px solid ' + sensColor + '44;">' + sp.sensitivity + '</span></td>' +
                            '<td style="color:#64748b;">' + sp.spike_events + '</td></tr>';
                    });
                    html += '</tbody></table></div>';
                }

                var tierLabel = planLevel >= 4 ? 'Enterprise Intelligence' : (planLevel >= 3 ? 'Pro Intelligence' : 'Trader Intelligence');
                if (d.last_updated) {
                    html += '<div class="gti-last-updated">' + tierLabel + ' last updated: ' + d.last_updated + '</div>';
                }

                if (planLevel < 3) {
                    html += '<div class="gti-upgrade-section">' +
                        '<div class="gti-upgrade-title">Unlock Pro Intelligence</div>' +
                        '<div class="gti-upgrade-features"><span>Cross-Asset Correlations</span><span>Risk Decomposition</span><span>Regime Probability</span></div>' +
                        '<button onclick="showSection(\'plans\')" class="gti-upgrade-btn">Upgrade to Pro </button></div>';
                } else if (planLevel < 4) {
                    html += '<div class="gti-upgrade-section">' +
                        '<div class="gti-upgrade-title">Unlock Enterprise Intelligence</div>' +
                        '<div class="gti-upgrade-features"><span>Spillover Analysis</span><span>Portfolio Modeling</span><span>Custom Alert Thresholds</span></div>' +
                        '<button onclick="showSection(\'plans\')" class="gti-upgrade-btn">Upgrade to Enterprise </button></div>';
                }

                section.innerHTML = html || '<div class="geri-trader-panel" style="text-align:center; color:#64748b;">Trader intelligence data will appear once sufficient GERI history is available.</div>';
            } catch (err) {
                console.error('Error loading GERI trader intel:', err);
                section.innerHTML = '<div class="geri-trader-panel" style="text-align:center; color:#64748b;">Error loading trader intelligence.</div>';
            }
        }

        // Chart instance reference
        let geriChart = null;
        let geriHistoryData = [];
        let currentRangeFilter = 'all'; // Track current range
        let marketOverlays = {
            brent: { active: false, data: [], rawData: [], unit: 'USD/barrel' },
            gas_storage: { active: false, data: [], rawData: [], unit: '%' },
            vix: { active: false, data: [], rawData: [], unit: 'index' },
            ttf: { active: false, data: [], rawData: [], unit: 'EUR/MWh' },
            eurusd: { active: false, data: [], rawData: [], unit: 'rate' }
        };
        let overlayDataLoaded = false;
        
        // Fetch real market data from API
        async function loadMarketOverlayData() {
            if (overlayDataLoaded) return;
            
            try {
                const response = await fetch('/api/v1/indices/geri/market-overlays?from=2026-01-01', {
                    headers: { 'X-User-Token': sessionToken }
                });
                
                if (!response.ok) {
                    console.warn('Failed to fetch market overlay data');
                    return;
                }
                
                const result = await response.json();
                
                if (result.overlays?.brent?.data) {
                    marketOverlays.brent.rawData = result.overlays.brent.data;
                    marketOverlays.brent.unit = result.overlays.brent.unit;
                    alignOverlayWithGeri('brent');
                }
                
                if (result.overlays?.gas_storage?.data) {
                    marketOverlays.gas_storage.rawData = result.overlays.gas_storage.data;
                    marketOverlays.gas_storage.unit = result.overlays.gas_storage.unit;
                    alignOverlayWithGeri('gas_storage');
                }
                
                if (result.overlays?.vix?.data) {
                    marketOverlays.vix.rawData = result.overlays.vix.data;
                    marketOverlays.vix.unit = result.overlays.vix.unit;
                    alignOverlayWithGeri('vix');
                }
                
                if (result.overlays?.ttf?.data) {
                    marketOverlays.ttf.rawData = result.overlays.ttf.data;
                    marketOverlays.ttf.unit = result.overlays.ttf.unit;
                    alignOverlayWithGeri('ttf');
                }
                
                if (result.overlays?.eurusd?.data) {
                    marketOverlays.eurusd.rawData = result.overlays.eurusd.data;
                    marketOverlays.eurusd.unit = result.overlays.eurusd.unit;
                    alignOverlayWithGeri('eurusd');
                }
                
                overlayDataLoaded = true;
                console.log('Market overlay data loaded:', {
                    brent: marketOverlays.brent.data.length,
                    gas_storage: marketOverlays.gas_storage.data.length,
                    vix: marketOverlays.vix.data.length,
                    ttf: marketOverlays.ttf.data.length,
                    eurusd: marketOverlays.eurusd.data.length
                });
            } catch (error) {
                console.error('Error loading market overlay data:', error);
            }
        }
        
        // Normalization ranges for each asset type (historical context)
        // These ranges map real-world values to 0-100 scale
        const assetNormalizationRanges = {
            brent: { min: 50, max: 120, label: 'Brent Oil' },      // USD/barrel typical range
            gas_storage: { min: 0, max: 100, label: 'EU Gas Storage' }, // Already 0-100%
            vix: { min: 10, max: 50, label: 'VIX' },               // VIX typical range (low ~12, crisis ~40+)
            ttf: { min: 20, max: 100, label: 'TTF Gas' },          // EUR/MWh typical range
            eurusd: { min: 1.00, max: 1.30, label: 'EUR/USD' }     // EUR/USD typical range
        };
        
        // Normalize a value to 0-100 scale based on asset type
        function normalizeToScale(value, assetKey) {
            if (value === null || value === undefined) return null;
            
            const range = assetNormalizationRanges[assetKey];
            if (!range) return value;
            
            // Linear normalization: ((value - min) / (max - min)) * 100
            // Clamp to 0-100 to handle outliers
            const normalized = ((value - range.min) / (range.max - range.min)) * 100;
            return Math.max(0, Math.min(100, normalized));
        }
        
        // Align overlay data with GERI dates (for chart synchronization)
        function alignOverlayWithGeri(key) {
            const overlay = marketOverlays[key];
            const rawData = overlay.rawData;
            
            // Create a map of date -> value for quick lookup
            const dateMap = {};
            rawData.forEach(d => {
                dateMap[d.date] = d.value;
            });
            
            // Map to GERI dates and normalize to 0-100 scale
            overlay.data = geriHistoryData.map(geriPoint => {
                const rawVal = dateMap[geriPoint.date];
                if (rawVal === undefined) return null;
                return normalizeToScale(rawVal, key);
            });
            
            // Also store raw values for tooltip display
            overlay.rawAligned = geriHistoryData.map(geriPoint => {
                const val = dateMap[geriPoint.date];
                return val !== undefined ? val : null;
            });
        }
        
        // Get overlay data sliced to current range (normalized 0-100)
        function getSlicedOverlayData(key) {
            const fullData = marketOverlays[key].data;
            if (currentRangeFilter === 'all' || !fullData.length) {
                return fullData;
            }
            const rangeNum = parseInt(currentRangeFilter);
            return fullData.slice(-rangeNum);
        }
        
        // Get raw overlay data sliced to current range (actual prices)
        function getSlicedOverlayRawData(key) {
            const fullRawData = marketOverlays[key].rawAligned || [];
            if (currentRangeFilter === 'all' || !fullRawData.length) {
                return fullRawData;
            }
            const rangeNum = parseInt(currentRangeFilter);
            return fullRawData.slice(-rangeNum);
        }
        
        async function loadGeriChartData(currentGeri) {
            const plan = currentUser?.plan || 'free';
            const cfg = GERI_PLAN_CONFIG[plan] || GERI_PLAN_CONFIG.free;

            try {
                const headers = cfg.useDelayedData ? {} : { 'X-User-Token': sessionToken };
                let toParam = '';
                if (cfg.useDelayedData) {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    toParam = '&to=' + yesterday.toISOString().split('T')[0];
                }
                const response = await fetch('/api/v1/indices/geri?from=2026-01-01' + toParam, { headers });
                
                if (!response.ok) throw new Error('Failed to fetch GERI history');
                
                const result = await response.json();
                let allData = result.data || [];

                if (cfg.maxHistoryDays > 0 && allData.length > cfg.maxHistoryDays) {
                    allData = allData.slice(-cfg.maxHistoryDays);
                }
                geriHistoryData = allData;
                
                await loadMarketOverlayData();

                if (cfg.showTrendIndicators) {
                    updateTrendIndicators(currentGeri, geriHistoryData);
                }
                
                initializeGeriChart();
                setupRangeButtons();
                setupOverlayToggles();
                setupSmoothingSelector();

                if (plan === 'free') {
                    marketOverlays.brent.active = true;
                    updateMarketOverlays();
                }

                if (cfg.showAssetReaction) {
                    var reactionEl = document.getElementById('geriAssetReaction');
                    if (reactionEl) {
                        reactionEl.innerHTML = buildAssetReactionSummary(geriHistoryData, marketOverlays);
                    }
                }

                updateGeriChartAxisLabel();
                
            } catch (error) {
                console.error('Error loading GERI chart data:', error);
            }
        }

        function setupSmoothingSelector() {
            const select = document.getElementById('geriSmoothingSelect');
            if (!select) return;
            select.addEventListener('change', () => {
                currentGeriSmoothing = select.value;
                applySmoothing();
            });
        }

        function applySmoothing() {
            if (!geriChart || !geriHistoryData.length) return;
            const rawValues = geriHistoryData.map(d => d.value);
            let displayValues = rawValues;
            if (currentGeriSmoothing === '3') {
                displayValues = computeMovingAverage(rawValues, 3);
            } else if (currentGeriSmoothing === '7') {
                displayValues = computeMovingAverage(rawValues, 7);
            }

            let filteredData = displayValues;
            if (currentRangeFilter !== 'all') {
                const rangeNum = parseInt(currentRangeFilter);
                filteredData = displayValues.slice(-rangeNum);
            }

            geriChart.data.datasets[0].data = filteredData;
            geriChart.update();
        }
        
        function updateTrendIndicators(currentGeri, historyData) {
            const trend1dEl = document.getElementById('trend1d');
            const trend7dEl = document.getElementById('trend7d');
            const momentumEl = document.getElementById('trendMomentum');
            const currentBandEl = document.getElementById('currentBand');
            const currentBandValueEl = document.getElementById('currentBandValue');
            
            // Current band
            if (currentBandEl && currentGeri) {
                const bandColor = currentGeri.band === 'CRITICAL' ? '#ef4444' :
                                  currentGeri.band === 'ELEVATED' ? '#f97316' :
                                  currentGeri.band === 'MODERATE' ? '#eab308' : '#22c55e';
                currentBandEl.textContent = currentGeri.band || '--';
                currentBandEl.style.color = bandColor;
            }
            if (currentBandValueEl && currentGeri) {
                currentBandValueEl.textContent = (currentGeri.value || '--') + '/100';
            }
            
            // 1-day change
            const trend1d = currentGeri.trend_1d || 0;
            if (trend1dEl) {
                const sign = trend1d > 0 ? '+' : '';
                trend1dEl.textContent = sign + trend1d.toFixed(0);
                trend1dEl.className = 'trend-indicator-value ' + 
                    (trend1d > 0 ? 'positive' : trend1d < 0 ? 'negative' : 'neutral');
            }
            
            // 7-day change
            const trend7d = currentGeri.trend_7d || 0;
            if (trend7dEl) {
                const sign = trend7d > 0 ? '+' : '';
                trend7dEl.textContent = sign + trend7d.toFixed(0);
                trend7dEl.className = 'trend-indicator-value ' + 
                    (trend7d > 0 ? 'positive' : trend7d < 0 ? 'negative' : 'neutral');
            }
            
            // Momentum (based on recent slope)
            if (momentumEl && historyData.length >= 3) {
                const recent = historyData.slice(-5);
                const firstVal = recent[0]?.value || 0;
                const lastVal = recent[recent.length - 1]?.value || 0;
                const diff = lastVal - firstVal;
                
                let momentum = 'Stable';
                if (diff > 5) momentum = 'Accelerating ';
                else if (diff > 0) momentum = 'Rising ';
                else if (diff < -5) momentum = 'Decelerating ';
                else if (diff < 0) momentum = 'Falling ';
                
                momentumEl.textContent = momentum;
                momentumEl.className = 'trend-indicator-value ' + 
                    (diff > 0 ? 'positive' : diff < 0 ? 'negative' : 'neutral');
            }
        }
        
        function initializeGeriChart() {
            const ctx = document.getElementById('geriHistoryChart');
            if (!ctx) return;
            
            // Destroy existing chart
            if (geriChart) {
                geriChart.destroy();
            }
            
            const labels = geriHistoryData.map(d => d.date);
            const values = geriHistoryData.map(d => d.value);
            
            // Band colors for background shading
            const bandPlugin = {
                id: 'bandShading',
                beforeDraw: (chart) => {
                    const ctx = chart.ctx;
                    const chartArea = chart.chartArea;
                    const yScale = chart.scales.y;
                    
                    const bands = [
                        { min: 0, max: 25, color: 'rgba(34, 197, 94, 0.1)' },    // LOW - green
                        { min: 25, max: 50, color: 'rgba(234, 179, 8, 0.1)' },   // MODERATE - yellow
                        { min: 50, max: 75, color: 'rgba(249, 115, 22, 0.1)' },  // ELEVATED - orange
                        { min: 75, max: 100, color: 'rgba(239, 68, 68, 0.1)' }   // CRITICAL - red
                    ];
                    
                    bands.forEach(band => {
                        const top = yScale.getPixelForValue(band.max);
                        const bottom = yScale.getPixelForValue(band.min);
                        
                        ctx.save();
                        ctx.fillStyle = band.color;
                        ctx.fillRect(chartArea.left, top, chartArea.right - chartArea.left, bottom - top);
                        ctx.restore();
                    });
                }
            };
            
            geriChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'GERI',
                        data: values,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointRadius: 3,
                        pointHoverRadius: 6,
                        pointBackgroundColor: '#3b82f6',
                        pointBorderColor: '#1e293b',
                        pointBorderWidth: 2,
                        yAxisID: 'y'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#94a3b8',
                                usePointStyle: true,
                                padding: 20,
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            backgroundColor: '#1e293b',
                            titleColor: '#f1f5f9',
                            bodyColor: '#94a3b8',
                            borderColor: '#334155',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                title: (items) => 'Date: ' + items[0].label,
                                label: (context) => {
                                    const val = context.parsed.y;
                                    const dsLabel = context.dataset.label;
                                    
                                    // GERI shows band
                                    if (dsLabel === 'GERI') {
                                        let band = 'LOW';
                                        if (val >= 76) band = 'CRITICAL';
                                        else if (val >= 51) band = 'ELEVATED';
                                        else if (val >= 26) band = 'MODERATE';
                                        return dsLabel + ': ' + val.toFixed(0) + ' (' + band + ')';
                                    }
                                    
                                    // For overlays, show the actual raw value
                                    const rawValue = context.dataset.rawData?.[context.dataIndex];
                                    if (rawValue !== null && rawValue !== undefined) {
                                        const unit = context.dataset.unit || '';
                                        // Format based on asset type
                                        if (dsLabel.includes('EUR/USD')) {
                                            return dsLabel + ': ' + rawValue.toFixed(4);
                                        } else if (dsLabel.includes('Storage')) {
                                            return dsLabel + ': ' + rawValue.toFixed(1) + '%';
                                        } else if (dsLabel.includes('VIX')) {
                                            return dsLabel + ': ' + rawValue.toFixed(2);
                                        } else if (dsLabel.includes('TTF')) {
                                            return dsLabel + ': ' + rawValue.toFixed(2) + '/MWh';
                                        } else if (dsLabel.includes('Brent')) {
                                            return dsLabel + ': $' + rawValue.toFixed(2) + '/barrel';
                                        }
                                        return dsLabel + ': ' + rawValue.toFixed(2) + ' ' + unit;
                                    }
                                    return dsLabel + ': ' + val.toFixed(1);
                                }
                            }
                        },
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'x'
                            },
                            zoom: {
                                wheel: { enabled: true },
                                pinch: { enabled: true },
                                mode: 'x',
                                onZoomComplete: ({ chart }) => {
                                    chart.update('none');
                                }
                            }
                        },
                        decimation: {
                            enabled: false
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(51, 65, 85, 0.5)' },
                            ticks: { 
                                color: '#64748b',
                                maxRotation: 45,
                                autoSkip: true,
                                maxTicksLimit: 10
                            }
                        },
                        y: {
                            min: 0,
                            max: 100,
                            grid: { color: 'rgba(51, 65, 85, 0.5)' },
                            ticks: { 
                                color: '#64748b',
                                stepSize: 25,
                                callback: (val) => val
                            },
                            title: {
                                display: true,
                                text: 'GERI Value',
                                color: '#64748b'
                            }
                        },
                        y1: {
                            position: 'right',
                            display: false,
                            min: 0,
                            max: 100,
                            grid: { drawOnChartArea: false },
                            ticks: { 
                                color: '#64748b',
                                stepSize: 25
                            }
                        }
                    }
                },
                plugins: [bandPlugin, geriAnnotationPlugin]
            });
        }

        var geriAnnotationPlugin = {
            id: 'geriAnnotations',
            afterDraw: function(chart) {
                var plan = currentUser?.plan || 'free';
                var cfg = GERI_PLAN_CONFIG[plan] || GERI_PLAN_CONFIG.free;
                if (!cfg.showChartAnnotations) return;
                if (!geriHistoryData || geriHistoryData.length < 3) return;

                var ctx = chart.ctx;
                var chartArea = chart.chartArea;
                var xScale = chart.scales.x;
                var yScale = chart.scales.y;
                var labels = chart.data.labels;

                for (var i = 1; i < geriHistoryData.length; i++) {
                    var curr = geriHistoryData[i];
                    var prev = geriHistoryData[i - 1];
                    if (!curr || !prev) continue;

                    var delta = curr.value - prev.value;
                    var labelIdx = labels.indexOf(curr.date);
                    if (labelIdx === -1) continue;

                    var annotText = null;
                    if (delta >= 8) {
                        annotText = 'Risk spike';
                    } else if (delta <= -8) {
                        annotText = 'Risk drop';
                    } else if (curr.value >= 75 && prev.value < 75) {
                        annotText = 'Critical';
                    }

                    if (annotText) {
                        var x = xScale.getPixelForValue(labelIdx);
                        var y = yScale.getPixelForValue(curr.value);
                        if (x < chartArea.left || x > chartArea.right) continue;

                        ctx.save();
                        ctx.beginPath();
                        ctx.arc(x, y - 14, 3, 0, Math.PI * 2);
                        ctx.fillStyle = delta > 0 ? 'rgba(239,68,68,0.7)' : 'rgba(34,197,94,0.7)';
                        ctx.fill();

                        ctx.font = '9px -apple-system, BlinkMacSystemFont, sans-serif';
                        ctx.fillStyle = 'rgba(148,163,184,0.7)';
                        ctx.textAlign = 'center';
                        ctx.fillText(annotText, x, y - 20);
                        ctx.restore();
                    }
                }
            }
        };

        function updateGeriChartAxisLabel() {
            var el = document.getElementById('geriChartAxisLabel');
            if (!el) return;
            var activeOverlay = null;
            var names = { brent: 'Brent', ttf: 'TTF', vix: 'VIX', eurusd: 'EUR/USD', gas_storage: 'Storage' };
            var keys = ['brent', 'ttf', 'vix', 'eurusd', 'gas_storage'];
            for (var i = 0; i < keys.length; i++) {
                if (marketOverlays[keys[i]] && marketOverlays[keys[i]].active) {
                    activeOverlay = names[keys[i]];
                    break;
                }
            }
            if (activeOverlay) {
                el.textContent = 'GERI (index) | ' + activeOverlay + ' (price context)';
            } else {
                el.textContent = 'GERI (index)';
            }
        }

        function setupRangeButtons() {
            const buttons = document.querySelectorAll('.chart-range-btn');
            const dataLength = geriHistoryData.length;
            
            buttons.forEach(btn => {
                const range = btn.dataset.range;
                const rangeNum = parseInt(range);
                if (!isNaN(rangeNum) && dataLength < rangeNum) {
                    btn.disabled = true;
                }
                
                btn.addEventListener('click', () => {
                    if (btn.disabled) return;
                    
                    buttons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentRangeFilter = range;
                    
                    let filteredData = geriHistoryData;
                    if (range !== 'all') {
                        filteredData = geriHistoryData.slice(-parseInt(range));
                    }
                    
                    if (geriChart) {
                        geriChart.data.labels = filteredData.map(d => d.date);

                        let values = filteredData.map(d => d.value);
                        if (currentGeriSmoothing === '3') {
                            values = computeMovingAverage(values, 3);
                        } else if (currentGeriSmoothing === '7') {
                            values = computeMovingAverage(values, 7);
                        }
                        geriChart.data.datasets[0].data = values;
                        
                        updateMarketOverlays();
                    }
                });
            });
        }
        
        function setupOverlayToggles() {
            const plan = currentUser?.plan || 'free';
            const cfg = GERI_PLAN_CONFIG[plan] || GERI_PLAN_CONFIG.free;

            const assetSelect = document.getElementById('geriAssetSelect');
            if (assetSelect) {
                assetSelect.addEventListener('change', () => {
                    Object.keys(marketOverlays).forEach(k => { marketOverlays[k].active = false; });
                    const selected = assetSelect.value;
                    if (selected && marketOverlays[selected]) {
                        marketOverlays[selected].active = true;
                    }
                    updateMarketOverlays();
                });
            }

            const toggles = document.querySelectorAll('.overlay-toggle');
            
            toggles.forEach(toggle => {
                toggle.addEventListener('click', () => {
                    const overlay = toggle.dataset.overlay;
                    const isActive = toggle.classList.contains('active');

                    if (!isActive) {
                        const activeCount = Object.values(marketOverlays).filter(o => o.active).length;
                        if (activeCount >= cfg.maxOverlays) {
                            showOverlayLimitToast(cfg.maxOverlays);
                            return;
                        }
                    }

                    toggle.classList.toggle('active');
                    marketOverlays[overlay].active = toggle.classList.contains('active');
                    updateMarketOverlays();
                });
            });
        }
        
        async function updateMarketOverlays() {
            if (!geriChart) return;
            
            // Remove existing overlay datasets (keep only GERI)
            geriChart.data.datasets = geriChart.data.datasets.filter(ds => ds.label === 'GERI');
            
            // Display configuration for each overlay
            const overlayConfigs = {
                brent: { label: 'Brent Oil (USD/barrel)', color: '#f59e0b' },
                gas_storage: { label: 'EU Gas Storage (%)', color: '#10b981' },
                vix: { label: 'VIX (index)', color: '#ef4444' },
                ttf: { label: 'TTF Gas (EUR/MWh)', color: '#8b5cf6' },
                eurusd: { label: 'EUR/USD', color: '#06b6d4' }
            };
            
            // Get current labels from chart (matches current range)
            const currentLabels = geriChart.data.labels;
            
            Object.entries(marketOverlays).forEach(([key, overlay]) => {
                if (overlay.active && overlay.data.length > 0) {
                    const config = overlayConfigs[key];
                    
                    // Use pre-generated normalized data (0-100 scale), sliced to match current range
                    const slicedData = getSlicedOverlayData(key);
                    const slicedRawData = getSlicedOverlayRawData(key);
                    
                    geriChart.data.datasets.push({
                        label: config.label,
                        data: slicedData,
                        rawData: slicedRawData,  // Store raw values for tooltip display
                        unit: overlay.unit,
                        borderColor: config.color,
                        backgroundColor: 'transparent',
                        borderWidth: 1.5,
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0.3,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        yAxisID: 'y',  // Use primary Y-axis since values are normalized to 0-100
                        spanGaps: true  // Connect lines across missing data points
                    });
                }
            });
            
            geriChart.update();
            updateGeriChartAxisLabel();

            var plan = currentUser?.plan || 'free';
            var cfg = GERI_PLAN_CONFIG[plan] || GERI_PLAN_CONFIG.free;
            if (cfg.showAssetReaction) {
                var reactionEl = document.getElementById('geriAssetReaction');
                if (reactionEl) {
                    reactionEl.innerHTML = buildAssetReactionSummary(geriHistoryData, marketOverlays);
                }
            }
        }

        async function generateTelegramCode() {
            try {
                const response = await fetch('/users/telegram/generate-code', {
                    method: 'POST',
                    headers: { 'X-User-Token': sessionToken }
                });
                
                if (!response.ok) {
                    const err = await response.json().catch(() => ({}));
                    throw new Error(err.detail || 'Failed to generate code');
                }
                
                const data = await response.json();
                
                document.getElementById('telegramLinkCode').textContent = data.code;
                document.getElementById('telegramBotUsername').textContent = data.bot_username;
                document.getElementById('telegramCodeExpiry').textContent = data.expires_in_minutes;
                
                if (data.deep_link) {
                    document.getElementById('telegramDeepLink').href = data.deep_link;
                }
                
                document.getElementById('telegramLinkStep1').style.display = 'none';
                document.getElementById('telegramLinkStep2').style.display = 'block';
                document.getElementById('telegramManualEntry').style.display = 'none';
                
                telegramPollCount = 0;
                setTimeout(() => {
                    checkTelegramLinked();
                }, 5000);
            } catch (error) {
                console.error('Error generating Telegram code:', error);
                alert(error.message || 'Failed to generate linking code. Please try again.');
            }
        }

        function showManualChatIdEntry() {
            document.getElementById('telegramLinkStep1').style.display = 'none';
            document.getElementById('telegramLinkStep2').style.display = 'none';
            document.getElementById('telegramManualEntry').style.display = 'block';
        }

        function cancelManualEntry() {
            document.getElementById('telegramLinkStep1').style.display = 'block';
            document.getElementById('telegramManualEntry').style.display = 'none';
            document.getElementById('manualChatIdInput').value = '';
        }

        async function linkManualChatId() {
            const chatId = document.getElementById('manualChatIdInput').value.trim();
            if (!chatId) {
                alert('Please enter your Chat ID');
                return;
            }
            
            try {
                const response = await fetch(`/users/telegram/link-manual?chat_id=${encodeURIComponent(chatId)}`, {
                    method: 'POST',
                    headers: { 'X-User-Token': sessionToken }
                });
                
                if (!response.ok) {
                    const err = await response.json().catch(() => ({}));
                    throw new Error(err.detail || 'Failed to link Telegram');
                }
                
                const data = await response.json();
                currentUser.telegram_chat_id = data.chat_id;
                updateTelegramUI();
                cancelManualEntry();
                alert('Telegram linked successfully!');
            } catch (error) {
                console.error('Error linking Telegram:', error);
                alert(error.message || 'Failed to link Telegram. Please check your Chat ID and try again.');
            }
        }

        function cancelTelegramLink() {
            document.getElementById('telegramLinkStep1').style.display = 'block';
            document.getElementById('telegramManualEntry').style.display = 'none';
            document.getElementById('telegramLinkStep2').style.display = 'none';
        }

        let telegramPollCount = 0;
        const MAX_TELEGRAM_POLLS = 180;
        
        async function checkTelegramLinked() {
            telegramPollCount++;
            
            if (telegramPollCount > MAX_TELEGRAM_POLLS) {
                cancelTelegramLink();
                alert('Linking code expired. Please generate a new code.');
                return;
            }
            
            try {
                const response = await fetch('/users/me', {
                    headers: { 'X-User-Token': sessionToken }
                });
                
                if (response.ok) {
                    const user = await response.json();
                    if (user.telegram_chat_id) {
                        currentUser = user;
                        updateTelegramUI();
                        cancelTelegramLink();
                        telegramPollCount = 0;
                    } else if (document.getElementById('telegramLinkStep2').style.display === 'block') {
                        setTimeout(checkTelegramLinked, 5000);
                    }
                }
            } catch (error) {
                console.error('Error checking Telegram status:', error);
            }
        }

        async function unlinkTelegram() {
            if (!confirm('Are you sure you want to unlink your Telegram account?')) return;
            
            try {
                const response = await fetch('/users/telegram/unlink', {
                    method: 'POST',
                    headers: { 'X-User-Token': sessionToken }
                });
                
                if (!response.ok) throw new Error('Failed to unlink');
                
                currentUser.telegram_chat_id = null;
                updateTelegramUI();
            } catch (error) {
                console.error('Error unlinking Telegram:', error);
                alert('Failed to unlink Telegram. Please try again.');
            }
        }

        let allowedAlertTypes = [];

        async function loadAlerts() {
            try {
                const response = await fetch('/users/alerts?limit=100', {
                    headers: { 'X-User-Token': sessionToken }
                });

                if (!response.ok) throw new Error('Failed to load alerts');

                const data = await response.json();
                allowedAlertTypes = data.allowed_alert_types || [];
                const lockedTypes = data.locked_alert_types || [];
                const lockedSamples = data.locked_samples || [];
                
                allAlerts = data.alerts || [];
                
                initializeFilters();
                renderAlerts(allAlerts, allowedAlertTypes);
                renderAllowedAlertTypes(allowedAlertTypes, lockedTypes);
                renderLockedSamples(lockedSamples);
            } catch (error) {
                console.error('Error loading alerts:', error);
                const ra = document.getElementById('recentAlerts');
                if (ra) ra.innerHTML = '<div class="empty-state">Failed to load alerts</div>';
                document.getElementById('allAlerts').innerHTML = '<div class="empty-state">Failed to load alerts</div>';
            }
        }
        
        function initializeFilters() {
            const now = new Date();
            const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            
            document.getElementById('filterFromDate').value = yesterday.toISOString().split('T')[0];
            document.getElementById('filterFromTime').value = yesterday.toTimeString().slice(0, 5);
            document.getElementById('filterToDate').value = now.toISOString().split('T')[0];
            document.getElementById('filterToTime').value = now.toTimeString().slice(0, 5);
            document.getElementById('filterRegion').value = '';
            document.getElementById('filterOil').classList.add('active');
            document.getElementById('filterGas').classList.add('active');
            document.getElementById('filterFX').classList.add('active');
        }
        
        function toggleFilter(type) {
            const btn = document.getElementById('filter' + type);
            btn.classList.toggle('active');
        }
        
        function applyFilters() {
            const fromDate = document.getElementById('filterFromDate').value;
            const fromTime = document.getElementById('filterFromTime').value || '00:00';
            const toDate = document.getElementById('filterToDate').value;
            const toTime = document.getElementById('filterToTime').value || '23:59';
            const selectedRegion = document.getElementById('filterRegion').value;
            const showOil = document.getElementById('filterOil').classList.contains('active');
            const showGas = document.getElementById('filterGas').classList.contains('active');
            const showFX = document.getElementById('filterFX').classList.contains('active');
            
            let filtered = allAlerts;
            
            if (fromDate && toDate) {
                const fromDateTime = new Date(`${fromDate}T${fromTime}`);
                const toDateTime = new Date(`${toDate}T${toTime}`);
                filtered = filtered.filter(alert => {
                    const alertDate = new Date(alert.created_at);
                    return alertDate >= fromDateTime && alertDate <= toDateTime;
                });
            }
            
            if (selectedRegion) {
                filtered = filtered.filter(alert => {
                    const alertRegion = (alert.region || '').toLowerCase().replace(/\s+/g, '_');
                    return alertRegion === selectedRegion;
                });
            }
            
            if (!showOil || !showGas || !showFX) {
                filtered = filtered.filter(alert => {
                    const asset = (alert.asset || '').toLowerCase();
                    if (asset.includes('oil') || asset.includes('brent') || asset.includes('wti') || asset.includes('crude')) {
                        return showOil;
                    }
                    if (asset.includes('gas') || asset.includes('lng') || asset.includes('natural')) {
                        return showGas;
                    }
                    if (asset.includes('fx') || asset.includes('eur') || asset.includes('usd') || asset.includes('currency')) {
                        return showFX;
                    }
                    return true;
                });
            }
            
            renderAlertsGrid(filtered, allowedAlertTypes, document.getElementById('allAlerts'));
        }
        
        function resetFilters() {
            initializeFilters();
            renderAlerts(allAlerts, allowedAlertTypes);
        }

        function renderAllowedAlertTypes(allowedTypes, lockedTypes) {
            const allTypes = ['HIGH_IMPACT_EVENT', 'REGIONAL_RISK_SPIKE', 'ASSET_RISK_SPIKE', 'DAILY_DIGEST'];
            const container = document.getElementById('alertTypesInfo');
            if (!container) return;

            const html = allTypes.map(type => {
                const isAllowed = allowedTypes.includes(type) || allowedTypes.includes('ALL');
                const displayName = type.replace(/_/g, ' ');
                return `
                    <div class="alert-type-item ${isAllowed ? 'allowed' : 'locked'}">
                        <span class="alert-type-icon">${isAllowed ? '&#10003;' : '&#128274;'}</span>
                        <span class="alert-type-name">${displayName}</span>
                        ${!isAllowed ? '<span class="upgrade-hint">Upgrade to unlock</span>' : ''}
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }
        
        function renderLockedSamples(lockedSamples) {
            const container = document.getElementById('lockedSamplesSection');
            if (!container) return;
            
            if (lockedSamples.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            const iconSvg = {
                REGIONAL_RISK_SPIKE: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
                ASSET_RISK_SPIKE: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>',
                HIGH_IMPACT_EVENT: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>',
                DAILY_DIGEST: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>'
            };

            const iconClass = {
                REGIONAL_RISK_SPIKE: 'regional',
                ASSET_RISK_SPIKE: 'asset',
                HIGH_IMPACT_EVENT: 'high-impact',
                DAILY_DIGEST: 'digest'
            };
            
            const getTypeLabel = (type) => {
                const labels = {
                    'HIGH_IMPACT_EVENT': 'High Impact Event',
                    'REGIONAL_RISK_SPIKE': 'Regional Risk Spike',
                    'ASSET_RISK_SPIKE': 'Asset Risk Spike',
                    'DAILY_DIGEST': 'Daily Digest'
                };
                return labels[type] || type.replace(/_/g, ' ');
            };
            
            container.style.display = 'block';
            const html = `
                <div class="card-header" style="border-bottom: 1px solid #334155;">
                    <h2 class="card-title" style="color: #f59e0b;">
                        <span style="margin-right: 8px;">&#128274;</span>
                        Upgrade to Unlock More Alerts
                    </h2>
                </div>
                <div class="card-body">
                    <p style="color: #94a3b8; margin-bottom: 20px;">Here's a preview of alerts available on higher plans:</p>
                    <div class="alerts-grid">
                        ${lockedSamples.map(sample => {
                            const alertType = sample.alert_type || 'REGIONAL_RISK_SPIKE';
                            const icon = iconSvg[alertType] || iconSvg.REGIONAL_RISK_SPIKE;
                            const iconCls = iconClass[alertType] || 'regional';
                            return `
                                <div class="sample-card locked">
                                    <div class="card-timestamp">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        ${formatDate(sample.created_at)}
                                    </div>
                                    <div class="card-header">
                                        <div class="alert-icon ${iconCls}">
                                            ${icon}
                                        </div>
                                        <div class="card-header-text">
                                            <h3>${sample.title || 'Alert Preview'}</h3>
                                            <span class="type-badge">${getTypeLabel(alertType)}</span>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="alert-content">${sample.preview || 'Upgrade to see full alert content'}</div>
                                    </div>
                                    <div class="card-footer">
                                        <span>${sample.region || ''}${sample.asset ? ' - ' + sample.asset.toUpperCase() : ''}</span>
                                    </div>
                                    <div class="card-lock-overlay">
                                        <span class="lock-icon">&#128274;</span>
                                        <span>Upgrade your plan to unlock</span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            container.innerHTML = html;
        }

        function cleanAlertMessage(message) {
            if (!message) return '';
            return message
                .replace(/Upgrade to \w+ for.*?https:\/\/energyriskiq\.com\/upgrade/gi, '')
                .replace(/https:\/\/energyriskiq\.com\/upgrade/gi, '')
                .trim();
        }
        
        function isLatestAlert(createdAt) {
            if (!createdAt) return false;
            const alertTime = new Date(createdAt);
            const now = new Date();
            const threeHoursAgo = new Date(now.getTime() - 3 * 60 * 60 * 1000);
            return alertTime >= threeHoursAgo;
        }
        
        function filterLast24Hours(alerts) {
            const now = new Date();
            const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            return alerts.filter(alert => {
                const alertDate = new Date(alert.created_at);
                return alertDate >= yesterday;
            });
        }
        
        function filterLast3Hours(alerts) {
            const now = new Date();
            const threeHoursAgo = new Date(now.getTime() - 3 * 60 * 60 * 1000);
            return alerts.filter(alert => {
                const alertDate = new Date(alert.created_at);
                return alertDate >= threeHoursAgo;
            });
        }
        
        function renderAlerts(alerts, allowedTypes) {
            const last24h = filterLast24Hours(alerts);
            const last3h = filterLast3Hours(alerts);
            const alertsCountEl = document.getElementById('alertsCount');
            if (alertsCountEl) alertsCountEl.textContent = last24h.length;

            const recentAlertsEl = document.getElementById('recentAlerts');
            if (recentAlertsEl) {
                if (last3h.length === 0) {
                    recentAlertsEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">&#128276;</div><p>No alerts in the last 3 hours.</p></div>';
                } else {
                    renderAlertsGrid(last3h.slice(0, 4), allowedTypes, recentAlertsEl);
                }
            }

            if (last24h.length === 0) {
                document.getElementById('allAlerts').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">&#128276;</div>
                        <p>No alerts in the last 24 hours. You'll see alerts here once they're triggered.</p>
                    </div>
                `;
            } else {
                renderAlertsGrid(last24h, allowedTypes, document.getElementById('allAlerts'));
            }
        }
        
        function renderAlertsGrid(alerts, allowedTypes, container) {
            if (alerts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">&#128276;</div>
                        <p>No alerts match your filter criteria.</p>
                    </div>
                `;
                return;
            }
            
            const iconSvg = {
                REGIONAL_RISK_SPIKE: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
                ASSET_RISK_SPIKE: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>',
                HIGH_IMPACT_EVENT: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>',
                DAILY_DIGEST: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>'
            };

            const iconClass = {
                REGIONAL_RISK_SPIKE: 'regional',
                ASSET_RISK_SPIKE: 'asset',
                HIGH_IMPACT_EVENT: 'high-impact',
                DAILY_DIGEST: 'digest'
            };
            
            const getTypeLabel = (type) => {
                const labels = {
                    'HIGH_IMPACT_EVENT': 'High Impact Event',
                    'REGIONAL_RISK_SPIKE': 'Regional Risk Spike',
                    'ASSET_RISK_SPIKE': 'Asset Risk Spike',
                    'DAILY_DIGEST': 'Daily Digest'
                };
                return labels[type] || type.replace(/_/g, ' ');
            };
            
            const alertCardHTML = (alert) => {
                const isAllowed = alert.allowed_by_plan;
                const isLatest = isLatestAlert(alert.created_at);
                const alertType = alert.alert_type || 'REGIONAL_RISK_SPIKE';
                const icon = iconSvg[alertType] || iconSvg.REGIONAL_RISK_SPIKE;
                const iconCls = iconClass[alertType] || 'regional';
                const channel = alert.channel || 'email';
                
                return `
                    <div class="sample-card ${!isAllowed ? 'locked' : ''}">
                        <div class="card-timestamp">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            ${formatDate(alert.created_at)}
                            ${isLatest ? '<span class="latest-badge">Latest</span>' : ''}
                        </div>
                        <div class="card-header">
                            <div class="alert-icon ${iconCls}">
                                ${icon}
                            </div>
                            <div class="card-header-text">
                                <h3>${alert.title || 'Alert'}</h3>
                                <span class="type-badge">${getTypeLabel(alertType)}</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="alert-content">${alert.message || 'No message content'}</div>
                        </div>
                        <div class="card-footer">
                            <span class="channel-badge ${channel}">${channel.toUpperCase()}</span>
                            <span>${alert.region || ''}${alert.asset ? ' - ' + alert.asset.toUpperCase() : ''}</span>
                        </div>
                        ${!isAllowed ? `
                            <div class="card-lock-overlay">
                                <span class="lock-icon">&#128274;</span>
                                <span>Available on higher tier plans</span>
                            </div>
                        ` : ''}
                    </div>
                `;
            };

            container.innerHTML = `
                <div class="alerts-grid">
                    ${alerts.map(alert => alertCardHTML(alert)).join('')}
                </div>
            `;
        }

        function formatDate(isoString) {
            if (!isoString) return '--';
            const date = new Date(isoString);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        /* ============================================
           EERI Pro Module - Encapsulated JavaScript
           ============================================ */
        
        let eeriProChart = null;
        let eeriProState = {
            loaded: false,
            days: 30,
            smoothing: 'raw',
            data: null,
            activeAssets: [],
            assetData: null
        };

        const EERI_BAND_COLORS = {
            'LOW': '#22c55e',
            'MODERATE': '#eab308',
            'ELEVATED': '#f97316',
            'CRITICAL': '#ef4444'
        };

        async function loadEeriProData() {
            const plan = currentUser?.plan || 'free';
            const isProTier = ['pro', 'enterprise'].includes(plan);
            const isTraderTier = ['trader', 'pro', 'enterprise'].includes(plan);
            
            const loadingEl = document.getElementById('eeriProLoading');
            const lockedEl = document.getElementById('eeriProLocked');
            const dashboardEl = document.getElementById('eeriProDashboard');
            const proOnlySections = document.querySelectorAll('.eeri-pro-only');
            const traderOnlySections = document.querySelectorAll('.eeri-trader-only');
            
            const headerBadge = document.getElementById('eeriHeaderBadge');
            const headerSubtitle = document.getElementById('eeriHeaderSubtitle');
            const planLabels = {'free': 'FREE', 'personal': 'PERSONAL', 'trader': 'TRADER', 'pro': 'PRO', 'enterprise': 'ENTERPRISE'};
            const planSubtitles = {
                'free': 'Weekly energy risk trends and market direction',
                'personal': 'Historical context and probability insights for energy market volatility',
                'trader': 'Tactical intelligence with reaction speed analysis and conditional probability modeling',
                'pro': 'Full structural risk intelligence with regime persistence and scenario outlooks',
                'enterprise': 'Strategic multi-region energy risk forecasting and portfolio exposure intelligence'
            };
            if (headerBadge) {
                headerBadge.textContent = planLabels[plan] || 'FREE';
                headerBadge.className = 'eeri-plan-badge-header badge-' + (plan || 'free');
            }
            if (headerSubtitle) {
                headerSubtitle.textContent = planSubtitles[plan] || planSubtitles['free'];
            }
            
            if (loadingEl) loadingEl.style.display = 'block';
            if (lockedEl) lockedEl.style.display = 'none';
            if (dashboardEl) dashboardEl.style.display = 'none';
            
            proOnlySections.forEach(el => {
                if (isProTier) {
                    el.classList.remove('eeri-hidden');
                } else {
                    el.classList.add('eeri-hidden');
                }
            });
            traderOnlySections.forEach(el => {
                if (isTraderTier) {
                    el.classList.remove('eeri-hidden');
                } else {
                    el.classList.add('eeri-hidden');
                }
            });
            
            try {
                const fetchPromises = [
                    fetch(`/api/v1/eeri-pro/weekly-snapshot?plan=${plan}`)
                ];
                
                if (isTraderTier) {
                    fetchPromises.push(
                        fetch('/api/v1/eeri-pro/trader-intel')
                    );
                }
                
                if (isProTier) {
                    fetchPromises.push(
                        fetch('/api/v1/eeri-pro/realtime'),
                        fetch('/api/v1/eeri-pro/daily-summary'),
                        fetch('/api/v1/eeri-pro/regime-stats')
                    );
                }
                
                const results = await Promise.all(fetchPromises);
                const snapshotData = await results[0].json();
                
                if (loadingEl) loadingEl.style.display = 'none';
                if (dashboardEl) dashboardEl.style.display = 'flex';
                
                if (snapshotData.success && snapshotData.data) {
                    renderWeeklySnapshot(snapshotData.data, plan);
                } else {
                    var wsContent = document.getElementById('wsContent');
                    if (wsContent) {
                        wsContent.innerHTML = '<div style="text-align: center; padding: 30px 20px; color: #94a3b8;"><p style="font-size: 14px;">Weekly snapshot data is not yet available. At least 3 days of EERI data in a completed week are needed.</p><p style="font-size: 12px; margin-top: 8px; color: #64748b;">Data is collected daily and will appear here once sufficient history is built.</p></div>';
                    }
                }
                
                let resultIdx = 1;
                
                if (isTraderTier) {
                    const traderData = await results[resultIdx].json();
                    resultIdx++;
                    if (traderData.success && traderData.data) {
                        renderTraderIntel(traderData.data);
                    }
                }
                
                if (isProTier) {
                    const realtimeData = await results[resultIdx].json();
                    const summaryData = await results[resultIdx + 1].json();
                    const regimeData = await results[resultIdx + 2].json();
                    
                    if (realtimeData.success && realtimeData.data) {
                        renderEeriMainDisplay(realtimeData.data);
                        renderEeriComponents(realtimeData.data.component_breakdown);
                        renderEeriAssetStress(realtimeData.data.asset_stress);
                        renderEeriTopDrivers(realtimeData.data.top_drivers);
                    }
                    
                    if (summaryData.success && summaryData.data) {
                        renderEeriSummary(summaryData.data);
                    }
                    
                    if (regimeData.success) {
                        renderEeriRegimeStats(regimeData);
                    }
                    
                    loadEeriHistoryChart(eeriProState.days, eeriProState.smoothing);
                    initEeriTimeControls();
                }
                
                eeriProState.loaded = true;
                
            } catch (error) {
                console.error('Error loading EERI data:', error);
                if (loadingEl) loadingEl.innerHTML = '<p style="color: #f87171;">Error loading EERI data. Please try again.</p>';
            }
        }

        function renderTraderIntel(data) {
            const tsBar = document.getElementById('eeriTimestampBar');
            if (tsBar && data.data_timestamps) {
                const ts = data.data_timestamps;
                tsBar.innerHTML = Object.entries(ts).map(([key, obj]) => {
                    const label = key.toUpperCase();
                    const d = obj && obj.date ? obj.date : '--';
                    return `<span class="ts-item"><strong>${label}:</strong> ${d}</span>`;
                }).join('');
            }

            const shockBanner = document.getElementById('eeriShockBanner');
            const shockMsg = document.getElementById('eeriShockMessage');
            if (data.risk_shock && data.risk_shock.detected) {
                if (shockBanner) shockBanner.style.display = '';
                if (shockMsg) {
                    shockMsg.innerHTML = `<span class="shock-delta">+${data.risk_shock.delta} pts</span> &mdash; ${data.risk_shock.message || 'Risk shock detected'}`;
                }
            } else {
                if (shockBanner) shockBanner.style.display = 'none';
            }

            const insightEl = document.getElementById('eeriInsightBanner');
            if (insightEl) {
                insightEl.textContent = data.trading_insight || '';
            }

            const lagBody = document.getElementById('eeriLagBody');
            if (lagBody && data.reaction_lag) {
                lagBody.innerHTML = data.reaction_lag.map(r =>
                    `<tr><td>${r.asset || ''}</td><td>${r.lag || ''}</td><td>${r.note || ''}</td></tr>`
                ).join('');
            }

            const corrList = document.getElementById('eeriCorrelationList');
            if (corrList && data.correlations) {
                const corrs = data.correlations.correlations || [];
                corrList.innerHTML = corrs.map(c => {
                    const val = c.correlation || 0;
                    const absVal = Math.abs(val);
                    const widthPct = (absVal * 100).toFixed(0);
                    const barClass = val >= 0 ? 'positive' : 'negative';
                    const strengthClass = (c.strength || 'weak').toLowerCase();
                    return `<div class="eeri-correlation-row">
                        <span class="corr-asset">${c.asset || ''}</span>
                        <div class="corr-bar-wrap"><div class="corr-bar ${barClass}" style="width:${widthPct}%"></div></div>
                        <span class="corr-val">${val.toFixed(2)}</span>
                        <span class="corr-strength ${strengthClass}">${c.strength || ''}</span>
                    </div>`;
                }).join('');
            }

            const persistEl = document.getElementById('eeriPersistenceBadge');
            if (persistEl && data.regime_persistence) {
                const rp = data.regime_persistence;
                persistEl.innerHTML = `
                    <div class="persist-value">${rp.probability || 0}%</div>
                    <div class="persist-label">Probability of staying in <strong>${rp.current_band || '--'}</strong> band next week (Confidence: ${rp.confidence || '--'})</div>
                    <div class="persist-narrative">${rp.narrative || ''}</div>
                    <div class="persist-meta">Sample size: ${rp.sample_size || '--'} observations</div>
                `;
            }

            const rankList = document.getElementById('eeriImpactRankList');
            if (rankList && data.asset_impact_ranking) {
                rankList.innerHTML = data.asset_impact_ranking.map(a => {
                    const movePct = a.weekly_move_pct || 0;
                    const moveClass = movePct >= 0 ? 'up' : 'down';
                    const moveSign = movePct >= 0 ? '+' : '';
                    return `<div class="eeri-impact-rank">
                        <span class="rank-num">${a.rank || ''}</span>
                        <span class="rank-asset">${a.asset || ''}</span>
                        <span class="rank-value">${a.last_value != null ? a.last_value.toFixed(2) : '--'}</span>
                        <span class="rank-move ${moveClass}">${moveSign}${movePct.toFixed(1)}%</span>
                        <span class="rank-score">Score: ${a.sensitivity_score != null ? a.sensitivity_score.toFixed(2) : '--'}</span>
                    </div>`;
                }).join('');
            }

            const datesBody = document.getElementById('eeriKeyDatesBody');
            if (datesBody && data.key_dates) {
                datesBody.innerHTML = data.key_dates.map(d =>
                    `<tr><td>${d.category || ''}</td><td>${d.event || ''}</td><td>${d.frequency || ''}</td></tr>`
                ).join('');
            }

            const weekendNote = document.getElementById('eeriWeekendNote');
            if (weekendNote) {
                weekendNote.textContent = data.weekend_note || '';
            }
        }

        function renderWeeklySnapshot(data, plan) {
            const container = document.getElementById('wsContent');
            const rangeEl = document.getElementById('wsWeekRange');
            if (!container) return;

            if (rangeEl) {
                rangeEl.textContent = data.week_start + ' to ' + data.week_end;
            }

            const ov = data.overview;
            const bandColors = {'LOW': '#22c55e', 'MODERATE': '#eab308', 'ELEVATED': '#f97316', 'SEVERE': '#dc2626', 'CRITICAL': '#ef4444'};
            const bandColor = bandColors[ov.band] || '#94a3b8';
            const trendArrow = ov.trend_vs_prior === 'rising' ? '\u2191' : (ov.trend_vs_prior === 'falling' ? '\u2193' : '\u2192');
            const trendColor = ov.trend_vs_prior === 'rising' ? '#f87171' : (ov.trend_vs_prior === 'falling' ? '#4ade80' : '#94a3b8');
            const planLevel = {'free': 0, 'personal': 1, 'trader': 2, 'pro': 3, 'enterprise': 4}[plan] || 0;

            let html = '';

            html += '<div class="ws-overview-dash">' +
                '<div class="ws-stat-item"><div class="ws-stat-label">Weekly Average</div><div class="ws-stat-value" style="color: ' + bandColor + ';">' + ov.average + '</div><div class="ws-stat-sub">' + ov.band + '</div></div>' +
                '<div class="ws-stat-item"><div class="ws-stat-label">High</div><div class="ws-stat-value">' + ov.high.value + '</div><div class="ws-stat-sub">' + (ov.high.day || '') + '</div></div>' +
                '<div class="ws-stat-item"><div class="ws-stat-label">Low</div><div class="ws-stat-value">' + ov.low.value + '</div><div class="ws-stat-sub">' + (ov.low.day || '') + '</div></div>' +
                '<div class="ws-stat-item"><div class="ws-stat-label">Trend</div><div class="ws-stat-value" style="color: ' + trendColor + ';">' + trendArrow + '</div><div class="ws-stat-sub">' + ov.trend_vs_prior.charAt(0).toUpperCase() + ov.trend_vs_prior.slice(1) + '</div></div>' +
                '</div>';

            var assetTable = data.asset_table || [];
            var dirIcons = {'up': '\u2191', 'down': '\u2193', 'flat': '~'};
            var dirColors = {'up': '#4ade80', 'down': '#f87171', 'flat': '#94a3b8'};

            html += '<table class="ws-asset-table"><thead><tr><th>Asset</th><th>Direction</th><th>Move</th>';
            if (planLevel >= 1) html += '<th>Alignment</th>';
            if (planLevel >= 2) html += '<th>Reaction</th>';
            html += '</tr></thead><tbody>';

            assetTable.forEach(function(a) {
                var icon = dirIcons[a.direction] || '~';
                var color = dirColors[a.direction] || '#94a3b8';
                var movePct = (a.weekly_move_pct !== null && a.weekly_move_pct !== undefined) ? (a.weekly_move_pct > 0 ? '+' : '') + a.weekly_move_pct.toFixed(2) + '%' : 'N/A';

                html += '<tr><td>' + a.asset + '</td><td style="color: ' + color + '; font-weight: 600;">' + icon + '</td><td>' + movePct + '</td>';
                if (planLevel >= 1) {
                    var align = a.alignment || 'neutral';
                    html += '<td><span class="ws-badge ws-badge-' + align + '">' + align + '</span></td>';
                }
                if (planLevel >= 2) {
                    var speed = a.reaction_speed || 'medium';
                    html += '<td><span class="ws-badge ws-badge-' + speed + '">' + speed + '</span></td>';
                }
                html += '</tr>';
            });
            html += '</tbody></table>';

            if (data.interpretation) {
                html += '<div class="ws-narrative-block"><h4>Market Interpretation</h4><p>' + data.interpretation + '</p></div>';
            }

            if (data.regime_distribution) {
                var regimeBands = ['CRITICAL', 'SEVERE', 'ELEVATED', 'MODERATE', 'LOW'];
                var totalDays = data.data_days || 1;
                html += '<div style="margin-bottom: 16px;">';
                regimeBands.forEach(function(b) {
                    var days = data.regime_distribution[b] || 0;
                    if (days > 0) {
                        var pct = Math.round((days / totalDays) * 100);
                        var bc = bandColors[b] || '#6b7280';
                        html += '<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 6px;">' +
                            '<span style="width: 80px; font-size: 11px; color: ' + bc + '; font-weight: 600;">' + b + '</span>' +
                            '<div style="flex: 1; height: 6px; background: #0f172a; border-radius: 3px; overflow: hidden;">' +
                            '<div style="width: ' + pct + '%; height: 100%; background: ' + bc + '; border-radius: 3px;"></div></div>' +
                            '<span style="font-size: 12px; color: #94a3b8; width: 60px; text-align: right;">' + days + 'd (' + pct + '%)</span></div>';
                    }
                });
                html += '</div>';
            }

            if (data.next_week_outlook) {
                html += '<div class="ws-narrative-block"><h4>Next-Week Context</h4><p>' + data.next_week_outlook + '</p></div>';
            }

            if (planLevel >= 1) {
                if (data.divergence_narrative) {
                    var divStatus = data.divergence_status || 'mixed';
                    var divColor = divStatus === 'confirming' ? '#4ade80' : (divStatus === 'diverging' ? '#f87171' : '#eab308');
                    html += '<div class="ws-narrative-block" style="border-left: 3px solid ' + divColor + ';"><h4>Divergence Watch \u2014 <span style="color: ' + divColor + ';">' + divStatus.toUpperCase() + '</span></h4><p>' + data.divergence_narrative + '</p></div>';
                }

                if (data.historical_context && data.historical_context.length > 0) {
                    html += '<div class="ws-narrative-block"><h4>Historical Context</h4><ul style="margin: 0; padding-left: 18px;">';
                    data.historical_context.forEach(function(ctx) {
                        html += '<li style="margin-bottom: 4px;">' + ctx + '</li>';
                    });
                    html += '</ul></div>';
                }

                if (data.tendencies && data.tendencies.length > 0) {
                    html += '<table class="ws-tendencies-table"><thead><tr><th>Asset</th><th>Historical Tendency</th><th>Confidence</th>';
                    if (planLevel >= 2 && data.conditional_tendencies) html += '<th>Condition</th>';
                    html += '</tr></thead><tbody>';

                    var tendencyData = (planLevel >= 2 && data.conditional_tendencies) ? data.conditional_tendencies : data.tendencies;
                    tendencyData.forEach(function(t) {
                        var confColor = t.confidence === 'High' ? '#4ade80' : (t.confidence === 'Medium' ? '#eab308' : '#94a3b8');
                        html += '<tr><td>' + t.asset + '</td><td>' + t.tendency + '</td><td><span style="color: ' + confColor + ';">' + t.confidence + '</span></td>';
                        if (planLevel >= 2 && t.condition) {
                            html += '<td style="font-size: 12px; color: #64748b;">' + t.condition + '</td>';
                        }
                        html += '</tr>';
                    });
                    html += '</tbody></table>';
                }

                if (data.charts_enabled && data.chart_data) {
                    html += '<div class="ws-chart-row" id="wsChartRow"></div>';
                }
            }

            if (planLevel >= 2) {
                if (data.momentum) {
                    var momColors = {'accelerating': '#ef4444', 'building': '#f97316', 'plateauing': '#eab308', 'softening': '#22c55e', 'easing': '#4ade80', 'stable': '#94a3b8'};
                    var momColor = momColors[data.momentum.label] || '#94a3b8';
                    html += '<div class="ws-momentum-card"><h4 style="font-size: 13px; color: #f1f5f9; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Risk Momentum</h4>' +
                        '<span class="ws-momentum-label" style="background: ' + momColor + '20; color: ' + momColor + ';">' + data.momentum.label.toUpperCase() + '</span>' +
                        '<p style="color: #cbd5e1; font-size: 14px; margin-top: 8px; line-height: 1.6;">' + data.momentum.narrative + '</p></div>';
                }

                if (data.volatility_commentary) {
                    html += '<div class="ws-narrative-block"><h4>Volatility Outlook</h4><p>' + data.volatility_commentary + '</p></div>';
                }
            }

            if (planLevel >= 3) {
                if (data.component_attribution && data.component_attribution.length > 0) {
                    html += '<div class="ws-narrative-block"><h4>Component Attribution</h4><div class="ws-component-bars">';
                    var maxContrib = Math.max.apply(null, data.component_attribution.map(function(c) { return c.contribution; }));
                    var compColors = ['#3b82f6', '#f97316', '#22c55e', '#a855f7'];
                    data.component_attribution.forEach(function(c, i) {
                        var pct = maxContrib > 0 ? Math.round((c.contribution / maxContrib) * 100) : 0;
                        html += '<div class="ws-comp-row"><span class="ws-comp-label">' + c.component + '</span>' +
                            '<div class="ws-comp-bar-track"><div class="ws-comp-bar-fill" style="width: ' + pct + '%; background: ' + compColors[i % 4] + ';"></div></div>' +
                            '<span class="ws-comp-value">' + c.contribution + '</span></div>';
                    });
                    html += '</div></div>';
                }

                if (data.regime_persistence) {
                    var rp = data.regime_persistence;
                    html += '<div class="ws-persistence-card"><div class="ws-persistence-value">' + Math.round(rp.prob_low * 100) + '\u2013' + Math.round(rp.prob_high * 100) + '%</div>' +
                        '<div class="ws-persistence-label">Regime Persistence Probability (Confidence: ' + rp.confidence + ')</div>' +
                        '<p style="color: #94a3b8; font-size: 13px; margin-top: 8px;">' + rp.narrative + '</p></div>';
                }

                if (data.analog_framing) {
                    html += '<div class="ws-narrative-block"><h4>Historical Analog</h4><p>' + data.analog_framing + '</p></div>';
                }

                if (data.scenario_outlook && data.scenario_outlook.length > 0) {
                    html += '<div style="margin-bottom: 16px;"><h4 style="font-size: 13px; color: #f1f5f9; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Scenario Outlook</h4><div class="ws-scenarios-grid">';
                    var scenarioColors = {'Escalation': '#ef4444', 'Stabilization': '#eab308', 'De-escalation': '#22c55e'};
                    data.scenario_outlook.forEach(function(s) {
                        var sc = scenarioColors[s.name] || '#94a3b8';
                        html += '<div class="ws-scenario-card" style="border-left-color: ' + sc + ';"><h5 style="color: ' + sc + ';">' + s.name + '</h5><p>' + s.description + '</p></div>';
                    });
                    html += '</div></div>';
                }
            }

            if (planLevel < 4) {
                html += '<div class="ws-upgrade-hint">';
                html += '<div class="ws-upgrade-title">Unlock Deeper Intelligence</div>';
                html += '<div class="ws-upgrade-subtitle">See what each plan adds to your EERI Weekly Snapshot</div>';
                html += '<div class="ws-upgrade-cards">';

                if (planLevel < 1) {
                    html += '<div class="ws-plan-card card-personal">';
                    html += '<div class="ws-plan-card-name plan-personal">Personal</div>';
                    html += '<div class="ws-plan-card-price">9.95 / month</div>';
                    html += '<div class="ws-plan-card-tagline">Historical context and probability insights to better interpret energy market volatility.</div>';
                    html += '<ul class="ws-plan-card-features">';
                    html += '<li>Mini weekly overlay charts (EERI vs each asset)</li>';
                    html += '<li>Alignment labels: Confirming / Mixed / Diverging</li>';
                    html += '<li>Basic historical context with percentile analysis</li>';
                    html += '<li>Simple probability outlook with confidence ranges</li>';
                    html += '</ul>';
                    html += '</div>';
                }

                if (planLevel < 2) {
                    html += '<div class="ws-plan-card card-trader">';
                    html += '<div class="ws-plan-card-name plan-trader">Trader</div>';
                    html += '<div class="ws-plan-card-price">29 / month</div>';
                    html += '<div class="ws-plan-card-tagline">Tactical intelligence with reaction speed analysis and conditional probability modeling for active risk monitoring.</div>';
                    html += '<ul class="ws-plan-card-features">';
                    html += '<li>Asset reaction speed analysis (which led, which lagged)</li>';
                    html += '<li>Week-vs-week risk acceleration tracking</li>';
                    html += '<li>Conditional historical tendencies (e.g. "When EERI is Severe AND rising: TTF \u2191 68%")</li>';
                    html += '<li>Volatility expectation commentary</li>';
                    html += '</ul>';
                    if (planLevel >= 1) { html += '<div class="ws-plan-card-includes">Includes all Personal features</div>'; }
                    html += '</div>';
                }

                if (planLevel < 3) {
                    html += '<div class="ws-plan-card card-pro">';
                    html += '<div class="ws-plan-card-name plan-pro">Pro</div>';
                    html += '<div class="ws-plan-card-price">49 / month</div>';
                    html += '<div class="ws-plan-card-tagline">Full structural risk intelligence with regime persistence, historical analogs, and scenario outlooks.</div>';
                    html += '<ul class="ws-plan-card-features">';
                    html += '<li>Component attribution summary (what drove the week)</li>';
                    html += '<li>Historical analog weeks identification</li>';
                    html += '<li>Regime persistence probability</li>';
                    html += '<li>Cross-asset transmission narrative</li>';
                    html += '<li>Scenario outlook (Escalation / Stabilization / De-escalation)</li>';
                    html += '</ul>';
                    if (planLevel >= 2) { html += '<div class="ws-plan-card-includes">Includes all Trader features</div>'; }
                    else { html += '<div class="ws-plan-card-includes">Includes all Personal + Trader features</div>'; }
                    html += '</div>';
                }

                html += '<div class="ws-plan-card card-enterprise">';
                html += '<div class="ws-plan-card-name plan-enterprise">Enterprise</div>';
                html += '<div class="ws-plan-card-price">129 / month</div>';
                html += '<div class="ws-plan-card-tagline">Strategic multi-region energy risk forecasting, sector-level impact modeling, and portfolio exposure intelligence.</div>';
                html += '<ul class="ws-plan-card-features">';
                html += '<li>Multi-region spillover risk (Europe \u2194 Middle East \u2194 Black Sea)</li>';
                html += '<li>Sector impact forecast (Power, Industrial, LNG, Storage)</li>';
                html += '<li>Portfolio exposure commentary</li>';
                html += '<li>Multi-week risk path forecast bands</li>';
                html += '</ul>';
                if (planLevel >= 3) { html += '<div class="ws-plan-card-includes">Includes all Pro features</div>'; }
                else if (planLevel >= 2) { html += '<div class="ws-plan-card-includes">Includes all Trader + Pro features</div>'; }
                else { html += '<div class="ws-plan-card-includes">Includes all Personal + Trader + Pro features</div>'; }
                html += '</div>';

                html += '</div>';
                html += '<button onclick="showSection(\'plans\')">Upgrade Your Plan</button>';
                html += '</div>';
            }

            container.innerHTML = html;

            if (planLevel >= 1 && data.charts_enabled && data.chart_data) {
                renderWsCharts(data.chart_data);
            }
        }

        var wsChartInstances = [];

        function renderWsCharts(chartData) {
            if (typeof Chart === 'undefined') { console.error('Chart.js not loaded'); return; }
            var chartRow = document.getElementById('wsChartRow');
            if (!chartRow || !chartData || !chartData.eeri) return;

            var eeriPts = chartData.eeri;
            if (!eeriPts || eeriPts.length < 2) return;

            wsChartInstances.forEach(function(ch) { try { ch.destroy(); } catch(e) {} });
            wsChartInstances = [];

            var assetKeys = [
                {key: 'ttf', label: 'EERI vs TTF Gas', color: '#3b82f6'},
                {key: 'brent', label: 'EERI vs Brent Oil', color: '#f97316'},
                {key: 'vix', label: 'EERI vs VIX', color: '#a855f7'},
                {key: 'eurusd', label: 'EERI vs EUR/USD', color: '#22c55e'},
                {key: 'storage', label: 'EERI vs EU Storage', color: '#06b6d4'}
            ];

            var chartHtml = '';
            var chartConfigs = [];

            assetKeys.forEach(function(asset) {
                if (!chartData[asset.key] || chartData[asset.key].length < 2) return;
                var chartId = 'wsChart_' + asset.key;
                chartConfigs.push({id: chartId, key: asset.key, label: asset.label, color: asset.color});
                chartHtml += '<div class="ws-mini-chart"><h5>' + asset.label + '</h5><p style="color:#64748b;font-size:10px;margin:-4px 0 6px 0;">Y-axis shows % change (indexed to 100), not raw index values</p><div style="position:relative;height:120px;width:100%;"><canvas id="' + chartId + '" style="display:block;width:100%;height:120px;"></canvas></div></div>';
            });

            chartRow.innerHTML = chartHtml;

            function initSingleChart(c) {
                try {
                    var canvas = document.getElementById(c.id);
                    if (!canvas) return;

                    var wrapper = canvas.parentElement;
                    var w = wrapper.clientWidth || wrapper.offsetWidth || 300;
                    var h = wrapper.clientHeight || wrapper.offsetHeight || 120;

                    canvas.width = w;
                    canvas.height = h;
                    canvas.style.width = w + 'px';
                    canvas.style.height = h + 'px';

                    var assetPts = chartData[c.key];
                    var eeriBase = Number(eeriPts[0].value) || 1;
                    var assetBase = Number(assetPts[0].value) || 1;

                    var minLen = Math.min(eeriPts.length, assetPts.length);
                    var labels = eeriPts.slice(0, minLen).map(function(p) {
                        var d = new Date(p.date + 'T12:00:00');
                        return d.toLocaleDateString('en-US', {weekday: 'short'});
                    });

                    var eeriIndexed = eeriPts.slice(0, minLen).map(function(p) { return parseFloat(((Number(p.value) / eeriBase) * 100).toFixed(1)); });
                    var assetIndexed = assetPts.slice(0, minLen).map(function(p) { return parseFloat(((Number(p.value) / assetBase) * 100).toFixed(1)); });

                    var chartInstance = new Chart(canvas.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                {label: 'EERI', data: eeriIndexed, borderColor: '#ef4444', backgroundColor: 'transparent', borderWidth: 2, pointRadius: 0, tension: 0.3},
                                {label: c.label.split(' vs ')[1], data: assetIndexed, borderColor: c.color, backgroundColor: 'transparent', borderWidth: 2, pointRadius: 0, tension: 0.3}
                            ]
                        },
                        options: {
                            responsive: false,
                            maintainAspectRatio: false,
                            animation: false,
                            devicePixelRatio: window.devicePixelRatio || 1,
                            plugins: {
                                legend: {display: true, position: 'bottom', labels: {color: '#94a3b8', boxWidth: 12, padding: 6, font: {size: 10}}},
                                zoom: {zoom: {wheel: {enabled: false}, pinch: {enabled: false}}, pan: {enabled: false}}
                            },
                            scales: {
                                x: {ticks: {color: '#64748b', font: {size: 9}}, grid: {display: false}},
                                y: {ticks: {color: '#64748b', font: {size: 9}}, grid: {color: '#1e293b'}}
                            }
                        }
                    });
                    wsChartInstances.push(chartInstance);
                } catch(e) {
                    console.error('Chart init error for ' + c.id + ':', e);
                }
            }

            void chartRow.offsetHeight;

            chartConfigs.forEach(function(c) {
                initSingleChart(c);
            });

            setTimeout(function() {
                var anyBad = false;
                chartConfigs.forEach(function(c) {
                    var canvas = document.getElementById(c.id);
                    if (!canvas) return;
                    var wrapper = canvas.parentElement;
                    if (wrapper && (wrapper.clientWidth === 0 || wrapper.clientHeight === 0)) anyBad = true;
                    if (canvas.width === 0 || canvas.height === 0) anyBad = true;
                });
                if (anyBad) {
                    wsChartInstances.forEach(function(ch) { try { ch.destroy(); } catch(e) {} });
                    wsChartInstances = [];
                    chartConfigs.forEach(function(c) { initSingleChart(c); });
                }
            }, 500);
        }

        function renderEeriMainDisplay(data) {
            const valueEl = document.getElementById('eeriValue');
            const bandEl = document.getElementById('eeriBandLabel');
            const trendIconEl = document.getElementById('eeriTrendIcon');
            const trendTextEl = document.getElementById('eeriTrendText');
            const computedAtEl = document.getElementById('eeriComputedAt');
            
            if (valueEl) valueEl.textContent = Math.round(data.value);
            if (bandEl) {
                bandEl.textContent = data.band;
                bandEl.style.color = EERI_BAND_COLORS[data.band] || '#94a3b8';
            }
            
            const trend7d = data.trend_7d || 0;
            let trendIcon = '';
            let trendText = 'Stable (7d)';
            let trendColor = '#94a3b8';
            
            if (trend7d > 5) {
                trendIcon = '';
                trendText = `+${trend7d.toFixed(1)} (7d)`;
                trendColor = '#f87171';
            } else if (trend7d < -5) {
                trendIcon = '';
                trendText = `${trend7d.toFixed(1)} (7d)`;
                trendColor = '#4ade80';
            }
            
            if (trendIconEl) {
                trendIconEl.textContent = trendIcon;
                trendIconEl.style.color = trendColor;
            }
            if (trendTextEl) trendTextEl.textContent = trendText;
            
            if (computedAtEl && data.computed_at) {
                const date = new Date(data.computed_at);
                computedAtEl.textContent = `Updated: ${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} at ${date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}`;
            }
        }

        function renderEeriComponents(breakdown) {
            const chartEl = document.getElementById('eeriComponentsChart');
            const legendEl = document.getElementById('eeriComponentsLegend');
            
            if (!breakdown || !breakdown.components) return;
            
            const total = breakdown.components.reduce((sum, c) => sum + c.contribution, 0);
            
            chartEl.innerHTML = breakdown.components.map(comp => {
                const width = total > 0 ? (comp.contribution / total * 100) : 25;
                return `<div class="eeri-component-bar" style="width: ${width}%; background: ${comp.color};" title="${comp.name}: ${comp.contribution.toFixed(1)}"></div>`;
            }).join('');
            
            legendEl.innerHTML = breakdown.components.map(comp => `
                <div class="eeri-legend-item">
                    <div class="eeri-legend-color" style="background: ${comp.color};"></div>
                    <span class="eeri-legend-label">${comp.short_name}</span>
                    <span class="eeri-legend-value">${comp.contribution.toFixed(1)} (${comp.percentage.toFixed(0)}%)</span>
                </div>
            `).join('');
        }

        function renderEeriAssetStress(assets) {
            const gridEl = document.getElementById('eeriAssetStressGrid');
            if (!assets || !gridEl) return;
            
            gridEl.innerHTML = assets.map(asset => `
                <div class="eeri-asset-item">
                    <div class="eeri-asset-name">${asset.display_name}</div>
                    <div class="eeri-asset-score" style="color: ${asset.color};">${Math.round(asset.score)}</div>
                    <div class="eeri-asset-status" style="color: ${asset.color};">
                        <span class="eeri-asset-trend">${asset.trend}</span>
                        ${asset.status_label}
                    </div>
                </div>
            `).join('');
        }

        function renderEeriTopDrivers(drivers) {
            const listEl = document.getElementById('eeriDriversList');
            if (!drivers || !listEl) return;
            
            if (drivers.length === 0) {
                listEl.innerHTML = '<p style="color: #64748b; text-align: center; padding: 20px;">No drivers available</p>';
                return;
            }
            
            listEl.innerHTML = drivers.map(driver => {
                const assetsText = driver.assets_affected && driver.assets_affected.length > 0 
                    ? driver.assets_affected.slice(0, 3).join(', ') 
                    : '';
                
                return `
                    <div class="eeri-driver-item">
                        <div class="eeri-driver-rank">${driver.rank}</div>
                        <div class="eeri-driver-content">
                            <div class="eeri-driver-headline">${driver.headline}</div>
                            <div class="eeri-driver-meta">
                                <span class="eeri-driver-tag theme">${driver.theme}</span>
                                <span class="eeri-driver-tag severity">Severity: ${driver.severity}</span>
                                <span class="eeri-driver-tag confidence">Conf: ${driver.confidence}%</span>
                                ${assetsText ? `<span class="eeri-driver-tag assets">${assetsText}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderEeriSummary(data) {
            const dateEl = document.getElementById('eeriSummaryDate');
            const textEl = document.getElementById('eeriSummaryText');
            const driversEl = document.getElementById('eeriSummaryDrivers');
            
            if (dateEl && data.date) {
                const date = new Date(data.date);
                dateEl.textContent = date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
            }
            
            if (textEl && data.interpretation) {
                const paragraphs = data.interpretation.split(/\n\n+|\. (?=[A-Z])/g)
                    .filter(p => p.trim())
                    .map(p => p.trim().endsWith('.') ? p.trim() : p.trim() + '.');
                
                if (paragraphs.length > 1) {
                    textEl.innerHTML = paragraphs.map(p => `<p>${p}</p>`).join('');
                } else {
                    const text = data.interpretation;
                    const sentences = text.match(/[^.!?]+[.!?]+/g) || [text];
                    if (sentences.length >= 4) {
                        const mid = Math.ceil(sentences.length / 2);
                        const para1 = sentences.slice(0, mid).join(' ').trim();
                        const para2 = sentences.slice(mid).join(' ').trim();
                        textEl.innerHTML = `<p>${para1}</p><p>${para2}</p>`;
                    } else {
                        textEl.innerHTML = `<p>${text}</p>`;
                    }
                }
            }
            
            if (driversEl && data.key_drivers) {
                driversEl.textContent = `Key Drivers: ${data.key_drivers.slice(0, 3).join('  ')}`;
            }
        }

        const eeriModalContent = {
            components: {
                title: 'Component Breakdown',
                body: `
                    <h4>What is the Component Breakdown?</h4>
                    <p>The Component Breakdown displays how different risk factors contribute to today's overall EERI (Europe Energy Risk Index) value. Each component represents a distinct category of risk that affects European energy markets.</p>
                    
                    <h4>Understanding the Components</h4>
                    <ul>
                        <li><strong>RERI_EU (Regional Risk):</strong> Base regional escalation risk for Europe, measuring geopolitical tensions and regional instability.</li>
                        <li><strong>Theme Pressure:</strong> Aggregate pressure from thematic risk categories like supply disruptions, infrastructure threats, and policy changes.</li>
                        <li><strong>Asset Transmission:</strong> How risks propagate across energy asset classes (gas, oil, power, etc.).</li>
                        <li><strong>Contagion:</strong> Spillover effects from neighboring regions that could impact European energy markets.</li>
                    </ul>
                    
                    <div class="eeri-modal-highlight">
                        <strong>How to interpret:</strong> Larger bars indicate components contributing more to overall risk. Use this to identify which risk categories are driving market conditions.
                    </div>
                `
            },
            assetStress: {
                title: 'Asset Stress Panel',
                body: `
                    <h4>What is the Asset Stress Panel?</h4>
                    <p>The Asset Stress Panel shows real-time stress levels across different energy asset classes in European markets. It helps you understand which commodities and markets are under pressure.</p>
                    
                    <h4>Asset Classes Monitored</h4>
                    <ul>
                        <li><strong>Natural Gas:</strong> European gas markets including TTF pricing and supply dynamics.</li>
                        <li><strong>Crude Oil:</strong> Brent crude and European oil market stress.</li>
                        <li><strong>Freight/Shipping:</strong> LNG tanker rates and energy transportation costs.</li>
                        <li><strong>Currency/FX:</strong> EUR/USD and energy-linked currency movements.</li>
                        <li><strong>Power:</strong> European electricity markets and grid stress.</li>
                        <li><strong>LNG:</strong> Liquefied natural gas import dynamics and pricing.</li>
                        <li><strong>Electricity:</strong> Spot and forward power market conditions.</li>
                    </ul>
                    
                    <h4>Stress Levels</h4>
                    <p>Each asset shows a score from 0-100 with status labels: Minimal (green), Low (blue), Moderate (yellow), Elevated (orange), or Critical (red). The trend arrow indicates direction of change.</p>
                    
                    <div class="eeri-modal-highlight">
                        <strong>How to interpret:</strong> Focus on assets showing "Elevated" or "Critical" status for immediate attention. Upward trends suggest worsening conditions.
                    </div>
                `
            },
            history: {
                title: 'Historical Intelligence',
                body: `
                    <h4>What is Historical Intelligence?</h4>
                    <p>This chart displays the EERI index over time, allowing you to identify trends, patterns, and significant risk events in European energy markets.</p>
                    
                    <h4>Time Range Controls</h4>
                    <ul>
                        <li><strong>7D:</strong> Last 7 days - ideal for spotting recent developments.</li>
                        <li><strong>30D:</strong> Last 30 days - shows monthly patterns and trends.</li>
                        <li><strong>90D:</strong> Last 90 days - reveals seasonal patterns and longer-term trends.</li>
                        <li><strong>All:</strong> Full historical data - comprehensive view for strategic analysis.</li>
                    </ul>
                    
                    <h4>Smoothing Options</h4>
                    <ul>
                        <li><strong>Raw:</strong> Actual daily values with full volatility visible.</li>
                        <li><strong>3D MA:</strong> 3-day moving average - smooths short-term noise.</li>
                        <li><strong>7D MA:</strong> 7-day moving average - shows underlying trend direction.</li>
                    </ul>
                    
                    <div class="eeri-modal-highlight">
                        <strong>How to interpret:</strong> Use Raw for detail, moving averages for trend direction. The color bands indicate risk levels: green (LOW), yellow (MODERATE), orange (ELEVATED), red (SEVERE), dark red (CRITICAL).
                    </div>
                `
            },
            regime: {
                title: 'Regime Statistics',
                body: `
                    <h4>What are Regime Statistics?</h4>
                    <p>Regime Statistics show how much time the EERI index has spent in each risk band over the past 90 days, along with recent transitions between risk levels.</p>
                    
                    <h4>Risk Bands</h4>
                    <ul>
                        <li><strong>LOW (0-20):</strong> Calm conditions, minimal market stress.</li>
                        <li><strong>MODERATE (21-40):</strong> Background tension, standard monitoring.</li>
                        <li><strong>ELEVATED (41-60):</strong> Heightened risk, increased attention needed.</li>
                        <li><strong>SEVERE (61-80):</strong> System under strain, hedging advised.</li>
                        <li><strong>CRITICAL (81-100):</strong> Crisis conditions, potential market disruption.</li>
                    </ul>
                    
                    <h4>Band Distribution</h4>
                    <p>The percentage bars show how many days (out of the last 90) the market spent in each risk band. A healthy market typically spends most time in LOW or MODERATE.</p>
                    
                    <h4>Regime Transitions</h4>
                    <p>Shows recent shifts between risk bands, helping you track when markets moved from one state to another.</p>
                    
                    <div class="eeri-modal-highlight">
                        <strong>How to interpret:</strong> High percentage in ELEVATED or CRITICAL suggests persistent stress. Frequent transitions indicate volatility in market conditions.
                    </div>
                `
            },
            behavioral: {
                title: 'Conceptual, Behavioral Interpretation',
                body: `
                    <p style="margin-bottom: 20px; color: #94a3b8;">Below is a conceptual, behavioral interpretation of each band  what is happening in the world, how markets tend to behave, and how users should mentally respond.</p>
                    
                    <div class="eeri-band-section" style="border-left: 4px solid #22c55e; padding-left: 16px; margin-bottom: 24px;">
                        <h4 style="color: #22c55e;"> 020  LOW</h4>
                        <p><strong>Background risk</strong></p>
                        <p><strong>What's happening:</strong> Geopolitical and energy-related events are isolated. Supply chains function normally. Markets absorb news without stress. No clustering, no persistence. Risk exists  but it's ambient, not directional.</p>
                        <p><strong>How markets behave:</strong> Prices respond mostly to fundamentals. Volatility is low and mean-reverting. Headlines fade quickly.</p>
                        <div class="eeri-modal-highlight"><strong>How to interpret:</strong> "The system is stable. Risk is not the dominant variable." This is when markets are efficient, noise dominates signal, and overreacting is the biggest danger.</div>
                    </div>
                    
                    <div class="eeri-band-section" style="border-left: 4px solid #facc15; padding-left: 16px; margin-bottom: 24px;">
                        <h4 style="color: #facc15;"> 2140  MODERATE</h4>
                        <p><strong>Early tension / alert phase</strong></p>
                        <p><strong>What's happening:</strong> Early signs of geopolitical or supply stress. Narratives begin to repeat. Markets are attentive but not alarmed. Stress is forming, not spreading.</p>
                        <p><strong>How markets behave:</strong> Selective sensitivity to news. Brief volatility spikes. Divergence between assets.</p>
                        <div class="eeri-modal-highlight"><strong>How to interpret:</strong> "Something is forming  pay attention." This is a watch phase: Don't act yet. Start monitoring drivers. Check which assets are reacting. This band is often underestimated.</div>
                    </div>
                    
                    <div class="eeri-band-section" style="border-left: 4px solid #f97316; padding-left: 16px; margin-bottom: 24px;">
                        <h4 style="color: #f97316;"> 4160  ELEVATED</h4>
                        <p><strong>Active stress regime</strong></p>
                        <p><strong>What's happening:</strong> Multiple high-impact events. Clear thematic dominance (war, supply, logistics). Early clustering. Risk becomes persistent. This is no longer background noise.</p>
                        <p><strong>How markets behave:</strong> Volatility increases. Correlations begin to rise. Safe-haven behavior emerges. Assets start reacting together.</p>
                        <div class="eeri-modal-highlight"><strong>How to interpret:</strong> "Risk is now a key market driver." This is where risk management matters, narratives start driving price, and false calm becomes dangerous.</div>
                    </div>
                    
                    <div class="eeri-band-section" style="border-left: 4px solid #ef4444; padding-left: 16px; margin-bottom: 24px;">
                        <h4 style="color: #ef4444;"> 6180  SEVERE</h4>
                        <p><strong>System under strain</strong></p>
                        <p><strong>What's happening:</strong> Escalation is sustained. Supply or logistics constraints are binding. Second-order effects appear. Market psychology shifts. The system is tense.</p>
                        <p><strong>How markets behave:</strong> Non-linear moves. Correlations spike. Liquidity thins. Reactions become asymmetric.</p>
                        <div class="eeri-modal-highlight"><strong>How to interpret:</strong> "The system is fragile. Expect surprises." This is when historical analogs matter, timing becomes difficult, and overconfidence is punished.</div>
                    </div>
                    
                    <div class="eeri-band-section" style="border-left: 4px solid #b91c1c; padding-left: 16px; margin-bottom: 24px;">
                        <h4 style="color: #b91c1c;"> 81100  CRITICAL</h4>
                        <p><strong>Crisis conditions</strong></p>
                        <p><strong>What's happening:</strong> Systemic stress dominates. Multiple components fully aligned. Shock propagation is active. Control narratives break down. This is not about <em>if</em> something breaks  it's about <em>where</em>.</p>
                        <p><strong>How markets behave:</strong> Dislocations. Gap moves. Policy intervention risk. Decoupling from fundamentals.</p>
                        <div class="eeri-modal-highlight"><strong>How to interpret:</strong> "The environment itself is dangerous." In this regime: Preservation > optimization. Liquidity > return. Awareness > precision. This is when EERI is most valuable.</div>
                    </div>
                    
                    <div style="background: #1e293b; border: 1px solid #475569; border-radius: 8px; padding: 16px; margin-top: 20px;">
                        <h4 style="color: #f1f5f9; margin-top: 0;"> One Critical Conceptual Point</h4>
                        <p style="margin-bottom: 8px;"><strong>These bands are not linear.</strong></p>
                        <p style="margin-bottom: 4px;">The jump from:</p>
                        <ul style="margin: 0 0 8px 20px;">
                            <li>20  30 is <strong>mild</strong></li>
                            <li>50  60 is <strong>meaningful</strong></li>
                            <li>75  85 is <strong>dramatic</strong></li>
                        </ul>
                        <p style="margin: 0;"><strong>Risk accelerates non-linearly as bands increase. That's why the bands exist.</strong></p>
                    </div>
                    
                    <hr style="border: none; border-top: 1px solid #475569; margin: 28px 0;">
                    
                    <h4 style="color: #f1f5f9;"> How You Should Use These Bands</h4>
                    
                    <div style="display: flex; gap: 40px; flex-wrap: wrap; margin: 16px 0;">
                        <div>
                            <p style="color: #ef4444; margin-bottom: 8px;"><strong>NOT as:</strong></p>
                            <ul style="margin: 0 0 0 20px; color: #94a3b8;">
                                <li>Trading signals</li>
                                <li>Predictions</li>
                                <li>Alarms</li>
                            </ul>
                        </div>
                        <div>
                            <p style="color: #22c55e; margin-bottom: 8px;"><strong>BUT as:</strong></p>
                            <ul style="margin: 0 0 0 20px; color: #94a3b8;">
                                <li>Context</li>
                                <li>Attention allocation</li>
                                <li>Risk framing</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="eeri-modal-highlight" style="margin-top: 16px;">
                        <strong>Each band answers one question:</strong> "How careful should I be right now?"
                    </div>
                    
                    <hr style="border: none; border-top: 1px solid #475569; margin: 28px 0;">
                    
                    <h4 style="color: #f1f5f9;"> How This Positions EERI Uniquely</h4>
                    
                    <div style="display: flex; gap: 24px; flex-wrap: wrap; margin: 16px 0;">
                        <div style="flex: 1; min-width: 200px; background: #334155; padding: 16px; border-radius: 8px;">
                            <p style="color: #94a3b8; margin: 0 0 8px 0; font-size: 13px;">Most indices say:</p>
                            <p style="color: #f1f5f9; margin: 0; font-size: 16px;"><em>"Volatility is X"</em></p>
                        </div>
                        <div style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #1e40af, #7c3aed); padding: 16px; border-radius: 8px;">
                            <p style="color: #c4b5fd; margin: 0 0 8px 0; font-size: 13px;">EERI says:</p>
                            <p style="color: #ffffff; margin: 0; font-size: 16px;"><strong><em>"This is the kind of world you are operating in today."</em></strong></p>
                        </div>
                    </div>
                    
                    <p style="text-align: center; color: #60a5fa; margin-top: 16px;"><strong>That's a much deeper insight.</strong></p>
                    
                    <hr style="border: none; border-top: 1px solid #475569; margin: 28px 0;">
                    
                    <div style="background: linear-gradient(135deg, #0f172a, #1e293b); border: 2px solid #60a5fa; border-radius: 12px; padding: 20px; text-align: center;">
                        <h4 style="color: #60a5fa; margin: 0 0 16px 0;"> Final Takeaway</h4>
                        <p style="color: #f1f5f9; margin-bottom: 16px;"><strong>EERI Risk Bands tell users:</strong></p>
                        <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; margin-bottom: 20px;">
                            <span style="background: #22c55e; color: #000; padding: 6px 12px; border-radius: 20px; font-size: 13px;"><strong>Low</strong>  Ignore noise</span>
                            <span style="background: #facc15; color: #000; padding: 6px 12px; border-radius: 20px; font-size: 13px;"><strong>Moderate</strong>  Start watching</span>
                            <span style="background: #f97316; color: #000; padding: 6px 12px; border-radius: 20px; font-size: 13px;"><strong>Elevated</strong>  Risk is active</span>
                            <span style="background: #ef4444; color: #fff; padding: 6px 12px; border-radius: 20px; font-size: 13px;"><strong>Severe</strong>  System is strained</span>
                            <span style="background: #b91c1c; color: #fff; padding: 6px 12px; border-radius: 20px; font-size: 13px;"><strong>Critical</strong>  Crisis environment</span>
                        </div>
                        <p style="color: #94a3b8; margin: 0; font-style: italic;">Once users internalize this ladder, they stop reacting emotionally  and start thinking structurally.</p>
                        <p style="color: #60a5fa; margin: 16px 0 0 0;"><strong>That's exactly the behavior EERI is designed to support.</strong></p>
                    </div>
                `
            }
        };

        function openEeriModal(type) {
            const content = eeriModalContent[type];
            if (!content) return;
            
            const overlay = document.getElementById('eeriModalOverlay');
            const titleEl = document.getElementById('eeriModalTitle');
            const bodyEl = document.getElementById('eeriModalBody');
            
            if (titleEl) titleEl.textContent = content.title;
            if (bodyEl) bodyEl.innerHTML = content.body;
            if (overlay) overlay.classList.add('active');
        }

        function closeEeriModal() {
            const overlay = document.getElementById('eeriModalOverlay');
            if (overlay) overlay.classList.remove('active');
        }

        function renderEeriRegimeStats(data) {
            const distEl = document.getElementById('eeriBandDistribution');
            const transEl = document.getElementById('eeriTransitionsList');
            
            if (distEl && data.statistics) {
                const percentages = data.statistics.band_percentages || {};
                distEl.innerHTML = ['CRITICAL', 'ELEVATED', 'MODERATE', 'LOW'].map(band => {
                    const pct = percentages[band] || 0;
                    return `
                        <div class="eeri-band-row">
                            <span class="eeri-band-label" style="color: ${EERI_BAND_COLORS[band]};">${band}</span>
                            <div class="eeri-band-bar-container">
                                <div class="eeri-band-bar" style="width: ${pct}%; background: ${EERI_BAND_COLORS[band]};"></div>
                            </div>
                            <span class="eeri-band-percent">${pct.toFixed(1)}%</span>
                        </div>
                    `;
                }).join('');
            }
            
            if (transEl && data.recent_transitions) {
                if (data.recent_transitions.length === 0) {
                    transEl.innerHTML = '<p style="color: #64748b; font-size: 12px;">No regime transitions in period</p>';
                } else {
                    transEl.innerHTML = data.recent_transitions.slice(-5).reverse().map(t => `
                        <div class="eeri-transition-item">
                            <span class="eeri-transition-date">${new Date(t.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>
                            <span style="color: ${EERI_BAND_COLORS[t.from_band]};">${t.from_band}</span>
                            <span class="eeri-transition-arrow"></span>
                            <span style="color: ${EERI_BAND_COLORS[t.to_band]};">${t.to_band}</span>
                        </div>
                    `).join('');
                }
            }
        }

        async function loadEeriHistoryChart(days, smoothing) {
            const statsAvg = document.getElementById('eeriStatAvg');
            const statsMax = document.getElementById('eeriStatMax');
            const statsMin = document.getElementById('eeriStatMin');
            const statsVol = document.getElementById('eeriStatVol');
            
            try {
                const response = await fetch(`/api/v1/eeri-pro/history?days=${days}&smoothing=${smoothing}`);
                const result = await response.json();
                
                if (!result.success || !result.data) return;
                
                eeriProState.data = result.data;
                eeriProState.assetData = result.assets || null;
                
                if (statsAvg) statsAvg.textContent = result.statistics.average;
                if (statsMax) statsMax.textContent = result.statistics.max;
                if (statsMin) statsMin.textContent = result.statistics.min;
                if (statsVol) statsVol.textContent = (result.statistics.max - result.statistics.min).toFixed(1);
                
                renderEeriHistoryChart(result.data, smoothing);
                
            } catch (error) {
                console.error('Error loading EERI history:', error);
            }
        }

        const riskBandPlugin = {
            id: 'riskBandBackground',
            beforeDraw: (chart) => {
                const { ctx, chartArea, scales } = chart;
                if (!chartArea) return;
                
                const bands = [
                    { min: 0, max: 20, color: 'rgba(34, 197, 94, 0.15)' },
                    { min: 20, max: 40, color: 'rgba(250, 204, 21, 0.12)' },
                    { min: 40, max: 60, color: 'rgba(249, 115, 22, 0.12)' },
                    { min: 60, max: 80, color: 'rgba(239, 68, 68, 0.12)' },
                    { min: 80, max: 100, color: 'rgba(185, 28, 28, 0.18)' },
                ];
                
                bands.forEach(band => {
                    const yTop = scales.y.getPixelForValue(band.max);
                    const yBottom = scales.y.getPixelForValue(band.min);
                    
                    ctx.save();
                    ctx.fillStyle = band.color;
                    ctx.fillRect(chartArea.left, yTop, chartArea.right - chartArea.left, yBottom - yTop);
                    ctx.restore();
                });
            }
        };

        const ASSET_META = {
            brent: { label: 'Brent Oil', color: '#f59e0b', unit: '$', suffix: '/bbl' },
            ttf: { label: 'TTF Gas', color: '#10b981', unit: '', suffix: '/MWh' },
            vix: { label: 'VIX', color: '#ef4444', unit: '', suffix: '' },
            eurusd: { label: 'EUR/USD', color: '#3b82f6', unit: '', suffix: '' },
            storage: { label: 'EU Storage', color: '#06b6d4', unit: '', suffix: '%' },
        };

        function computeMovingAverage(arr, window) {
            const result = new Array(arr.length).fill(null);
            for (let i = window - 1; i < arr.length; i++) {
                let sum = 0, count = 0;
                for (let j = i - window + 1; j <= i; j++) {
                    if (arr[j] !== null && arr[j] !== undefined) { sum += arr[j]; count++; }
                }
                if (count === window) result[i] = Math.round((sum / count) * 100) / 100;
            }
            return result;
        }

        function getBandName(value) {
            if (value <= 25) return 'Low Risk';
            if (value <= 50) return 'Moderate Risk';
            if (value <= 75) return 'Elevated Risk';
            return 'Critical Risk';
        }

        function renderEeriHistoryChart(data, smoothing) {
            const canvas = document.getElementById('eeriHistoryChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            if (eeriProChart) {
                eeriProChart.destroy();
            }
            
            const eeriDates = data.map(d => d.date);
            const labels = data.map(d => {
                const dt = new Date(d.date);
                return dt.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            const fullDateLabels = data.map(d => {
                const dt = new Date(d.date);
                return dt.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
            });
            
            const values = data.map(d => d.value);
            const smoothedValues = data.map(d => d.smoothed || null);
            
            const datasets = [{
                label: 'EERI',
                data: values,
                borderColor: '#8b5cf6',
                backgroundColor: 'rgba(139, 92, 246, 0.2)',
                borderWidth: 2,
                fill: true,
                tension: 0.3,
                pointRadius: values.length > 60 ? 0 : 3,
                pointHoverRadius: 5,
                yAxisID: 'y',
                _isEeri: true,
                _rawValues: values,
                _bands: data.map(d => d.band),
            }];
            
            if (smoothing !== 'raw' && smoothedValues.some(v => v !== null)) {
                datasets.push({
                    label: smoothing === 'ma3' ? '3-Day MA' : '7-Day MA',
                    data: smoothedValues,
                    borderColor: '#3b82f6',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.3,
                    pointRadius: 0,
                    yAxisID: 'y',
                    _isEeri: true,
                    _rawValues: smoothedValues,
                    _bands: data.map(d => d.band),
                });
            }

            const hasAssets = eeriProState.activeAssets.length > 0;
            const subtitle = document.getElementById('eeriAssetSubtitle');
            if (subtitle) subtitle.style.display = hasAssets ? '' : 'none';

            if (hasAssets && eeriProState.assetData) {
                const dateIndex = {};
                eeriDates.forEach((d, i) => { dateIndex[d] = i; });

                eeriProState.activeAssets.forEach(assetId => {
                    const assetSeries = eeriProState.assetData[assetId];
                    if (!assetSeries || assetSeries.length === 0) return;
                    const meta = ASSET_META[assetId] || { label: assetId, color: '#94a3b8', unit: '', suffix: '' };

                    const rawAligned = new Array(eeriDates.length).fill(null);
                    assetSeries.forEach(pt => {
                        const idx = dateIndex[pt.date];
                        if (idx !== undefined) rawAligned[idx] = pt.value;
                    });

                    let lastKnown = null;
                    for (let i = 0; i < rawAligned.length; i++) {
                        if (rawAligned[i] !== null) {
                            lastKnown = rawAligned[i];
                        } else if (lastKnown !== null) {
                            rawAligned[i] = lastKnown;
                        }
                    }

                    let firstVal = null;
                    for (let i = 0; i < rawAligned.length; i++) {
                        if (rawAligned[i] !== null) { firstVal = rawAligned[i]; break; }
                    }
                    if (firstVal === null || firstVal === 0) return;

                    const indexed = rawAligned.map(v => v !== null ? Math.round((v / firstVal) * 10000) / 100 : null);

                    let displayData = indexed;
                    if (smoothing === 'ma3') {
                        displayData = computeMovingAverage(indexed, 3);
                    } else if (smoothing === 'ma7') {
                        displayData = computeMovingAverage(indexed, 7);
                    }

                    datasets.push({
                        label: meta.label,
                        data: displayData,
                        borderColor: meta.color,
                        backgroundColor: 'transparent',
                        borderWidth: 1.5,
                        fill: false,
                        tension: 0.3,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        yAxisID: 'y1',
                        _isAsset: true,
                        _assetId: assetId,
                        _rawValues: rawAligned,
                        _indexedValues: indexed,
                        _firstVal: firstVal,
                        _meta: meta,
                    });
                });
            }

            const scalesConfig = {
                x: {
                    grid: { color: 'rgba(51, 65, 85, 0.5)' },
                    ticks: { color: '#64748b', maxRotation: 45, font: { size: 10 } }
                },
                y: {
                    position: 'left',
                    min: 0,
                    max: 100,
                    grid: { color: 'rgba(51, 65, 85, 0.5)' },
                    ticks: { color: '#64748b', font: { size: 11 } },
                    title: { display: hasAssets, text: 'EERI (0100)', color: '#94a3b8', font: { size: 11 } }
                }
            };

            if (hasAssets) {
                scalesConfig.y1 = {
                    position: 'right',
                    grid: { drawOnChartArea: false },
                    ticks: { color: '#64748b', font: { size: 11 } },
                    title: { display: true, text: 'Indexed (100 = start)', color: '#94a3b8', font: { size: 11 } }
                };
            }
            
            eeriProChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                plugins: [riskBandPlugin],
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: datasets.length > 1,
                            position: 'top',
                            labels: { color: '#94a3b8', font: { size: 11 } }
                        },
                        tooltip: {
                            backgroundColor: '#1e293b',
                            titleColor: '#f1f5f9',
                            bodyColor: '#e2e8f0',
                            borderColor: '#334155',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                title: function(items) {
                                    if (!items.length) return '';
                                    return fullDateLabels[items[0].dataIndex] || labels[items[0].dataIndex];
                                },
                                label: function(context) {
                                    const ds = context.dataset;
                                    const idx = context.dataIndex;
                                    const val = context.parsed.y;
                                    if (val === null || val === undefined) return null;

                                    if (ds._isEeri) {
                                        const band = ds._bands ? ds._bands[idx] : null;
                                        const bandLabel = band ? ('  ' + band.charAt(0) + band.slice(1).toLowerCase() + ' Risk') : '';
                                        return `${ds.label}: ${val.toFixed(1)}${bandLabel}`;
                                    }

                                    if (ds._isAsset) {
                                        const meta = ds._meta;
                                        const aid = ds._assetId;
                                        const raw = ds._rawValues ? ds._rawValues[idx] : null;
                                        const indexed = ds._indexedValues ? ds._indexedValues[idx] : val;
                                        const lines = [];
                                        if (raw !== null) {
                                            const decimals = aid === 'eurusd' ? 4 : (meta.suffix === '%' ? 1 : 2);
                                            lines.push(`${meta.label}: ${meta.unit}${raw.toFixed(decimals)}${meta.suffix}`);
                                        }
                                        if (indexed !== null) {
                                            lines.push(`  Indexed: ${indexed.toFixed(1)}`);
                                            const change = indexed - 100;
                                            const sign = change >= 0 ? '+' : '';
                                            lines.push(`  ${sign}${change.toFixed(1)}% from start`);
                                        }
                                        return lines;
                                    }

                                    return `${ds.label}: ${val.toFixed(1)}`;
                                }
                            }
                        },
                    },
                    scales: scalesConfig
                }
            });
        }

        function initEeriTimeControls() {
            document.querySelectorAll('.eeri-time-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.eeri-time-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    eeriProState.days = parseInt(this.dataset.days);
                    loadEeriHistoryChart(eeriProState.days, eeriProState.smoothing);
                });
            });
            
            document.querySelectorAll('.eeri-smooth-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.eeri-smooth-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    eeriProState.smoothing = this.dataset.smooth;
                    loadEeriHistoryChart(eeriProState.days, eeriProState.smoothing);
                });
            });

            document.querySelectorAll('.eeri-asset-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const assetId = this.dataset.asset;
                    const idx = eeriProState.activeAssets.indexOf(assetId);
                    if (idx >= 0) {
                        eeriProState.activeAssets.splice(idx, 1);
                        this.classList.remove('active');
                        this.style.borderColor = '#334155';
                    } else {
                        eeriProState.activeAssets.push(assetId);
                        this.classList.add('active');
                        const color = this.style.getPropertyValue('--asset-color');
                        if (color) this.style.borderColor = color;
                    }
                    if (eeriProState.data) {
                        renderEeriHistoryChart(eeriProState.data, eeriProState.smoothing);
                    }
                });
            });
        }

        function setupEeriProNavAccess() {
            const plan = currentUser?.plan || 'free';
            const eeriTierLabels = {'free': 'FREE', 'personal': 'PERSONAL', 'trader': 'TRADER', 'pro': 'PRO', 'enterprise': 'ENTERPRISE'};
            
            const eeriNavItem = document.getElementById('eeriNavItem');
            const eeriBadge = document.getElementById('eeriBadge');
            const eeriUpgradeHint = document.getElementById('eeriUpgradeHint');
            
            if (eeriNavItem) {
                eeriNavItem.classList.remove('nav-item-disabled');
                if (eeriBadge) {
                    eeriBadge.textContent = eeriTierLabels[plan] || 'FREE';
                    eeriBadge.className = 'pro-badge-nav badge-' + (plan || 'free');
                }
                if (eeriUpgradeHint) eeriUpgradeHint.style.display = 'none';
            }
        }

        /* End EERI Pro Module */

        /* ============================================
           Daily Geo-Energy Intelligence Digest Module
           ============================================ */
        let digestData = null;
        let digestLoaded = false;

        async function loadDailyDigest() {
            if (digestLoaded && digestData) {
                return;
            }
            const container = document.getElementById('digestContent');
            container.innerHTML = `
                <div style="text-align: center; padding: 60px 20px;">
                    <div style="width: 40px; height: 40px; border: 3px solid #3b82f6; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div>
                    <p style="color: #94a3b8;">Generating your daily intelligence digest...</p>
                    <p style="color: #64748b; font-size: 12px; margin-top: 8px;">This may take a few moments as we analyze today's data with AI</p>
                </div>
            `;
            try {
                const response = await fetch('/api/v1/digest/daily', {
                    headers: { 'X-User-Token': sessionToken }
                });
                if (!response.ok) throw new Error('Failed to load digest');
                digestData = await response.json();
                digestLoaded = true;
                renderDailyDigest(digestData);
            } catch (error) {
                console.error('Digest load error:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px;">
                        <p style="color: #f87171; font-size: 16px; margin-bottom: 8px;">Unable to load digest</p>
                        <p style="color: #94a3b8; font-size: 13px;">Please try again in a moment.</p>
                        <button onclick="digestLoaded=false; loadDailyDigest();" style="margin-top: 16px; background: #3b82f6; color: white; border: none; padding: 10px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">Retry</button>
                    </div>
                `;
            }
        }

        function renderDailyDigest(d) {
            const container = document.getElementById('digestContent');
            const plan = d.plan || 'free';
            const planLevel = d.plan_level || 0;

            const badgeEl = document.getElementById('digestPlanBadge');
            if (badgeEl) {
                const planLabels = {free: 'FREE', personal: 'PERSONAL', trader: 'TRADER', pro: 'PRO', enterprise: 'ENTERPRISE'};
                badgeEl.textContent = planLabels[plan] || 'FREE';
                badgeEl.className = 'eeri-plan-badge-header badge-' + plan;
            }

            let html = '';

            html += renderDigestHeaderBar(d);
            html += renderRiskToneSection(d);
            html += renderIndexSummary(d, planLevel);
            html += renderAssetMovesSection(d);
            html += renderTopAlertsSection(d, planLevel);

            if (planLevel >= 1) {
                html += renderCorrelationsSection(d, planLevel);
            } else {
                html += renderLockedSection('Risk Correlation Analysis', 'See how risk indices relate to asset prices with 7-day correlation data.', 'Personal', '9.95/mo');
            }

            if (planLevel >= 2) {
                html += renderRegimeSection(d);
            } else {
                html += renderLockedSection('Regime Classification', 'Understand the current risk regime: Calm, Risk Build, Shock, or Gas-Storage Stress.', 'Trader', '29/mo');
            }

            if (planLevel >= 2) {
                html += renderForwardWatchlistSection(d);
            } else if (planLevel >= 1) {
                html += renderLockedSection('Forward Watchlist', 'Monitor high-severity events and critical risk thresholds that may impact markets.', 'Trader', '29/mo');
            }

            if (planLevel >= 2) {
                html += renderProbabilityScoringSection(d);
            } else if (planLevel >= 1) {
                html += renderLockedSection('Probability Scoring', 'Access escalation, de-escalation, and stability probability assessments.', 'Trader', '29/mo');
            }

            if (planLevel >= 2) {
                html += renderVolatilityOutlookSection(d);
            } else {
                html += renderLockedSection('Volatility Outlook', 'See current volatility regime and VIX-informed market stress outlook.', 'Trader', '29/mo');
            }

            if (planLevel >= 3) {
                html += renderBetasSection(d);
            } else if (planLevel >= 2) {
                html += renderLockedSection('Asset Sensitivity Dashboard', 'Access GERI beta coefficients vs Brent, TTF, VIX for institutional-grade analysis.', 'Pro', '49/mo');
            }

            if (planLevel >= 3) {
                html += renderScenarioForecastsSection(d);
            } else if (planLevel >= 2) {
                html += renderLockedSection('Scenario Forecasts', 'View base case, escalation, and de-escalation scenario projections with GERI forecasts.', 'Pro', '49/mo');
            }

            if (d.ai_narrative) {
                html += renderNarrativeSection(d, planLevel);
            }

            html += renderUpgradeHintsSection(d, planLevel);

            html += `<div style="text-align: center; padding: 12px; color: #64748b; font-size: 11px; margin-top: 8px;">
                Informational only. Not financial advice. | EnergyRiskIQ Intelligence Engine
            </div>`;

            container.innerHTML = html;
        }

        function renderDigestHeaderBar(d) {
            let delayBadge = '';
            if (d.is_delayed) {
                delayBadge = '<span class="digest-delayed-badge">24h Delayed (Free Plan)</span>';
            }
            return `
                <div class="digest-header-bar">
                    <div class="digest-date">
                        <strong>Digest Date:</strong> ${d.digest_date} &nbsp;|&nbsp;
                        <strong>Based on Alerts From:</strong> ${d.alerts_date} &nbsp;|&nbsp;
                        <strong>Total Alerts:</strong> ${d.total_alerts_yesterday}
                    </div>
                    ${delayBadge}
                </div>
            `;
        }

        function renderRiskToneSection(d) {
            const tone = d.risk_tone || {};
            const toneIcons = {red: '\u{1F534}', orange: '\u{1F7E0}', yellow: '\u{1F7E1}', green: '\u{1F7E2}', gray: '\u26AA'};
            return `
                <div class="digest-risk-tone tone-${tone.color || 'gray'}">
                    <span style="font-size: 28px;">${toneIcons[tone.color] || '\u26AA'}</span>
                    <div>
                        <div class="tone-label">Global Risk Tone: ${tone.tone || 'Unknown'}</div>
                        <div style="color: #94a3b8; font-size: 12px; margin-top: 2px;">Based on ${d.total_alerts_yesterday || 0} alerts analyzed from ${d.alerts_date}</div>
                    </div>
                </div>
            `;
        }

        function renderIndexSummary(d, planLevel) {
            let cards = '';

            if (d.geri) {
                cards += renderIndexCard('GERI', d.geri);
            }
            if (d.eeri && planLevel >= 1) {
                cards += renderIndexCard('EERI', d.eeri);
            } else if (planLevel < 1) {
                cards += `<div class="digest-index-card" style="opacity: 0.5; position: relative;">
                    <div class="index-name">EERI</div>
                    <div class="index-value" style="filter: blur(4px);">--</div>
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); padding: 4px 10px; border-radius: 6px; font-size: 11px; color: #60a5fa;">Personal+</div>
                </div>`;
            }
            if (d.egsi && planLevel >= 1) {
                cards += renderIndexCard('EGSI-M', d.egsi);
            } else if (planLevel < 1) {
                cards += `<div class="digest-index-card" style="opacity: 0.5; position: relative;">
                    <div class="index-name">EGSI-M</div>
                    <div class="index-value" style="filter: blur(4px);">--</div>
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); padding: 4px 10px; border-radius: 6px; font-size: 11px; color: #60a5fa;">Personal+</div>
                </div>`;
            }
            if (d.storage_context && planLevel >= 1) {
                const sc = d.storage_context;
                const bandColors = {'ELEVATED': '#f59e0b', 'CRITICAL': '#ef4444', 'MODERATE': '#eab308', 'LOW': '#22c55e'};
                const color = bandColors[sc.risk_band] || '#94a3b8';
                cards += `<div class="digest-index-card">
                    <div class="index-name">EU GAS STORAGE</div>
                    <div class="index-value">${sc.current}%</div>
                    <div class="index-band" style="background: ${color}20; color: ${color};">${sc.risk_band || 'N/A'}</div>
                </div>`;
            }

            if (!cards) return '';
            return `
                <div class="digest-card">
                    <div class="digest-card-header">
                        <span class="digest-section-icon">\u{1F4CA}</span>
                        <h3>Index Movement Summary</h3>
                    </div>
                    <div class="digest-card-body">
                        <div class="digest-index-grid">${cards}</div>
                    </div>
                </div>
            `;
        }

        function renderIndexCard(name, data) {
            if (!data) return '';
            const bandColors = {'CRITICAL': '#ef4444', 'ELEVATED': '#f59e0b', 'MODERATE': '#eab308', 'LOW': '#22c55e'};
            const color = bandColors[data.band] || '#94a3b8';
            const trend = data.trend_1d || 0;
            const trendClass = trend > 0 ? 'up' : trend < 0 ? 'down' : 'flat';
            const trendArrow = trend > 0 ? '\u2191' : trend < 0 ? '\u2193' : '\u2192';
            return `<div class="digest-index-card">
                <div class="index-name">${name}</div>
                <div class="index-value">${data.value}</div>
                <div class="index-band" style="background: ${color}20; color: ${color};">${data.band || 'N/A'}</div>
                <div class="index-trend ${trendClass}">${trendArrow} ${trend > 0 ? '+' : ''}${trend} (1d) | ${data.trend_7d > 0 ? '+' : ''}${data.trend_7d || 0} (7d)</div>
            </div>`;
        }

        function renderAssetMovesSection(d) {
            const changes = d.asset_changes || {};
            if (Object.keys(changes).length === 0) return '';

            let items = '';
            for (const [key, data] of Object.entries(changes)) {
                const label = data.label || key;
                const value = data.current;
                let changeText = '';
                let changeClass = 'neutral';
                if ('change_pct' in data) {
                    changeText = `${data.change_pct > 0 ? '+' : ''}${data.change_pct.toFixed(2)}%`;
                    changeClass = data.change_pct > 0 ? 'positive' : data.change_pct < 0 ? 'negative' : 'neutral';
                    if (key === 'vix' || key === 'storage') {
                        changeClass = data.change_pct > 0 ? 'negative' : data.change_pct < 0 ? 'positive' : 'neutral';
                    }
                } else if ('change_delta' in data) {
                    changeText = `${data.change_delta > 0 ? '+' : ''}${data.change_delta}`;
                    changeClass = data.change_delta > 0 ? (key === 'vix' ? 'negative' : 'positive') : data.change_delta < 0 ? (key === 'storage' ? 'negative' : 'positive') : 'neutral';
                }

                let displayVal = value;
                if (key === 'eurusd') displayVal = value.toFixed(4);
                else if (key === 'storage') displayVal = value + '%';
                else if (key === 'brent' || key === 'ttf') displayVal = '$' + value.toFixed(2);
                else displayVal = value.toFixed(2);

                items += `<div class="digest-asset-item">
                    <div class="asset-label">${label}</div>
                    <div class="asset-value">${displayVal}</div>
                    <div class="asset-change ${changeClass}">${changeText}</div>
                </div>`;
            }

            return `
                <div class="digest-card">
                    <div class="digest-card-header">
                        <span class="digest-section-icon">\u{1F4B9}</span>
                        <h3>Market Reaction (24h)</h3>
                    </div>
                    <div class="digest-card-body">
                        <div class="digest-asset-grid">${items}</div>
                    </div>
                </div>
            `;
        }

        function renderTopAlertsSection(d, planLevel) {
            const alerts = d.alerts || [];
            if (alerts.length === 0) return '';

            let items = '';
            for (const a of alerts) {
                items += `<div class="digest-alert-item">
                    <div class="alert-headline">
                        <span class="digest-severity-dot sev-${a.severity}"></span>
                        ${a.headline}
                    </div>
                    <div class="alert-meta">
                        <span>Region: ${a.region}</span>
                        <span>Severity: ${a.severity}/5</span>
                        <span>Category: ${a.category || 'N/A'}</span>
                        ${a.confidence ? '<span>Confidence: ' + (a.confidence * 100).toFixed(0) + '%</span>' : ''}
                    </div>
                </div>`;
            }

            const totalHidden = (d.total_alerts_yesterday || 0) - alerts.length;
            let moreNote = '';
            if (totalHidden > 0 && planLevel < 1) {
                moreNote = `<div style="text-align: center; padding: 12px; color: #64748b; font-size: 12px; border-top: 1px solid #334155; margin-top: 12px;">
                    +${totalHidden} more alerts available with <button onclick="showSection('plans')" style="background: none; border: none; color: #60a5fa; cursor: pointer; font-weight: 600; font-size: 12px;">Personal plan (9.95/mo)</button>
                </div>`;
            } else if (totalHidden > 0 && planLevel < 3) {
                moreNote = `<div style="text-align: center; padding: 12px; color: #64748b; font-size: 12px; border-top: 1px solid #334155; margin-top: 12px;">
                    +${totalHidden} more alerts analyzed | Showing top ${alerts.length} by severity
                </div>`;
            }

            return `
                <div class="digest-card">
                    <div class="digest-card-header">
                        <span class="digest-section-icon">\u26A0\uFE0F</span>
                        <h3>Top Risk Events (${alerts.length})</h3>
                    </div>
                    <div class="digest-card-body">
                        ${items}
                        ${moreNote}
                    </div>
                </div>
            `;
        }

        function renderCorrelationsSection(d, planLevel) {
            const corr = d.correlations;
            if (!corr || Object.keys(corr).length === 0) {
                return `<div class="digest-card">
                    <div class="digest-card-header">
                        <span class="digest-section-icon">\u{1F517}</span>
                        <h3>Risk vs Asset Correlation (7d)</h3>
                    </div>
                    <div class="digest-card-body">
                        <p style="color: #94a3b8; font-size: 13px;">Insufficient data for correlation analysis. More historical data is being collected.</p>
                    </div>
                </div>`;
            }

            const corrLabels = {brent: 'GERI vs Brent', ttf: 'GERI vs TTF Gas', vix: 'GERI vs VIX'};
            let rows = '';
            for (const [key, val] of Object.entries(corr)) {
                const label = corrLabels[key] || key;
                const strength = Math.abs(val) >= 0.7 ? 'Strong' : Math.abs(val) >= 0.4 ? 'Moderate' : 'Weak';
                const strengthColor = Math.abs(val) >= 0.7 ? '#ef4444' : Math.abs(val) >= 0.4 ? '#f59e0b' : '#22c55e';
                rows += `<tr>
                    <td>${label}</td>
                    <td style="font-weight: 600;">${val.toFixed(2)}</td>
                    <td style="color: ${strengthColor}; font-weight: 600;">${strength}</td>
                </tr>`;
            }

            return `
                <div class="digest-card">
                    <div class="digest-card-header">
                        <span class="digest-section-icon">\u{1F517}</span>
                        <h3>Risk vs Asset Correlation (7d)</h3>
                    </div>
                    <div class="digest-card-body">
                        <table class="digest-correlation-table">
                            <thead><tr><th>Pair</th><th>Correlation</th><th>Strength</th></tr></thead>
                            <tbody>${rows}</tbody>
                        </table>
                        ${planLevel < 2 ? '<p style="color: #64748b; font-size: 11px; margin-top: 10px;">Upgrade to Trader for probability scoring and volatility outlook.</p>' : ''}
                    </div>
                </div>
            `;
        }

        function renderRegimeSection(d) {
            if (!d.regime) return '';
            const regimeColors = {
                'Shock': {bg: 'rgba(239,68,68,0.15)', border: '#ef4444', text: '#ef4444'},
                'Gas-Storage Stress': {bg: 'rgba(249,115,22,0.15)', border: '#f97316', text: '#f97316'},
                'Risk Build': {bg: 'rgba(234,179,8,0.15)', border: '#eab308', text: '#eab308'},
                'Elevated Uncertainty': {bg: 'rgba(234,179,8,0.15)', border: '#eab308', text: '#eab308'},
                'Calm': {bg: 'rgba(34,197,94,0.15)', border: '#22c55e', text: '#22c55e'},
                'Moderate': {bg: 'rgba(148,163,184,0.15)', border: '#94a3b8', text: '#94a3b8'}
            };
            const rc = regimeColors[d.regime] || regimeColors['Moderate'];
            return `
                <div class="digest-card">
                    <div class="digest-card-header">
                        <span class="digest-section-icon">\u{1F3AF}</span>
                        <h3>Regime Classification</h3>
                    </div>
                    <div class="digest-card-body" style="text-align: center;">
                        <div class="digest-regime-badge" style="background: ${rc.bg}; border: 1px solid ${rc.border}; color: ${rc.text};">
                            ${d.regime}
                        </div>
                        <p style="color: #94a3b8; font-size: 12px; margin-top: 10px;">
                            Rule-based regime classification using GERI, EERI, VIX, and EU Storage levels
                        </p>
                    </div>
                </div>
            `;
        }

        function renderBetasSection(d) {
            const betas = d.betas;
            if (!betas || Object.keys(betas).length === 0) {
                return `<div class="digest-card">
                    <div class="digest-card-header">
                        <span class="digest-section-icon">\u{1F4C8}</span>
                        <h3>Asset Sensitivity Dashboard (Rolling Beta)</h3>
                    </div>
                    <div class="digest-card-body">
                        <p style="color: #94a3b8; font-size: 13px;">Insufficient historical data for beta calculation. Building dataset...</p>
                    </div>
                </div>`;
            }

            const betaLabels = {brent: 'GERI \u2192 Brent', ttf: 'GERI \u2192 TTF Gas', vix: 'GERI \u2192 VIX'};
            let rows = '';
            for (const [key, val] of Object.entries(betas)) {
                const label = betaLabels[key] || key;
                rows += `<tr>
                    <td>${label}</td>
                    <td style="font-weight: 700; color: #f1f5f9;">${val.toFixed(3)}</td>
                    <td style="color: #94a3b8;">When GERI rises 10pts, ${key === 'brent' ? 'Brent' : key === 'ttf' ? 'TTF' : 'VIX'} moves ~${(val * 10).toFixed(1)}pts</td>
                </tr>`;
            }

            return `
                <div class="digest-card">
                    <div class="digest-card-header">
                        <span class="digest-section-icon">\u{1F4C8}</span>
                        <h3>Asset Sensitivity Dashboard (Rolling Beta)</h3>
                        <span style="background: rgba(239,68,68,0.2); color: #ef4444; font-size: 10px; padding: 2px 8px; border-radius: 4px; margin-left: auto;">PRO</span>
                    </div>
                    <div class="digest-card-body">
                        <table class="digest-correlation-table">
                            <thead><tr><th>Sensitivity</th><th>Beta</th><th>Interpretation</th></tr></thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderForwardWatchlistSection(d) {
            const items = d.forward_watchlist;
            if (!items || items.length === 0) {
                return `
                <div class="digest-card">
                    <div class="digest-card-header">
                        <span class="digest-section-icon">\u{1F50D}</span>
                        <h3>Forward Watchlist</h3>
                        <span style="background: rgba(249,115,22,0.2); color: #f97316; font-size: 10px; padding: 2px 8px; border-radius: 4px; margin-left: auto;">TRADER+</span>
                    </div>
                    <div class="digest-card-body">
                        <p style="color: #94a3b8; font-size: 13px;">No high-priority items on the watchlist today.</p>
                    </div>
                </div>`;
            }
            let rows = '';
            for (const item of items) {
                const sevColor = item.severity >= 8 ? '#ef4444' : item.severity >= 6 ? '#f97316' : '#eab308';
                rows += `<tr>
                    <td style="color: ${sevColor}; font-weight: 700;">${item.severity}/10</td>
                    <td>${item.headline}</td>
                    <td style="color: #94a3b8;">${item.region}</td>
                    <td style="color: #cbd5e1; font-size: 12px;">${item.watch_reason}</td>
                </tr>`;
            }
            return `
                <div class="digest-card">
                    <div class="digest-card-header">
                        <span class="digest-section-icon">\u{1F50D}</span>
                        <h3>Forward Watchlist</h3>
                        <span style="background: rgba(249,115,22,0.2); color: #f97316; font-size: 10px; padding: 2px 8px; border-radius: 4px; margin-left: auto;">TRADER+</span>
                    </div>
                    <div class="digest-card-body">
                        <table class="digest-correlation-table">
                            <thead><tr><th>Severity</th><th>Event</th><th>Region</th><th>Watch Reason</th></tr></thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>
                </div>`;
        }

        function renderProbabilityScoringSection(d) {
            const ps = d.probability_scoring;
            if (!ps) {
                return `
                <div class="digest-card">
                    <div class="digest-card-header">
                        <span class="digest-section-icon">\u{1F3AF}</span>
                        <h3>Probability Scoring</h3>
                        <span style="background: rgba(249,115,22,0.2); color: #f97316; font-size: 10px; padding: 2px 8px; border-radius: 4px; margin-left: auto;">TRADER+</span>
                    </div>
                    <div class="digest-card-body">
                        <p style="color: #94a3b8; font-size: 13px;">Insufficient data to generate probability assessments.</p>
                    </div>
                </div>`;
            }
            function probBar(label, pct, color) {
                return `<div style="margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <span style="color: #cbd5e1; font-size: 13px;">${label}</span>
                        <span style="color: ${color}; font-weight: 700; font-size: 13px;">${pct}%</span>
                    </div>
                    <div style="background: rgba(100,116,139,0.2); border-radius: 4px; height: 8px; overflow: hidden;">
                        <div style="background: ${color}; width: ${pct}%; height: 100%; border-radius: 4px; transition: width 0.6s;"></div>
                    </div>
                </div>`;
            }
            return `
                <div class="digest-card">
                    <div class="digest-card-header">
                        <span class="digest-section-icon">\u{1F3AF}</span>
                        <h3>Probability Scoring</h3>
                        <span style="background: rgba(249,115,22,0.2); color: #f97316; font-size: 10px; padding: 2px 8px; border-radius: 4px; margin-left: auto;">TRADER+</span>
                    </div>
                    <div class="digest-card-body">
                        ${probBar('Escalation', ps.escalation_probability, '#ef4444')}
                        ${probBar('Stability', ps.stability_probability, '#22c55e')}
                        ${probBar('De-escalation', ps.de_escalation_probability, '#3b82f6')}
                        <p style="color: #64748b; font-size: 11px; margin-top: 8px;">${ps.methodology}</p>
                    </div>
                </div>`;
        }

        function renderVolatilityOutlookSection(d) {
            const vo = d.volatility_outlook;
            if (!vo) {
                return `
                <div class="digest-card">
                    <div class="digest-card-header">
                        <span class="digest-section-icon">\u{1F30A}</span>
                        <h3>Volatility Outlook</h3>
                        <span style="background: rgba(249,115,22,0.2); color: #f97316; font-size: 10px; padding: 2px 8px; border-radius: 4px; margin-left: auto;">TRADER+</span>
                    </div>
                    <div class="digest-card-body">
                        <p style="color: #94a3b8; font-size: 13px;">Insufficient data for volatility assessment.</p>
                    </div>
                </div>`;
            }
            const regimeColors = {low: '#22c55e', moderate: '#eab308', high: '#f97316', extreme: '#ef4444'};
            const regimeColor = regimeColors[vo.regime] || '#94a3b8';
            return `
                <div class="digest-card">
                    <div class="digest-card-header">
                        <span class="digest-section-icon">\u{1F30A}</span>
                        <h3>Volatility Outlook</h3>
                        <span style="background: rgba(249,115,22,0.2); color: #f97316; font-size: 10px; padding: 2px 8px; border-radius: 4px; margin-left: auto;">TRADER+</span>
                    </div>
                    <div class="digest-card-body">
                        <div style="display: flex; gap: 24px; align-items: center; margin-bottom: 12px;">
                            <div style="text-align: center;">
                                <div style="font-size: 28px; font-weight: 700; color: ${regimeColor};">${vo.current_vol}</div>
                                <div style="color: #94a3b8; font-size: 11px;">GERI 7d Vol</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 16px; font-weight: 600; color: ${regimeColor}; text-transform: uppercase;">${vo.regime}</div>
                                <div style="color: #94a3b8; font-size: 11px;">Vol Regime</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 28px; font-weight: 700; color: #f1f5f9;">${vo.vix_level.toFixed(1)}</div>
                                <div style="color: #94a3b8; font-size: 11px;">VIX Level</div>
                            </div>
                        </div>
                        <p style="color: #cbd5e1; font-size: 13px;">${vo.outlook}</p>
                    </div>
                </div>`;
        }

        function renderScenarioForecastsSection(d) {
            const scenarios = d.scenario_forecasts;
            if (!scenarios || scenarios.length === 0) {
                return `
                <div class="digest-card">
                    <div class="digest-card-header">
                        <span class="digest-section-icon">\u{1F52E}</span>
                        <h3>Scenario Forecasts</h3>
                        <span style="background: rgba(239,68,68,0.2); color: #ef4444; font-size: 10px; padding: 2px 8px; border-radius: 4px; margin-left: auto;">PRO</span>
                    </div>
                    <div class="digest-card-body">
                        <p style="color: #94a3b8; font-size: 13px;">Insufficient data for scenario generation.</p>
                    </div>
                </div>`;
            }
            const scenarioColors = {'Base Case': '#3b82f6', 'Escalation': '#ef4444', 'De-escalation': '#22c55e'};
            let cards = '';
            for (const s of scenarios) {
                const color = scenarioColors[s.scenario] || '#94a3b8';
                cards += `<div style="flex: 1; background: rgba(30,41,59,0.5); border-radius: 8px; padding: 14px; border-left: 3px solid ${color};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="color: ${color}; font-weight: 700; font-size: 14px;">${s.scenario}</span>
                        <span style="color: #f1f5f9; font-weight: 600;">${s.probability}%</span>
                    </div>
                    <div style="color: #94a3b8; font-size: 12px; margin-bottom: 6px;">GERI Forecast: <span style="color: #f1f5f9; font-weight: 600;">${s.geri_forecast}</span></div>
                    <div style="color: #cbd5e1; font-size: 12px;">${s.description}</div>
                </div>`;
            }
            return `
                <div class="digest-card">
                    <div class="digest-card-header">
                        <span class="digest-section-icon">\u{1F52E}</span>
                        <h3>Scenario Forecasts</h3>
                        <span style="background: rgba(239,68,68,0.2); color: #ef4444; font-size: 10px; padding: 2px 8px; border-radius: 4px; margin-left: auto;">PRO</span>
                    </div>
                    <div class="digest-card-body" style="display: flex; gap: 12px; flex-wrap: wrap;">
                        ${cards}
                    </div>
                </div>`;
        }

        function renderNarrativeSection(d, planLevel) {
            let narrative = d.ai_narrative || '';
            narrative = narrative
                .replace(/## (.*)/g, '<h2>$1</h2>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/^\- (.*)/gm, '<li>$1</li>')
                .replace(/^\* (.*)/gm, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)/gs, function(match) {
                    return '<ul>' + match + '</ul>';
                })
                .replace(/<\/ul>\s*<ul>/g, '')
                .replace(/\n\n/g, '<br><br>')
                .replace(/\n/g, '<br>');

            const sectionLabels = {
                0: 'Executive Intelligence Brief',
                1: 'Full Daily Intelligence Digest',
                2: 'Trader Intelligence Digest',
                3: 'Professional Intelligence Report',
                4: 'Enterprise Intelligence Report'
            };

            return `
                <div class="digest-card">
                    <div class="digest-card-header">
                        <span class="digest-section-icon">\u{1F9E0}</span>
                        <h3>${sectionLabels[planLevel] || 'AI Intelligence Digest'}</h3>
                        <span style="background: rgba(59,130,246,0.2); color: #60a5fa; font-size: 10px; padding: 2px 8px; border-radius: 4px; margin-left: auto;">AI-Generated</span>
                    </div>
                    <div class="digest-card-body">
                        <div class="digest-narrative">${narrative}</div>
                    </div>
                </div>
            `;
        }

        function renderLockedSection(title, desc, plan, price) {
            return `
                <div class="digest-locked-section">
                    <div class="lock-icon">\u{1F512}</div>
                    <div class="lock-title">${title}</div>
                    <div class="lock-desc">${desc}</div>
                    <button class="lock-btn" onclick="showSection('plans')">Upgrade to ${plan} (${price})</button>
                </div>
            `;
        }

        function renderUpgradeHintsSection(d, planLevel) {
            if (planLevel >= 4) return '';
            const hints = d.upgrade_hints || [];
            if (hints.length === 0) return '';

            const nextPlanHints = {};
            for (const h of hints) {
                if (!nextPlanHints[h.plan]) nextPlanHints[h.plan] = [];
                nextPlanHints[h.plan].push(h.feature);
            }

            let cards = '';
            const planColors = {Personal: '#3b82f6', Trader: '#f59e0b', Pro: '#ef4444', Enterprise: '#a855f7'};
            for (const [planName, features] of Object.entries(nextPlanHints)) {
                const color = planColors[planName] || '#3b82f6';
                const price = hints.find(h => h.plan === planName)?.price || '';
                cards += `
                    <div style="background: ${color}10; border: 1px solid ${color}30; border-radius: 10px; padding: 16px; flex: 1; min-width: 200px;">
                        <div style="color: ${color}; font-weight: 700; font-size: 14px; margin-bottom: 8px;">${planName} ${price}</div>
                        <ul style="color: #94a3b8; font-size: 12px; padding-left: 16px; margin: 0;">
                            ${features.map(f => '<li>' + f + '</li>').join('')}
                        </ul>
                        <button onclick="showSection('plans')" style="margin-top: 12px; background: ${color}; color: white; border: none; padding: 6px 16px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">Upgrade</button>
                    </div>
                `;
            }

            return `
                <div class="digest-card">
                    <div class="digest-card-header">
                        <span class="digest-section-icon">\u{1F513}</span>
                        <h3>Unlock More Intelligence</h3>
                    </div>
                    <div class="digest-card-body">
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            ${cards}
                        </div>
                    </div>
                </div>
            `;
        }

        /* End Daily Digest Module */

        /* ========== EGSI Dashboard Module ========== */
        const EGSI_PLAN_CONFIG = {
            free: { label: 'Free', realtime: false, historyDays: 14, showComponents: false, showDrivers: false, showChokepoints: false, showStorage: false, showInterpretation: false, showHistory: true, upgradeTitle: 'Unlock full EGSI intelligence', upgradeDesc: 'Upgrade to Personal for real-time data, component breakdowns, and 90 days of history.' },
            personal: { label: 'Personal', realtime: true, historyDays: 90, showComponents: true, showDrivers: true, showChokepoints: false, showStorage: false, showInterpretation: false, showHistory: true, upgradeTitle: 'Go deeper with Trader intelligence', upgradeDesc: 'Upgrade to Trader to unlock: \u2713 Market impact intelligence \u2713 Asset divergence detection \u2713 Forward stress probabilities \u2713 Full historical analytics' },
            trader: { label: 'Trader', realtime: true, historyDays: 365, showComponents: true, showDrivers: true, showChokepoints: true, showStorage: true, showInterpretation: false, showHistory: true, upgradeTitle: 'Unlock AI interpretation with Pro', upgradeDesc: 'Upgrade to Pro for AI-powered market interpretation and scenario analysis.' },
            pro: { label: 'Pro', realtime: true, historyDays: 365, showComponents: true, showDrivers: true, showChokepoints: true, showStorage: true, showInterpretation: true, showHistory: true, upgradeTitle: 'Enterprise-grade intelligence', upgradeDesc: 'Contact us for institutional-grade features, API access, and team workspace.' },
            enterprise: { label: 'Enterprise', realtime: true, historyDays: 365, showComponents: true, showDrivers: true, showChokepoints: true, showStorage: true, showInterpretation: true, showHistory: true, upgradeTitle: '', upgradeDesc: '' },
        };

        let egsiDataCache = null;

        async function loadEgsiDashboard() {
            const plan = currentUser?.plan || 'free';
            const config = EGSI_PLAN_CONFIG[plan] || EGSI_PLAN_CONFIG.free;
            document.getElementById('egsiLoading').style.display = 'block';
            document.getElementById('egsiDashboard').style.display = 'none';
            const badge = document.getElementById('egsiHeaderBadge');
            if (badge) badge.textContent = config.label.toUpperCase();
            try {
                const resp = await fetch('/api/v1/indices/egsi/dashboard?plan=' + plan + '&history_days=' + config.historyDays, { headers: { 'X-User-Token': sessionToken } });
                const json = await resp.json();
                if (!json.success) {
                    document.getElementById('egsiLoading').innerHTML = '<p style="color:#94a3b8;">No EGSI data available yet. Data will appear once the index engine runs.</p>';
                    return;
                }
                egsiDataCache = json;
                document.getElementById('egsiLoading').style.display = 'none';
                document.getElementById('egsiDashboard').style.display = 'block';
                renderEgsiDualIndex(json, config);
                renderEgsiWhatChanged(json, config);
                renderEgsiComponents(json, config);
                renderEgsiDrivers(json, config);
                renderEgsiChokepoints(json, config);
                renderEgsiStorage(json, config);
                renderEgsiInterpretation(json, config);
                renderEgsiOutlook(json, config);
                renderEgsiNarrative(json, config);
                renderEgsiHistory(json, config);
                renderEgsiUpgradePrompt(config);
                loadEgsiTraderIntel();
            } catch (e) {
                console.error('EGSI dashboard error:', e);
                document.getElementById('egsiLoading').innerHTML = '<p style="color:#f87171;">Failed to load EGSI dashboard. Please try again later.</p>';
            }
        }

        function egsiFormatBand(band) { return 'egsi-band-' + (band || 'low').toLowerCase(); }

        function egsiFormatTrend(val, label) {
            if (val === null || val === undefined) return '';
            const n = parseFloat(val);
            const cls = n > 0 ? 'egsi-trend-up' : n < 0 ? 'egsi-trend-down' : 'egsi-trend-flat';
            const arrow = n > 0 ? '&#9650;' : n < 0 ? '&#9660;' : '&#8212;';
            return '<span class="egsi-trend ' + cls + '">' + arrow + ' ' + (n > 0 ? '+' : '') + n.toFixed(1) + ' (' + label + ')</span>';
        }

        function egsiFormatDate(dateStr) {
            if (!dateStr) return '';
            return new Date(dateStr + 'T00:00:00').toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        function renderEgsiCardExtras(prefix, indexData, historyArr) {
            var el = document.getElementById(prefix + 'Extras');
            if (!el) return;
            var html = '';
            var t1d = parseFloat(indexData.trend_1d || 0);
            var t7d = parseFloat(indexData.trend_7d || 0);
            var trajectory, trajClass;
            if (t1d > 0 && t7d > 0 && t1d > t7d) { trajectory = 'RAPIDLY RISING \u2B08'; trajClass = 'egsi-trajectory-rising'; }
            else if (t1d > 0 && t7d > 0) { trajectory = 'RISING \u2191'; trajClass = 'egsi-trajectory-rising'; }
            else if (t1d > 0 && t7d <= 0) { trajectory = 'RECOVERING \u2197'; trajClass = 'egsi-trajectory-recovering'; }
            else if (Math.abs(t1d) < 1 && Math.abs(t7d) < 1) { trajectory = 'STABLE \u2192'; trajClass = 'egsi-trajectory-stable'; }
            else if (t1d <= 0 && t7d > 0) { trajectory = 'COOLING \u2198'; trajClass = 'egsi-trajectory-declining'; }
            else if (t1d < 0 && t7d < 0 && Math.abs(t1d) > Math.abs(t7d)) { trajectory = 'RAPIDLY DECLINING \u2B0A'; trajClass = 'egsi-trajectory-declining'; }
            else if (t1d < 0) { trajectory = 'DECLINING \u2193'; trajClass = 'egsi-trajectory-declining'; }
            else { trajectory = 'STABLE \u2192'; trajClass = 'egsi-trajectory-stable'; }
            html += '<div class="egsi-trajectory ' + trajClass + '">Trajectory: ' + trajectory + '</div>';
            var velocity = Math.abs(t1d);
            var velLabel;
            if (velocity > 10) velLabel = 'FAST';
            else if (velocity > 5) velLabel = 'MODERATE';
            else if (velocity > 2) velLabel = 'SLOW';
            else velLabel = 'MINIMAL';
            html += '<div class="egsi-velocity-tag">Velocity: ' + velLabel + '</div>';
            var band = (indexData.band || '').toUpperCase();
            var regime;
            if (band === 'CRITICAL') regime = 'SYSTEMIC CRISIS';
            else if (band === 'HIGH') regime = 'ACUTE MARKET STRESS';
            else if (band === 'ELEVATED') regime = 'ELEVATED RISK ENVIRONMENT';
            else if (band === 'NORMAL') regime = 'BALANCED FUNDAMENTALS';
            else regime = 'LOW STRESS BASELINE';
            var regimeColor = band === 'CRITICAL' ? 'rgba(220,38,38,0.2);color:#fca5a5' : band === 'HIGH' ? 'rgba(239,68,68,0.15);color:#f87171' : band === 'ELEVATED' ? 'rgba(245,158,11,0.15);color:#fbbf24' : band === 'NORMAL' ? 'rgba(59,130,246,0.15);color:#60a5fa' : 'rgba(34,197,94,0.15);color:#4ade80';
            html += '<div class="egsi-regime-badge" style="background:' + regimeColor + '">REGIME: ' + regime + '</div>';
            if (historyArr && historyArr.length >= 5) {
                var val = indexData.value;
                var sorted = historyArr.map(function(h) { return h.value; }).sort(function(a,b) { return a - b; });
                var rank = sorted.filter(function(v) { return v <= val; }).length;
                var pctile = Math.round((rank / sorted.length) * 100);
                if (pctile >= 50) {
                    html += '<div class="egsi-percentile">Top ' + (100 - pctile) + '% of historical readings</div>';
                } else {
                    html += '<div class="egsi-percentile">Below median stress (Percentile: ' + pctile + '%)</div>';
                }
            }
            el.innerHTML = html;
        }

        function renderEgsiDualIndex(data, config) {
            if (data.egsi_m) {
                const m = data.egsi_m;
                document.getElementById('egsiMValue').textContent = m.value !== null ? m.value.toFixed(1) : '--';
                const mBand = document.getElementById('egsiMBand');
                mBand.textContent = m.band || '--';
                mBand.className = 'egsi-value-band ' + egsiFormatBand(m.band);
                document.getElementById('egsiMTrend1d').innerHTML = egsiFormatTrend(m.trend_1d, '1d');
                document.getElementById('egsiMTrend7d').innerHTML = egsiFormatTrend(m.trend_7d, '7d');
                document.getElementById('egsiMDate').textContent = egsiFormatDate(m.date);
                if (m.is_delayed) {
                    document.getElementById('egsiMDelayedBadge').style.display = 'inline-block';
                    document.getElementById('egsiMRealtimeBadge').style.display = 'none';
                } else {
                    document.getElementById('egsiMDelayedBadge').style.display = 'none';
                    document.getElementById('egsiMRealtimeBadge').style.display = 'inline-block';
                }
            }
            if (data.egsi_s) {
                const s = data.egsi_s;
                document.getElementById('egsiSValue').textContent = s.value !== null ? s.value.toFixed(1) : '--';
                const sBand = document.getElementById('egsiSBand');
                sBand.textContent = s.band || '--';
                sBand.className = 'egsi-value-band ' + egsiFormatBand(s.band);
                document.getElementById('egsiSTrend1d').innerHTML = egsiFormatTrend(s.trend_1d, '1d');
                document.getElementById('egsiSTrend7d').innerHTML = egsiFormatTrend(s.trend_7d, '7d');
                document.getElementById('egsiSDate').textContent = egsiFormatDate(s.date);
            } else {
                document.getElementById('egsiSCard').innerHTML = '<div style="padding:24px;text-align:center;color:#64748b;">EGSI-S data not yet available</div>';
            }
            var mHist = data.history && data.history.egsi_m ? data.history.egsi_m : [];
            var sHist = data.history && data.history.egsi_s ? data.history.egsi_s : [];
            if (data.egsi_m) renderEgsiCardExtras('egsiM', data.egsi_m, mHist);
            if (data.egsi_s) renderEgsiCardExtras('egsiS', data.egsi_s, sHist);
        }

        function renderEgsiComponents(data, config) {
            var mTooltips = { 'RERI (EU Risk)': 'Measures regional escalation risk from geopolitical events affecting European energy security', 'Gas Theme Pressure': 'Aggregated pressure from energy-related news themes indicating market stress', 'Asset Transmission': 'Measures how risk events transmit to specific energy assets like gas, oil, and power', 'Chokepoint Factor': 'Tracks critical infrastructure bottleneck risks at key transit points' };
            var sTooltips = { 'Storage Stress': 'Measures deviation of current storage levels from seasonal targets', 'Price Volatility': 'Tracks TTF natural gas price volatility relative to moving averages', 'Injection/Flows': 'Monitors gas injection rates and cross-border flow patterns', 'Winter Readiness': 'Assesses system preparedness for peak winter demand periods', 'Supply Alerts': 'Counts and scores supply-disruption related intelligence alerts' };
            const section = document.getElementById('egsiComponentsSection');
            if (!config.showComponents) { section.style.display = 'none'; return; }
            section.style.display = 'block';
            if (data.egsi_m && data.egsi_m.components) {
                const c = data.egsi_m.components;
                const items = [
                    { label: 'RERI (EU Risk)', value: c.reri_eu?.contribution || c.reri_eu?.value || 0, max: 0.35 },
                    { label: 'Gas Theme Pressure', value: c.theme_pressure?.contribution || 0, max: 0.35 },
                    { label: 'Asset Transmission', value: c.asset_transmission?.contribution || 0, max: 0.20 },
                    { label: 'Chokepoint Factor', value: c.chokepoint_factor?.contribution || 0, max: 0.10 },
                ];
                var totalM = data.egsi_m.value || 1;
                document.getElementById('egsiMComponents').innerHTML = items.map(function(item) {
                    const pct = Math.min(100, Math.round((item.value / (item.max || 1)) * 100));
                    var pctOfTotal = totalM > 0 ? Math.round((item.value / (totalM / 100)) * 100) : 0;
                    var tooltip = mTooltips[item.label] || '';
                    return '<div class="egsi-component-item egsi-component-tooltip" title="' + tooltip + '"><div class="egsi-component-label"><span>' + item.label + ' \u2014 ' + (item.value * 100).toFixed(1) + ' (' + pctOfTotal + '% of EGSI-M)</span><span>' + (item.value * 100).toFixed(1) + '</span></div><div class="egsi-component-bar"><div class="egsi-component-fill egsi-m-fill" style="width:' + pct + '%"></div></div></div>';
                }).join('');
            }
            const sGroup = document.getElementById('egsiSComponentsGroup');
            if (data.egsi_s && data.egsi_s.components) {
                sGroup.style.display = 'block';
                const sc = data.egsi_s.components;
                const sItems = [
                    { label: 'Storage Stress', value: sc.storage?.contribution || 0, max: 0.20 },
                    { label: 'Price Volatility', value: sc.price?.contribution || 0, max: 0.20 },
                    { label: 'Injection/Flows', value: sc.flows?.contribution || 0, max: 0.20 },
                    { label: 'Winter Readiness', value: sc.winter_readiness?.contribution || 0, max: 0.25 },
                    { label: 'Supply Alerts', value: sc.alerts?.contribution || 0, max: 0.15 },
                ];
                var totalS = data.egsi_s.value || 1;
                document.getElementById('egsiSComponents').innerHTML = sItems.map(function(item) {
                    const pct = Math.min(100, Math.round((item.value / (item.max || 1)) * 100));
                    var pctOfTotal = totalS > 0 ? Math.round((item.value / (totalS / 100)) * 100) : 0;
                    var tooltip = sTooltips[item.label] || '';
                    return '<div class="egsi-component-item egsi-component-tooltip" title="' + tooltip + '"><div class="egsi-component-label"><span>' + item.label + ' \u2014 ' + (item.value * 100).toFixed(1) + ' (' + pctOfTotal + '% of EGSI-S)</span><span>' + (item.value * 100).toFixed(1) + '</span></div><div class="egsi-component-bar"><div class="egsi-component-fill egsi-s-fill" style="width:' + pct + '%"></div></div></div>';
                }).join('');
            } else { sGroup.style.display = 'none'; }
        }

        function renderEgsiDrivers(data, config) {
            const section = document.getElementById('egsiDriversSection');
            if (!config.showDrivers) { section.style.display = 'none'; return; }
            section.style.display = 'block';
            function getDriverImpact(cat) {
                cat = (cat || '').toLowerCase();
                if (cat === 'energy' || cat === 'asset_risk') return '\u2191 Price volatility risk \u00B7 \u2191 Supply disruption probability';
                if (cat === 'war' || cat === 'regional_risk') return '\u2191 Supply disruption risk \u00B7 \u2191 Transit uncertainty';
                if (cat === 'high_impact') return '\u2191 Market stress acceleration \u00B7 \u2191 Price spike probability';
                return '\u2191 Market uncertainty';
            }
            function getDriverTrend(score) {
                var s = parseFloat(score || 0);
                if (s >= 4.5) return { label: 'Escalating \u2191', cls: 'egsi-driver-trend-escalating' };
                if (s >= 3.5) return { label: 'Active \u2192', cls: 'egsi-driver-trend-active' };
                return { label: 'Monitoring \u2193', cls: 'egsi-driver-trend-monitoring' };
            }
            function renderDriverList(drivers, containerId) {
                const container = document.getElementById(containerId);
                if (!drivers || drivers.length === 0) { container.innerHTML = '<div style="color:#64748b;font-size:13px;padding:12px;">No drivers reported</div>'; return; }
                container.innerHTML = drivers.map(function(d, i) {
                    const headline = d.headline || d.label || d.driver || 'Risk driver';
                    const meta = d.severity ? '<div class="egsi-driver-meta">' + (d.severity || '') + (d.confidence ? ' | Conf: ' + d.confidence : '') + '</div>' : '';
                    var impact = '<div class="egsi-driver-impact">' + getDriverImpact(d.category) + '</div>';
                    var trend = getDriverTrend(d.score);
                    var trendHtml = '<div class="egsi-driver-trend-tag ' + trend.cls + '">Confidence: ' + (d.confidence || 'N/A') + ' \u00B7 Trend: ' + trend.label + '</div>';
                    return '<div class="egsi-driver-item"><div class="egsi-driver-rank">' + (i + 1) + '</div><div><div class="egsi-driver-text">' + headline + '</div>' + meta + impact + trendHtml + '</div></div>';
                }).join('');
            }
            renderDriverList(data.egsi_m?.top_drivers, 'egsiMDrivers');
            const sCol = document.getElementById('egsiSDriversCol');
            if (data.egsi_s?.top_drivers && data.egsi_s.top_drivers.length > 0) { sCol.style.display = 'block'; renderDriverList(data.egsi_s.top_drivers, 'egsiSDrivers'); }
            else { sCol.style.display = 'none'; }
        }

        function renderEgsiChokepoints(data, config) {
            const section = document.getElementById('egsiChokepointSection');
            if (!config.showChokepoints || !data.egsi_m?.chokepoint_watch || data.egsi_m.chokepoint_watch.length === 0) { section.style.display = 'none'; return; }
            section.style.display = 'block';
            document.getElementById('egsiChokepointList').innerHTML = data.egsi_m.chokepoint_watch.map(function(cp) {
                return '<div class="egsi-chokepoint-item"><div class="egsi-chokepoint-name">' + (cp.name || cp.id || 'Unknown') + '</div><div class="egsi-chokepoint-cat">' + (cp.category || '') + '</div><div class="egsi-chokepoint-weight">' + (cp.weight ? cp.weight.toFixed(2) : '') + '</div></div>';
            }).join('');
        }

        function renderEgsiStorage(data, config) {
            const section = document.getElementById('egsiStoragePanel');
            if (!config.showStorage || !data.egsi_s?.components?.storage) { section.style.display = 'none'; return; }
            section.style.display = 'block';
            const stor = data.egsi_s.components.storage;
            const price = data.egsi_s.components.price || {};
            const winter = data.egsi_s.components.winter_readiness || {};
            const items = [
                { label: 'Storage Level', value: (stor.level_pct * 100).toFixed(1) + '%', bar: stor.level_pct * 100 },
                { label: 'Target Level', value: (stor.target_pct * 100).toFixed(1) + '%', bar: stor.target_pct * 100 },
                { label: 'TTF Price', value: price.ttf_current ? (price.ttf_current.toFixed(2) + ' EUR/MWh') : 'N/A', bar: null },
                { label: 'Days to Winter', value: winter.days_to_winter !== undefined ? winter.days_to_winter + ' days' : 'N/A', bar: null },
            ];
            document.getElementById('egsiStorageGrid').innerHTML = items.map(function(item) {
                const barHtml = item.bar !== null ? '<div class="egsi-storage-bar"><div class="egsi-storage-fill" style="width:' + Math.min(100, item.bar) + '%"></div></div>' : '';
                return '<div class="egsi-storage-item"><div class="egsi-storage-label">' + item.label + '</div><div class="egsi-storage-value">' + item.value + '</div>' + barHtml + '</div>';
            }).join('');
        }

        function renderEgsiInterpretation(data, config) {
            const section = document.getElementById('egsiInterpretationSection');
            if (!config.showInterpretation) { section.style.display = 'none'; return; }
            const mInterp = data.egsi_m?.interpretation || '';
            const sInterp = data.egsi_s?.interpretation || '';
            const combined = [mInterp, sInterp].filter(Boolean).join('<br><br>');
            if (!combined) { section.style.display = 'none'; return; }
            section.style.display = 'block';
            document.getElementById('egsiInterpretation').innerHTML = combined;
        }

        function renderEgsiHistory(data, config) {
            const section = document.getElementById('egsiHistorySection');
            if (!config.showHistory || !data.history) { section.style.display = 'none'; return; }
            section.style.display = 'block';
            document.getElementById('egsiHistoryInfo').textContent = 'Showing ' + data.history.days + ' days (max ' + data.history.max_days + ' for your plan)';
            renderEgsiChart(data, 30);
            const mHist = data.history.egsi_m || [];
            const sHist = data.history.egsi_s || [];
            const sMap = {};
            sHist.forEach(function(h) { sMap[h.date] = h; });
            var mReversed = [].concat(mHist).reverse();
            var avg7dMap = {};
            for (var i = 0; i < mReversed.length; i++) {
                var windowSlice = mReversed.slice(Math.max(0, i - 6), i + 1);
                var sum = 0; windowSlice.forEach(function(w) { sum += w.value; });
                avg7dMap[mReversed[i].date] = (sum / windowSlice.length).toFixed(1);
            }
            const rows = mHist.slice(0, 30).map(function(m, idx) {
                const s = sMap[m.date];
                const mTrendCls = m.trend_1d > 0 ? 'egsi-trend-up' : m.trend_1d < 0 ? 'egsi-trend-down' : 'egsi-trend-flat';
                const sTrendCls = s && s.trend_1d > 0 ? 'egsi-trend-up' : s && s.trend_1d < 0 ? 'egsi-trend-down' : 'egsi-trend-flat';
                var arrow7d = avg7dMap[m.date] || '-';
                var trendArrow = m.trend_1d > 0 ? '\u25B2' : m.trend_1d < 0 ? '\u25BC' : '\u2014';
                var trendArrowCls = m.trend_1d > 0 ? 'egsi-trend-up' : m.trend_1d < 0 ? 'egsi-trend-down' : 'egsi-trend-flat';
                var prevBand = idx < mHist.length - 1 ? mHist[idx + 1].band : m.band;
                var rowCls = (m.band !== prevBand && idx > 0) ? ' class="egsi-regime-change-row"' : '';
                return '<tr' + rowCls + '><td>' + egsiFormatDate(m.date) + '</td><td style="font-weight:600;">' + m.value.toFixed(1) + '</td><td><span class="' + egsiFormatBand(m.band) + '" style="padding:2px 8px;border-radius:10px;font-size:11px;">' + m.band + '</span></td><td class="' + mTrendCls + '">' + (m.trend_1d !== null ? (m.trend_1d > 0 ? '+' : '') + m.trend_1d.toFixed(1) : '-') + '</td><td>' + arrow7d + '</td><td class="' + trendArrowCls + '">' + trendArrow + '</td><td style="font-weight:600;">' + (s ? s.value.toFixed(1) : '-') + '</td><td>' + (s ? '<span class="' + egsiFormatBand(s.band) + '" style="padding:2px 8px;border-radius:10px;font-size:11px;">' + s.band + '</span>' : '-') + '</td><td class="' + sTrendCls + '">' + (s && s.trend_1d !== null ? (s.trend_1d > 0 ? '+' : '') + s.trend_1d.toFixed(1) : '-') + '</td></tr>';
            });
            document.getElementById('egsiHistoryBody').innerHTML = rows.join('');
        }

        function renderEgsiUpgradePrompt(config) {
            const prompt = document.getElementById('egsiUpgradePrompt');
            if (!config.upgradeTitle) { prompt.style.display = 'none'; return; }
            prompt.style.display = 'flex';
            document.getElementById('egsiUpgradeTitle').textContent = config.upgradeTitle;
            document.getElementById('egsiUpgradeDesc').textContent = config.upgradeDesc;
        }

        async function loadEgsiSnapshot() {
            const body = document.getElementById('snapshotEgsiBody');
            try {
                const plan = currentUser?.plan || 'free';
                const resp = await fetch('/api/v1/indices/egsi/dashboard?plan=' + plan + '&history_days=1', { headers: { 'X-User-Token': sessionToken } });
                const json = await resp.json();
                if (!json.success || !json.egsi_m) { body.innerHTML = '<div class="snapshot-card-detail">No EGSI data available yet</div>'; return; }
                const m = json.egsi_m;
                const val = m.value !== null ? m.value.toFixed(1) : '--';
                const band = m.band || 'N/A';
                const bandCls = 'band-' + (band || '').toLowerCase().replace(/\s+/g, '-');
                let trendHtml = '';
                if (m.trend_1d !== null && m.trend_1d !== undefined) {
                    const t = parseFloat(m.trend_1d);
                    const cls = t > 0 ? 'trend-up' : t < 0 ? 'trend-down' : 'trend-flat';
                    const arrow = t > 0 ? '&#9650;' : t < 0 ? '&#9660;' : '&#8212;';
                    trendHtml = '<div class="snapshot-card-trend ' + cls + '">' + arrow + ' ' + (t > 0 ? '+' : '') + t.toFixed(1) + ' (1d)</div>';
                }
                const dateStr = m.date ? egsiFormatDate(m.date) : '';
                const delayTag = m.is_delayed ? ' (24h delayed)' : '';
                body.innerHTML = '<div class="snapshot-card-value">' + val + '</div><span class="snapshot-card-band ' + bandCls + '">' + band + '</span>' + trendHtml + '<div class="snapshot-card-meta">' + dateStr + delayTag + '</div>';
            } catch (e) {
                console.error('EGSI snapshot error:', e);
                body.innerHTML = '<div class="snapshot-card-detail">Unable to load</div>';
            }
        }
        var egsiChart = null;
        var egsiChartData = null;

        function egsiSwitchView(view) {
            document.getElementById('egsiChartView').style.display = view === 'chart' ? 'block' : 'none';
            document.getElementById('egsiTableView').style.display = view === 'table' ? 'block' : 'none';
            document.getElementById('egsiChartViewBtn').classList.toggle('active', view === 'chart');
            document.getElementById('egsiTableViewBtn').classList.toggle('active', view === 'table');
            document.getElementById('egsiChartRangeBtns').style.display = view === 'chart' ? 'flex' : 'none';
        }

        function egsiSetRange(days) {
            document.querySelectorAll('.egsi-range-btn').forEach(function(b) { b.classList.remove('active'); });
            if (event && event.currentTarget) event.currentTarget.classList.add('active');
            renderEgsiChart(egsiChartData, days);
        }

        function renderEgsiChart(data, rangeDays) {
            if (!data || !data.history) return;
            egsiChartData = data;
            var mHist = data.history.egsi_m || [];
            var sHist = data.history.egsi_s || [];
            var mFiltered = [].concat(mHist).reverse();
            var sFiltered = [].concat(sHist).reverse();
            if (rangeDays > 0) {
                mFiltered = mFiltered.slice(-rangeDays);
                sFiltered = sFiltered.slice(-rangeDays);
            } else {
                var yearStart = new Date().getFullYear() + '-01-01';
                mFiltered = mFiltered.filter(function(h) { return h.date >= yearStart; });
                sFiltered = sFiltered.filter(function(h) { return h.date >= yearStart; });
            }
            var sMap = {};
            sFiltered.forEach(function(h) { sMap[h.date] = h; });
            var labels = mFiltered.map(function(h) {
                var d = new Date(h.date + 'T00:00:00');
                return d.toLocaleDateString('en-GB', {day:'numeric', month:'short'});
            });
            var mValues = mFiltered.map(function(h) { return h.value; });
            var sValues = mFiltered.map(function(h) { return sMap[h.date] ? sMap[h.date].value : null; });
            var ctx = document.getElementById('egsiHistoryChart');
            if (egsiChart) { egsiChart.destroy(); }
            var stressBandsPlugin = {
                id: 'egsiStressBands',
                beforeDraw: function(chart) {
                    var cCtx = chart.ctx;
                    var yAxis = chart.scales.y;
                    var xAxis = chart.scales.x;
                    var bands = [
                        { min: 0, max: 20, color: 'rgba(34,197,94,0.06)' },
                        { min: 20, max: 40, color: 'rgba(59,130,246,0.06)' },
                        { min: 40, max: 60, color: 'rgba(245,158,11,0.06)' },
                        { min: 60, max: 80, color: 'rgba(239,68,68,0.06)' },
                        { min: 80, max: 100, color: 'rgba(220,38,38,0.08)' },
                    ];
                    bands.forEach(function(band) {
                        var yTop = yAxis.getPixelForValue(Math.min(band.max, yAxis.max));
                        var yBot = yAxis.getPixelForValue(Math.max(band.min, yAxis.min));
                        if (yBot > yTop) {
                            cCtx.fillStyle = band.color;
                            cCtx.fillRect(xAxis.left, yTop, xAxis.width, yBot - yTop);
                        }
                    });
                }
            };
            egsiChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'EGSI-M (Market)',
                            data: mValues,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16,185,129,0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.3,
                            pointRadius: mValues.length > 60 ? 0 : 3,
                            pointHoverRadius: 5,
                            pointBackgroundColor: '#10b981',
                        },
                        {
                            label: 'EGSI-S (System)',
                            data: sValues,
                            borderColor: '#06b6d4',
                            backgroundColor: 'rgba(6,182,212,0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.3,
                            pointRadius: sValues.length > 60 ? 0 : 3,
                            pointHoverRadius: 5,
                            pointBackgroundColor: '#06b6d4',
                            yAxisID: 'y1',
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { labels: { color: '#94a3b8', font: { size: 12 } } },
                        tooltip: {
                            backgroundColor: '#1e293b',
                            titleColor: '#f1f5f9',
                            bodyColor: '#cbd5e1',
                            borderColor: '#334155',
                            borderWidth: 1,
                            callbacks: {
                                label: function(tooltipCtx) {
                                    return tooltipCtx.dataset.label + ': ' + (tooltipCtx.parsed.y !== null ? tooltipCtx.parsed.y.toFixed(1) : 'N/A');
                                }
                            }
                        }
                    },
                    scales: {
                        x: { ticks: { color: '#64748b', font: { size: 10 }, maxRotation: 45 }, grid: { color: 'rgba(51,65,85,0.3)' } },
                        y: { position: 'left', title: { display: true, text: 'EGSI-M', color: '#10b981', font: { size: 11 } }, ticks: { color: '#64748b', font: { size: 10 } }, grid: { color: 'rgba(51,65,85,0.3)' }, min: 0 },
                        y1: { position: 'right', title: { display: true, text: 'EGSI-S', color: '#06b6d4', font: { size: 11 } }, ticks: { color: '#64748b', font: { size: 10 } }, grid: { drawOnChartArea: false }, min: 0 }
                    }
                },
                plugins: [stressBandsPlugin]
            });
        }

        function renderEgsiWhatChanged(data, config) {
            var section = document.getElementById('egsiWhatChanged');
            if (!config.showComponents) { section.style.display = 'none'; return; }
            var mHist = data.history && data.history.egsi_m ? data.history.egsi_m : [];
            var sHist = data.history && data.history.egsi_s ? data.history.egsi_s : [];
            if (mHist.length < 2 && sHist.length < 2) { section.style.display = 'none'; return; }
            section.style.display = 'block';
            var changes = [];
            if (data.egsi_m && mHist.length >= 2) {
                var todayVal = data.egsi_m.value;
                var yesterdayVal = mHist[1] ? mHist[1].value : mHist[0].value;
                var delta = todayVal - yesterdayVal;
                if (Math.abs(delta) > 0.5) {
                    changes.push({ text: 'Market stress ' + (delta > 0 ? 'increased' : 'decreased') + ' by ' + Math.abs(delta).toFixed(1) + ' points', up: delta > 0 });
                }
                var todayBand = data.egsi_m.band;
                var yesterBand = mHist.length > 1 ? mHist[1].band : mHist[0].band;
                if (todayBand !== yesterBand) {
                    changes.push({ text: 'Stress band shifted from ' + yesterBand + ' to ' + todayBand, up: true });
                }
            }
            if (data.egsi_m && data.egsi_m.components) {
                var c = data.egsi_m.components;
                if (c.theme_pressure && c.theme_pressure.contribution > 0.1) changes.push({ text: 'Theme pressure elevated at ' + (c.theme_pressure.contribution * 100).toFixed(1) + '%', up: true });
                if (c.asset_transmission && c.asset_transmission.contribution > 0.03) changes.push({ text: 'Asset transmission stress at ' + (c.asset_transmission.contribution * 100).toFixed(1) + '%', up: true });
                if (c.chokepoint_factor && c.chokepoint_factor.contribution > 0) changes.push({ text: 'Chokepoint disruptions detected', up: true });
                if ((!c.theme_pressure || c.theme_pressure.contribution === 0) && (!c.chokepoint_factor || c.chokepoint_factor.contribution === 0)) changes.push({ text: 'No active theme pressure or chokepoint disruptions', up: false });
            }
            if (data.egsi_s && data.egsi_s.components && data.egsi_s.components.storage) {
                var stor = data.egsi_s.components.storage;
                if (stor.level_pct && stor.target_pct) {
                    var deficit = ((stor.target_pct - stor.level_pct) * 100).toFixed(1);
                    if (deficit > 5) changes.push({ text: 'Storage ' + deficit + '% below seasonal target', up: true });
                }
            }
            if (data.egsi_s && data.egsi_s.components && data.egsi_s.components.price && data.egsi_s.components.price.volatility_norm > 0.1) {
                changes.push({ text: 'Price volatility elevated', up: true });
            } else if (data.egsi_s && data.egsi_s.components && data.egsi_s.components.price) {
                changes.push({ text: 'Price volatility contained', up: false });
            }
            if (changes.length === 0) changes.push({ text: 'No significant changes detected today', up: false });
            document.getElementById('egsiWhatChangedList').innerHTML = changes.map(function(ch) {
                var cls = ch.up ? 'egsi-change-up' : 'egsi-change-down';
                var icon = ch.up ? '+' : '\u2212';
                return '<div class="egsi-change-item ' + cls + '"><span class="egsi-change-icon">' + icon + '</span><span>' + ch.text + '</span></div>';
            }).join('');
        }

        function renderEgsiOutlook(data, config) {
            var section = document.getElementById('egsiOutlookPanel');
            if (!config.showComponents) { section.style.display = 'none'; return; }
            var m = data.egsi_m;
            if (!m) { section.style.display = 'none'; return; }
            section.style.display = 'block';
            var t1d = parseFloat(m.trend_1d || 0);
            var t7d = parseFloat(m.trend_7d || 0);
            var band = (m.band || '').toUpperCase();
            var outlook, basis;
            if (t1d > 5 && t7d > 3) {
                outlook = 'Significant escalation risk. Market stress momentum suggests sustained elevated readings over the next 1-2 weeks unless stabilizing factors emerge.';
                basis = 'Based on: accelerating momentum, rising 7-day trend, ' + band.toLowerCase() + ' stress band';
            } else if (t1d > 2 && t7d > 0) {
                outlook = 'Moderate escalation risk. Current stress trajectory points to gradually increasing pressure, with potential for stress band elevation.';
                basis = 'Based on: positive momentum, upward 7-day trend';
            } else if (Math.abs(t1d) < 2 && Math.abs(t7d) < 2) {
                outlook = 'Stable conditions expected. Stress indicators suggest continuation of current regime with low probability of sharp movements.';
                basis = 'Based on: minimal momentum, stable 7-day trend';
            } else if (t1d < -2 && t7d < 0) {
                outlook = 'De-escalation likely. Declining momentum suggests stress relief over the coming days, though residual risks remain from underlying drivers.';
                basis = 'Based on: declining momentum, negative 7-day trend';
            } else {
                outlook = 'Mixed signals. Conflicting short-term and medium-term trends suggest potential for volatility in stress readings. Close monitoring recommended.';
                basis = 'Based on: divergent short-term and 7-day momentum';
            }
            if (data.egsi_s && data.egsi_s.components && data.egsi_s.components.storage && data.egsi_s.components.storage.level_pct < 0.4) {
                basis += ', low storage levels (' + (data.egsi_s.components.storage.level_pct * 100).toFixed(0) + '%)';
            }
            document.getElementById('egsiOutlookText').textContent = outlook;
            document.getElementById('egsiOutlookBasis').textContent = basis;
        }

        function renderEgsiNarrative(data, config) {
            var section = document.getElementById('egsiNarrativePanel');
            if (!config.showComponents) { section.style.display = 'none'; return; }
            var m = data.egsi_m;
            var s = data.egsi_s;
            if (!m) { section.style.display = 'none'; return; }
            section.style.display = 'block';
            var mVal = m.value ? m.value.toFixed(1) : '0';
            var t7d = parseFloat(m.trend_7d || 0);
            var narrative = 'European gas market stress is currently at ' + mVal + ' (' + m.band + ')';
            if (t7d > 3) narrative += ', with accelerating pressure over the past week';
            else if (t7d > 0) narrative += ', showing a gradually rising trend';
            else if (t7d < -3) narrative += ', with significant relief observed over the past week';
            else if (t7d < 0) narrative += ', on a declining trajectory';
            else narrative += ', in a stable pattern';
            narrative += '. ';
            if (m.top_drivers && m.top_drivers.length > 0) {
                var topDriver = m.top_drivers[0];
                narrative += 'The primary driver is "' + (topDriver.headline || 'market conditions') + '" ';
                if (topDriver.severity >= 4) narrative += 'at critical severity. ';
                else narrative += 'at moderate severity. ';
            }
            if (s && s.components && s.components.storage) {
                var stor = s.components.storage;
                var pct = (stor.level_pct * 100).toFixed(0);
                var target = (stor.target_pct * 100).toFixed(0);
                narrative += 'Storage levels stand at ' + pct + '% against a seasonal target of ' + target + '%';
                if (stor.level_pct < stor.target_pct - 0.1) narrative += ', indicating below-target reserves that warrant close monitoring';
                else narrative += ', within acceptable range';
                narrative += '. ';
            }
            if (s && s.components && s.components.price && s.components.price.ttf_current) {
                narrative += 'TTF gas prices are at \u20AC' + s.components.price.ttf_current.toFixed(2) + '/MWh';
                if (s.components.price.volatility_norm > 0.1) narrative += ' with elevated volatility';
                else narrative += ' with contained volatility';
                narrative += '.';
            }
            document.getElementById('egsiNarrativeText').textContent = narrative;
        }

        /* ========== EGSI Trader Intelligence Module ========== */
        var egsiTraderData = null;
        var egsiOverlayChartObj = null;
        var egsiStorageChartObj = null;

        async function loadEgsiTraderIntel() {
            var planLevel = 0;
            var planMap = {free: 0, personal: 1, trader: 2, pro: 3, enterprise: 4};
            if (currentUser && currentUser.plan) planLevel = planMap[currentUser.plan] || 0;

            if (planLevel < 2) {
                document.getElementById('egsiTraderIntelSection').style.display = 'none';
                document.getElementById('egsiTraderUpgradePrompt').style.display = 'block';
                return;
            }
            document.getElementById('egsiTraderUpgradePrompt').style.display = 'none';

            try {
                var resp = await fetch('/api/v1/indices/egsi/trader-intel', { headers: { 'X-User-Token': sessionToken } });
                var json = await resp.json();
                if (!json.success || !json.data) return;
                egsiTraderData = json.data;
                document.getElementById('egsiTraderIntelSection').style.display = 'block';
                renderEgsiMomentum(json.data.stress_momentum);
                renderEgsiDivergence(json.data.ttf_divergence);
                renderEgsiWeeklyDriver(json.data.weekly_driver);
                renderEgsiRiskRadar(json.data.risk_radar);
                renderEgsiAlertImpact(json.data.alert_impact);
                renderEgsiRegimeHistory(json.data.regime_history);
                renderEgsiOverlayChart();
                renderEgsiStorageSeasonalChart(json.data.storage_seasonal);
                renderEgsiAnalogFinder(json.data.analog_finder);
            } catch (e) {
                console.error('EGSI Trader Intel error:', e);
            }
        }

        function renderEgsiMomentum(data) {
            if (!data || data.rsi === null) return;
            var rsi = data.rsi;
            document.getElementById('egsiMomentumValue').textContent = rsi.toFixed(1);
            var label = data.label || 'NEUTRAL';
            document.getElementById('egsiMomentumLabel').textContent = label;
            document.getElementById('egsiMomentumBar').style.width = rsi + '%';
            var cls = '';
            if (rsi >= 70) cls = 'egsi-momentum-overbought';
            else if (rsi >= 55) cls = 'egsi-momentum-building';
            else if (rsi <= 30) cls = 'egsi-momentum-oversold';
            else if (rsi <= 45) cls = 'egsi-momentum-easing';
            else cls = 'egsi-momentum-neutral';
            document.getElementById('egsiMomentumBar').className = 'egsi-momentum-bar ' + cls;
            document.getElementById('egsiMomentumDesc').textContent = data.description || '';
        }

        function renderEgsiDivergence(data) {
            if (!data) return;
            var el = document.getElementById('egsiDivergenceSignal');
            var signal = data.signal || 'N/A';
            var signalMap = {
                'OVERPRICED': { text: 'OVERPRICED', cls: 'egsi-div-overpriced' },
                'UNDERPRICED': { text: 'UNDERPRICED', cls: 'egsi-div-underpriced' },
                'SLIGHT_PREMIUM': { text: 'SLIGHT PREMIUM', cls: 'egsi-div-slight-up' },
                'SLIGHT_DISCOUNT': { text: 'SLIGHT DISCOUNT', cls: 'egsi-div-slight-down' },
                'ALIGNED': { text: 'ALIGNED', cls: 'egsi-div-aligned' },
            };
            var s = signalMap[signal] || { text: signal, cls: '' };
            el.textContent = s.text;
            el.className = 'egsi-divergence-signal ' + s.cls;
            if (data.z_score !== null && data.z_score !== undefined) {
                document.getElementById('egsiDivergenceZScore').textContent = (data.z_score > 0 ? '+' : '') + data.z_score.toFixed(2) + '\u03C3';
            }
            document.getElementById('egsiDivergenceDesc').textContent = data.description || '';
            var meta = '';
            if (data.latest_egsi) meta += 'EGSI: ' + data.latest_egsi;
            if (data.latest_ttf) meta += ' | TTF: \u20AC' + data.latest_ttf;
            document.getElementById('egsiDivergenceMeta').textContent = meta;
        }

        function renderEgsiWeeklyDriver(data) {
            if (!data || !data.headline) {
                document.getElementById('egsiWeeklyHeadline').textContent = 'No significant driver this week';
                return;
            }
            document.getElementById('egsiWeeklyHeadline').textContent = data.headline;
            var meta = [];
            if (data.severity) meta.push('Severity: ' + data.severity);
            if (data.type) meta.push('Type: ' + data.type);
            if (data.source) meta.push('Source: ' + data.source);
            document.getElementById('egsiWeeklyMeta').textContent = meta.join(' | ');
        }

        function renderEgsiRiskRadar(data) {
            if (!data) return;
            var overallMap = {
                'RISK_ON': { text: 'RISK ON', cls: 'egsi-radar-risk-on' },
                'LEANING_UP': { text: 'LEANING UP', cls: 'egsi-radar-leaning-up' },
                'NEUTRAL': { text: 'NEUTRAL', cls: 'egsi-radar-neutral' },
                'LEANING_DOWN': { text: 'LEANING DOWN', cls: 'egsi-radar-leaning-down' },
                'RISK_OFF': { text: 'RISK OFF', cls: 'egsi-radar-risk-off' },
            };
            var o = overallMap[data.overall_bias] || { text: data.overall_bias, cls: '' };
            document.getElementById('egsiRadarOverall').innerHTML = '<span class="egsi-radar-badge ' + o.cls + '">' + o.text + '</span>';

            var signalsHtml = (data.signals || []).map(function(s) {
                var biasIcon = s.bias === 'UP' ? '<span class="egsi-radar-up">&#9650;</span>' : s.bias === 'DOWN' ? '<span class="egsi-radar-down">&#9660;</span>' : '<span class="egsi-radar-flat">&#8212;</span>';
                return '<div class="egsi-radar-signal-row">' + biasIcon + '<div class="egsi-radar-signal-info"><strong>' + s.factor + '</strong><span>' + s.detail + '</span></div></div>';
            }).join('');
            document.getElementById('egsiRadarSignals').innerHTML = signalsHtml;
        }

        function renderEgsiAlertImpact(data) {
            if (!data || !data.scenarios || data.scenarios.length === 0) return;
            var html = '<div class="egsi-impact-current">Current: <strong>' + (data.current_value || '--') + '</strong> (' + (data.current_band || '--') + ') | Momentum: ' + (data.momentum || 0).toFixed(2) + '</div>';
            html += '<div class="egsi-impact-grid">';
            data.scenarios.forEach(function(sc) {
                var cls = sc.label.indexOf('accelerates') >= 0 ? 'egsi-scenario-up' : sc.label.indexOf('reverses') >= 0 ? 'egsi-scenario-down' : 'egsi-scenario-base';
                html += '<div class="egsi-scenario-card ' + cls + '"><div class="egsi-scenario-label">' + sc.label + '</div><div class="egsi-scenario-range">EGSI: ' + sc.egsi_range + '</div><div class="egsi-scenario-band">Band: ' + sc.implied_band + '</div><div class="egsi-scenario-ttf">TTF: ' + sc.ttf_impact + '</div></div>';
            });
            html += '</div>';
            document.getElementById('egsiImpactScenarios').innerHTML = html;
        }

        function renderEgsiRegimeHistory(data) {
            if (!data || !data.bands || data.bands.length === 0) return;
            var colorMap = { LOW: '#22c55e', NORMAL: '#3b82f6', ELEVATED: '#f59e0b', HIGH: '#ef4444', CRITICAL: '#dc2626' };
            var maxDays = Math.max.apply(null, data.bands.map(function(b) { return b.days; })) || 1;
            var barsHtml = data.bands.map(function(b) {
                var pct = Math.max(2, (b.days / maxDays) * 100);
                var color = colorMap[b.band] || '#64748b';
                return '<div class="egsi-regime-row"><span class="egsi-regime-band-label">' + b.band + '</span><div class="egsi-regime-bar-bg"><div class="egsi-regime-bar-fill" style="width:' + pct + '%;background:' + color + ';"></div></div><span class="egsi-regime-days">' + b.days + 'd (' + b.pct + '%)</span></div>';
            }).join('');
            document.getElementById('egsiRegimeBars').innerHTML = barsHtml;
            document.getElementById('egsiRegimeStats').textContent = 'Total: ' + data.total_days + ' days | Transitions: ' + (data.transitions || 0);
        }

        function renderEgsiOverlayChart() {
            if (!egsiTraderData || !egsiTraderData.asset_overlay) return;
            var overlay = egsiTraderData.asset_overlay;
            var datasets = [];
            var egsiDates = (overlay.egsi_m || []).map(function(d) { return d.date; });
            var labels = egsiDates.map(function(d) { return new Date(d + 'T00:00:00').toLocaleDateString('en-GB', {day:'numeric',month:'short'}); });

            datasets.push({
                label: 'EGSI-M',
                data: (overlay.egsi_m || []).map(function(d) { return d.value; }),
                borderColor: '#10b981',
                backgroundColor: 'rgba(16,185,129,0.1)',
                borderWidth: 2, fill: false, tension: 0.3, yAxisID: 'y',
                pointRadius: labels.length > 60 ? 0 : 2, pointHoverRadius: 4,
            });

            var assetConfigs = [
                { id: 'egsiOverlayTTF', key: 'ttf', label: 'TTF (EUR/MWh)', color: '#f59e0b', yAxis: 'y1' },
                { id: 'egsiOverlayBrent', key: 'brent', label: 'Brent (USD)', color: '#06b6d4', yAxis: 'y1' },
                { id: 'egsiOverlayVIX', key: 'vix', label: 'VIX', color: '#a78bfa', yAxis: 'y1' },
                { id: 'egsiOverlayEURUSD', key: 'eurusd', label: 'EUR/USD', color: '#fb923c', yAxis: 'y2' },
                { id: 'egsiOverlayStorage', key: 'storage', label: 'EU Storage %', color: '#2dd4bf', yAxis: 'y2' },
            ];

            assetConfigs.forEach(function(ac) {
                var cb = document.getElementById(ac.id);
                if (!cb || !cb.checked) return;
                var series = overlay[ac.key] || [];
                var dateMap = {};
                series.forEach(function(s) { dateMap[s.date] = s.value; });
                var aligned = egsiDates.map(function(d) { return dateMap[d] !== undefined ? dateMap[d] : null; });
                datasets.push({
                    label: ac.label,
                    data: aligned,
                    borderColor: ac.color,
                    borderWidth: 1.5, fill: false, tension: 0.3,
                    pointRadius: 0, pointHoverRadius: 3,
                    yAxisID: ac.yAxis,
                    borderDash: [4, 2],
                });
            });

            var ctx = document.getElementById('egsiOverlayChart');
            if (egsiOverlayChartObj) egsiOverlayChartObj.destroy();
            egsiOverlayChartObj = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { labels: { color: '#94a3b8', font: { size: 11 } } }, tooltip: { backgroundColor: '#1e293b', titleColor: '#f1f5f9', bodyColor: '#cbd5e1', borderColor: '#334155', borderWidth: 1 } },
                    scales: {
                        x: { ticks: { color: '#64748b', font: { size: 10 }, maxRotation: 45 }, grid: { color: 'rgba(51,65,85,0.3)' } },
                        y: { position: 'left', title: { display: true, text: 'EGSI-M', color: '#10b981', font: { size: 11 } }, ticks: { color: '#64748b' }, grid: { color: 'rgba(51,65,85,0.3)' }, min: 0 },
                        y1: { position: 'right', title: { display: true, text: 'Asset Price', color: '#f59e0b', font: { size: 11 } }, ticks: { color: '#64748b' }, grid: { drawOnChartArea: false } },
                        y2: { display: false },
                    },
                },
            });
        }

        function renderEgsiStorageSeasonalChart(data) {
            if (!data || !data.current || data.current.length === 0) return;
            var labels = data.current.map(function(d) { return new Date(d.date + 'T00:00:00').toLocaleDateString('en-GB', {day:'numeric',month:'short'}); });
            var currentVals = data.current.map(function(d) { return d.value; });
            var seasonalVals = data.seasonal_avg.map(function(d) { return d.value; });

            var ctx = document.getElementById('egsiStorageSeasonalChart');
            if (egsiStorageChartObj) egsiStorageChartObj.destroy();
            egsiStorageChartObj = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Current Storage %', data: currentVals, borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)', borderWidth: 2, fill: true, tension: 0.3, pointRadius: currentVals.length > 30 ? 0 : 3 },
                        { label: 'Seasonal Average', data: seasonalVals, borderColor: '#94a3b8', borderWidth: 1.5, borderDash: [5, 3], fill: false, tension: 0.3, pointRadius: 0 },
                    ],
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#94a3b8', font: { size: 11 } } }, tooltip: { backgroundColor: '#1e293b', titleColor: '#f1f5f9', bodyColor: '#cbd5e1' } },
                    scales: {
                        x: { ticks: { color: '#64748b', font: { size: 10 } }, grid: { color: 'rgba(51,65,85,0.3)' } },
                        y: { title: { display: true, text: 'Storage %', color: '#10b981', font: { size: 11 } }, ticks: { color: '#64748b' }, grid: { color: 'rgba(51,65,85,0.3)' }, min: 0, max: 100 },
                    },
                },
            });
            var metaHtml = '';
            if (data.latest_pct !== null) metaHtml += 'Current: ' + data.latest_pct + '%';
            if (data.seasonal_norm_pct !== null) metaHtml += ' | Seasonal norm: ' + data.seasonal_norm_pct + '%';
            if (data.deficit !== null) metaHtml += ' | Deficit: ' + (data.deficit > 0 ? '-' : '+') + Math.abs(data.deficit) + '%';
            document.getElementById('egsiStorageSeasonalMeta').textContent = metaHtml;
        }

        function renderEgsiAnalogFinder(data) {
            if (!data || !data.analogs || data.analogs.length === 0) {
                document.getElementById('egsiAnalogList').innerHTML = '<div style="color:#64748b;font-size:13px;">Not enough history for pattern matching yet.</div>';
                return;
            }
            var html = '<div style="color:#94a3b8;font-size:12px;margin-bottom:8px;">Current pattern avg: ' + (data.current_avg || '--') + ' | Window: ' + (data.pattern_window || 14) + ' days</div>';
            html += data.analogs.map(function(a) {
                var outcomeColor = a.outcome_7d === 'rose' ? '#f87171' : a.outcome_7d === 'fell' ? '#4ade80' : '#94a3b8';
                var outcomeText = a.outcome_7d === 'rose' ? 'Stress rose' : a.outcome_7d === 'fell' ? 'Stress fell' : 'Stable';
                return '<div class="egsi-analog-item"><div class="egsi-analog-dates">' + a.start_date + ' to ' + a.end_date + '</div><div class="egsi-analog-meta">Similarity: <strong>' + (a.similarity * 100).toFixed(0) + '%</strong> | Avg: ' + a.avg_value + ' | Band: ' + a.band_at_time + '</div><div class="egsi-analog-outcome" style="color:' + outcomeColor + '">7d after: ' + outcomeText + '</div></div>';
            }).join('');
            document.getElementById('egsiAnalogList').innerHTML = html;
        }

        /* ========== End EGSI Dashboard Module ========== */

        function showSection(sectionId) {
            document.querySelectorAll('.section-content').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            document.getElementById('section-' + sectionId).classList.add('active');
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }

            if (sectionId === 'plans') {
                loadPlans();
            } else if (sectionId === 'settings') {
                loadAlertSettings();
            } else if (sectionId === 'geri') {
                loadGeriData();
            } else if (sectionId === 'eeri-pro') {
                loadEeriProData();
            } else if (sectionId === 'digest') {
                loadDailyDigest();
            } else if (sectionId === 'egsi') {
                loadEgsiDashboard();
            } else if (sectionId === 'eriq') {
                loadEriqStatus();
            }
        }

        async function loadPlans() {
            const grid = document.getElementById('plansGrid');
            
            try {
                const response = await fetch('/billing/plans');
                const data = await response.json();
                const plans = data.plans || [];
                
                const planOrder = ['free', 'personal', 'trader', 'pro', 'enterprise'];
                plans.sort((a, b) => planOrder.indexOf(a.plan_code) - planOrder.indexOf(b.plan_code));
                
                const currentPlan = currentUser?.plan || 'free';
                const currentPlanIndex = planOrder.indexOf(currentPlan);

                grid.innerHTML = plans.map(plan => {
                    const planIndex = planOrder.indexOf(plan.plan_code);
                    const isCurrent = plan.plan_code === currentPlan;
                    const isUpgrade = planIndex > currentPlanIndex;
                    const isDowngrade = planIndex < currentPlanIndex && plan.plan_code !== 'free';
                    const isFree = plan.plan_code === 'free';
                    
                    let btnClass = 'plan-btn';
                    let btnText = '';
                    let btnDisabled = '';
                    
                    if (isCurrent) {
                        btnClass += ' current';
                        btnText = 'Current Plan';
                        btnDisabled = 'disabled';
                    } else if (isUpgrade) {
                        btnClass += ' upgrade';
                        btnText = `Upgrade to ${plan.display_name}`;
                    } else if (isDowngrade || (isFree && currentPlan !== 'free')) {
                        btnClass += ' downgrade';
                        btnText = `Downgrade to ${plan.display_name}`;
                    }
                    
                    const features = getPlanCardFeatures(plan.plan_code);
                    
                    return `
                        <div class="plan-card ${isCurrent ? 'current' : ''}">
                            <div class="plan-name">${plan.display_name}</div>
                            <div class="plan-tagline">${planTaglines[plan.plan_code] || ''}</div>
                            <div class="plan-price">${plan.price > 0 ? '' + plan.price.toFixed(2) : 'Free'}<span>${plan.price > 0 ? '/mo' : ''}</span></div>
                            <ul class="plan-features">
                                ${renderPlanFeaturesList(features)}
                            </ul>
                            <button class="${btnClass}" 
                                    ${btnDisabled}
                                    onclick="openPlanModal('${plan.plan_code}', '${plan.display_name}', ${plan.price}, '${isUpgrade ? 'upgrade' : 'downgrade'}')">
                                ${btnText}
                            </button>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading plans:', error);
                grid.innerHTML = '<p style="color: #f87171;">Failed to load plans</p>';
            }
        }

        function openPlanModal(planCode, planName, price, action) {
            const modal = document.getElementById('planModal');
            const modalTitle = document.getElementById('planModalTitle');
            const modalBody = document.getElementById('planModalBody');
            const modalBtn = document.getElementById('planModalBtn');
            
            const planColors = {
                'free': '#22c55e',
                'personal': '#3b82f6',
                'trader': '#f59e0b',
                'pro': '#ef4444',
                'enterprise': '#a855f7'
            };
            const pColor = planColors[planCode] || '#3b82f6';
            const features = getPlanCardFeatures(planCode);
            
            const settingsNote = `
                <div style="background: #0f172a; border: 1px solid ${pColor}33; border-radius: 8px; padding: 14px; margin-top: 16px;">
                    <p style="color: ${pColor}; font-weight: 600; margin-bottom: 8px;">Plan Features:</p>
                    <ul class="plan-features" style="margin: 0; padding: 0; font-size: 12px; line-height: 1.6;">
                        ${renderPlanFeaturesList(features)}
                    </ul>
                </div>
            `;
            
            if (planCode === 'free') {
                modalTitle.textContent = 'Downgrade to Free';
                modalBody.innerHTML = `
                    <p>Are you sure you want to downgrade to the Free plan?</p>
                    <p style="color: #94a3b8; margin-top: 12px;">Your current plan benefits will remain active until the end of your billing period.</p>
                    <p style="color: #f87171; margin-top: 12px; font-size: 13px;">
                        <strong>Note:</strong> Your current alert settings that exceed Free plan limits will be automatically adjusted.
                    </p>
                    ${settingsNote}
                `;
                modalBtn.textContent = 'Downgrade to Free';
                modalBtn.className = 'plan-btn downgrade';
                modalBtn.onclick = () => cancelSubscription();
            } else {
                const actionText = action === 'upgrade' ? 'Upgrade' : 'Downgrade';
                modalTitle.textContent = `${actionText} to ${planName}`;
                modalBody.innerHTML = `
                    <p>You are about to ${action} to the <strong>${planName}</strong> plan.</p>
                    <div style="background: #1e293b; border-radius: 8px; padding: 16px; margin: 16px 0;">
                        <div style="font-size: 24px; font-weight: 700; color: #f1f5f9;">${price.toFixed(2)}<span style="font-size: 14px; color: #94a3b8;">/month</span></div>
                    </div>
                    ${action === 'upgrade' ? '<p style="color: #4ade80;">Your new plan will be activated immediately.</p>' : '<p style="color: #fbbf24;">Changes will take effect at the end of your current billing period. Settings exceeding the new plan limits will be adjusted.</p>'}
                    ${settingsNote}
                `;
                modalBtn.textContent = `${actionText} to ${planName}`;
                modalBtn.className = action === 'upgrade' ? 'plan-btn upgrade' : 'plan-btn downgrade';
                modalBtn.onclick = () => startCheckout(planCode);
            }
            
            modal.style.display = 'flex';
        }

        function closePlanModal() {
            document.getElementById('planModal').style.display = 'none';
        }

        async function startCheckout(planCode) {
            const btn = document.getElementById('planModalBtn');
            const originalText = btn.textContent;
            btn.textContent = 'Processing...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/billing/checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-Token': sessionToken
                    },
                    body: JSON.stringify({ plan_code: planCode })
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Failed to create checkout');
                }
                
                const data = await response.json();
                
                if (data.checkout_url) {
                    window.location.href = data.checkout_url;
                } else if (data.success) {
                    closePlanModal();
                    alert('Your plan has been updated successfully!');
                    loadPlans();
                }
            } catch (error) {
                console.error('Checkout error:', error);
                alert('Failed to start checkout: ' + error.message);
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        async function cancelSubscription() {
            const btn = document.getElementById('planModalBtn');
            const originalText = btn.textContent;
            btn.textContent = 'Cancelling...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/billing/cancel', {
                    method: 'POST',
                    headers: { 'X-User-Token': sessionToken }
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Failed to cancel subscription');
                }
                
                closePlanModal();
                alert('Your subscription has been cancelled. It will remain active until the end of your billing period.');
                loadPlans();
            } catch (error) {
                console.error('Cancel error:', error);
                alert('Failed to cancel subscription: ' + error.message);
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        async function openBillingPortal() {
            try {
                const response = await fetch('/billing/portal', {
                    method: 'POST',
                    headers: { 'X-User-Token': sessionToken }
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Failed to open billing portal');
                }
                
                const data = await response.json();
                if (data.portal_url) {
                    window.location.href = data.portal_url;
                }
            } catch (error) {
                console.error('Portal error:', error);
                alert('Failed to open billing portal: ' + error.message);
            }
        }

        async function logout() {
            try {
                await fetch('/users/signout', {
                    method: 'POST',
                    headers: { 'X-User-Token': sessionToken }
                });
            } catch (e) {}

            localStorage.removeItem('userSession');
            window.location.href = '/users';
        }

        async function loadAlertSettings() {
            try {
                const response = await fetch('/users/settings', {
                    headers: { 'X-User-Token': sessionToken }
                });

                if (!response.ok) throw new Error('Failed to load settings');

                userSettings = await response.json();
                renderAlertSettings();
            } catch (error) {
                console.error('Error loading alert settings:', error);
                document.getElementById('currentSettingsList').innerHTML = 
                    '<p style="color: #f87171;">Failed to load settings</p>';
            }
        }

        function renderSettingsFromDashboard(settings) {
            userSettings = {
                plan: settings.plan,
                allowed_alert_types: settings.allowed_alert_types,
                max_regions: settings.max_regions,
                current_region_count: settings.current_region_count,
                available_regions: settings.available_regions,
                settings: settings.items
            };
            renderAlertSettings();
        }

        function renderPlans(plans) {
            const grid = document.getElementById('plansGrid');
            if (!grid) return;
            
            const planOrder = ['free', 'personal', 'trader', 'pro', 'enterprise'];
            plans.sort((a, b) => planOrder.indexOf(a.plan_code) - planOrder.indexOf(b.plan_code));
            
            const currentPlan = currentUser?.plan || 'free';
            const currentPlanIndex = planOrder.indexOf(currentPlan);

            grid.innerHTML = plans.map(plan => {
                const planIndex = planOrder.indexOf(plan.plan_code);
                const isCurrent = plan.plan_code === currentPlan;
                const isUpgrade = planIndex > currentPlanIndex;
                const isDowngrade = planIndex < currentPlanIndex && plan.plan_code !== 'free';
                const isFree = plan.plan_code === 'free';
                
                let btnClass = 'plan-btn';
                let btnText = '';
                let btnDisabled = '';
                
                if (isCurrent) {
                    btnClass += ' current';
                    btnText = 'Current Plan';
                    btnDisabled = 'disabled';
                } else if (isUpgrade) {
                    btnClass += ' upgrade';
                    btnText = `Upgrade to ${plan.display_name}`;
                } else if (isDowngrade || (isFree && currentPlan !== 'free')) {
                    btnClass += ' downgrade';
                    btnText = `Downgrade to ${plan.display_name}`;
                }
                
                const features = getPlanCardFeatures(plan.plan_code);
                
                return `
                    <div class="plan-card ${isCurrent ? 'current' : ''}">
                        <div class="plan-name">${plan.display_name}</div>
                        <div class="plan-tagline">${planTaglines[plan.plan_code] || ''}</div>
                        <div class="plan-price">${plan.price > 0 ? '' + plan.price.toFixed(2) : 'Free'}<span>${plan.price > 0 ? '/mo' : ''}</span></div>
                        <ul class="plan-features">
                            ${renderPlanFeaturesList(features)}
                        </ul>
                        <button class="${btnClass}" 
                                ${btnDisabled}
                                onclick="openPlanModal('${plan.plan_code}', '${plan.display_name}', ${plan.price}, '${isUpgrade ? 'upgrade' : 'downgrade'}')">
                            ${btnText}
                        </button>
                    </div>
                `;
            }).join('');
        }

        function renderAlertSettings() {
            if (!userSettings) return;

            const plan = userSettings.plan || 'free';
            const planDisplay = plan.charAt(0).toUpperCase() + plan.slice(1);
            const maxRegions = userSettings.max_regions === -1 ? 'Unlimited' : userSettings.max_regions;
            const regionCountText = userSettings.max_regions === -1 
                ? `${userSettings.current_region_count}` 
                : `${userSettings.current_region_count} / ${userSettings.max_regions}`;

            document.getElementById('settingsPlanBadge').textContent = planDisplay;
            document.getElementById('settingsPlanBadge').className = 'stat-badge ' + plan;
            document.getElementById('settingsRegionCount').textContent = regionCountText;

            const typeSelect = document.getElementById('newAlertType');
            typeSelect.innerHTML = '<option value="">Select alert type...</option>';
            userSettings.allowed_alert_types.forEach(type => {
                const displayName = type.replace(/_/g, ' ');
                typeSelect.innerHTML += `<option value="${type}">${displayName}</option>`;
            });

            const regionSelect = document.getElementById('newAlertRegion');
            regionSelect.innerHTML = '<option value="">Select region...</option>';
            if (userSettings.max_regions === -1) {
                regionSelect.innerHTML += '<option value="__all__">All Regions (Unlimited)</option>';
            }
            userSettings.available_regions.forEach(region => {
                regionSelect.innerHTML += `<option value="${region}">${region}</option>`;
            });

            const listContainer = document.getElementById('currentSettingsList');
            const noSettingsMsg = document.getElementById('noSettingsMessage');

            if (!userSettings.settings || userSettings.settings.length === 0) {
                listContainer.innerHTML = '';
                noSettingsMsg.style.display = 'block';
                return;
            }

            noSettingsMsg.style.display = 'none';
            listContainer.innerHTML = userSettings.settings.map(setting => `
                <div class="info-row" style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <span class="type-badge" style="background: rgba(59, 130, 246, 0.2); color: #60a5fa;">
                            ${setting.alert_type.replace(/_/g, ' ')}
                        </span>
                        <span style="color: #f1f5f9; font-weight: 500;">
                            ${setting.region || 'All Regions'}
                        </span>
                        ${setting.enabled ? 
                            '<span style="color: #4ade80; font-size: 12px;">Active</span>' : 
                            '<span style="color: #64748b; font-size: 12px;">Disabled</span>'
                        }
                    </div>
                    <button class="filter-btn secondary" onclick="deleteSetting(${setting.id})" 
                            style="padding: 6px 12px; font-size: 12px;">
                        Remove
                    </button>
                </div>
            `).join('');
        }

        async function addAlertSetting() {
            const alertType = document.getElementById('newAlertType').value;
            let region = document.getElementById('newAlertRegion').value;
            const errorEl = document.getElementById('addSettingError');

            if (!alertType) {
                errorEl.textContent = 'Please select an alert type';
                errorEl.style.display = 'block';
                return;
            }

            if (!region) {
                errorEl.textContent = 'Please select a region';
                errorEl.style.display = 'block';
                return;
            }

            if (region === '__all__') {
                region = null;
            }

            errorEl.style.display = 'none';

            try {
                const response = await fetch('/users/settings', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-User-Token': sessionToken 
                    },
                    body: JSON.stringify({
                        alert_type: alertType,
                        region: region,
                        enabled: true
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Failed to add setting');
                }

                document.getElementById('newAlertType').value = '';
                document.getElementById('newAlertRegion').value = '';
                
                await loadAlertSettings();
            } catch (error) {
                errorEl.textContent = error.message;
                errorEl.style.display = 'block';
            }
        }

        async function deleteSetting(settingId) {
            if (!confirm('Are you sure you want to remove this alert setting?')) return;

            try {
                const response = await fetch(`/users/settings/${settingId}`, {
                    method: 'DELETE',
                    headers: { 'X-User-Token': sessionToken }
                });

                if (!response.ok) throw new Error('Failed to delete setting');

                await loadAlertSettings();
            } catch (error) {
                alert('Failed to remove setting. Please try again.');
            }
        }

        function renderDeliveryPreferences(prefs) {
            const indices = ['geri', 'eeri', 'egsi', 'daily_digest'];
            const hasTelegram = !!(currentUser && currentUser.telegram_chat_id);
            
            indices.forEach(idx => {
                const p = prefs[idx] || { email: false, telegram: false };
                const emailCb = document.getElementById(`pref_${idx}_email`);
                const tgCb = document.getElementById(`pref_${idx}_telegram`);
                if (emailCb) emailCb.checked = p.email;
                if (tgCb) {
                    tgCb.checked = p.telegram;
                    if (!hasTelegram) {
                        tgCb.disabled = true;
                        tgCb.checked = false;
                    }
                }
            });
            
            const tgNote = document.getElementById('telegramPrefNote');
            if (tgNote && !hasTelegram) {
                tgNote.style.display = 'block';
            }
        }

        let deliverySaveTimeout = null;
        async function saveDeliveryPreferences() {
            if (deliverySaveTimeout) clearTimeout(deliverySaveTimeout);
            
            deliverySaveTimeout = setTimeout(async () => {
                const statusEl = document.getElementById('deliveryPrefStatus');
                const errorEl = document.getElementById('deliveryPrefError');
                statusEl.style.display = 'none';
                errorEl.style.display = 'none';
                
                const body = {
                    geri_email: document.getElementById('pref_geri_email')?.checked || false,
                    geri_telegram: document.getElementById('pref_geri_telegram')?.checked || false,
                    eeri_email: document.getElementById('pref_eeri_email')?.checked || false,
                    eeri_telegram: document.getElementById('pref_eeri_telegram')?.checked || false,
                    egsi_email: document.getElementById('pref_egsi_email')?.checked || false,
                    egsi_telegram: document.getElementById('pref_egsi_telegram')?.checked || false,
                    daily_digest_email: document.getElementById('pref_daily_digest_email')?.checked || false,
                    daily_digest_telegram: document.getElementById('pref_daily_digest_telegram')?.checked || false
                };
                
                try {
                    const response = await fetch('/users/delivery-preferences', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-User-Token': sessionToken
                        },
                        body: JSON.stringify(body)
                    });
                    
                    if (!response.ok) throw new Error('Failed to save');
                    
                    statusEl.textContent = 'Preferences saved';
                    statusEl.style.display = 'block';
                    setTimeout(() => { statusEl.style.display = 'none'; }, 2000);
                } catch (error) {
                    console.error('Error saving delivery preferences:', error);
                    errorEl.textContent = 'Failed to save preferences. Please try again.';
                    errorEl.style.display = 'block';
                }
            }, 500);
        }

        window.onerror = function(msg, url, line, col, error) {
            console.error('Global error:', msg, 'at', url, 'line', line);
            return false;
        };

        try {
            if (checkSession()) {
                loadDashboard().catch(function(err) {
                    console.error('Dashboard load error:', err);
                });
            }
        } catch (initError) {
            console.error('Initialization error:', initError);
        }

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('billing') === 'success') {
            const expectedPlan = urlParams.get('plan');
            window.history.replaceState({}, document.title, '/users/account');
            
            async function waitForPlanUpdate(expectedPlan, maxAttempts = 10) {
                const statusEl = document.createElement('div');
                statusEl.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#1e293b;border:1px solid #3b82f6;border-radius:12px;padding:24px 32px;z-index:9999;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,0.4);';
                statusEl.innerHTML = '<div style="font-size:18px;font-weight:600;color:#e2e8f0;margin-bottom:8px;">Activating your plan...</div><div style="color:#94a3b8;font-size:14px;">Please wait while we confirm your upgrade</div>';
                document.body.appendChild(statusEl);
                
                for (let i = 0; i < maxAttempts; i++) {
                    try {
                        const response = await fetch('/users/me', {
                            headers: { 'X-User-Token': sessionToken }
                        });
                        if (response.ok) {
                            const user = await response.json();
                            if (!expectedPlan || user.plan === expectedPlan) {
                                statusEl.remove();
                                await loadDashboard();
                                alert('Payment successful! Your plan has been upgraded to ' + (user.plan || 'your new plan').charAt(0).toUpperCase() + (user.plan || '').slice(1) + '.\n\nPlease visit the Settings tab to configure your alert preferences.');
                                return;
                            }
                        }
                    } catch (e) {
                        console.error('Plan check error:', e);
                    }
                    await new Promise(r => setTimeout(r, 1500));
                }
                
                statusEl.remove();
                await loadDashboard();
                alert('Payment successful! Your plan upgrade is being processed.\n\nIf your plan does not update within a few minutes, please refresh the page.');
            }
            
            waitForPlanUpdate(expectedPlan);
        } else if (urlParams.get('billing') === 'cancelled') {
            window.history.replaceState({}, document.title, '/users/account');
        }
    </script>

    <!-- Plan Upgrade/Downgrade Modal -->
    <div id="planModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <button class="modal-close" onclick="closePlanModal()">&times;</button>
            <h2 id="planModalTitle" class="modal-title">Upgrade Plan</h2>
            <div id="planModalBody" class="modal-body">
            </div>
            <div class="modal-actions">
                <button class="plan-btn secondary" onclick="closePlanModal()">Cancel</button>
                <button id="planModalBtn" class="plan-btn upgrade">Confirm</button>
            </div>
        </div>
    </div>

    <style>
        .eriq-chat-container {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 180px);
            min-height: 500px;
            max-height: 800px;
            overflow: hidden;
        }
        .eriq-status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: #0f172a;
            border-bottom: 1px solid #334155;
            border-radius: 16px 16px 0 0;
        }
        .eriq-status-left {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #94a3b8;
        }
        .eriq-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
            box-shadow: 0 0 6px rgba(34, 197, 94, 0.5);
        }
        .eriq-status-right {
            font-size: 12px;
            color: #64748b;
        }
        .eriq-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            scroll-behavior: smooth;
        }
        .eriq-messages::-webkit-scrollbar {
            width: 6px;
        }
        .eriq-messages::-webkit-scrollbar-track {
            background: transparent;
        }
        .eriq-messages::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 3px;
        }
        .eriq-welcome {
            text-align: center;
            padding: 40px 20px;
        }
        .eriq-welcome .eriq-avatar {
            width: 64px;
            height: 64px;
            background: rgba(139, 92, 246, 0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            border: 2px solid rgba(139, 92, 246, 0.3);
        }
        .eriq-welcome h3 {
            font-size: 20px;
            font-weight: 700;
            color: #f1f5f9;
            margin-bottom: 8px;
        }
        .eriq-welcome p {
            color: #94a3b8;
            font-size: 14px;
            line-height: 1.6;
            max-width: 500px;
            margin: 0 auto 24px;
        }
        .eriq-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }
        .eriq-suggestion-btn {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            color: #c4b5fd;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        .eriq-suggestion-btn:hover {
            background: rgba(139, 92, 246, 0.2);
            border-color: rgba(139, 92, 246, 0.5);
            color: #e9d5ff;
        }
        .eriq-msg {
            display: flex;
            gap: 12px;
            max-width: 85%;
            animation: eriqFadeIn 0.3s ease-out;
        }
        @keyframes eriqFadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .eriq-msg.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        .eriq-msg-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 14px;
            font-weight: 700;
        }
        .eriq-msg.assistant .eriq-msg-avatar {
            background: rgba(139, 92, 246, 0.2);
            color: #8b5cf6;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }
        .eriq-msg.user .eriq-msg-avatar {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        .eriq-msg-bubble {
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.7;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .eriq-msg.assistant .eriq-msg-bubble {
            background: #0f172a;
            border: 1px solid #334155;
            color: #e2e8f0;
        }
        .eriq-msg.user .eriq-msg-bubble {
            background: rgba(59, 130, 246, 0.15);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #e2e8f0;
        }
        .eriq-msg-meta {
            display: flex;
            gap: 8px;
            margin-top: 6px;
            align-items: center;
        }
        .eriq-msg-badge {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .eriq-msg-badge.explain {
            background: rgba(139, 92, 246, 0.15);
            color: #a78bfa;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }
        .eriq-msg-badge.interpret {
            background: rgba(245, 158, 11, 0.15);
            color: #fbbf24;
            border: 1px solid rgba(245, 158, 11, 0.2);
        }
        .eriq-msg-badge.decide_support {
            background: rgba(34, 197, 94, 0.15);
            color: #4ade80;
            border: 1px solid rgba(34, 197, 94, 0.2);
        }
        .eriq-msg-quality {
            font-size: 10px;
            color: #64748b;
        }
        .eriq-msg-feedback {
            display: flex;
            gap: 4px;
            margin-left: auto;
        }
        .eriq-feedback-btn {
            background: none;
            border: 1px solid #334155;
            color: #64748b;
            width: 24px;
            height: 24px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s;
        }
        .eriq-feedback-btn:hover {
            border-color: #8b5cf6;
            color: #8b5cf6;
        }
        .eriq-feedback-btn.active {
            background: rgba(139, 92, 246, 0.15);
            border-color: #8b5cf6;
            color: #8b5cf6;
        }
        .eriq-typing {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }
        .eriq-typing-dots {
            display: flex;
            gap: 4px;
            padding: 16px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 12px;
        }
        .eriq-typing-dots span {
            width: 8px;
            height: 8px;
            background: #8b5cf6;
            border-radius: 50%;
            animation: eriqBounce 1.4s ease-in-out infinite;
        }
        .eriq-typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .eriq-typing-dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes eriqBounce {
            0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
            40% { transform: scale(1); opacity: 1; }
        }
        .eriq-input-area {
            padding: 16px 20px;
            border-top: 1px solid #334155;
            background: #0f172a;
            border-radius: 0 0 16px 16px;
        }
        .eriq-input-wrapper {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }
        .eriq-input {
            flex: 1;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 12px 16px;
            color: #e2e8f0;
            font-size: 14px;
            font-family: inherit;
            resize: none;
            max-height: 120px;
            min-height: 44px;
            line-height: 1.5;
            outline: none;
            transition: border-color 0.2s;
        }
        .eriq-input:focus {
            border-color: #8b5cf6;
        }
        .eriq-input::placeholder {
            color: #475569;
        }
        .eriq-send-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: linear-gradient(135deg, #8b5cf6, #6d28d9);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .eriq-send-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }
        .eriq-send-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .eriq-disclaimer {
            text-align: center;
            font-size: 11px;
            color: #475569;
            margin-top: 8px;
        }
        .eriq-limit-warning {
            text-align: center;
            padding: 12px;
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 8px;
            color: #fbbf24;
            font-size: 13px;
            margin: 8px 20px;
        }
        @media (max-width: 768px) {
            .eriq-chat-container {
                height: calc(100vh - 160px);
                border-radius: 12px;
            }
            .eriq-msg {
                max-width: 95%;
            }
            .eriq-suggestions {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>

    <style>
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: #1e293b;
            border-radius: 16px;
            padding: 32px;
            max-width: 480px;
            width: 90%;
            position: relative;
            border: 1px solid #334155;
        }
        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 24px;
            cursor: pointer;
        }
        .modal-close:hover {
            color: #f1f5f9;
        }
        .modal-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 16px;
            color: #f1f5f9;
        }
        .modal-body {
            color: #cbd5e1;
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 24px;
        }
        .modal-body strong {
            color: #f1f5f9;
        }
        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        .plan-btn.secondary {
            background: transparent;
            border: 1px solid #475569;
            color: #94a3b8;
        }
        .plan-btn.secondary:hover {
            background: #334155;
            color: #f1f5f9;
        }
        .plan-btn.downgrade {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        .plan-btn.downgrade:hover {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        }
    </style>
<!-- GERI Interpretation Modal -->
    <div id="interpretationModal" class="interpretation-modal-overlay" onclick="closeInterpretationModal(event)">
        <div class="interpretation-modal-content" onclick="event.stopPropagation()">
            <button class="interpretation-modal-close" onclick="closeInterpretationModal()">&times;</button>
            <h2 class="interpretation-modal-title">GERI Interpretation</h2>
            <div id="interpretationModalBody" class="interpretation-modal-body"></div>
        </div>
    </div>

    <script>
        let eriqConversationHistory = [];
        let eriqIsLoading = false;

        async function loadEriqStatus() {
            if (!sessionToken) return;
            try {
                const resp = await fetch('/api/v1/eriq/status', {
                    headers: { 'X-User-Token': sessionToken }
                });
                if (resp.ok) {
                    const data = await resp.json();
                    const quotaEl = document.getElementById('eriqQuotaText');
                    const remaining = data.questions_remaining;
                    const limit = data.questions_limit;
                    if (limit >= 999999) {
                        quotaEl.textContent = 'Unlimited questions';
                    } else {
                        quotaEl.textContent = remaining + ' / ' + limit + ' questions remaining today';
                    }
                    if (remaining <= 0 && limit < 999999) {
                        quotaEl.style.color = '#ef4444';
                    } else if (remaining <= 3 && limit < 999999) {
                        quotaEl.style.color = '#f59e0b';
                    } else {
                        quotaEl.style.color = '#64748b';
                    }
                }
            } catch (e) {
                console.warn('ERIQ status fetch failed:', e);
            }
        }

        function eriqAutoResize(el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 120) + 'px';
            const sendBtn = document.getElementById('eriqSendBtn');
            sendBtn.disabled = !el.value.trim();
        }

        function eriqHandleKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                eriqSendMessage();
            }
        }

        function eriqAskSuggestion(question) {
            const input = document.getElementById('eriqInput');
            input.value = question;
            eriqAutoResize(input);
            eriqSendMessage();
        }

        async function eriqSendMessage() {
            const input = document.getElementById('eriqInput');
            const question = input.value.trim();
            if (!question || eriqIsLoading) return;

            if (!sessionToken) {
                eriqAddMessage('assistant', 'Please sign in to use ERIQ Analyst.');
                return;
            }

            const welcomeEl = document.querySelector('.eriq-welcome');
            if (welcomeEl) welcomeEl.remove();

            eriqAddMessage('user', question);
            input.value = '';
            input.style.height = 'auto';
            document.getElementById('eriqSendBtn').disabled = true;

            eriqIsLoading = true;
            const typingEl = eriqShowTyping();

            try {
                const resp = await fetch('/api/v1/eriq/ask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-Token': sessionToken
                    },
                    body: JSON.stringify({
                        question: question,
                        conversation_history: eriqConversationHistory.slice(-6)
                    })
                });

                typingEl.remove();

                if (!resp.ok) {
                    if (resp.status === 401) {
                        eriqAddMessage('assistant', 'Your session has expired. Please sign in again.');
                    } else {
                        eriqAddMessage('assistant', 'Something went wrong. Please try again.');
                    }
                    eriqIsLoading = false;
                    return;
                }

                const data = await resp.json();

                eriqConversationHistory.push({ role: 'user', content: question });

                if (data.success) {
                    eriqAddMessage('assistant', data.response, {
                        mode: data.mode,
                        quality: data.data_quality,
                        id: data.conversation_id
                    });
                    eriqConversationHistory.push({ role: 'assistant', content: data.response });
                } else if (data.error === 'daily_limit') {
                    eriqAddMessage('assistant', data.message, { isLimit: true });
                } else {
                    eriqAddMessage('assistant', data.message || 'I encountered an issue. Please try again.');
                }

                const quotaEl = document.getElementById('eriqQuotaText');
                if (data.questions_used !== undefined && data.questions_limit !== undefined) {
                    const remaining = Math.max(0, data.questions_limit - data.questions_used);
                    if (data.questions_limit >= 999999) {
                        quotaEl.textContent = 'Unlimited questions';
                    } else {
                        quotaEl.textContent = remaining + ' / ' + data.questions_limit + ' questions remaining today';
                    }
                    if (remaining <= 0) {
                        quotaEl.style.color = '#ef4444';
                    } else if (remaining <= 3) {
                        quotaEl.style.color = '#f59e0b';
                    } else {
                        quotaEl.style.color = '#64748b';
                    }
                }
            } catch (e) {
                typingEl.remove();
                eriqAddMessage('assistant', 'Connection error. Please check your network and try again.');
            }

            eriqIsLoading = false;
        }

        function eriqAddMessage(role, content, meta) {
            const container = document.getElementById('eriqMessages');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'eriq-msg ' + role;

            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'eriq-msg-avatar';
            if (role === 'assistant') {
                avatarDiv.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>';
            } else {
                avatarDiv.textContent = 'You';
            }

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'eriq-msg-bubble';

            if (role === 'assistant') {
                bubbleDiv.innerHTML = eriqFormatResponse(content);
            } else {
                bubbleDiv.textContent = content;
            }

            msgDiv.appendChild(avatarDiv);
            const contentWrapper = document.createElement('div');
            contentWrapper.style.cssText = 'display: flex; flex-direction: column; min-width: 0; flex: 1;';
            contentWrapper.appendChild(bubbleDiv);

            if (role === 'assistant' && meta && !meta.isLimit) {
                const metaDiv = document.createElement('div');
                metaDiv.className = 'eriq-msg-meta';

                if (meta.mode) {
                    const badge = document.createElement('span');
                    badge.className = 'eriq-msg-badge ' + meta.mode;
                    badge.textContent = meta.mode.replace('_', '-');
                    metaDiv.appendChild(badge);
                }

                if (meta.quality && meta.quality !== 'good') {
                    const qualSpan = document.createElement('span');
                    qualSpan.className = 'eriq-msg-quality';
                    qualSpan.textContent = 'Data: ' + meta.quality;
                    metaDiv.appendChild(qualSpan);
                }

                contentWrapper.appendChild(metaDiv);
            }

            msgDiv.appendChild(contentWrapper);
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        function eriqFormatResponse(text) {
            if (!text) return '';
            let html = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');

            html = html.replace(/\*\*(.+?)\*\*/g, '<strong style="color: #f1f5f9;">$1</strong>');
            html = html.replace(/\*(.+?)\*/g, '<em style="color: #cbd5e1;">$1</em>');

            html = html.replace(/^---$/gm, '<hr style="border: none; border-top: 1px solid #334155; margin: 12px 0;">');

            html = html.replace(/^### (.+)$/gm, '<div style="font-weight: 700; color: #e2e8f0; margin: 12px 0 6px; font-size: 14px;">$1</div>');
            html = html.replace(/^## (.+)$/gm, '<div style="font-weight: 700; color: #f1f5f9; margin: 14px 0 8px; font-size: 15px;">$1</div>');

            html = html.replace(/^- (.+)$/gm, '<div style="padding-left: 16px; position: relative; margin: 2px 0;"><span style="position: absolute; left: 4px; color: #8b5cf6;">&#8226;</span>$1</div>');

            html = html.replace(/\n/g, '<br>');

            return html;
        }

        function eriqShowTyping() {
            const container = document.getElementById('eriqMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'eriq-typing';
            typingDiv.innerHTML = '<div class="eriq-msg-avatar" style="background: rgba(139, 92, 246, 0.2); color: #8b5cf6; border: 1px solid rgba(139, 92, 246, 0.3);"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></div><div class="eriq-typing-dots"><span></span><span></span><span></span></div>';
            container.appendChild(typingDiv);
            container.scrollTop = container.scrollHeight;
            return typingDiv;
        }
    </script>

    <script>
        function openInterpretationModal() {
            const modal = document.getElementById('interpretationModal');
            const body = document.getElementById('interpretationModalBody');
            if (modal && body && window.fullGeriInterpretation) {
                body.innerHTML = '"' + window.fullGeriInterpretation + '"';
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeInterpretationModal(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('interpretationModal');
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeInterpretationModal();
            }
        });
    </script>
</body>
</html>
